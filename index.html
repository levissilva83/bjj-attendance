<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#08080a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-TileColor" content="#08080a">
    <title>JIU JITSU ACADEMY - Checkin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
    // Early notch detection
    (function(){
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        var h = screen.height, w = screen.width;
        var hasNotch = isIOS && (Math.max(h,w) >= 812);
        var isStandalone = navigator.standalone === true;
        if (hasNotch || isStandalone) {
            document.documentElement.style.setProperty('--notch-top', hasNotch ? '50px' : '24px');
        }
    })();
    </script>
    <style>

        * {
            margin: 0;
            padding: 0;
            border: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-deep: #08080a;
            --bg-card: #111114;
            --bg-elevated: #19191e;
            --bg-glass: rgba(17, 17, 20, 0.8);
            --accent: #D4A529;
            --accent-dim: rgba(212, 165, 41, 0.12);
            --accent-glow: rgba(212, 165, 41, 0.25);
            --gold-light: #F5D04E;
            --gold-deep: #B8860B;
            --coral: #E85D5D;
            --amber: #F0A030;
            --lavender: #9B8ACE;
            --text-1: #f0ede5;
            --text-2: #8a8678;
            --text-3: #55524a;
            --border: rgba(212, 165, 41, 0.08);
            --border-accent: rgba(212, 165, 41, 0.2);
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --shadow-card: 0 2px 20px rgba(0,0,0,0.4);
            --shadow-glow: 0 0 30px rgba(212, 165, 41, 0.1);
            --safe-bottom: 0px;
            --notch-top: 0px;
        }

        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            :root { --safe-bottom: env(safe-area-inset-bottom, 0px); }
        }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-deep);
            color: var(--text-1);
            line-height: 1.5;
            touch-action: manipulation;
        }

        /* ===== AMBIENT OVERLAY ===== */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: 
                radial-gradient(ellipse at 20% 0%, rgba(212,165,41,0.03) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(184,134,11,0.02) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .app {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            width: 100%;
            position: relative;
            z-index: 1;
            overflow: hidden;
        }

        @supports (height: 100dvh) {
            .app { height: 100dvh; }
        }

        /* ===== HEADER ===== */
        .hdr {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            -ms-flex-pack: justify;
            justify-content: space-between;
            padding: 14px 20px;
            padding-top: calc(14px + var(--notch-top, 0px));
            background: #08080a;
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 10;
            -webkit-flex-shrink: 0;
            -ms-flex-negative: 0;
            flex-shrink: 0;
        }

        /* iOS 11.0-11.1 */
        @supports (padding-top: constant(safe-area-inset-top)) {
            .hdr { padding-top: calc(14px + constant(safe-area-inset-top)); }
        }

        /* iOS 11.2+ / modern */
        @supports (padding-top: env(safe-area-inset-top)) {
            .hdr { padding-top: calc(14px + env(safe-area-inset-top)); }
        }

        @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
            .hdr {
                background: rgba(8,8,10,0.92);
                -webkit-backdrop-filter: blur(20px);
                backdrop-filter: blur(20px);
            }
        }

        .hdr-brand {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
        }

        .hdr-brand > * + * {
            margin-left: 10px;
        }

        .hdr-title {
            font-family: 'Sora', sans-serif;
            font-weight: 800;
            font-size: 14px;
            letter-spacing: 2px;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hdr-user {
            display: none;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            padding: 6px 14px 6px 8px;
            background: var(--accent-dim);
            border-radius: 50px;
            border: 1px solid var(--border-accent);
            cursor: pointer;
        }

        .hdr-user > * + * {
            margin-left: 10px;
        }

        .hdr-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: var(--bg-deep);
        }

        .hdr-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
        }

        /* ===== MAIN CONTENT ===== */
        .main {
            -webkit-box-flex: 1;
            -webkit-flex: 1 1 0;
            -ms-flex: 1 1 0px;
            flex: 1 1 0;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-y: contain;
            -ms-scroll-chaining: none;
            padding: 20px 16px;
            padding-bottom: 90px;
            min-height: 0;
            position: relative;
            touch-action: pan-y;
        }

        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .main { padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px)); }
        }

        .main::-webkit-scrollbar { width: 4px; }
        .main::-webkit-scrollbar-track { background: transparent; }
        .main::-webkit-scrollbar-thumb { background: var(--text-3); border-radius: 4px; }
        .main::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* ===== MODE SWITCHER ===== */
        .mode-switch {
            display: none;
            align-items: center; gap: 4px;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 3px; cursor: pointer;
        }
        .mode-switch.visible { display: flex; }
        .mode-switch-opt {
            padding: 4px 10px; border-radius: 16px; font-size: 10px; font-weight: 700;
            letter-spacing: 0.5px; text-transform: uppercase; transition: all 0.25s;
            color: var(--text-3); background: transparent; border: none; cursor: pointer;
            font-family: 'Sora', sans-serif; white-space: nowrap;
        }
        .mode-switch-opt.active {
            background: var(--accent); color: #000;
            box-shadow: 0 2px 8px rgba(212,165,41,0.3);
        }
        .mode-switch-opt.active.admin-active {
            background: var(--adm-primary); color: #000;
            box-shadow: 0 2px 8px rgba(20,184,166,0.3);
        }

        /* ===== BOTTOM NAV ===== */
        .bnav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: none;
            background: #08080a;
            border-top: 1px solid var(--border);
            padding: 8px 16px 8px;
            z-index: 100;
        }

        @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
            .bnav {
                background: rgba(8,8,10,0.94);
                -webkit-backdrop-filter: blur(24px);
                backdrop-filter: blur(24px);
            }
        }

        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bnav { padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px)); }
        }

        .bnav-inner {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-justify-content: space-around;
            -ms-flex-pack: distribute;
            justify-content: space-around;
            max-width: 400px;
            margin: 0 auto;
        }

        .bnav-btn {
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -webkit-flex-direction: column;
            -ms-flex-direction: column;
            flex-direction: column;
            -webkit-box-align: center;
            -webkit-align-items: center;
            -ms-flex-align: center;
            align-items: center;
            padding: 6px 10px;
            background: none;
            border: none;
            color: var(--text-3);
            cursor: pointer;
            -webkit-transition: all 0.25s ease;
            transition: all 0.25s ease;
            border-radius: var(--radius-sm);
            position: relative;
            font-family: inherit;
        }

        .bnav-btn .bnav-icon {
            font-size: 22px;
            margin-bottom: 4px;
            -webkit-transition: -webkit-transform 0.25s ease;
            transition: transform 0.25s ease;
        }

        .bnav-btn .bnav-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .bnav-btn.active {
            color: var(--accent);
        }

        .bnav-btn.active .bnav-icon {
            transform: scale(1.15);
        }

        .bnav-btn.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            border-radius: 0 0 4px 4px;
            background: var(--accent);
        }

        /* ===== FORM ELEMENTS ===== */
        input, select, textarea {
            width: 100%;
            font-family: inherit;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            border-radius: var(--radius-md);
            padding: 14px 16px;
            background: var(--bg-elevated);
            color: var(--text-1);
            border: 1.5px solid var(--border);
            transition: all 0.3s ease;
            -webkit-user-select: text;
            user-select: text;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(212,165,41,0.05);
            box-shadow: 0 0 0 3px rgba(212,165,41,0.1);
        }

        input::placeholder { color: var(--text-3); }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23D4A529' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 14px center;
            background-size: 18px;
            padding-right: 42px;
            cursor: pointer;
        }

        select option {
            background: var(--bg-card);
            color: var(--text-1);
        }

        button {
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            border: none;
            font-family: inherit;
        }

        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn {
            width: 100%;
            min-height: 50px;
            padding: 14px 24px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 14px;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            color: var(--bg-deep);
            box-shadow: 0 4px 20px rgba(212,165,41,0.3);
        }

        .btn-primary:active {
            box-shadow: 0 2px 10px rgba(212,165,41,0.2);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--border-accent);
        }

        .btn-danger-outline {
            background: transparent;
            color: var(--coral);
            border: 2px solid rgba(255,107,107,0.3);
        }

        /* ===== CARD BASE ===== */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .card-glass {
            background: #111114;
        }

        @supports ((-webkit-backdrop-filter: blur(1px)) or (backdrop-filter: blur(1px))) {
            .card-glass {
                background: var(--bg-glass);
                -webkit-backdrop-filter: blur(12px);
                backdrop-filter: blur(12px);
            }
        }

        .card-glow {
            box-shadow: var(--shadow-glow);
            border-color: var(--border-accent);
        }

        /* ===== LOGIN SCREEN ===== */
        #loginScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 0;
            padding: 40px 0 20px;
            animation: fadeUp 0.6s ease-out;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-hero {
            text-align: center;
            margin-bottom: 36px;
        }

        .login-title {
            font-family: 'Sora', sans-serif;
            font-size: 28px;
            font-weight: 800;
            letter-spacing: 3px;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
        }

        .login-sub {
            color: var(--text-2);
            font-size: 14px;
        }

        .login-box {
            width: 100%;
            max-width: 400px;
        }

        .form-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 28px 24px;
            margin-bottom: 14px;
        }

        .form-card-title {
            font-family: 'Sora', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 22px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        /* ===== PASSWORD INPUT ===== */
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 44px;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-3);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
            transition: color 0.2s;
        }
        .password-toggle:hover {
            color: var(--gold);
        }
        .password-match-hint {
            font-size: 11px;
            margin-top: 4px;
            min-height: 16px;
        }
        .password-match-hint.match { color: #2ecc71; }
        .password-match-hint.no-match { color: #e74c3c; }

        /* ===== TAB CONTENT ===== */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== CHECK-IN TAB ===== */
        .checkin-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-elevated));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 20px;
        }

        .checkin-avatar {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 800;
            color: var(--bg-deep);
            flex-shrink: 0;
        }

        .checkin-info { flex: 1; }

        .checkin-name {
            font-family: 'Sora', sans-serif;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-1);
            margin-bottom: 2px;
        }

        .checkin-meta {
            font-size: 13px;
            color: var(--text-2);
        }

        .checkin-meta span {
            color: var(--accent);
            font-weight: 600;
        }

        .checkin-count {
            text-align: center;
            padding: 8px 14px;
            background: var(--accent-dim);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-accent);
        }

        .checkin-count-num {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
        }

        .checkin-count-label {
            font-size: 9px;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ct-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
        }

        .ct-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .ct-btn {
            padding: 14px 10px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-2);
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
            text-align: center;
            font-family: inherit;
        }

        .ct-btn:hover { border-color: var(--accent); color: var(--text-1); }

        .ct-btn.selected {
            background: var(--accent-dim);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(212,165,41,0.15);
        }

        .selected-ct-bar {
            display: none;
            padding: 12px 16px;
            background: var(--accent-dim);
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-sm);
            margin-top: 14px;
            font-size: 13px;
            color: var(--text-2);
        }

        .selected-ct-bar span {
            color: var(--accent);
            font-weight: 700;
        }

        .selected-ct-bar.active { display: flex; justify-content: space-between; }

        /* ===== MESSAGE ===== */
        .msg {
            padding: 14px 18px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            margin: 14px 0;
            text-align: center;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.success { background: rgba(212,165,41,0.12); color: var(--accent); border: 1px solid var(--border-accent); }
        .msg.danger { background: rgba(255,107,107,0.12); color: var(--coral); border: 1px solid rgba(255,107,107,0.2); }
        .msg.warning { background: rgba(255,179,71,0.12); color: var(--amber); border: 1px solid rgba(255,179,71,0.2); }
        .msg.info { background: rgba(184,134,11,0.12); color: var(--gold-light); border: 1px solid rgba(184,134,11,0.2); }

        /* ===== RANKING TAB ===== */
        .rank-period {
            display: flex;
            gap: 8px;
            background: var(--bg-card);
            border-radius: 50px;
            padding: 4px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .rank-period-btn {
            flex: 1;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 50px;
            color: var(--text-3);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .rank-period-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            color: var(--bg-deep);
            box-shadow: 0 4px 15px rgba(212,165,41,0.3);
        }

        .rank-ct-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .rank-ct-scroll::-webkit-scrollbar { height: 0; }

        .rank-ct-chip {
            padding: 8px 18px;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: 50px;
            color: var(--text-2);
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .rank-ct-chip.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }

        .rank-ct-chip.geral.active {
            background: rgba(184,134,11,0.15);
            border-color: var(--gold-light);
            color: var(--gold-light);
        }

        /* User training summary */
        .user-stats-card {
            display: none;
            background: linear-gradient(135deg, var(--bg-card), rgba(212,165,41,0.05));
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-lg);
            padding: 18px;
            margin-bottom: 20px;
        }

        .user-stats-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-stats-total {
            text-align: center;
            padding: 12px 18px;
            background: var(--accent-dim);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-accent);
            flex-shrink: 0;
        }

        .user-stats-num {
            font-family: 'Sora', sans-serif;
            font-size: 28px;
            font-weight: 800;
            color: var(--accent);
        }

        .user-stats-lbl {
            font-size: 10px;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .user-ct-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }

        .user-ct-tag {
            padding: 8px 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .user-ct-tag-name {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .user-ct-tag-count {
            font-family: 'Sora', sans-serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        /* Podium */
        .podium {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .podium-card {
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 16px 10px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .podium-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .podium-card.gold::before { background: linear-gradient(90deg, #FFD700, #FFA500); }
        .podium-card.silver::before { background: linear-gradient(90deg, #C0C0C0, #A0A0A0); }
        .podium-card.bronze::before { background: linear-gradient(90deg, #CD7F32, #B8722D); }

        .podium-medal { font-size: 28px; margin-bottom: 8px; }

        .podium-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-1);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .podium-faixa {
            font-size: 11px;
            color: var(--text-3);
            margin-bottom: 6px;
        }

        .podium-count {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
        }

        .podium-ct {
            font-size: 10px;
            color: var(--text-3);
            margin-top: 4px;
        }

        /* User position */
        .user-pos-card {
            display: none;
            background: linear-gradient(135deg, var(--bg-card), rgba(212,165,41,0.05));
            border: 1.5px solid var(--border-accent);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 20px;
        }

        .user-pos-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-pos-rank {
            font-family: 'Sora', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--accent);
        }

        .user-pos-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-1);
            margin-top: 2px;
        }

        .user-pos-meta {
            font-size: 12px;
            color: var(--text-2);
        }

        .user-pos-next-label {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: right;
        }

        .user-pos-diff {
            font-family: 'Sora', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--coral);
            text-align: right;
        }

        /* Ranking list */
        .rank-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rank-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .rank-item.me {
            background: linear-gradient(135deg, var(--bg-card), rgba(212,165,41,0.08));
            border-color: var(--border-accent);
        }

        .rank-item-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
            min-width: 0;
        }

        .rank-pos {
            font-family: 'Sora', sans-serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--accent);
            min-width: 36px;
            text-align: center;
        }

        .rank-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-1);
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rank-detail {
            font-size: 11px;
            color: var(--text-3);
        }

        .rank-num {
            font-family: 'Sora', sans-serif;
            font-size: 16px;
            font-weight: 800;
            color: var(--accent);
            flex-shrink: 0;
        }

        /* ===== EVOLUÇÃO TAB ===== */
        /* === GRADUATION TIMELINE === */
        .grad-section { margin-top: 12px; }
        .grad-section-title { font-size: 13px; font-weight: 700; color: var(--adm-primary-bright, var(--accent)); margin-bottom: 10px; }
        .grad-timeline { position: relative; padding-left: 20px; }
        .grad-timeline::before {
            content: ''; position: absolute; left: 7px; top: 4px; bottom: 4px;
            width: 2px; background: rgba(255,255,255,0.08);
        }
        .grad-event {
            position: relative; padding: 8px 12px; margin-bottom: 8px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px; font-size: 12px;
        }
        .grad-event::before {
            content: ''; position: absolute; left: -17px; top: 14px;
            width: 10px; height: 10px; border-radius: 50%;
            background: rgba(251,191,36,0.3); border: 2px solid rgba(251,191,36,0.6);
        }
        .grad-event.inicio::before { background: rgba(46,204,113,0.3); border-color: rgba(46,204,113,0.6); }
        .grad-event.faixa::before { background: rgba(139,92,246,0.3); border-color: rgba(139,92,246,0.6); }
        .grad-event .grad-date { font-size: 10px; color: var(--text-3, #999); margin-bottom: 2px; }
        .grad-event .grad-title { font-weight: 700; color: var(--text-1, #fff); }
        .grad-event .grad-obs { font-size: 10px; color: var(--text-3, #999); margin-top: 2px; font-style: italic; }
        .grad-event .grad-delete {
            position: absolute; top: 6px; right: 8px; font-size: 10px;
            color: rgba(231,76,60,0.5); cursor: pointer; padding: 2px 4px;
        }
        .grad-event .grad-delete:hover { color: #e74c3c; }
        .grad-event.pendente { opacity: 0.85; border-style: dashed; border-color: rgba(251,191,36,0.3); }
        .grad-empty { text-align: center; padding: 16px; color: var(--text-3, #999); font-size: 12px; }

        /* Admin add form */
        .grad-add-form {
            display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px;
            padding: 10px; background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.08);
            border-radius: 10px;
        }
        .grad-add-form select, .grad-add-form input {
            flex: 1; min-width: 80px; padding: 7px 8px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04);
            color: var(--text-1, #fff); font-size: 11px;
        }
        .grad-add-btn {
            padding: 7px 14px; border-radius: 6px; border: none;
            background: rgba(20,184,166,0.2); color: var(--adm-primary-bright, #5eead4);
            font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap;
        }
        .grad-add-btn:hover { background: rgba(20,184,166,0.3); }

        /* Student timeline (Evolução) */
        .evo-timeline { margin-top: 20px; }
        .evo-timeline-title {
            font-size: 14px; font-weight: 700; color: var(--accent);
            margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
        }
        .evo-tl-event {
            position: relative; padding: 12px 14px; margin-bottom: 10px;
            background: var(--card); border: 1px solid var(--border);
            border-radius: 12px; margin-left: 24px;
        }
        .evo-tl-event::before {
            content: ''; position: absolute; left: -20px; top: 16px;
            width: 12px; height: 12px; border-radius: 50%; border: 2px solid;
        }
        .evo-tl-event.inicio::before { border-color: #2ecc71; background: rgba(46,204,113,0.2); }
        .evo-tl-event.grau::before { border-color: #fbbf24; background: rgba(251,191,36,0.2); }
        .evo-tl-event.faixa::before { border-color: #8b5cf6; background: rgba(139,92,246,0.2); }
        .evo-tl-event .evo-tl-icon { font-size: 20px; float: right; }
        .evo-tl-event .evo-tl-title { font-weight: 700; font-size: 13px; color: var(--text-1); }
        .evo-tl-event .evo-tl-sub { font-size: 11px; color: var(--text-3); margin-top: 2px; }
        .evo-tl-event .evo-tl-date { font-size: 10px; color: var(--accent); margin-top: 4px; font-weight: 600; }
        .evo-tl-event .evo-tl-obs { font-size: 10px; color: var(--text-3); margin-top: 3px; font-style: italic; }
        .evo-tl-line {
            position: absolute; left: 4px; top: 0; bottom: 0; width: 2px;
            background: rgba(255,255,255,0.06); margin-left: 0;
        }
        .evo-tl-start { font-size: 11px; color: var(--text-3); text-align: center; padding: 10px; }

        /* Student inicio box */
        .evo-inicio-box {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 14px; margin-bottom: 14px;
        }
        .evo-inicio-label { font-size: 13px; font-weight: 600; color: var(--text-1); margin-bottom: 8px; }
        .evo-inicio-row { display: flex; gap: 8px; align-items: center; }
        .evo-inicio-input {
            flex: 1; padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.04); color: var(--text-1); font-size: 13px;
        }
        .evo-inicio-btn {
            padding: 8px 16px; border-radius: 8px; border: none;
            background: rgba(46,204,113,0.2); color: #2ecc71; font-weight: 700; font-size: 12px;
            cursor: pointer; white-space: nowrap;
        }
        .evo-inicio-btn:hover { background: rgba(46,204,113,0.3); }
        .evo-inicio-saved {
            font-size: 12px; color: #2ecc71; font-weight: 600; padding-top: 4px;
        }
        .evo-inicio-edit {
            color: var(--accent); cursor: pointer; margin-left: 8px; font-size: 11px;
            text-decoration: underline; font-weight: 400;
        }

        /* Apt notification */
        .evo-apt-msg {
            background: linear-gradient(135deg, rgba(251,191,36,0.08), rgba(251,191,36,0.02));
            border: 1px solid rgba(251,191,36,0.2); border-radius: 12px;
            padding: 14px; margin-bottom: 14px; text-align: center;
            animation: fadeIn 0.3s ease;
        }
        .evo-apt-icon { font-size: 28px; margin-bottom: 4px; }
        .evo-apt-text { font-size: 13px; font-weight: 700; color: var(--accent); }
        .evo-apt-sub { font-size: 11px; color: var(--text-3); margin-top: 4px; }

        /* Student declare prior history */
        .evo-declare-box {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            margin-bottom: 14px; overflow: hidden;
        }
        .evo-declare-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 14px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-2);
        }
        .evo-declare-header:active { background: rgba(255,255,255,0.03); }
        .evo-declare-toggle { font-size: 14px; color: var(--text-3); transition: transform 0.2s; }
        .evo-declare-toggle.open { transform: rotate(90deg); }
        .evo-declare-form { padding: 0 14px 14px; }
        .evo-declare-hint { font-size: 11px; color: var(--text-3); margin-bottom: 10px; }
        .evo-declare-row { display: flex; gap: 6px; margin-bottom: 6px; flex-wrap: wrap; }
        .evo-declare-row select, .evo-declare-row input {
            flex: 1; min-width: 70px; padding: 8px 8px; border-radius: 8px;
            border: 1px solid var(--border); background: rgba(255,255,255,0.04);
            color: var(--text-1); font-size: 12px;
        }
        .evo-declare-btn {
            padding: 8px 16px; border-radius: 8px; border: none;
            background: rgba(251,191,36,0.2); color: var(--accent); font-weight: 700; font-size: 12px;
            cursor: pointer; white-space: nowrap;
        }
        .evo-declare-btn:hover { background: rgba(251,191,36,0.3); }

        /* Status badges (timeline) */
        .grad-status {
            display: inline-block; font-size: 9px; padding: 2px 8px; border-radius: 4px;
            font-weight: 700; margin-left: 6px; vertical-align: middle;
        }
        .grad-status.aprovado { background: rgba(46,204,113,0.15); color: #2ecc71; }
        .grad-status.pendente { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .evo-tl-status {
            display: inline-block; font-size: 9px; padding: 2px 8px; border-radius: 4px;
            font-weight: 700; margin-top: 4px;
        }
        .evo-tl-status.aprovado { background: rgba(46,204,113,0.15); color: #2ecc71; }
        .evo-tl-status.pendente { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .evo-tl-event.pendente { opacity: 0.7; border-style: dashed; }

        /* Admin approve/reject buttons */
        .grad-actions { display: flex; gap: 6px; margin-top: 6px; }
        .grad-action-btn {
            padding: 5px 12px; border-radius: 6px; border: none;
            font-size: 10px; font-weight: 700; cursor: pointer;
        }
        .grad-action-btn.approve { background: rgba(46,204,113,0.2); color: #2ecc71; }
        .grad-action-btn.approve:hover { background: rgba(46,204,113,0.3); }
        .grad-action-btn.reject { background: rgba(231,76,60,0.15); color: #e74c3c; }
        .grad-action-btn.reject:hover { background: rgba(231,76,60,0.25); }

        /* === PRESENÇAS CALENDAR === */
        .prs-container { padding: 16px 0; }
        .prs-month-nav {
            display: flex; align-items: center; justify-content: center; gap: 16px;
            margin-bottom: 16px;
        }
        .prs-nav-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--border);
            background: var(--card); color: var(--accent); font-size: 20px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .prs-nav-btn:hover { background: rgba(212,175,55,0.1); }
        .prs-month-title { font-size: 16px; font-weight: 700; color: var(--accent); min-width: 160px; text-align: center; }
        
        .prs-summary {
            display: flex; gap: 8px; margin-bottom: 16px;
        }
        .prs-stat {
            flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 12px 8px; text-align: center;
        }
        .prs-stat-num { font-size: 22px; font-weight: 800; color: var(--accent); }
        .prs-stat-lbl { font-size: 10px; color: var(--text-3); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .prs-cal {
            background: var(--card); border: 1px solid var(--border); border-radius: 14px;
            padding: 12px; margin-bottom: 12px;
        }
        .prs-cal-header {
            display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 6px;
        }
        .prs-cal-hdr {
            text-align: center; font-size: 10px; font-weight: 700; color: var(--text-3);
            text-transform: uppercase; padding: 4px 0;
        }
        .prs-cal-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;
        }
        .prs-day {
            aspect-ratio: 1; border-radius: 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.15s; position: relative; color: var(--text-2);
        }
        .prs-day.empty { cursor: default; }
        .prs-day.today { outline: 2px solid var(--accent); outline-offset: -2px; }
        .prs-day.present { background: rgba(46,204,113,0.15); color: #2ecc71; }
        .prs-day.present::after {
            content: ''; position: absolute; bottom: 4px; width: 6px; height: 6px;
            border-radius: 50%; background: #2ecc71;
        }
        .prs-day.missed { background: rgba(231,76,60,0.1); color: rgba(231,76,60,0.7); }
        .prs-day.missed::after {
            content: '✕'; position: absolute; bottom: 2px; font-size: 8px; color: rgba(231,76,60,0.5);
        }
        .prs-day.expected { background: rgba(251,191,36,0.08); }
        .prs-day.expected::after {
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px;
            border-radius: 50%; background: rgba(251,191,36,0.3);
        }
        .prs-day.multi::after { width: 10px; border-radius: 3px; height: 4px; }
        .prs-day.selected { outline: 2px solid var(--accent); outline-offset: -2px; }
        .prs-day:hover:not(.empty) { background: rgba(255,255,255,0.05); }
        .prs-day .prs-ct-dot {
            position: absolute; top: 3px; right: 3px; width: 5px; height: 5px;
            border-radius: 50%;
        }
        
        .prs-legend {
            display: flex; gap: 14px; justify-content: center; margin-bottom: 14px;
        }
        .prs-legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-3); }
        .prs-dot { width: 8px; height: 8px; border-radius: 50%; }
        .prs-dot.present { background: #2ecc71; }
        .prs-dot.expected { background: rgba(251,191,36,0.4); }
        .prs-dot.missed { background: rgba(231,76,60,0.5); }
        
        .prs-detail {
            background: var(--card); border: 1px solid var(--border); border-radius: 12px;
            padding: 14px; margin-bottom: 12px; animation: fadeIn 0.2s ease;
        }
        .prs-detail-header {
            font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 8px;
        }
        .prs-detail-list {}
        .prs-detail-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 0;
            border-bottom: 1px solid var(--border); font-size: 12px;
        }
        .prs-detail-item:last-child { border-bottom: none; }
        .prs-detail-time { font-weight: 700; color: var(--text-1); min-width: 44px; }
        .prs-detail-ct { color: var(--accent); font-weight: 600; }
        .prs-detail-badge {
            font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700;
            background: rgba(46,204,113,0.15); color: #2ecc71;
        }
        
        .prs-list { }
        .prs-list-title {
            font-size: 12px; font-weight: 700; color: var(--text-3); margin-bottom: 8px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .prs-list-item {
            display: flex; align-items: center; padding: 10px 12px;
            background: var(--card); border: 1px solid var(--border); border-radius: 10px;
            margin-bottom: 6px;
        }
        .prs-list-date { font-weight: 700; color: var(--text-1); min-width: 36px; font-size: 13px; }
        .prs-list-day { font-size: 10px; color: var(--text-3); min-width: 32px; }
        .prs-list-ct { flex: 1; font-size: 12px; color: var(--accent); font-weight: 600; }
        .prs-list-time { font-size: 11px; color: var(--text-3); }

        .evo-container {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        /* Motivation banner */
        .evo-motivation {
            background: linear-gradient(135deg, rgba(212,165,41,0.08), rgba(184,134,11,0.08));
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-lg);
            padding: 18px 20px;
            text-align: center;
        }

        .evo-motivation-icon { font-size: 28px; margin-bottom: 6px; }

        .evo-motivation-text {
            font-family: 'Sora', sans-serif;
            font-size: 14px;
            font-weight: 600;
            font-style: italic;
            color: var(--text-1);
            margin-bottom: 4px;
        }

        .evo-motivation-sub {
            font-size: 12px;
            color: var(--text-2);
        }

        /* Hero card */
        .evo-hero {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 24px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
        }

        .evo-hero-belt {
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            flex-shrink: 0;
        }

        .evo-hero-belt.branca { background: linear-gradient(135deg, #f0f0f0, #d0d0d0); }
        .evo-hero-belt.azul { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .evo-hero-belt.roxa { background: linear-gradient(135deg, #9C27B0, #6A1B9A); }
        .evo-hero-belt.marrom { background: linear-gradient(135deg, #8D6E63, #5D4037); }
        .evo-hero-belt.preta { background: linear-gradient(135deg, #424242, #1a1a1a); }

        .evo-hero-info { flex: 1; min-width: 140px; }

        .evo-hero-title {
            font-family: 'Sora', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-1);
        }

        .evo-hero-sub {
            font-size: 12px;
            color: var(--text-2);
            margin-top: 2px;
        }

        .evo-hero-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 6px;
        }

        .evo-hero-status.red { background: rgba(255,107,107,0.15); color: var(--coral); }
        .evo-hero-status.yellow { background: rgba(255,179,71,0.15); color: var(--amber); }
        .evo-hero-status.green { background: rgba(212,165,41,0.15); color: var(--accent); }

        .evo-hero-stats {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .evo-hero-stat {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .evo-hero-stat-val {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--accent);
        }

        .evo-hero-stat-lbl {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Seals */
        .evo-seals {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .evo-seals-title {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .evo-seals-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .evo-seal { text-align: center; }

        .evo-seal-circle {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 6px;
            transition: all 0.5s ease;
        }

        .evo-seal-circle.locked {
            background: var(--bg-elevated);
            border: 2px dashed var(--text-3);
            opacity: 0.5;
        }

        .evo-seal-circle.current-target {
            background: var(--accent-dim);
            border: 2px solid var(--accent);
            animation: pulse-seal 2s ease-in-out infinite;
        }

        @keyframes pulse-seal {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,165,41,0.2); }
            50% { box-shadow: 0 0 0 8px rgba(212,165,41,0); }
        }

        .evo-seal-circle.unlocked {
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            border: none;
            box-shadow: 0 4px 15px rgba(212,165,41,0.3);
        }

        .evo-seal-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-3);
        }

        .evo-seal-label.unlocked { color: var(--accent); }
        .evo-seal-label.current-target { color: var(--accent); }

        .evo-seal-progress {
            font-size: 10px;
            color: var(--text-3);
            margin-top: 2px;
        }

        /* Frequency bar */
        .evo-freq {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px 20px;
        }

        .evo-freq-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .evo-freq-left {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-2);
        }

        .evo-freq-pct {
            font-family: 'Sora', sans-serif;
            font-size: 18px;
            font-weight: 800;
        }

        .evo-freq-pct.red { color: var(--coral); }
        .evo-freq-pct.yellow { color: var(--amber); }
        .evo-freq-pct.green { color: var(--accent); }

        .evo-freq-bar-bg {
            width: 100%;
            height: 8px;
            background: var(--bg-elevated);
            border-radius: 4px;
            overflow: hidden;
        }

        .evo-freq-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .evo-freq-bar-fill.red { background: linear-gradient(90deg, var(--coral), #FF8A80); }
        .evo-freq-bar-fill.yellow { background: linear-gradient(90deg, var(--amber), #FFD54F); }
        .evo-freq-bar-fill.green { background: linear-gradient(90deg, var(--accent), var(--gold-light)); }

        .evo-freq-sub {
            font-size: 11px;
            color: var(--text-3);
            margin-top: 8px;
            text-align: center;
        }

        /* Criteria */
        .evo-criteria-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .evo-criteria-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .evo-criteria-header-icon { font-size: 20px; }

        .evo-criteria-header-text {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-1);
            flex: 1;
        }

        .evo-criteria-header-sub {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent);
        }

        .evo-criteria-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .evo-criteria-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
        }

        .evo-criteria-check {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .evo-criteria-check.pass { background: rgba(212,165,41,0.15); color: var(--accent); }
        .evo-criteria-check.fail { background: rgba(255,107,107,0.15); color: var(--coral); }
        .evo-criteria-check.pending { background: rgba(255,179,71,0.15); color: var(--amber); }

        .evo-criteria-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-1);
        }

        .evo-criteria-detail {
            font-size: 11px;
            color: var(--text-3);
        }

        /* Exam button */
        .evo-exam-btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 14px;
            text-align: center;
            letter-spacing: 0.5px;
            font-family: inherit;
        }

        .evo-exam-btn.disabled {
            background: var(--bg-elevated);
            color: var(--text-3);
            cursor: not-allowed;
        }

        .evo-exam-btn.active {
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            color: var(--bg-deep);
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(212,165,41,0.3);
        }

        /* ===== IBJJF ROADMAP ===== */
        .ibjjf-roadmap {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px 16px;
        }

        .ibjjf-title {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .ibjjf-subtitle {
            font-size: 11px;
            color: var(--text-3);
            margin-bottom: 16px;
        }

        /* Legend row */
        .ibjjf-legend {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-flex-wrap: wrap;
            flex-wrap: wrap;
            margin-bottom: 16px;
            gap: 0;
        }

        .ibjjf-legend-item {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            font-size: 10px;
            color: var(--text-3);
            margin-right: 14px;
            margin-bottom: 4px;
        }

        .ibjjf-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
        }

        .ibjjf-legend-dot.past { background: var(--accent); opacity: 0.6; }
        .ibjjf-legend-dot.current { background: var(--accent); box-shadow: 0 0 6px rgba(212,165,41,0.5); }
        .ibjjf-legend-dot.next { border: 2px solid var(--accent); background: transparent; }
        .ibjjf-legend-dot.future { border: 1.5px dashed var(--text-3); background: transparent; opacity: 0.5; }

        /* Vertical track */
        .ibjjf-track {
            position: relative;
            padding-left: 32px;
        }

        .ibjjf-track::before {
            content: '';
            position: absolute;
            left: 11px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--bg-elevated);
            border-radius: 2px;
        }

        .ibjjf-track-fill {
            position: absolute;
            left: 11px;
            top: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--accent), var(--gold-light));
            border-radius: 2px;
            -webkit-transition: height 1s ease;
            transition: height 1s ease;
        }

        /* Belt node */
        .ibjjf-node {
            position: relative;
            margin-bottom: 4px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            -webkit-transition: all 0.3s ease;
            transition: all 0.3s ease;
        }

        .ibjjf-node:last-child { margin-bottom: 0; }

        /* Dot on left */
        .ibjjf-node::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 50%;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--text-3);
            z-index: 2;
        }

        /* States */
        .ibjjf-node.completed::before {
            background: var(--accent);
            border-color: var(--accent);
            opacity: 0.7;
        }

        .ibjjf-node.completed {
            opacity: 0.55;
        }

        .ibjjf-node.current {
            background: rgba(212,165,41,0.08);
            border: 1.5px solid var(--border-accent);
        }

        .ibjjf-node.current::before {
            background: var(--accent);
            border-color: var(--gold-light);
            width: 15px;
            height: 15px;
            left: -28px;
            box-shadow: 0 0 12px rgba(212,165,41,0.5);
        }

        .ibjjf-node.next {
            background: rgba(212,165,41,0.04);
            border: 1px dashed var(--border-accent);
        }

        .ibjjf-node.next::before {
            border-color: var(--accent);
            border-style: dashed;
            background: transparent;
        }

        .ibjjf-node.future {
            opacity: 0.35;
        }

        .ibjjf-node.future::before {
            border-style: dashed;
            opacity: 0.5;
        }

        /* Node inner layout */
        .ibjjf-node-inner {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
        }

        /* Belt color band */
        .ibjjf-belt-band {
            width: 36px;
            height: 10px;
            border-radius: 3px;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
            margin-right: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Belt stripe indicator */
        .ibjjf-belt-band .stripe {
            position: absolute;
            right: 2px;
            top: 0;
            height: 100%;
            width: 6px;
            background: #111;
        }

        .ibjjf-belt-band .stripe-inner {
            position: absolute;
            top: 1px;
            bottom: 1px;
            width: 2px;
        }

        /* Belt colors */
        .ibjjf-belt-band.branca { background: linear-gradient(90deg, #e8e8e8, #f5f5f5); }
        .ibjjf-belt-band.azul { background: linear-gradient(90deg, #1565C0, #2196F3); }
        .ibjjf-belt-band.roxa { background: linear-gradient(90deg, #6A1B9A, #9C27B0); }
        .ibjjf-belt-band.marrom { background: linear-gradient(90deg, #5D4037, #8D6E63); }
        .ibjjf-belt-band.preta { background: linear-gradient(90deg, #1a1a1a, #424242); }

        /* Belt info */
        .ibjjf-belt-info {
            -webkit-box-flex: 1;
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .ibjjf-belt-name {
            font-family: 'Sora', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-1);
            line-height: 1.2;
        }

        .ibjjf-node.completed .ibjjf-belt-name { color: var(--text-2); }
        .ibjjf-node.current .ibjjf-belt-name { color: var(--accent); }
        .ibjjf-node.future .ibjjf-belt-name { color: var(--text-3); }

        .ibjjf-belt-meta {
            font-size: 10px;
            color: var(--text-3);
            margin-top: 1px;
        }

        .ibjjf-node.current .ibjjf-belt-meta { color: var(--text-2); }

        /* Right side badges */
        .ibjjf-belt-badges {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            -webkit-flex-shrink: 0;
            flex-shrink: 0;
            margin-left: 8px;
        }

        /* Grau dots */
        .ibjjf-grau-dots {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
        }

        .ibjjf-grau-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-left: 3px;
            background: var(--bg-elevated);
            border: 1px solid var(--text-3);
        }

        .ibjjf-grau-dot.filled {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Status tag on right */
        .ibjjf-status-tag {
            font-family: 'Sora', sans-serif;
            font-size: 9px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 50px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .ibjjf-status-tag.here {
            background: rgba(212,165,41,0.15);
            color: var(--accent);
            border: 1px solid var(--border-accent);
        }

        .ibjjf-status-tag.goal {
            background: transparent;
            color: var(--text-2);
            border: 1px dashed var(--border-accent);
        }

        .ibjjf-status-tag.done {
            color: var(--text-3);
            font-size: 12px;
        }

        /* Progress summary below roadmap */
        .ibjjf-summary {
            margin-top: 16px;
            padding: 14px;
            background: var(--bg-elevated);
            border-radius: var(--radius-sm);
        }

        .ibjjf-summary-row {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-pack: justify;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-box-align: center;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 8px;
        }

        .ibjjf-summary-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-2);
        }

        .ibjjf-summary-val {
            font-family: 'Sora', sans-serif;
            font-size: 14px;
            font-weight: 800;
            color: var(--accent);
        }

        .ibjjf-summary-bar-bg {
            height: 6px;
            background: var(--bg-deep);
            border-radius: 3px;
            overflow: hidden;
        }

        .ibjjf-summary-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--gold-light));
            border-radius: 3px;
            -webkit-transition: width 1s ease;
            transition: width 1s ease;
        }

        /* ===== ADMIN SECTION ===== */
        .admin-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            margin-top: 20px;
        }

        .admin-form {
            display: flex;
            gap: 8px;
        }

        .admin-form input {
            flex: 1;
            padding: 10px 14px;
            font-size: 13px;
        }

        .admin-form button {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            color: var(--bg-deep);
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            font-family: inherit;
        }

        .cts-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .ct-item {
            padding: 8px 14px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: var(--text-2);
        }

        .ct-item button {
            background: rgba(255,107,107,0.15);
            color: var(--coral);
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 700;
        }

        /* ===== PERFIL TAB ===== */
        .perfil-container { max-width: 480px; margin: 0 auto; }

        .perfil-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .perfil-avatar-big {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
            -webkit-justify-content: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            color: var(--bg-deep);
            margin: 0 auto 12px;
            font-family: 'Sora', sans-serif;
        }

        .perfil-nome {
            font-family: 'Sora', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: var(--text-1);
        }

        .perfil-faixa-tag {
            display: inline-block;
            font-size: 11px;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: var(--accent-dim);
            color: var(--accent);
            margin-top: 6px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .perfil-completeness {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .perfil-completeness-row {
            display: -webkit-flex;
            display: flex;
            -webkit-justify-content: space-between;
            justify-content: space-between;
            -webkit-align-items: center;
            align-items: center;
            margin-bottom: 6px;
        }

        .perfil-completeness-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-2);
        }

        .perfil-completeness-pct {
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 800;
            color: var(--accent);
        }

        .perfil-completeness-bar {
            height: 5px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
        }

        .perfil-completeness-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--gold-light));
            border-radius: 3px;
            -webkit-transition: width 0.6s ease;
            transition: width 0.6s ease;
        }

        .perfil-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px;
            margin-bottom: 16px;
        }

        .perfil-section-title {
            font-family: 'Sora', sans-serif;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            display: -webkit-flex;
            display: flex;
            -webkit-align-items: center;
            align-items: center;
        }

        .perfil-section-title span { margin-right: 8px; }

        .perfil-field {
            margin-bottom: 14px;
        }

        .perfil-field:last-child { margin-bottom: 0; }

        .perfil-field label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .perfil-field input,
        .perfil-field select,
        .perfil-field textarea {
            width: 100%;
            padding: 12px 14px;
            font-size: 15px;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-1);
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }

        .perfil-field textarea {
            resize: vertical;
            min-height: 70px;
        }

        .perfil-field input:focus,
        .perfil-field select:focus,
        .perfil-field textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(212,165,41,0.05);
            box-shadow: 0 0 0 3px rgba(212,165,41,0.1);
        }

        .perfil-row {
            display: -webkit-flex;
            display: flex;
            gap: 12px;
        }

        .perfil-row > .perfil-field {
            -webkit-flex: 1;
            flex: 1;
            min-width: 0;
        }

        .perfil-save-btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--accent), var(--gold-light));
            color: var(--bg-deep);
            font-family: 'Sora', sans-serif;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(212,165,41,0.3);
        }

        .perfil-save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .perfil-divider {
            height: 1px;
            background: var(--border);
            margin: 14px 0;
        }

        .perfil-pwd-row {
            display: -webkit-flex;
            display: flex;
            gap: 12px;
        }

        .perfil-pwd-row > .perfil-field { -webkit-flex: 1; flex: 1; min-width: 0; }

        .perfil-logout-btn {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--coral);
            border: 2px solid rgba(232,93,93,0.3);
            font-family: inherit;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            margin-top: 8px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 380px) {
            .main { padding: 14px 12px; padding-bottom: 76px; }
            .evo-seals-row { gap: 4px; }
            .evo-seal-circle { width: 38px; height: 38px; font-size: 16px; border-radius: 12px; }
            .evo-seal-label { font-size: 9px; }
            .evo-seal-progress { font-size: 8px; }
            .evo-seal-label { font-size: 9px; }
            .evo-seal-progress { font-size: 8px; }
            .podium { gap: 6px; }
        }

        @media (min-width: 769px) {
            .main { padding: 24px; padding-bottom: 80px; max-width: 560px; margin: 0 auto; }
        }

        /* ===== BROAD COMPATIBILITY ===== */
        /* Prefix transitions for older WebKit/Samsung/UC browsers */
        button, input, select, .card, .bnav-btn, .rank-ct-chip, .ct-btn, .evo-seal-circle {
            -webkit-transition: all 0.2s ease;
            -o-transition: all 0.2s ease;
            transition: all 0.2s ease;
        }

        /* Prefix transforms */
        .bnav-btn.active .bnav-icon {
            -webkit-transform: scale(1.15);
            -ms-transform: scale(1.15);
            transform: scale(1.15);
        }

        button:active {
            -webkit-transform: scale(0.97);
            -ms-transform: scale(0.97);
            transform: scale(0.97);
        }

        /* Prefix animations */
        @-webkit-keyframes fadeUp {
            from { opacity: 0; -webkit-transform: translateY(20px); transform: translateY(20px); }
            to { opacity: 1; -webkit-transform: translateY(0); transform: translateY(0); }
        }

        @-webkit-keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @-webkit-keyframes pulse-seal {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,165,41,0.2); }
            50% { box-shadow: 0 0 0 8px rgba(212,165,41,0); }
        }

        /* Prefix gradient text for older Chrome/Samsung */
        .hdr-title, .login-title {
            -webkit-background-clip: text !important;
            background-clip: text;
        }

        /* Ensure touch targets min 44px */
        button, a, input, select, .bnav-btn, .rank-ct-chip, .ct-btn {
            min-height: 44px;
        }

        /* Fix 300ms tap delay on old Android */
        a, button, input, select {
            touch-action: manipulation;
        }

        /* Samsung Internet input fix */
        input, select, textarea {
            -webkit-border-radius: 14px;
            border-radius: 14px;
        }

        /* Prevent zoom on input focus (iOS) */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select, textarea, input[type="text"], input[type="password"], input[type="email"] {
                font-size: 16px;
            }
        }

        /* Notch safe areas for all devices */
        @supports (padding-left: env(safe-area-inset-left)) {
            .hdr { padding-left: max(20px, env(safe-area-inset-left)); padding-right: max(20px, env(safe-area-inset-right)); }
            .main { padding-left: max(16px, env(safe-area-inset-left)); padding-right: max(16px, env(safe-area-inset-right)); }
        }

        /* ===== ADMIN PANEL - TEMA INDIGO (DIFERENTE DO ALUNO) ===== */
        /* Admin color palette */
        :root {
            --adm-primary: #818CF8;
            --adm-primary-bright: #A5B4FC;
            --adm-primary-dim: rgba(129,140,248,0.10);
            --adm-primary-glow: rgba(129,140,248,0.25);
            --adm-bg: #080a1a;
            --adm-bg-card: #0f1228;
            --adm-bg-elevated: #161938;
            --adm-border: rgba(129,140,248,0.12);
            --adm-border-accent: rgba(129,140,248,0.25);
            --adm-text-1: #E8E9F3;
            --adm-text-2: #9698B8;
            --adm-text-3: #5C5E80;
            --adm-green: #34D399;
            --adm-green-dim: rgba(52,211,153,0.12);
            --adm-red: #F87171;
            --adm-red-dim: rgba(248,113,113,0.12);
            --adm-amber: #FBBF24;
            --adm-amber-dim: rgba(251,191,36,0.12);
        }

        /* Admin screen wrapper - distinct background */
        #adminScreen {
            background: var(--adm-bg);
            min-height: calc(100vh - 120px);
            padding-bottom: 100px;
        }

        /* Admin page title bar */
        .adm-page-title {
            padding: 20px 0 4px;
            text-align: center;
        }
        .adm-page-title h2 {
            font-family: 'Sora', sans-serif;
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--adm-primary-bright), var(--adm-primary), #C4B5FD);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .adm-page-title p {
            font-size: 11px;
            color: var(--adm-text-3);
            margin: 4px 0 0;
            letter-spacing: 0.5px;
        }

        .admin-container { max-width: 560px; margin: 0 auto; padding: 0 4px; }

        /* Admin welcome banner */
        .admin-welcome {
            display: flex; align-items: center; gap: 14px;
            padding: 18px 16px;
            background: linear-gradient(135deg, var(--adm-primary-dim), rgba(99,102,241,0.04));
            border-radius: 16px;
            margin-bottom: 18px;
            border: 1px solid var(--adm-border-accent);
            position: relative;
            overflow: hidden;
        }
        .admin-welcome::after {
            content: '';
            position: absolute; top: -30px; right: -30px;
            width: 100px; height: 100px;
            background: radial-gradient(circle, var(--adm-primary-glow), transparent 70%);
            pointer-events: none;
        }
        .admin-welcome-icon { font-size: 36px; z-index: 1; }
        .admin-welcome-text { z-index: 1; }
        .admin-welcome-title { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 700; color: var(--adm-text-1); }
        .admin-welcome-sub { font-size: 11px; color: var(--adm-primary); font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

        /* Admin sections */
        .admin-section {
            background: var(--adm-bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
            border: 1px solid var(--adm-border);
        }
        .admin-section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .admin-section-title {
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700;
            color: var(--adm-primary-bright);
            display: flex; align-items: center; gap: 8px;
        }

        /* Admin badges */
        .admin-badge { background: var(--adm-red); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; min-width: 20px; text-align: center; }
        .admin-badge.green { background: var(--adm-green); color: #0a0a0a; }
        .admin-badge.blue { background: var(--adm-primary); color: #0a0a0a; }

        /* ══════ REPORT FILTERS ══════ */
        .rpt-filters {
            display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: flex-end;
        }
        .rpt-date-range { display: flex; gap: 6px; flex: 1; min-width: 200px; }
        .rpt-date-field { display: flex; flex-direction: column; flex: 1; }
        .rpt-date-field label { font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--adm-text-3); font-weight: 600; margin-bottom: 3px; }
        .rpt-date-field input[type="date"], .rpt-date-field select {
            padding: 10px 12px; border-radius: 10px; border: 1px solid var(--adm-border);
            background: var(--adm-bg-card); color: var(--adm-text-1); font-size: 13px;
            font-family: 'Inter', sans-serif; cursor: pointer;
        }
        .rpt-date-field input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.7); cursor: pointer; font-size: 16px; padding: 2px;
        }
        .rpt-date-field input[type="date"]:focus {
            border-color: var(--adm-primary); outline: none;
            box-shadow: 0 0 0 2px rgba(20,184,166,0.2);
        }
        .rpt-generate-btn {
            padding: 10px 20px; border-radius: 10px; border: none;
            background: linear-gradient(135deg, var(--adm-primary), var(--adm-primary-bright));
            color: #000; font-weight: 700; font-size: 13px; cursor: pointer; white-space: nowrap;
            align-self: flex-end; min-height: 42px;
        }
        .rpt-generate-btn:active { transform: scale(0.97); }
        .rpt-quick-bar { display: flex; gap: 4px; margin-bottom: 14px; }
        .rpt-quick-btn {
            flex: 1; padding: 7px 6px; border-radius: 8px; border: 1px solid var(--adm-border);
            background: var(--adm-bg-card); color: var(--adm-text-3); font-size: 11px; font-weight: 600;
            cursor: pointer; text-align: center; transition: all 0.2s;
        }
        .rpt-quick-btn.active {
            background: var(--adm-primary-dim); border-color: var(--adm-primary);
            color: var(--adm-primary-bright);
        }

        /* ══════ REPORT HOURLY CARDS ══════ */
        .rpt-hourly-slot {
            background: var(--adm-bg-card); border: 1px solid var(--adm-border);
            border-radius: 10px; margin-bottom: 8px; overflow: hidden;
        }
        .rpt-hourly-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; cursor: pointer;
        }
        .rpt-hourly-header:active { background: rgba(255,255,255,0.02); }
        .rpt-hourly-time { font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 700; color: var(--adm-text-1); }
        .rpt-hourly-badges { display: flex; gap: 8px; }
        .rpt-hourly-badge { font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 8px; }
        .rpt-hourly-badge.green { background: rgba(46,204,113,0.15); color: #4ade80; }
        .rpt-hourly-badge.red { background: rgba(232,93,93,0.15); color: #f87171; }
        .rpt-hourly-detail { padding: 0 14px 12px; border-top: 1px solid var(--adm-border); }
        .rpt-hourly-group-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--adm-text-3); margin: 8px 0 4px; }
        .rpt-hourly-name { font-size: 11px; color: var(--adm-text-2); padding: 2px 0; }
        .rpt-hourly-columns { display: flex; gap: 16px; }
        .rpt-hourly-col { flex: 1; min-width: 0; }

        /* ══════ REPORT ALERT CARD ══════ */
        .rpt-alert-row {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 14px; border-bottom: 1px solid var(--adm-border);
            background: rgba(231,76,60,0.04);
        }
        .rpt-alert-row:last-child { border-bottom: none; }
        .rpt-alert-icon { font-size: 18px; }
        .rpt-alert-info { flex: 1; }
        .rpt-alert-name { font-weight: 700; color: var(--adm-text-1); font-size: 13px; }
        .rpt-alert-meta { font-size: 11px; color: var(--adm-text-3); }
        .rpt-alert-badge { font-size: 11px; font-weight: 800; color: #f87171; background: rgba(231,76,60,0.15); padding: 4px 10px; border-radius: 8px; }

        /* Keep existing styles */
        .rpt-panel { animation: fadeIn 0.3s ease; }
        .rpt-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 14px; padding: 12px 16px; border-radius: 12px;
            background: var(--adm-bg-card); border: 1px solid var(--adm-border);
        }
        .rpt-header-title { font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 700; color: var(--adm-text-1); }
        .rpt-header-date { font-size: 12px; color: var(--adm-primary); font-weight: 600; }
        .rpt-chart-area { min-height: 30px; }
        .rpt-bar-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .rpt-bar-label { min-width: 48px; font-size: 11px; color: var(--adm-text-2); text-align: right; font-weight: 600; }
        .rpt-bar-track { flex: 1; height: 22px; background: rgba(255,255,255,0.04); border-radius: 6px; overflow: hidden; }
        .rpt-bar-fill {
            height: 100%; border-radius: 6px; display: flex; align-items: center; padding: 0 8px;
            min-width: 24px; transition: width 0.5s ease;
            background: linear-gradient(90deg, var(--adm-primary-dim), var(--adm-primary));
        }
        .rpt-bar-fill.alt { background: linear-gradient(90deg, rgba(251,191,36,0.25), rgba(251,191,36,0.5)); }
        .rpt-bar-fill.belt { opacity: 0.85; }
        .rpt-bar-val { font-size: 10px; font-weight: 700; color: #fff; }
        .rpt-mini-list { max-height: 260px; overflow-y: auto; }
        .rpt-mini-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 12px; border-bottom: 1px solid var(--adm-border); font-size: 12px;
        }
        .rpt-mini-item:last-child { border-bottom: none; }
        .rpt-mini-name { color: var(--adm-text-1); font-weight: 600; }
        .rpt-mini-meta { color: var(--adm-text-3); font-size: 11px; margin-top: 1px; }
        .rpt-mini-tag {
            font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 10px; white-space: nowrap;
        }
        .rpt-mini-tag.green { background: rgba(45,200,90,0.15); color: #4ade80; }
        .rpt-mini-tag.yellow { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .rpt-mini-tag.red { background: rgba(232,93,93,0.15); color: #f87171; }
        .rpt-mini-tag.blue { background: rgba(20,184,166,0.15); color: var(--adm-primary-bright); }

        /* ══════ SYSTEM HEALTH ══════ */
        .sys-health-score {
            display: flex; align-items: center; gap: 16px; padding: 16px;
            background: var(--adm-bg-card); border: 1px solid var(--adm-border); border-radius: 14px; margin-bottom: 12px;
        }
        .sys-health-circle {
            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-family: 'Sora', sans-serif; font-size: 22px; font-weight: 900; flex-shrink: 0;
            border: 3px solid var(--adm-green); color: var(--adm-green); background: rgba(45,200,90,0.05);
        }
        .sys-health-circle.warn { border-color: var(--adm-amber); color: var(--adm-amber); background: rgba(251,191,36,0.05); }
        .sys-health-circle.bad { border-color: var(--adm-red); color: var(--adm-red); background: rgba(232,93,93,0.05); }
        .sys-health-info { flex: 1; }
        .sys-health-label { font-size: 14px; color: var(--adm-text-1); font-weight: 600; }
        .sys-health-time { font-size: 10px; color: var(--adm-text-3); margin-top: 2px; }
        .sys-issue {
            display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px;
            border-radius: 10px; margin-bottom: 6px; font-size: 12px; line-height: 1.4;
        }
        .sys-issue.error { background: rgba(232,93,93,0.08); border: 1px solid rgba(232,93,93,0.15); color: #f87171; }
        .sys-issue.warning { background: rgba(251,191,36,0.08); border: 1px solid rgba(251,191,36,0.15); color: #fbbf24; }
        .sys-issue.info { background: rgba(20,184,166,0.08); border: 1px solid rgba(20,184,166,0.15); color: var(--adm-primary-bright); }
        .sys-issue-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }
        .sys-issue-area { font-weight: 700; }

        .admin-empty { text-align: center; color: var(--adm-text-3); padding: 24px 0; font-size: 13px; }

        /* Admin stats grid */
        .admin-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 18px; }
        .admin-stat {
            background: var(--adm-bg-card);
            border-radius: 12px;
            padding: 12px 6px;
            text-align: center;
            border: 1px solid var(--adm-border);
            position: relative;
            overflow: hidden;
        }
        .admin-stat::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--adm-primary), transparent);
        }
        .admin-stat-num { font-family: 'Sora', sans-serif; font-size: 26px; font-weight: 800; color: var(--adm-primary-bright); }
        .admin-stat-label { font-size: 10px; color: var(--adm-text-3); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .admin-stat.warn .admin-stat-num { color: var(--adm-amber); }
        .admin-stat.warn::before { background: linear-gradient(90deg, transparent, var(--adm-amber), transparent); }
        .admin-stat.ok .admin-stat-num { color: var(--adm-green); }
        .admin-stat.ok::before { background: linear-gradient(90deg, transparent, var(--adm-green), transparent); }

        /* Admin cards */
        .admin-card {
            background: var(--adm-bg-elevated);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--adm-border);
            transition: border-color 0.2s;
        }
        .admin-card:last-child { margin-bottom: 0; }
        .admin-card:hover { border-color: var(--adm-border-accent); }
        .admin-card-top { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .admin-card-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            background: var(--adm-primary-dim); color: var(--adm-primary-bright);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; flex-shrink: 0;
            border: 1px solid var(--adm-border-accent);
        }
        .admin-card-info { flex: 1; min-width: 0; }
        .admin-card-name { font-weight: 600; color: var(--adm-text-1); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-card-meta { font-size: 12px; color: var(--adm-text-2); margin-top: 2px; }
        .admin-card-detail { font-size: 12px; color: var(--adm-text-3); margin-bottom: 8px; padding-left: 46px; }
        .admin-card-actions { display: flex; gap: 8px; padding-left: 46px; }

        /* Admin buttons */
        .admin-btn { padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; min-height: 36px; }
        .admin-btn.approve { background: var(--adm-green); color: #0a0a0a; }
        .admin-btn.approve:hover { background: #5EEAD4; }
        .admin-btn.reject { background: transparent; color: var(--adm-red); border: 1px solid var(--adm-red-dim); }
        .admin-btn.reject:hover { background: var(--adm-red-dim); }
        .admin-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .admin-refresh-btn {
            background: transparent; color: var(--adm-primary);
            border: 1px solid var(--adm-border-accent);
            padding: 6px 12px; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer; min-height: 32px;
        }
        .admin-refresh-btn:hover { background: var(--adm-primary-dim); }

        /* Admin bulk approve */
        .admin-bulk-btn {
            width: 100%; padding: 12px; border-radius: 10px; border: none;
            background: linear-gradient(135deg, var(--adm-primary), #6366F1);
            color: #fff; font-weight: 700; font-size: 14px; cursor: pointer;
            margin-top: 12px; min-height: 44px;
            box-shadow: 0 4px 16px var(--adm-primary-glow);
        }
        .admin-bulk-btn:hover { opacity: 0.9; }
        .admin-bulk-btn:disabled { opacity: 0.4; cursor: not-allowed; box-shadow: none; }

        /* Admin filter row */
        .admin-filter-row { display: flex; gap: 8px; margin-bottom: 12px; }
        .admin-filter-btn {
            flex: 1; padding: 8px; border-radius: 8px;
            background: var(--adm-bg-elevated); color: var(--adm-text-3);
            border: 1px solid var(--adm-border); font-size: 12px; font-weight: 600;
            cursor: pointer; text-align: center; min-height: 36px;
            transition: all 0.2s;
        }
        .admin-filter-btn.active { background: var(--adm-primary-dim); color: var(--adm-primary-bright); border-color: var(--adm-border-accent); }

        /* Status badges */
        .admin-checkin-status { display: inline-block; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .admin-checkin-status.pendente { background: var(--adm-amber-dim); color: var(--adm-amber); }
        .admin-checkin-status.aprovado { background: var(--adm-green-dim); color: var(--adm-green); }
        .admin-checkin-status.rejeitado { background: var(--adm-red-dim); color: var(--adm-red); }
        .admin-checkin-time { font-size: 11px; color: var(--adm-text-3); background: var(--adm-primary-dim); padding: 2px 8px; border-radius: 4px; display: inline-block; }

        /* Admin student list */
        .admin-student-card {
            background: var(--adm-bg-elevated); border-radius: 10px;
            padding: 12px; margin-bottom: 8px; border: 1px solid var(--adm-border);
            display: flex; align-items: center; gap: 10px;
        }
        .admin-student-card .admin-card-avatar { width: 32px; height: 32px; font-size: 13px; }
        .admin-student-info { flex: 1; min-width: 0; }
        .admin-student-name { font-weight: 600; color: var(--adm-text-1); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .admin-student-meta { font-size: 11px; color: var(--adm-text-3); }
        .admin-student-belt { font-size: 11px; font-weight: 600; color: var(--adm-text-2); }
        .admin-student-delete { background: transparent; border: 1px solid var(--adm-red-dim); color: var(--adm-red); font-size: 11px; padding: 4px 10px; border-radius: 6px; cursor: pointer; min-height: 28px; }

        /* Admin header badge */
        .admin-header-badge {
            display: inline-block; font-size: 9px; font-weight: 700;
            color: var(--adm-primary-bright); background: var(--adm-primary-dim);
            padding: 2px 8px; border-radius: 4px; letter-spacing: 1px;
            margin-left: 8px; vertical-align: middle;
            border: 1px solid var(--adm-border-accent);
        }

        /* Admin bottom nav */
        #adminNav {
            background: var(--adm-bg-card) !important;
            border-top: 1px solid var(--adm-border) !important;
        }
        #adminNav .bnav-btn { color: var(--adm-text-3); padding: 6px 6px; }
        #adminNav .bnav-btn .bnav-label { font-size: 9px; }
        #adminNav .bnav-inner { max-width: 520px; }
        #adminNav .bnav-btn.active { color: var(--adm-primary-bright); }
        #adminNav .bnav-btn.active::after {
            content: '';
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; border-radius: 50%;
            background: var(--adm-primary);
        }
        #adminNav .bnav-btn { position: relative; }

        /* Admin inner inputs */
        #adminScreen input, #adminScreen select, #adminScreen textarea {
            background: var(--adm-bg-elevated);
            border-color: var(--adm-border);
            color: var(--adm-text-1);
        }
        #adminScreen input:focus, #adminScreen select:focus, #adminScreen textarea:focus {
            border-color: var(--adm-primary);
            box-shadow: 0 0 0 3px var(--adm-primary-dim);
        }
        #adminScreen .btn-primary {
            background: linear-gradient(135deg, var(--adm-primary), #6366F1);
            box-shadow: 0 4px 12px var(--adm-primary-glow);
        }
        #adminScreen .perfil-logout-btn {
            background: var(--adm-bg-elevated);
            border-color: var(--adm-border);
            color: var(--adm-red);
        }
        #adminScreen .section-title { color: var(--adm-text-2); }
        #adminScreen .ct-btn {
            background: var(--adm-bg-elevated);
            border-color: var(--adm-border);
            color: var(--adm-text-2);
        }
        #adminScreen .ct-btn.selected {
            background: var(--adm-primary-dim);
            border-color: var(--adm-primary);
            color: var(--adm-primary-bright);
        }
        #adminScreen .selected-ct-bar {
            background: var(--adm-primary-dim);
            border-color: var(--adm-border-accent);
            color: var(--adm-primary-bright);
        }
        #adminScreen .checkin-profile {
            background: var(--adm-bg-elevated);
            border-color: var(--adm-border);
        }
        #adminScreen .checkin-avatar {
            background: var(--adm-primary-dim);
            color: var(--adm-primary-bright);
            border-color: var(--adm-border-accent);
        }
        #adminScreen .checkin-name { color: var(--adm-text-1); }
        #adminScreen .checkin-count-num { color: var(--adm-primary-bright); }
        #adminScreen .checkin-count-label { color: var(--adm-text-3); }

        /* Admin perfil card */
        #adminScreen .perfil-card {
            background: var(--adm-bg-elevated);
            border-color: var(--adm-border);
        }
        #adminScreen .perfil-avatar {
            background: var(--adm-primary-dim);
            color: var(--adm-primary-bright);
            border-color: var(--adm-border-accent);
        }
        #adminScreen .perfil-name { color: var(--adm-text-1); }
        #adminScreen .perfil-email { color: var(--adm-text-3); }
        #adminScreen .form-label { color: var(--adm-text-2); }

        /* CT Schedule Admin */

        /* Report Dashboard */
        .report-kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }
        .report-kpi {
            background: var(--adm-card);
            border: 1px solid var(--adm-border);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
        }
        .report-kpi-num {
            font-size: 26px;
            font-weight: 800;
            font-family: 'Sora', sans-serif;
        }
        .report-kpi-num.gold { color: var(--gold); }
        .report-kpi-num.green { color: #2ecc71; }
        .report-kpi-num.cyan { color: #67e8f9; }
        .report-kpi-num.purple { color: #c084fc; }
        .report-kpi-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--adm-text-3);
            margin-top: 2px;
        }
        .report-section {
            background: var(--adm-card);
            border: 1px solid var(--adm-border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
        }
        .report-section-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--adm-text-2);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
        }
        .report-bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .report-bar-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--adm-text-2);
            min-width: 50px;
            text-align: right;
            flex-shrink: 0;
        }
        .report-bar-track {
            flex: 1;
            height: 22px;
            background: rgba(255,255,255,0.04);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        .report-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s ease;
            min-width: 2px;
        }
        .report-bar-fill.gold { background: linear-gradient(90deg, #d4af37, #f5d76e); }
        .report-bar-fill.green { background: linear-gradient(90deg, #2ecc71, #67e8f9); }
        .report-bar-fill.cyan { background: linear-gradient(90deg, #67e8f9, #22d3ee); }
        .report-bar-fill.purple { background: linear-gradient(90deg, #a78bfa, #c084fc); }
        .report-bar-value {
            font-size: 11px;
            font-weight: 700;
            color: var(--adm-text-1);
            min-width: 30px;
            text-align: left;
            flex-shrink: 0;
        }
        .report-pico-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 18px;
        }
        .report-pico {
            background: var(--adm-card);
            border: 1px solid var(--adm-border);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
        }
        .report-pico-icon { font-size: 20px; margin-bottom: 4px; }
        .report-pico-val {
            font-size: 14px;
            font-weight: 800;
            color: var(--gold);
        }
        .report-pico-lbl {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--adm-text-3);
            margin-top: 2px;
        }
        .report-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
        }
        .report-table th {
            text-align: left;
            font-weight: 700;
            color: var(--adm-text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
            padding: 6px 4px;
            border-bottom: 1px solid var(--adm-border);
        }
        .report-table td {
            padding: 6px 4px;
            color: var(--adm-text-2);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .report-table tr:hover td { color: var(--adm-text-1); }
        .report-filter-row {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .report-filter-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--adm-border);
            background: transparent;
            color: var(--adm-text-3);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .report-filter-btn.active {
            background: var(--adm-primary-dim);
            border-color: var(--adm-primary-bright);
            color: var(--adm-primary-bright);
        }

        /* CT Schedule Admin */
        .ct-schedule-card {
            background: var(--adm-card);
            border: 1px solid var(--adm-border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 14px;
        }
        .ct-schedule-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .ct-schedule-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--adm-text-1);
        }
        .ct-schedule-status {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 20px;
        }
        .ct-schedule-status.saved { background: rgba(45,138,78,0.15); color: #2ecc71; }
        .ct-schedule-status.unsaved { background: rgba(212,175,55,0.15); color: var(--gold); }
        .ct-schedule-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }
        .ct-day-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 0;
            border-radius: 10px;
            border: 1px solid var(--adm-border);
            background: transparent;
            transition: all 0.2s;
            color: var(--adm-text-3);
        }
        .ct-day-toggle .ct-day-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ct-day-toggle .ct-day-icon {
            font-size: 16px;
        }
        .ct-day-toggle.active {
            background: rgba(45,138,78,0.15);
            border-color: #2ecc71;
            color: #2ecc71;
        }
        .ct-day-toggle.active .ct-day-icon::after { content: '✓'; }
        .ct-day-toggle:not(.active) .ct-day-icon::after { content: '✕'; }
        .ct-schedule-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        .ct-schedule-save {
            background: var(--adm-green);
            color: #0a0a0a;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ct-schedule-save:hover { background: #5EEAD4; }
        .ct-schedule-save:disabled { opacity: 0.5; cursor: default; }

        .adm-tab { display: none; }
        .adm-tab.active { display: block; }

        /* ===== BIRTHDAY CELEBRATION ===== */
        .bday-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999;
            background: radial-gradient(ellipse at center, rgba(15,12,8,0.97) 0%, rgba(5,5,5,0.99) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bdayFadeIn 0.6s ease;
            overflow: hidden;
        }
        @keyframes bdayFadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Confetti particles */
        .bday-confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            top: -20px;
            animation: bdayFall linear forwards;
        }
        @keyframes bdayFall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Glow ring */
        .bday-glow {
            position: absolute;
            width: 280px; height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(212,175,55,0.15) 0%, transparent 70%);
            animation: bdayPulse 2.5s ease-in-out infinite;
        }
        @keyframes bdayPulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.3); opacity: 1; }
        }

        .bday-card {
            position: relative;
            z-index: 2;
            text-align: center;
            max-width: 340px;
            padding: 32px 24px;
            animation: bdaySlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both;
        }
        @keyframes bdaySlideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .bday-emoji {
            font-size: 64px;
            margin-bottom: 8px;
            animation: bdayBounce 1s ease infinite;
        }
        @keyframes bdayBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .bday-title {
            font-family: 'Sora', sans-serif;
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #d4af37, #f5d76e, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .bday-name {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 16px;
        }

        .bday-msg {
            font-size: 14px;
            color: var(--text-2);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .bday-stats {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 20px;
        }
        .bday-stat {
            background: rgba(212,175,55,0.08);
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 12px;
            padding: 12px 14px;
            text-align: center;
            min-width: 70px;
        }
        .bday-stat-num {
            font-size: 22px;
            font-weight: 800;
            color: var(--gold);
            font-family: 'Sora', sans-serif;
        }
        .bday-stat-lbl {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-3);
            margin-top: 2px;
            font-weight: 600;
        }

        .bday-quote {
            font-size: 13px;
            font-style: italic;
            color: var(--text-3);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .bday-family {
            font-size: 12px;
            color: var(--gold);
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        .bday-close {
            background: linear-gradient(135deg, #d4af37, #b8972e);
            color: #0a0a0a;
            border: none;
            padding: 12px 32px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            font-family: 'Sora', sans-serif;
            letter-spacing: 0.5px;
            transition: transform 0.2s;
        }
        .bday-close:hover { transform: scale(1.05); }
        .bday-close:active { transform: scale(0.97); }

        /* ===== SUB-TABS ===== */
        .subtab-bar {
            display: flex;
            gap: 4px;
            padding: 6px;
            margin: 0 16px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .subtab-btn {
            flex: 1;
            padding: 8px 4px;
            background: none;
            border: none;
            border-radius: 9px;
            color: var(--text-3);
            font-size: 12px;
            font-weight: 600;
            font-family: 'Sora', sans-serif;
            cursor: pointer;
            transition: all 0.25s;
            letter-spacing: 0.3px;
        }
        .subtab-btn.active {
            background: rgba(212,175,55,0.12);
            color: var(--gold);
            border: 1px solid rgba(212,175,55,0.2);
        }
        .subtab-content { display: none; }
        .subtab-content.active { display: block; }

        /* ===== ONDE TREINAR / GUIDE (legacy) ===== */

        /* ===== ONDE TREINAR / GUIDE ===== */
        .guide-container { padding: 16px; max-width: 460px; margin: 0 auto; }

        .guide-today-hero {
            background: linear-gradient(135deg, #0d1a0d 0%, #1a2e1a 50%, #0d1a0d 100%);
            border: 1px solid rgba(46,204,113,0.25);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .guide-today-hero::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(46,204,113,0.06) 0%, transparent 70%);
            animation: campShimmer 5s ease-in-out infinite;
        }
        .guide-today-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #2ecc71;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
        }
        .guide-today-day {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: #fff;
            margin-bottom: 8px;
            position: relative;
        }
        .guide-today-cts {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            position: relative;
        }
        .guide-today-live {
            display: inline-block;
            width: 8px; height: 8px;
            background: #2ecc71;
            border-radius: 50%;
            margin-right: 6px;
            animation: guidePulse 1.5s ease infinite;
            vertical-align: middle;
        }
        @keyframes guidePulse { 0%,100% { opacity: 1; box-shadow: 0 0 0 0 rgba(46,204,113,0.4); } 50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(46,204,113,0); } }

        .guide-noclass {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            color: var(--text-3);
            font-size: 13px;
        }

        /* CT Guide Card */
        .guide-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: border-color 0.3s;
        }
        .guide-card.today { border-color: rgba(46,204,113,0.3); }

        .guide-card-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .guide-card-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
        }
        .guide-card.today .guide-card-icon { background: rgba(46,204,113,0.12); }
        .guide-card:not(.today) .guide-card-icon { background: rgba(255,255,255,0.04); }
        .guide-card-info { flex: 1; min-width: 0; }
        .guide-card-name {
            font-family: 'Sora', sans-serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-1);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .guide-live-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(46,204,113,0.15);
            color: #2ecc71;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .guide-card-addr {
            font-size: 12px;
            color: var(--text-3);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .guide-card-toggle {
            font-size: 16px;
            color: var(--text-3);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        .guide-card.open .guide-card-toggle { transform: rotate(180deg); }

        .guide-card-body {
            display: none;
            padding: 0 16px 16px;
        }
        .guide-card.open .guide-card-body { display: block; }

        /* Schedule dots */
        .guide-sched {
            display: flex;
            gap: 4px;
            margin-bottom: 14px;
        }
        .guide-sched-day {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
        }
        .guide-sched-day.on { background: rgba(46,204,113,0.12); color: #2ecc71; }
        .guide-sched-day.off { background: rgba(255,255,255,0.02); color: var(--text-3); opacity: 0.4; }
        .guide-sched-day.current { background: rgba(46,204,113,0.25); color: #2ecc71; box-shadow: 0 0 0 1px rgba(46,204,113,0.4); }

        /* Info rows */
        .guide-info-row {
            display: flex;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            gap: 10px;
        }
        .guide-info-row:last-child { border-bottom: none; }
        .guide-info-icon { font-size: 16px; width: 24px; text-align: center; flex-shrink: 0; margin-top: 1px; }
        .guide-info-content { flex: 1; }
        .guide-info-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); font-weight: 600; margin-bottom: 2px; }
        .guide-info-value { font-size: 13px; color: var(--text-1); line-height: 1.4; }

        /* Benefit tags */
        .guide-benefits { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .guide-benefit-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
        }
        .guide-benefit-tag.totalpass { background: rgba(255,87,34,0.12); color: #ff5722; border: 1px solid rgba(255,87,34,0.2); }
        .guide-benefit-tag.gympass { background: rgba(244,67,54,0.12); color: #f44336; border: 1px solid rgba(244,67,54,0.2); }
        .guide-benefit-tag.wellhub { background: rgba(156,39,176,0.12); color: #ce93d8; border: 1px solid rgba(156,39,176,0.2); }
        .guide-benefit-tag.gogood { background: rgba(76,175,80,0.12); color: #66bb6a; border: 1px solid rgba(76,175,80,0.2); }
        .guide-benefit-tag.classpass { background: rgba(33,150,243,0.12); color: #42a5f5; border: 1px solid rgba(33,150,243,0.2); }
        .guide-benefit-tag.totalfit { background: rgba(255,152,0,0.12); color: #ffa726; border: 1px solid rgba(255,152,0,0.2); }
        .guide-benefit-tag.default { background: rgba(255,255,255,0.05); color: var(--text-2); border: 1px solid rgba(255,255,255,0.1); }

        /* Action buttons */
        .guide-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .guide-action-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            color: var(--text-2);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }
        .guide-action-btn:hover { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.15); }

        /* Admin CT detail fields */
        .ct-detail-section {
            padding: 12px 0 0;
            border-top: 1px solid rgba(255,255,255,0.06);
            margin-top: 12px;
        }
        .ct-detail-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--adm-text-3);
            font-weight: 700;
            margin-bottom: 8px;
        }
        .ct-detail-field { margin-bottom: 8px; }
        .ct-detail-field label {
            display: block;
            font-size: 10px;
            color: var(--adm-text-3);
            margin-bottom: 3px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ct-detail-field input, .ct-detail-field textarea {
            width: 100%;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--adm-border);
            border-radius: 8px;
            padding: 8px 10px;
            color: var(--adm-text-1);
            font-size: 12px;
            font-family: inherit;
        }
        .ct-detail-field textarea { resize: vertical; min-height: 50px; }
        .ct-detail-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .ct-benefit-toggles { display: flex; flex-wrap: wrap; gap: 6px; }
        .ct-benefit-toggle {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: var(--adm-text-3);
            transition: all 0.2s;
        }
        .ct-benefit-toggle.active { background: rgba(46,204,113,0.15); color: #2ecc71; border-color: rgba(46,204,113,0.3); }

        /* ===== CT TIME SLOT PICKER ===== */
        .ct-time-picker { margin-top: 4px; }
        .ct-time-slots { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .ct-time-slot {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            font-family: 'Sora', monospace;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: var(--adm-text-3);
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }
        .ct-time-slot.active {
            background: rgba(94,234,212,0.15);
            color: #5EEAD4;
            border-color: rgba(94,234,212,0.4);
            box-shadow: 0 0 8px rgba(94,234,212,0.1);
        }
        .ct-time-slot.custom .ct-time-remove {
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
            opacity: 0.5;
            cursor: pointer;
        }
        .ct-time-slot.custom .ct-time-remove:hover { opacity: 1; color: #E85D5D; }
        .ct-time-add-row {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .ct-time-add-input {
            width: 70px;
            padding: 5px 8px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: var(--adm-text-1);
            font-size: 12px;
            font-family: 'Sora', monospace;
            text-align: center;
        }
        .ct-time-add-btn {
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid rgba(94,234,212,0.3);
            background: rgba(94,234,212,0.1);
            color: #5EEAD4;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ct-time-add-btn:hover { background: rgba(94,234,212,0.2); }

        /* ===== ADMIN STUDENT EDITOR MODAL ===== */
        .stu-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 8000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .stu-modal {
            max-width: 460px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg);
            padding: 0;
        }
        .stu-modal-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(10,10,15,0.97);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: env(safe-area-inset-top, 8px) 12px 0 12px;
            border-bottom: 1px solid var(--border);
        }
        .stu-modal-toprow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0 10px 0;
        }
        .stu-modal-back {
            background: rgba(255,255,255,0.06); border: none;
            color: var(--text-1); font-size: 16px; font-weight: 600;
            cursor: pointer; padding: 8px 14px;
            border-radius: 10px;
            display: flex; align-items: center; gap: 6px;
            font-family: 'Sora', sans-serif;
            transition: background 0.2s;
        }
        .stu-modal-back:active { background: rgba(255,255,255,0.12); }
        .stu-modal-title {
            font-family: 'Sora', sans-serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-1);
            text-align: center;
            position: absolute; left: 50%; transform: translateX(-50%);
            pointer-events: none;
        }
        .stu-modal-save {
            background: linear-gradient(135deg, #d4af37, #f5d76e);
            color: #000;
            border: none;
            padding: 8px 18px;
            border-radius: 10px;
            font-family: 'Sora', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .stu-modal-save:active { opacity: 0.7; }
        .stu-modal-save:disabled { opacity: 0.4; }

        .stu-modal-body { padding: 16px; }

        /* Student hero in modal */
        .stu-hero {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 16px;
        }
        .stu-hero-avatar {
            width: 64px; height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d4af37, #f5d76e);
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; font-weight: 800; color: #000;
            margin: 0 auto 8px;
            font-family: 'Sora', sans-serif;
        }
        .stu-hero-name {
            font-family: 'Sora', sans-serif;
            font-size: 18px; font-weight: 700; color: var(--text-1);
        }
        .stu-hero-email { font-size: 12px; color: var(--text-3); margin-top: 2px; }
        .stu-hero-stats {
            display: flex; justify-content: center; gap: 16px; margin-top: 10px;
        }
        .stu-hero-stat { text-align: center; }
        .stu-hero-stat-num { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 800; color: var(--gold); }
        .stu-hero-stat-lbl { font-size: 9px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-3); font-weight: 600; }

        /* Edit sections */
        .stu-section {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .stu-section-title {
            font-family: 'Sora', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-2);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .stu-field { margin-bottom: 10px; }
        .stu-field label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-3);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .stu-field input, .stu-field select, .stu-field textarea {
            width: 100%;
            box-sizing: border-box;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-1);
            font-size: 13px;
            font-family: inherit;
        }
        .stu-field textarea { resize: vertical; min-height: 60px; }
        .stu-field input:focus, .stu-field select:focus, .stu-field textarea:focus {
            outline: none; border-color: var(--gold);
        }
        .stu-field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stu-field-row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

        .stu-toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0;
        }
        .stu-toggle-label { font-size: 13px; color: var(--text-2); font-weight: 600; }
        .stu-toggle {
            position: relative;
            width: 44px; height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .stu-toggle.on { background: rgba(46,204,113,0.5); }
        .stu-toggle::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px;
            width: 20px; height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .stu-toggle.on::after { transform: translateX(20px); }

        .stu-days-row {
            display: flex; gap: 6px; margin-top: 6px;
        }
        .stu-day-btn {
            flex: 1; height: 38px; border-radius: 8px; border: 1.5px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04); color: var(--text-3); font-size: 13px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .stu-day-btn.on {
            background: rgba(20,184,166,0.2); border-color: var(--adm-primary);
            color: var(--adm-primary-bright); box-shadow: 0 0 8px rgba(20,184,166,0.15);
        }
        .stu-days-hint {
            font-size: 10px; color: var(--text-3); margin-top: 4px; min-height: 14px;
        }
        .stu-days-hint .hint-link {
            color: var(--adm-primary); cursor: pointer; text-decoration: underline;
        }

        /* Report CT filter */

        /* Enhanced Attendance List */
        .rpt-chamada { margin-top: 4px; }
        .rpt-chamada-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; border-radius: 10px; margin-bottom: 8px;
            background: linear-gradient(135deg, rgba(20,184,166,0.1), rgba(20,184,166,0.05));
        }
        .rpt-chamada-title { font-size: 14px; font-weight: 700; color: var(--adm-text-1); }
        .rpt-chamada-stats { display: flex; gap: 12px; }
        .rpt-chamada-stat { text-align: center; }
        .rpt-chamada-stat-num { font-size: 18px; font-weight: 800; }
        .rpt-chamada-stat-num.green { color: #4ade80; }
        .rpt-chamada-stat-num.red { color: #f87171; }
        .rpt-chamada-stat-num.blue { color: var(--adm-primary-bright); }
        .rpt-chamada-stat-lbl { font-size: 9px; color: var(--adm-text-3); text-transform: uppercase; font-weight: 600; }

        .rpt-aluno-row {
            display: flex; align-items: center; gap: 10px; padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.04); transition: background 0.15s;
        }
        .rpt-aluno-row:last-child { border-bottom: none; }
        .rpt-aluno-status {
            width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 16px; flex-shrink: 0;
        }
        .rpt-aluno-status.present { background: rgba(45,200,90,0.15); }
        .rpt-aluno-status.absent { background: rgba(232,93,93,0.12); }
        .rpt-aluno-info { flex: 1; min-width: 0; }
        .rpt-aluno-name { font-size: 13px; font-weight: 600; color: var(--adm-text-1); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rpt-aluno-detail { font-size: 11px; color: var(--adm-text-3); margin-top: 1px; }
        .rpt-aluno-badge {
            padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 700;
            white-space: nowrap; flex-shrink: 0;
        }
        .rpt-aluno-badge.ok { background: rgba(45,200,90,0.12); color: #4ade80; }
        .rpt-aluno-badge.warn { background: rgba(251,191,36,0.12); color: #fbbf24; }
        .rpt-aluno-badge.danger { background: rgba(232,93,93,0.12); color: #f87171; }
        .rpt-aluno-badge.info { background: rgba(20,184,166,0.12); color: var(--adm-primary-bright); }

        .rpt-section-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; cursor: pointer; border-radius: 8px;
            background: rgba(255,255,255,0.02); margin-bottom: 4px;
            -webkit-tap-highlight-color: transparent;
        }
        .rpt-section-toggle:active { background: rgba(255,255,255,0.06); }
        .rpt-section-toggle-left { display: flex; align-items: center; gap: 8px; }
        .rpt-section-toggle-title { font-size: 13px; font-weight: 700; color: var(--adm-text-1); }
        .rpt-section-toggle-arrow { color: var(--adm-text-3); transition: transform 0.2s; font-size: 12px; }
        .rpt-section-toggle.open .rpt-section-toggle-arrow { transform: rotate(90deg); }

        .rpt-ct-filter { display: flex; gap: 6px; margin-bottom: 14px; overflow-x: auto; padding-bottom: 2px; }
        .rpt-ct-btn {
            padding: 7px 14px; border-radius: 8px; border: 1px solid var(--adm-border);
            background: var(--adm-bg-card); color: var(--adm-text-3); font-size: 11px; font-weight: 600;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .rpt-ct-btn.active {
            background: rgba(251,191,36,0.15); border-color: rgba(251,191,36,0.4);
            color: #fbbf24;
        }

        /* Per-day horarios picker */
        .ct-hpd-days { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
        .ct-hpd-day-btn {
            padding: 6px 12px; border-radius: 8px; border: 1px solid var(--adm-border);
            background: var(--adm-bg-card); color: var(--adm-text-3); font-size: 11px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .ct-hpd-day-btn.active {
            background: rgba(20,184,166,0.15); border-color: var(--adm-primary);
            color: var(--adm-primary-bright);
        }
        .ct-hpd-day-btn .hpd-count {
            font-size: 9px; margin-left: 3px; opacity: 0.6;
        }
        .ct-hpd-panel { margin-bottom: 6px; animation: fadeIn 0.2s ease; }

        .stu-modal-msg {
            text-align: center;
            font-size: 13px;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            display: none;
        }
        .stu-modal-msg.success { display: block; background: rgba(46,204,113,0.12); color: #2ecc71; }
        .stu-modal-msg.error { display: block; background: rgba(231,76,60,0.12); color: #e74c3c; }

        .stu-danger-zone {
            border-top: 1px solid rgba(231,76,60,0.2);
            padding-top: 16px;
            margin-top: 8px;
        }
        .stu-delete-btn {
            width: 100%;
            background: rgba(231,76,60,0.1);
            border: 1px solid rgba(231,76,60,0.25);
            color: #e74c3c;
            padding: 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .stu-delete-btn:hover { background: rgba(231,76,60,0.2); }

        /* Admin student card clickable */
        .admin-student-card { cursor: pointer; transition: border-color 0.2s; }
        .admin-student-card:hover { border-color: rgba(212,175,55,0.3); }

        /* ===== CAMPEONATO INTERNO ===== */
        .camp-container { padding: 16px; max-width: 460px; margin: 0 auto; }

        /* Hero */
        .camp-hero {
            position: relative;
            border-radius: 20px;
            padding: 36px 20px 28px;
            text-align: center;
            overflow: hidden;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #1a1205 0%, #2a2010 40%, #1a1205 100%);
            border: 1px solid rgba(212,175,55,0.3);
        }
        .camp-hero-shimmer {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(212,175,55,0.04) 50%, transparent 70%);
            animation: campShimmer 4s ease-in-out infinite;
        }
        .camp-hero-emoji { font-size: 56px; margin-bottom: 8px; position: relative; z-index: 1; }
        .camp-hero-title {
            font-family: 'Sora', sans-serif; font-size: 24px; font-weight: 900;
            color: #fff; line-height: 1.2; margin-bottom: 10px; position: relative; z-index: 1;
        }
        .camp-hero-badge {
            display: inline-block; padding: 5px 16px; border-radius: 20px;
            font-family: 'Sora', sans-serif; font-size: 10px; font-weight: 800;
            letter-spacing: 2px; color: var(--gold);
            background: rgba(212,175,55,0.1); border: 1px solid rgba(212,175,55,0.25);
            position: relative; z-index: 1;
        }

        /* Sections */
        .camp-section {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; padding: 18px; margin-bottom: 12px;
        }
        .camp-section.camp-final {
            background: linear-gradient(135deg, rgba(212,175,55,0.04), rgba(212,175,55,0.01));
            border-color: rgba(212,175,55,0.2);
        }
        .camp-section-icon { font-size: 24px; margin-bottom: 6px; }
        .camp-section-title {
            font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 800;
            color: #fff; margin-bottom: 10px;
        }
        .camp-section-text { font-size: 13px; color: var(--text-2); line-height: 1.6; }
        .camp-section-text strong { color: #fff; }

        /* Info grid (45min, 5 vidas, ∞) */
        .camp-info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .camp-info-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px; padding: 14px 8px; text-align: center;
        }
        .camp-info-val {
            font-family: 'Sora', sans-serif; font-size: 28px; font-weight: 900; color: var(--gold);
        }
        .camp-info-lbl { font-size: 10px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; line-height: 1.3; margin-top: 2px; }

        /* Vidas animation */
        .camp-lives { display: flex; justify-content: center; gap: 10px; margin-bottom: 12px; }
        .camp-life { font-size: 28px; animation: campLifePulse 2s ease-in-out infinite; }
        .camp-life:nth-child(2) { animation-delay: 0.2s; }
        .camp-life:nth-child(3) { animation-delay: 0.4s; }
        .camp-life:nth-child(4) { animation-delay: 0.6s; }
        .camp-life:nth-child(5) { animation-delay: 0.8s; }
        @keyframes campLifePulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        /* Rules (finalizou/foi finalizado) */
        .camp-rule { margin-bottom: 12px; }
        .camp-rule:last-of-type { margin-bottom: 14px; }
        .camp-rule-badge {
            display: inline-block; padding: 4px 12px; border-radius: 8px;
            font-family: 'Sora', sans-serif; font-size: 11px; font-weight: 800;
            letter-spacing: 0.5px; margin-bottom: 8px;
        }
        .camp-rule-badge.win { background: rgba(46,204,113,0.12); color: #2ecc71; border: 1px solid rgba(46,204,113,0.2); }
        .camp-rule-badge.lose { background: rgba(231,76,60,0.12); color: #e74c3c; border: 1px solid rgba(231,76,60,0.2); }
        .camp-rule-item { font-size: 13px; color: var(--text-2); padding: 3px 0; }

        .camp-highlight {
            background: rgba(212,175,55,0.06); border: 1px solid rgba(212,175,55,0.15);
            border-radius: 10px; padding: 12px 16px; text-align: center;
            font-size: 13px; font-weight: 600; color: var(--gold);
        }

        /* Mini podium */
        .camp-podium-mini { display: flex; justify-content: center; align-items: flex-end; gap: 8px; margin-bottom: 14px; }
        .camp-pod { text-align: center; border-radius: 10px; padding: 10px 16px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); }
        .camp-pod-1 { padding: 14px 20px; background: rgba(212,175,55,0.08); border-color: rgba(212,175,55,0.2); }
        .camp-pod-medal { font-size: 28px; }
        .camp-pod-place { font-family: 'Sora', sans-serif; font-size: 12px; font-weight: 800; color: var(--text-2); margin-top: 2px; }

        /* VS Super Final */
        .camp-vs { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 16px; }
        .camp-vs-side { text-align: center; }
        .camp-vs-emoji { font-size: 36px; margin-bottom: 4px; }
        .camp-vs-label { font-size: 11px; color: var(--text-3); font-weight: 600; line-height: 1.3; }
        .camp-vs-x {
            font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 900;
            color: var(--gold); text-shadow: 0 0 12px rgba(212,175,55,0.3);
        }
        .camp-final-prize { font-size: 13px; color: var(--text-2); padding: 5px 0; line-height: 1.5; }
        .camp-final-prize strong { color: #fff; }

        /* Hall da Fama */
        .camp-hall { margin-bottom: 16px; }
        .camp-hall-title {
            font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 900;
            color: var(--gold); text-align: center; margin-bottom: 2px;
        }
        .camp-hall-sub { font-size: 11px; color: var(--text-3); text-align: center; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* Accordion (Regulamento) */
        .camp-accordion {
            border-radius: 16px; overflow: hidden; margin-bottom: 12px;
            border: 1px solid rgba(212,175,55,0.15);
            cursor: pointer;
        }
        .camp-accordion-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 16px;
            background: rgba(212,175,55,0.04);
        }
        .camp-accordion-left { display: flex; align-items: center; gap: 12px; }
        .camp-accordion-emoji { font-size: 24px; }
        .camp-accordion-title {
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 800; color: #fff;
        }
        .camp-accordion-sub { font-size: 11px; color: var(--text-3); margin-top: 1px; }
        .camp-accordion-arrow {
            font-size: 12px; color: var(--gold);
            transition: transform 0.3s ease;
        }
        .camp-accordion-arrow.open { transform: rotate(180deg); }
        .camp-accordion-body {
            padding: 0 12px 12px;
            animation: campAccIn 0.3s ease;
        }
        @keyframes campAccIn { from { opacity: 0; } to { opacity: 1; } }
        .camp-accordion-body .camp-hero { margin-top: 4px; }
        .camp-accordion-body .camp-section { margin-bottom: 10px; }
        .camp-champ-card {
            background: var(--card-bg); border: 1px solid rgba(212,175,55,0.2);
            border-radius: 16px; padding: 16px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 14px;
        }
        .camp-champ-medal { font-size: 36px; }
        .camp-champ-info { flex: 1; }
        .camp-champ-name { font-family: 'Sora', sans-serif; font-size: 15px; font-weight: 800; color: #fff; }
        .camp-champ-detail { font-size: 11px; color: var(--text-3); margin-top: 2px; }
        .camp-champ-detail strong { color: var(--gold); }
        .camp-champ-type {
            font-family: 'Sora', sans-serif; font-size: 9px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px; padding: 4px 10px;
            border-radius: 8px;
        }
        .camp-champ-type.geral { background: rgba(212,175,55,0.12); color: var(--gold); border: 1px solid rgba(212,175,55,0.25); }
        .camp-champ-type.local { background: rgba(192,192,192,0.1); color: #c0c0c0; border: 1px solid rgba(192,192,192,0.2); }

        /* Admin champion card actions */
        .camp-champ-admin { position: relative; }
        .camp-champ-actions {
            display: flex; flex-direction: column; gap: 4px; margin-left: 6px;
        }
        .camp-champ-act-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; cursor: pointer; transition: all 0.15s;
        }
        .camp-champ-act-btn.edit { background: rgba(212,175,55,0.1); }
        .camp-champ-act-btn.edit:hover { background: rgba(212,175,55,0.25); }
        .camp-champ-act-btn.del { background: rgba(231,76,60,0.08); }
        .camp-champ-act-btn.del:hover { background: rgba(231,76,60,0.2); }

        /* PODIUM (Student Hall da Fama) */
        .camp-podium-section { margin-bottom: 20px; }
        .camp-podium-ed-label {
            font-size: 11px; color: var(--text-3); font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; margin: 0 0 12px; padding-left: 4px;
        }
        .camp-podium-geral {
            background: linear-gradient(135deg, #1a1708 0%, #2a2510 50%, #1a1708 100%);
            border: 1.5px solid rgba(212,175,55,0.35);
            border-radius: 18px; padding: 20px 16px; text-align: center;
            position: relative; overflow: hidden; margin-bottom: 12px;
        }
        .camp-podium-geral-shimmer {
            position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.06), transparent);
            animation: campShimmer 5s ease-in-out infinite;
        }
        .camp-podium-geral-crown { font-size: 40px; margin-bottom: 4px; position: relative; }
        .camp-podium-geral-label {
            font-size: 10px; color: var(--gold); font-weight: 700;
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 6px; position: relative;
        }
        .camp-podium-geral-name {
            font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 900;
            color: #fff; position: relative;
        }
        .camp-podium-geral-meta {
            font-size: 12px; color: var(--text-3); margin-top: 4px; position: relative;
        }
        .camp-podium-geral-meta strong { color: var(--gold); }
        .camp-podium-locals-title {
            font-size: 11px; color: var(--text-3); font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; margin: 0 0 8px; padding-left: 4px;
        }
        .camp-podium-local {
            background: linear-gradient(135deg, #141618 0%, #1e2226 100%);
            border: 1px solid rgba(192,192,192,0.15);
            border-radius: 14px; padding: 14px; display: flex; align-items: center; gap: 12px;
            margin-bottom: 8px;
        }
        .camp-podium-local-icon { font-size: 28px; }
        .camp-podium-local-info { flex: 1; }
        .camp-podium-local-name {
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 800; color: #fff;
        }
        .camp-podium-local-meta { font-size: 11px; color: var(--text-3); margin-top: 2px; }
        .camp-podium-local-meta strong { color: #c0c0c0; }
        .camp-podium-local-ct {
            font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px;
            background: rgba(192,192,192,0.08); color: #c0c0c0;
            border: 1px solid rgba(192,192,192,0.15); text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* Scoreboard */
        .camp-score-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 12px;
        }
        .camp-score-title {
            font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 800; color: #fff;
        }

        /* Filter row */
        .camp-filter-row {
            display: flex; gap: 8px; margin-bottom: 14px;
        }
        .camp-filter-group { flex: 1; }
        .camp-filter-label {
            display: block; font-size: 10px; font-weight: 700; color: var(--text-3);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .camp-filter-select {
            width: 100%; padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 10px; color: #fff;
            font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23d4af37' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .camp-filter-select:focus { outline: none; border-color: var(--gold); }
        .camp-filter-select option { background: #1a1a1a; color: #fff; }

        .camp-score-row {
            display: flex; align-items: center; padding: 10px 12px;
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 6px; gap: 10px;
        }
        .camp-score-row.top1 { border-color: rgba(212,175,55,0.3); background: rgba(212,175,55,0.04); }
        .camp-score-row.top2 { border-color: rgba(192,192,192,0.2); }
        .camp-score-row.top3 { border-color: rgba(205,127,50,0.2); }
        .camp-score-row.eliminated { opacity: 0.45; }

        .camp-score-pos {
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 900;
            min-width: 28px; text-align: center;
        }
        .camp-score-row.top1 .camp-score-pos { color: var(--gold); }
        .camp-score-row.top2 .camp-score-pos { color: #c0c0c0; }
        .camp-score-row.top3 .camp-score-pos { color: #cd7f32; }

        .camp-score-avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 800; color: #fff;
            background: rgba(255,255,255,0.08);
        }
        .camp-score-info { flex: 1; min-width: 0; }
        .camp-score-name { font-size: 13px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .camp-score-meta { font-size: 10px; color: var(--text-3); margin-top: 1px; }

        .camp-score-borr {
            display: flex; align-items: center; gap: 4px;
            min-width: 50px; justify-content: flex-end;
        }
        .camp-score-borr-num {
            font-family: 'Sora', sans-serif; font-size: 20px; font-weight: 900; color: #fff;
        }
        .camp-score-row.top1 .camp-score-borr-num { color: var(--gold); }
        .camp-score-borr-icon { font-size: 16px; }
        .camp-score-borr-lbl { font-size: 8px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.3px; }

        .camp-score-empty {
            text-align: center; color: var(--text-3); font-size: 13px; padding: 24px;
            background: var(--card-bg); border: 1px solid var(--border); border-radius: 14px;
        }

        /* PODIUM VISUAL (2nd - 1st - 3rd) */
        .camp-podium-rank {
            display: flex; align-items: flex-end; justify-content: center; gap: 6px;
            margin-bottom: 16px; padding: 10px 4px 0;
        }
        .camp-podium-col {
            display: flex; flex-direction: column; align-items: center; flex: 1; max-width: 120px;
        }
        .camp-podium-avatar {
            width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 17px; font-weight: 900; color: #fff;
            font-family: 'Sora', sans-serif; margin-bottom: 4px;
        }
        .camp-podium-col.pos1 .camp-podium-avatar {
            width: 56px; height: 56px; font-size: 20px;
            background: linear-gradient(135deg, #b8972e, #f5d76e);
            box-shadow: 0 0 16px rgba(212,175,55,0.4);
        }
        .camp-podium-col.pos2 .camp-podium-avatar {
            background: linear-gradient(135deg, #808080, #c0c0c0);
        }
        .camp-podium-col.pos3 .camp-podium-avatar {
            background: linear-gradient(135deg, #8b5a2b, #cd7f32);
        }
        .camp-podium-medal { font-size: 18px; margin-bottom: 2px; }
        .camp-podium-pname {
            font-family: 'Sora', sans-serif; font-size: 11px; font-weight: 800;
            color: #fff; text-align: center; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; max-width: 100%; padding: 0 2px;
        }
        .camp-podium-col.pos1 .camp-podium-pname { font-size: 12px; }
        .camp-podium-borr { font-size: 10px; color: var(--text-3); margin-top: 1px; }
        .camp-podium-bar {
            width: 100%; border-radius: 8px 8px 0 0; margin-top: 4px;
        }
        .camp-podium-col.pos1 .camp-podium-bar {
            height: 72px; background: linear-gradient(180deg, rgba(212,175,55,0.25), rgba(212,175,55,0.06));
            border: 1px solid rgba(212,175,55,0.3); border-bottom: none;
        }
        .camp-podium-col.pos2 .camp-podium-bar {
            height: 50px; background: linear-gradient(180deg, rgba(192,192,192,0.2), rgba(192,192,192,0.05));
            border: 1px solid rgba(192,192,192,0.2); border-bottom: none;
        }
        .camp-podium-col.pos3 .camp-podium-bar {
            height: 36px; background: linear-gradient(180deg, rgba(205,127,50,0.2), rgba(205,127,50,0.05));
            border: 1px solid rgba(205,127,50,0.2); border-bottom: none;
        }

        /* CT CHAMPIONS ("Todos" mode) */
        .camp-ct-champ-card {
            background: var(--card-bg); border-radius: 14px;
            border: 1px solid rgba(212,175,55,0.15); padding: 14px;
            display: flex; align-items: center; gap: 12px; margin-bottom: 8px;
        }
        .camp-ct-champ-card.winner {
            border-color: rgba(212,175,55,0.4);
            background: linear-gradient(135deg, #1a1708, #2a2510);
        }
        .camp-ct-champ-pos { font-size: 22px; min-width: 32px; text-align: center; }
        .camp-ct-champ-info { flex: 1; }
        .camp-ct-champ-ct { font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 800; color: #fff; }
        .camp-ct-champ-name { font-size: 12px; color: var(--text-3); margin-top: 2px; }
        .camp-ct-champ-borr { font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 900; color: var(--gold); }

        /* CATEGORY SECTIONS */
        .camp-cat-section {
            margin-bottom: 20px; padding-bottom: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .camp-cat-section:last-child { border-bottom: none; margin-bottom: 0; }
        .camp-cat-header {
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 1.5px;
            padding: 8px 4px 6px; margin-bottom: 4px;
        }

        /* Admin placar row */
        .camp-adm-row {
            display: flex; align-items: center; gap: 8px; padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .camp-adm-row:last-child { border-bottom: none; }
        .camp-adm-name { flex: 1; font-size: 13px; color: var(--text-2); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .camp-adm-ct { font-size: 10px; color: var(--text-3); min-width: 60px; }
        .camp-adm-input {
            width: 60px; text-align: center; padding: 6px 4px;
            background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 8px; color: #fff; font-family: 'Sora', sans-serif;
            font-size: 14px; font-weight: 700;
        }

        /* ===== MOTIVATION MODAL (Retorno) ===== */
        .motiv-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; align-items: center; justify-content: center;
            z-index: 9998;
            animation: motivFadeIn 0.5s ease;
            padding: 20px;
        }
        @keyframes motivFadeIn { from { opacity: 0; } to { opacity: 1; } }

        .motiv-card {
            background: linear-gradient(160deg, #1a1a1a 0%, #111 100%);
            border-radius: 24px;
            padding: 32px 24px 24px;
            max-width: 360px;
            width: 100%;
            text-align: center;
            position: relative;
            border: 1px solid rgba(212,175,55,0.15);
            animation: motivSlideUp 0.6s cubic-bezier(0.16,1,0.3,1) 0.2s both;
        }
        @keyframes motivSlideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .motiv-emoji {
            font-size: 52px;
            margin-bottom: 8px;
            animation: motivFloat 3s ease-in-out infinite;
        }
        @keyframes motivFloat { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        .motiv-title {
            font-family: 'Sora', sans-serif;
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .motiv-title.tier1 { color: #2ecc71; }
        .motiv-title.tier2 { color: #f5d76e; }
        .motiv-title.tier3 { color: #e67e22; }
        .motiv-title.tier4 { color: #e74c3c; }

        .motiv-days {
            font-size: 12px;
            color: var(--text-3);
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .motiv-msg {
            font-size: 14px;
            color: var(--text-2);
            line-height: 1.7;
            margin-bottom: 16px;
        }

        .motiv-quote {
            font-size: 12px;
            color: var(--text-3);
            font-style: italic;
            line-height: 1.5;
            margin-bottom: 20px;
            padding: 0 8px;
        }

        .motiv-stat {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 10px 18px;
            margin-bottom: 20px;
        }
        .motiv-stat-num {
            font-family: 'Sora', sans-serif;
            font-size: 22px;
            font-weight: 900;
            color: #fff;
        }
        .motiv-stat-lbl {
            font-size: 10px;
            color: var(--text-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            text-align: left;
            line-height: 1.3;
        }

        .motiv-cta {
            display: inline-block;
            padding: 12px 32px;
            border-radius: 14px;
            font-family: 'Sora', sans-serif;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
            background: linear-gradient(135deg, #d4af37, #b8972e);
            color: #000;
        }
        .motiv-cta:hover { transform: scale(1.05); }
        .motiv-cta:active { transform: scale(0.97); }

        .motiv-skip {
            display: block;
            margin-top: 12px;
            background: none;
            border: none;
            color: var(--text-3);
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
        }
        /* ══════ TREINO ALARM ══════ */
        .treino-alarm {
            position: relative; overflow: hidden;
            background: linear-gradient(135deg, #0d1f0d 0%, #1a2e1a 50%, #0d1f0d 100%);
            border: 1px solid rgba(45,200,90,0.25);
            border-radius: 16px; padding: 16px; margin-bottom: 16px;
            display: flex; align-items: center; gap: 14px;
        }
        .treino-alarm-glow {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 30% 50%, rgba(45,200,90,0.08) 0%, transparent 60%);
            pointer-events: none;
        }
        .treino-alarm-icon {
            font-size: 36px; z-index: 1; position: relative;
            animation: alarmBell 2s ease-in-out infinite;
        }
        @keyframes alarmBell {
            0%, 100% { transform: rotate(0deg); }
            5% { transform: rotate(14deg); }
            10% { transform: rotate(-14deg); }
            15% { transform: rotate(10deg); }
            20% { transform: rotate(-8deg); }
            25% { transform: rotate(4deg); }
            30%, 100% { transform: rotate(0deg); }
        }
        .treino-alarm-body { z-index: 1; position: relative; flex: 1; }
        .treino-alarm-title {
            font-family: 'Sora', sans-serif; font-size: 16px; font-weight: 900;
            color: #4ade80; margin-bottom: 2px;
        }
        .treino-alarm-sub {
            font-size: 12px; color: rgba(74,222,128,0.6); font-weight: 600;
        }
        .treino-alarm-times {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;
        }
        .treino-alarm-time {
            background: rgba(45,200,90,0.12); border: 1px solid rgba(45,200,90,0.2);
            border-radius: 8px; padding: 4px 10px;
            font-family: 'Sora', sans-serif; font-size: 14px; font-weight: 800;
            color: #4ade80; display: flex; align-items: center; gap: 4px;
        }
        .treino-alarm-time .clock-icon { font-size: 12px; }
        .treino-alarm-time.next {
            background: rgba(45,200,90,0.25); border-color: rgba(45,200,90,0.5);
            box-shadow: 0 0 10px rgba(45,200,90,0.15);
            animation: nextPulse 2s ease-in-out infinite;
        }
        @keyframes nextPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(45,200,90,0.15); }
            50% { box-shadow: 0 0 18px rgba(45,200,90,0.3); }
        }
        .treino-alarm.no-train {
            background: linear-gradient(135deg, #1a1a1a 0%, #222 50%, #1a1a1a 100%);
            border-color: rgba(255,255,255,0.06);
        }
        .treino-alarm.no-train .treino-alarm-title { color: var(--text-3); }
        .treino-alarm.no-train .treino-alarm-sub { color: var(--text-3); opacity: 0.5; }
        .treino-alarm.no-train .treino-alarm-icon { animation: none; }
        .treino-alarm.checked-in {
            background: linear-gradient(135deg, #0a1a2e 0%, #0d2847 50%, #0a1a2e 100%);
            border-color: rgba(59,130,246,0.3);
        }
        .treino-alarm.checked-in .treino-alarm-glow {
            background: radial-gradient(circle at 30% 50%, rgba(59,130,246,0.1) 0%, transparent 60%);
        }
        .treino-alarm.checked-in .treino-alarm-title { color: #60a5fa; }
        .treino-alarm.checked-in .treino-alarm-sub { color: rgba(96,165,250,0.7); }
        .treino-alarm.checked-in .treino-alarm-icon { animation: none; }
        .treino-alarm.missed {
            background: linear-gradient(135deg, #2a1a0a 0%, #3d2210 50%, #2a1a0a 100%);
            border-color: rgba(251,191,36,0.25);
        }
        .treino-alarm.missed .treino-alarm-glow {
            background: radial-gradient(circle at 30% 50%, rgba(251,191,36,0.08) 0%, transparent 60%);
        }
        .treino-alarm.missed .treino-alarm-title { color: #fbbf24; }
        .treino-alarm.missed .treino-alarm-sub { color: rgba(251,191,36,0.6); }
        .treino-alarm.missed .treino-alarm-icon { animation: none; }

        /* ══════ AVATAR BUILDER ══════ */
        .avb-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
            padding: 16px; box-sizing: border-box;
        }
        .avb-modal {
            background: var(--bg-card); border-radius: 20px;
            width: 100%; max-width: 380px; max-height: 90vh;
            overflow-y: auto; padding: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .avb-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .avb-title { font-family: 'Sora', sans-serif; font-size: 18px; font-weight: 900; color: var(--text-1); }
        .avb-close {
            background: rgba(255,255,255,0.06); border: none; color: var(--text-3);
            width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer;
        }
        .avb-preview-wrap {
            display: flex; justify-content: center; padding: 16px 0;
        }
        .avb-preview {
            width: 120px; height: 120px; border-radius: 50%;
            background: rgba(255,255,255,0.04);
            border: 3px solid rgba(212,175,55,0.3);
            overflow: hidden; position: relative;
        }
        .avb-preview svg { width: 100%; height: 100%; }
        .avb-tabs {
            display: flex; gap: 4px; margin-bottom: 6px;
            background: rgba(255,255,255,0.03); border-radius: 12px; padding: 4px;
        }
        .avb-tab {
            flex: 1; border: none; background: transparent; padding: 8px;
            border-radius: 10px; font-size: 18px; cursor: pointer;
            transition: all 0.2s;
        }
        .avb-tab.active { background: rgba(212,175,55,0.15); box-shadow: 0 0 8px rgba(212,175,55,0.1); }
        .avb-tab-label {
            font-family: 'Sora', sans-serif; font-size: 11px; font-weight: 700;
            color: var(--text-3); text-transform: uppercase; letter-spacing: 1px;
            text-align: center; margin-bottom: 8px;
        }
        .avb-options {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            margin-bottom: 16px; min-height: 80px;
        }
        .avb-opt {
            aspect-ratio: 1; border-radius: 14px; border: 2px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.03); cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 28px;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .avb-opt:active { transform: scale(0.92); }
        .avb-opt.selected { border-color: var(--gold); background: rgba(212,175,55,0.1); box-shadow: 0 0 12px rgba(212,175,55,0.2); }
        .avb-opt-color {
            width: 36px; height: 36px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .avb-opt svg { width: 44px; height: 44px; }
        .avb-actions { display: flex; gap: 8px; }
        .avb-btn-random {
            flex: 1; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.04); color: var(--text-2);
            font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer;
        }
        .avb-btn-save {
            flex: 2; padding: 12px; border-radius: 12px; border: none;
            background: linear-gradient(135deg, var(--gold-light), var(--gold));
            color: var(--bg-deep); font-family: 'Sora', sans-serif;
            font-size: 13px; font-weight: 900; cursor: pointer;
        }
        .avb-btn-save:active { transform: scale(0.97); }

        /* Avatar render in profile */
        .perfil-avatar-big { position: relative; overflow: visible !important; }
        .perfil-avatar-big svg { width: 100%; height: 100%; border-radius: 50%; }
        .perfil-avatar-edit-badge {
            position: absolute; bottom: -2px; right: -2px;
            width: 24px; height: 24px; background: var(--gold);
            border-radius: 50%; display: flex; align-items: center;
            justify-content: center; font-size: 12px; border: 2px solid var(--bg-deep);
        }
        /* Header mini avatar */
        .hdr-avatar svg { width: 100%; height: 100%; border-radius: 50%; }

    </style>
</head>
<body>
    <div class="app">
        <!-- HEADER -->
        <div class="hdr">
            <div class="hdr-brand">
                                <div style="display:-webkit-box;display:-webkit-flex;display:flex;-webkit-box-orient:vertical;-webkit-flex-direction:column;flex-direction:column;">
                    <div class="hdr-title">JIU JITSU ACADEMY</div>
                    <div id="headerSubtitle" style="font-size:10px;letter-spacing:1.5px;color:var(--text-2);font-weight:600;text-transform:uppercase;font-family:'Sora',sans-serif;">Checkin</div>
                </div>
            </div>
            <div class="mode-switch" id="modeSwitcher">
                <button class="mode-switch-opt" id="modeOptAluno" onclick="switchViewMode('aluno')">🥋 Aluno</button>
                <button class="mode-switch-opt active admin-active" id="modeOptAdmin" onclick="switchViewMode('admin')">⚙️ Admin</button>
            </div>
            <div class="hdr-user" id="headerUser" onclick="handleLogout()">
                <div class="hdr-avatar" id="userInitial">L</div>
                <div class="hdr-name" id="headerUserName">User</div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main">
            <!-- LOGIN -->
            <div id="loginScreen">
                <div class="login-hero">
                    <h1 class="login-title">JIU JITSU ACADEMY</h1>
                    <p class="login-sub">Checkin de Treinos</p>
                </div>

                <div class="login-box">
                    <div id="loginTab">
                        <div class="form-card">
                            <div class="form-card-title">Entrar</div>
                            <form onsubmit="handleLogin(event)">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="loginEmail" placeholder="seu@email.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Senha</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="loginPassword" placeholder="••••••" required>
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)" title="Mostrar senha">👁</button>
                                    </div>
                                </div>
                                <div id="loginMessage"></div>
                                <button type="submit" class="btn btn-primary">Entrar</button>
                            </form>
                        </div>
                        <button class="btn btn-outline" onclick="showRegister()">Criar Nova Conta</button>
                        <button class="btn" onclick="showForgotPassword()" style="background:transparent;color:var(--text-3);font-size:13px;margin-top:4px;text-decoration:underline;border:none;cursor:pointer;">Esqueci minha senha</button>
                    </div>

                    <div id="registerTab" style="display: none;">
                        <div class="form-card">
                            <div class="form-card-title">Cadastro</div>
                            <form onsubmit="handleRegister(event)">
                                <div class="form-group">
                                    <label class="form-label">Nome Completo</label>
                                    <input type="text" id="regName" placeholder="Seu Nome" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="regEmail" placeholder="seu@email.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Senha</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="regPassword" placeholder="Mínimo 6 caracteres" required minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regPassword', this)" title="Mostrar senha">👁</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirmar Senha</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="regPasswordConfirm" placeholder="Repita a senha" required minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('regPasswordConfirm', this)" title="Mostrar senha">👁</button>
                                    </div>
                                    <div class="password-match-hint" id="passwordMatchHint"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Faixa</label>
                                    <select id="regFaixa" required>
                                        <option value="">Selecione sua faixa</option>
                                        <option value="Branca">⚪ Branca</option>
                                        <option value="Azul">🔵 Azul</option>
                                        <option value="Roxa">🟣 Roxa</option>
                                        <option value="Marrom">🟤 Marrom</option>
                                        <option value="Preta">⚫ Preta</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Grau</label>
                                    <select id="regGrau" required>
                                        <option value="">Selecione o grau</option>
                                        <option value="0">0</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">CT Principal</label>
                                    <select id="regCT" required>
                                        <option value="">Selecione seu CT</option>
                                    </select>
                                </div>
                                <div id="registerMessage"></div>
                                <button type="submit" class="btn btn-primary">Cadastrar</button>
                            </form>
                        </div>
                        <button class="btn btn-outline" onclick="showLogin()">Voltar ao Login</button>
                    </div>

                    <div id="forgotTab" style="display: none;">
                        <div class="form-card">
                            <div class="form-card-title">🔑 Recuperar Senha</div>
                            <p style="font-size:12px;color:var(--text-3);margin-bottom:16px;">Digite seu email cadastrado e uma nova senha. O Professor irá avaliar e aprovar a alteração.</p>
                            <form onsubmit="handleForgotPassword(event)">
                                <div class="form-group">
                                    <label class="form-label">Email cadastrado</label>
                                    <input type="email" id="forgotEmail" placeholder="seu@email.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Nova Senha</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="forgotPassword" placeholder="Mínimo 6 caracteres" required minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('forgotPassword', this)" title="Mostrar senha">👁</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Confirmar Nova Senha</label>
                                    <div class="password-wrapper">
                                        <input type="password" id="forgotPasswordConfirm" placeholder="Repita a nova senha" required minlength="6">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('forgotPasswordConfirm', this)" title="Mostrar senha">👁</button>
                                    </div>
                                </div>
                                <div id="forgotMessage"></div>
                                <button type="submit" class="btn btn-primary">Solicitar Nova Senha</button>
                            </form>
                        </div>
                        <button class="btn btn-outline" onclick="showLogin()">Voltar ao Login</button>
                    </div>
                </div>
            </div>

            <!-- APP -->
            <div id="appScreen" style="display:none;">
                <!-- TAB: TREINO (main) -->
                <div id="treino-tab" class="tab-content active">
                    <div class="subtab-bar">
                        <button class="subtab-btn active" onclick="switchSubTab('treino-tab','sub-checkin',event)">✍️ Check-in</button>
                        <button class="subtab-btn" onclick="switchSubTab('treino-tab','sub-evolucao',event)">📈 Evolução</button>
                        <button class="subtab-btn" onclick="switchSubTab('treino-tab','sub-presencas',event)">📅 Presenças</button>
                    </div>

                    <!-- SUB: CHECK-IN -->
                    <div id="sub-checkin" class="subtab-content active">
                    <!-- ALARM: Hoje tem treino! -->
                    <div id="treino-alarm" class="treino-alarm" style="display:none;">
                        <div class="treino-alarm-glow"></div>
                        <div class="treino-alarm-icon" id="treinoAlarmIcon">🔔</div>
                        <div class="treino-alarm-body">
                            <div class="treino-alarm-title" id="treinoAlarmTitle">Hoje tem treino!</div>
                            <div class="treino-alarm-sub" id="treinoAlarmSub">Bora pro tatame! 🤙</div>
                            <div class="treino-alarm-times" id="treinoAlarmTimes"></div>
                        </div>
                    </div>

                    <div class="checkin-profile">
                        <div class="checkin-avatar" id="checkinInitial">L</div>
                        <div class="checkin-info">
                            <div class="checkin-name" id="displayName">-</div>
                            <div class="checkin-meta"><span id="displayFaixa">-</span></div>
                        </div>
                        <div class="checkin-count">
                            <div class="checkin-count-num" id="displayCount">0</div>
                            <div class="checkin-count-label">Treinos</div>
                        </div>
                    </div>

                    <div class="ct-section">
                        <div class="section-title">Onde você treinou?</div>
                        <div class="ct-grid" id="ctGrid"></div>
                        <div class="selected-ct-bar" id="selectedInfo">
                            <span>Academia:</span>
                            <span id="selectedCT">-</span>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="confirmAttendance()">✓ Confirmar Presença</button>
                    <div id="attendanceMessage"></div>

                    <button class="btn btn-danger-outline" onclick="handleLogout()" style="margin-top: 24px;">Sair da Conta</button>
                </div>

                    <!-- SUB: EVOLUÇÃO -->
                    <div id="sub-evolucao" class="subtab-content">
                    <div class="evo-container">
                        <div class="evo-motivation" id="evoMotivation">
                            <div class="evo-motivation-icon">🔥</div>
                            <div class="evo-motivation-text" id="evoMotivationText">"Consistência constrói campeões."</div>
                            <div class="evo-motivation-sub" id="evoMotivationSub">Continue firme no tatame</div>
                        </div>

                        <div class="evo-hero" id="evoHero">
                            <div class="evo-hero-belt branca" id="evoHeroBelt">🥋</div>
                            <div class="evo-hero-info">
                                <div class="evo-hero-title" id="evoHeroTitle">Faixa Branca</div>
                                <div class="evo-hero-sub" id="evoHeroSub">Próxima: Azul</div>
                                <div id="evoHeroStatus"></div>
                            </div>
                            <div class="evo-hero-stats">
                                <div class="evo-hero-stat">
                                    <div class="evo-hero-stat-val" id="evoStatTreinos">0</div>
                                    <div class="evo-hero-stat-lbl">Treinos</div>
                                </div>
                                <div class="evo-hero-stat">
                                    <div class="evo-hero-stat-val" id="evoStatSemestre">0</div>
                                    <div class="evo-hero-stat-lbl">Semestre</div>
                                </div>
                            </div>
                        </div>

                        <div class="evo-seals">
                            <div class="evo-seals-title">🏅 Selos de Grau</div>
                            <div class="evo-seals-row" id="evoSealsRow"></div>
                        </div>

                        <div class="evo-freq">
                            <div class="evo-freq-row">
                                <div class="evo-freq-left">📊 Frequência Semestre</div>
                                <div class="evo-freq-pct" id="evoFreqPct">0%</div>
                            </div>
                            <div class="evo-freq-bar-bg">
                                <div class="evo-freq-bar-fill" id="evoFreqBarFill" style="width:0%"></div>
                            </div>
                            <div class="evo-freq-sub" id="evoFreqDetail">0 de 48 aulas possíveis</div>
                        </div>

                        <div class="evo-criteria-section" id="evoFaixaCriteria">
                            <div class="evo-criteria-header">
                                <div class="evo-criteria-header-icon">🏅</div>
                                <div class="evo-criteria-header-text" id="evoFaixaCriteriaTitle">Exame de Faixa</div>
                                <div class="evo-criteria-header-sub" id="evoFaixaProgress">0/6</div>
                            </div>
                            <div class="evo-criteria-list" id="evoFaixaCriteriaList"></div>
                        </div>

                        <button class="evo-exam-btn disabled" id="evoExamBtn" disabled>🔒 Critérios pendentes · Aprovação do professor</button>

                        <div class="ibjjf-roadmap">
                            <div class="ibjjf-title">🥋 Sistema de Graduação IBJJF</div>
                            <div class="ibjjf-subtitle">Seu caminho da Faixa Branca até a Faixa Preta</div>

                            <div class="ibjjf-legend">
                                <div class="ibjjf-legend-item"><div class="ibjjf-legend-dot past"></div>Concluída</div>
                                <div class="ibjjf-legend-item"><div class="ibjjf-legend-dot current"></div>Atual</div>
                                <div class="ibjjf-legend-item"><div class="ibjjf-legend-dot next"></div>Próxima</div>
                                <div class="ibjjf-legend-item"><div class="ibjjf-legend-dot future"></div>Futuro</div>
                            </div>

                            <div class="ibjjf-track" id="ibjjfTrack">
                                <div class="ibjjf-track-fill" id="ibjjfTrackFill" style="height:0%"></div>
                            </div>

                            <div class="ibjjf-summary">
                                <div class="ibjjf-summary-row">
                                    <div class="ibjjf-summary-label">Progresso Geral</div>
                                    <div class="ibjjf-summary-val" id="ibjjfOverallPct">0%</div>
                                </div>
                                <div class="ibjjf-summary-bar-bg">
                                    <div class="ibjjf-summary-bar-fill" id="ibjjfOverallFill" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Graduation Timeline -->
                        <div class="evo-timeline" id="evoTimeline">
                            <div class="evo-timeline-title">🏆 Minha Jornada</div>

                            <!-- Student: set own start date -->
                            <div class="evo-inicio-box" id="evoInicioBox">
                                <div class="evo-inicio-label">📅 Quando você começou no Jiu-Jitsu?</div>
                                <div class="evo-inicio-row">
                                    <input type="date" id="evoInicioDate" class="evo-inicio-input">
                                    <button class="evo-inicio-btn" id="evoInicioBtn" onclick="saveMyInicioBJJ()">Salvar</button>
                                </div>
                                <div class="evo-inicio-saved" id="evoInicioSaved" style="display:none;">
                                    ✅ <span id="evoInicioSavedText"></span>
                                    <span class="evo-inicio-edit" onclick="editInicioBJJ()">editar</span>
                                </div>
                            </div>

                            <!-- Student: declare prior grades/belts -->
                            <div class="evo-declare-box" id="evoDeclareBox">
                                <div class="evo-declare-header" onclick="toggleDeclareForm()">
                                    <span>📋 Já possui graus ou faixas anteriores?</span>
                                    <span class="evo-declare-toggle" id="evoDeclareToggle">▸</span>
                                </div>
                                <div class="evo-declare-form" id="evoDeclareForm" style="display:none;">
                                    <div class="evo-declare-hint">Informe seu histórico. O professor irá validar.</div>
                                    <div class="evo-declare-row">
                                        <select id="evoDeclTipo" onchange="onEvoDeclTipoChange()">
                                            <option value="grau">🏅 Grau</option>
                                            <option value="faixa">🥋 Faixa</option>
                                        </select>
                                        <select id="evoDeclFaixa" onchange="updateGrauOptions('evoDeclFaixa','evoDeclGrau')">
                                            <option value="Branca">Branca</option>
                                            <option value="Cinza">Cinza</option>
                                            <option value="Amarela">Amarela</option>
                                            <option value="Laranja">Laranja</option>
                                            <option value="Verde">Verde</option>
                                            <option value="Azul">Azul</option>
                                            <option value="Roxa">Roxa</option>
                                            <option value="Marrom">Marrom</option>
                                            <option value="Preta">Preta</option>
                                        </select>
                                        <select id="evoDeclGrau">
                                            <option value="0">0º Grau</option>
                                            <option value="1">1º Grau</option>
                                            <option value="2">2º Grau</option>
                                            <option value="3">3º Grau</option>
                                            <option value="4">4º Grau</option>
                                        </select>
                                    </div>
                                    <div class="evo-declare-row">
                                        <input type="date" id="evoDeclData" class="evo-inicio-input" style="flex:1;">
                                        <button class="evo-declare-btn" onclick="requestGraduacao()">Enviar</button>
                                    </div>
                                    <div id="evoDeclMsg" style="font-size:11px;color:var(--text-3);margin-top:4px;"></div>
                                </div>
                            </div>

                            <!-- Apt notification -->
                            <div class="evo-apt-msg" id="evoAptMsg" style="display:none;">
                                <div class="evo-apt-icon">🏅</div>
                                <div class="evo-apt-text" id="evoAptText">Você atingiu os critérios para o próximo grau!</div>
                                <div class="evo-apt-sub">Aguarde a aprovação do professor</div>
                            </div>

                            <div style="position:relative;padding-left:10px;">
                                <div class="evo-tl-line"></div>
                                <div id="evoTimelineContent">
                                    <div class="evo-tl-start">Sua jornada será registrada aqui pelo professor 🥋</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- SUBTAB: PRESENÇAS (Calendário Mensal) -->
                    <div id="sub-presencas" class="subtab-content">
                        <div class="prs-container">
                            <!-- Month Navigator -->
                            <div class="prs-month-nav">
                                <button class="prs-nav-btn" onclick="prsChangeMonth(-1)">‹</button>
                                <div class="prs-month-title" id="prsMonthTitle">Fevereiro 2026</div>
                                <button class="prs-nav-btn" onclick="prsChangeMonth(1)">›</button>
                            </div>

                            <!-- Summary Cards -->
                            <div class="prs-summary" id="prsSummary">
                                <div class="prs-stat">
                                    <div class="prs-stat-num" id="prsTotalMes">0</div>
                                    <div class="prs-stat-lbl">Treinos</div>
                                </div>
                                <div class="prs-stat">
                                    <div class="prs-stat-num" id="prsCTsMes">0</div>
                                    <div class="prs-stat-lbl">CTs</div>
                                </div>
                                <div class="prs-stat">
                                    <div class="prs-stat-num" id="prsFreqMes">0%</div>
                                    <div class="prs-stat-lbl">Frequência</div>
                                </div>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="prs-cal">
                                <div class="prs-cal-header">
                                    <div class="prs-cal-hdr">S</div>
                                    <div class="prs-cal-hdr">T</div>
                                    <div class="prs-cal-hdr">Q</div>
                                    <div class="prs-cal-hdr">Q</div>
                                    <div class="prs-cal-hdr">S</div>
                                    <div class="prs-cal-hdr">S</div>
                                    <div class="prs-cal-hdr">D</div>
                                </div>
                                <div class="prs-cal-grid" id="prsCalGrid"></div>
                            </div>

                            <!-- Legend -->
                            <div class="prs-legend">
                                <div class="prs-legend-item"><span class="prs-dot present"></span> Treinou</div>
                                <div class="prs-legend-item"><span class="prs-dot expected"></span> Dia de treino</div>
                                <div class="prs-legend-item"><span class="prs-dot missed"></span> Faltou</div>
                            </div>

                            <!-- Day Detail (expandable) -->
                            <div class="prs-detail" id="prsDetail" style="display:none;">
                                <div class="prs-detail-header" id="prsDetailHeader">—</div>
                                <div class="prs-detail-list" id="prsDetailList"></div>
                            </div>

                            <!-- Monthly List -->
                            <div class="prs-list" id="prsList"></div>
                        </div>
                    </div>

                </div> <!-- /treino-tab -->

                <!-- TAB: RANKING & PRÊMIOS (main) -->
                <div id="ranking-tab" class="tab-content">
                    <div class="subtab-bar">
                        <button class="subtab-btn active" onclick="switchSubTab('ranking-tab','sub-ranking',event)">🏆 Ranking</button>
                        <button class="subtab-btn" onclick="switchSubTab('ranking-tab','sub-campeonato',event)">🏅 Campeonato</button>
                    </div>

                    <!-- SUB: RANKING -->
                    <div id="sub-ranking" class="subtab-content active">
                    <div class="rank-period" id="periodFilterGrid">
                        <button class="rank-period-btn active" onclick="switchRankingPeriod('mes', event)">📅 Este Mês</button>
                        <button class="rank-period-btn" onclick="switchRankingPeriod('ano', event)">📆 Este Ano</button>
                    </div>

                    <div class="rank-ct-scroll" id="ctFilterGrid"></div>

                    <div class="user-stats-card" id="userTrainingSection">
                        <div class="section-title" style="margin-bottom:12px;">Seus treinos</div>
                        <div class="user-stats-row">
                            <div class="user-stats-total">
                                <div class="user-stats-num" id="userTotalCount">0</div>
                                <div class="user-stats-lbl" id="userTotalLabel">treinos</div>
                            </div>
                            <div class="user-ct-grid" id="userTrainingGrid"></div>
                        </div>
                    </div>

                    <div class="podium" id="top3Container"></div>

                    <div class="user-pos-card" id="userPositionSection">
                        <div class="user-pos-inner" id="userPositionCard"></div>
                    </div>

                    <div id="rankingListSection" style="display:none;">
                        <div class="section-title" style="margin-bottom:12px;">Ranking</div>
                        <div class="rank-list" id="rankingList"></div>
                    </div>

                    <div id="ctRankingContainer" style="display:none;">
                        <div class="section-title" id="ctRankingTitle" style="margin-bottom:12px;">Ranking</div>
                        <div class="rank-list" id="ctRankingList"></div>
                    </div>

                    <div id="rankingMessage" style="text-align:center; padding:30px; color:var(--text-3); font-size: 13px;">Carregando ranking...</div>
                    </div> <!-- /sub-ranking -->

                    <!-- SUB: CAMPEONATO INTERNO -->
                    <div id="sub-campeonato" class="subtab-content">
                        <div class="camp-container">

                            <!-- PLACAR POR CT (SEMPRE VISÍVEL) -->
                            <div id="campScoreSection" style="margin-bottom:16px;">
                                <div class="camp-score-header">
                                    <div class="camp-score-title">🏆 Ranking do Campeonato</div>
                                </div>
                                <div class="camp-filter-row">
                                    <div class="camp-filter-group">
                                        <label class="camp-filter-label">📅 Semestre</label>
                                        <select class="camp-filter-select" id="campScoreEdSelect" onchange="onCampScoreEdChange()">
                                            <option value="">Carregando...</option>
                                        </select>
                                    </div>
                                    <div class="camp-filter-group">
                                        <label class="camp-filter-label">📍 CT</label>
                                        <select class="camp-filter-select" id="campScoreCTSelect" onchange="onCampScoreCTChange()">
                                            <option value="">Selecione</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="campScoreList">
                                    <div class="camp-score-empty">🔵 Selecione semestre e CT para ver o ranking</div>
                                </div>
                            </div>

                            <!-- HALL DA FAMA -->
                            <div class="camp-hall" id="campHall" style="display:none;">
                                <div class="camp-hall-title">👑 Hall da Fama</div>
                                <div class="camp-hall-sub">Campeões do Borrachinha</div>
                                <div id="campHallCards"></div>
                            </div>

                            <!-- APRESENTAÇÃO (COLLAPSIBLE) -->
                            <div class="camp-accordion" onclick="toggleCampRules()">
                                <div class="camp-accordion-header" id="campAccordionHeader">
                                    <div class="camp-accordion-left">
                                        <span class="camp-accordion-emoji">🏆</span>
                                        <div>
                                            <div class="camp-accordion-title">Regulamento do Campeonato</div>
                                            <div class="camp-accordion-sub">Toque para ver as regras</div>
                                        </div>
                                    </div>
                                    <div class="camp-accordion-arrow" id="campAccordionArrow">▼</div>
                                </div>
                                <div class="camp-accordion-body" id="campAccordionBody" style="display:none;">

                                    <!-- Hero -->
                                    <div class="camp-hero">
                                        <div class="camp-hero-shimmer"></div>
                                        <div class="camp-hero-emoji">🏆</div>
                                        <div class="camp-hero-title">Campeonato<br>de Borrachinha</div>
                                        <div class="camp-hero-badge">FORMATO OFICIAL</div>
                                    </div>

                                    <!-- Periodicidade -->
                                    <div class="camp-section">
                                        <div class="camp-section-icon">📅</div>
                                        <div class="camp-section-title">Periodicidade</div>
                                        <div class="camp-section-text">O Campeonato de Borrachinha acontece <strong>duas vezes por ano</strong> (semestral).</div>
                                    </div>

                                    <!-- Formato -->
                                    <div class="camp-section">
                                        <div class="camp-section-icon">⏱</div>
                                        <div class="camp-section-title">Formato</div>
                                        <div class="camp-info-grid">
                                            <div class="camp-info-card">
                                                <div class="camp-info-val">45</div>
                                                <div class="camp-info-lbl">minutos<br>contínuos</div>
                                            </div>
                                            <div class="camp-info-card">
                                                <div class="camp-info-val">5</div>
                                                <div class="camp-info-lbl">vidas<br>iniciais</div>
                                            </div>
                                            <div class="camp-info-card">
                                                <div class="camp-info-val">∞</div>
                                                <div class="camp-info-lbl">lutas<br>dinâmicas</div>
                                            </div>
                                        </div>
                                        <div class="camp-section-text" style="margin-top:10px;">Modelo de <strong>resistência</strong> — sem interrupções. As lutas acontecem de forma dinâmica, sempre com o próximo adversário disponível.</div>
                                    </div>

                                    <!-- Vidas -->
                                    <div class="camp-section">
                                        <div class="camp-section-icon">🔵</div>
                                        <div class="camp-section-title">Sistema de Vidas</div>
                                        <div class="camp-lives">
                                            <span class="camp-life">🔵</span>
                                            <span class="camp-life">🔵</span>
                                            <span class="camp-life">🔵</span>
                                            <span class="camp-life">🔵</span>
                                            <span class="camp-life">🔵</span>
                                        </div>
                                        <div class="camp-section-text">Cada aluno inicia com <strong>5 borrachinhas</strong>. Cada borrachinha representa 1 vida.</div>
                                    </div>

                                    <!-- Dinâmica -->
                                    <div class="camp-section">
                                        <div class="camp-section-icon">🥋</div>
                                        <div class="camp-section-title">Como Funciona</div>
                                        <div class="camp-rule">
                                            <div class="camp-rule-badge win">FINALIZOU</div>
                                            <div class="camp-rule-items">
                                                <div class="camp-rule-item">✅ Você recebe 1 borrachinha do oponente</div>
                                                <div class="camp-rule-item">✅ Próximo adversário entra imediatamente</div>
                                                <div class="camp-rule-item">✅ Oponente perde 1 vida</div>
                                            </div>
                                        </div>
                                        <div class="camp-rule">
                                            <div class="camp-rule-badge lose">FOI FINALIZADO</div>
                                            <div class="camp-rule-items">
                                                <div class="camp-rule-item">❌ Você perde 1 borrachinha (1 vida)</div>
                                                <div class="camp-rule-item">⏳ Sai e aguarda ser chamado</div>
                                            </div>
                                        </div>
                                        <div class="camp-highlight">O atleta permanece na disputa enquanto tiver vidas.</div>
                                    </div>

                                    <!-- Premiação -->
                                    <div class="camp-section">
                                        <div class="camp-section-icon">🥇</div>
                                        <div class="camp-section-title">Premiação</div>
                                        <div class="camp-podium-mini">
                                            <div class="camp-pod camp-pod-2">
                                                <div class="camp-pod-medal">🥈</div>
                                                <div class="camp-pod-place">2º</div>
                                            </div>
                                            <div class="camp-pod camp-pod-1">
                                                <div class="camp-pod-medal">🥇</div>
                                                <div class="camp-pod-place">1º</div>
                                            </div>
                                            <div class="camp-pod camp-pod-3">
                                                <div class="camp-pod-medal">🥉</div>
                                                <div class="camp-pod-place">3º</div>
                                            </div>
                                        </div>
                                        <div class="camp-section-text">1º, 2º e 3º colocados recebem medalhas ou prêmios definidos pela organização.</div>
                                    </div>

                                    <!-- Super Final -->
                                    <div class="camp-section camp-final">
                                        <div class="camp-section-icon">👑</div>
                                        <div class="camp-section-title">Super Final</div>
                                        <div class="camp-vs">
                                            <div class="camp-vs-side">
                                                <div class="camp-vs-emoji">🏆</div>
                                                <div class="camp-vs-label">Campeão<br>CT A</div>
                                            </div>
                                            <div class="camp-vs-x">VS</div>
                                            <div class="camp-vs-side">
                                                <div class="camp-vs-emoji">🏆</div>
                                                <div class="camp-vs-label">Campeão<br>CT B</div>
                                            </div>
                                        </div>
                                        <div class="camp-final-prizes">
                                            <div class="camp-final-prize">🏆 <strong>Campeão Local</strong> — Vencedor do seu CT</div>
                                            <div class="camp-final-prize">👑 <strong>Campeão Geral</strong> — Vencedor da Super Final</div>
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div> <!-- /sub-campeonato -->

                </div> <!-- /ranking-tab -->

                <!-- PERFIL TAB -->


                <div id="perfil" class="tab-content">
                    <div class="perfil-container">
                        <div class="perfil-header">
                            <div class="perfil-avatar-big" id="perfilAvatar" onclick="openAvatarBuilder()" style="cursor:pointer;position:relative;overflow:visible;">
                                <span id="perfilAvatarInitial">?</span>
                                <div id="perfilAvatarSVG" style="position:absolute;top:0;left:0;width:100%;height:100%;display:none;"></div>
                                <div style="position:absolute;bottom:-2px;right:-2px;width:24px;height:24px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;border:2px solid var(--bg-deep);">✏️</div>
                            </div>
                            <input type="hidden" id="perfilAvatarData" value="">
                            <div class="perfil-nome" id="perfilNome">—</div>
                            <div class="perfil-faixa-tag" id="perfilFaixaTag">—</div>
                            <div class="perfil-completeness">
                                <div class="perfil-completeness-row">
                                    <div class="perfil-completeness-label">📋 Perfil completo</div>
                                    <div class="perfil-completeness-pct" id="perfilCompletePct">0%</div>
                                </div>
                                <div class="perfil-completeness-bar">
                                    <div class="perfil-completeness-fill" id="perfilCompleteFill" style="width:0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="perfil-section">
                            <div class="perfil-section-title"><span>👤</span> Dados Pessoais</div>
                            <div class="perfil-field">
                                <label>Data de Nascimento</label>
                                <input type="date" id="perfilNascimento">
                            </div>
                            <div class="perfil-row">
                                <div class="perfil-field">
                                    <label>Gênero</label>
                                    <select id="perfilGenero">
                                        <option value="">Selecione</option>
                                        <option value="Masculino">Masculino</option>
                                        <option value="Feminino">Feminino</option>
                                        <option value="Outro">Outro</option>
                                        <option value="Prefiro não dizer">Prefiro não dizer</option>
                                    </select>
                                </div>
                                <div class="perfil-field">
                                    <label>Profissão</label>
                                    <input type="text" id="perfilProfissao" placeholder="Ex: Engenheiro, Professor...">
                                </div>
                            </div>
                            <div class="perfil-field">
                                <label>Bairro / Cidade</label>
                                <input type="text" id="perfilBairro" placeholder="Ex: Tijuca - Rio de Janeiro">
                            </div>
                        </div>

                        <div class="perfil-section">
                            <div class="perfil-section-title"><span>📱</span> Contato</div>
                            <div class="perfil-field">
                                <label>Telefone / WhatsApp</label>
                                <input type="tel" id="perfilTelefone" placeholder="(21) 99999-9999">
                            </div>
                            <div class="perfil-field">
                                <label>Instagram</label>
                                <input type="text" id="perfilInstagram" placeholder="@seuusuario">
                            </div>
                            <div class="perfil-field">
                                <label>Contato de Emergência</label>
                                <input type="text" id="perfilEmergencia" placeholder="Nome — (21) 99999-9999">
                            </div>
                        </div>

                        <div class="perfil-section">
                            <div class="perfil-section-title"><span>🥋</span> Sobre seu Jiu Jitsu</div>
                            <div class="perfil-field">
                                <label>Como conheceu a academia?</label>
                                <select id="perfilOrigem">
                                    <option value="">Selecione</option>
                                    <option value="Indicação de amigo">Indicação de amigo</option>
                                    <option value="Indicação de aluno">Indicação de aluno</option>
                                    <option value="Instagram">Instagram</option>
                                    <option value="Facebook">Facebook</option>
                                    <option value="TikTok">TikTok</option>
                                    <option value="Google / Busca">Google / Busca</option>
                                    <option value="Passei na frente">Passei na frente</option>
                                    <option value="Evento / Campeonato">Evento / Campeonato</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="perfil-field">
                                <label>Objetivo no Jiu Jitsu</label>
                                <select id="perfilObjetivo">
                                    <option value="">Selecione</option>
                                    <option value="Saúde e condicionamento">Saúde e condicionamento</option>
                                    <option value="Defesa pessoal">Defesa pessoal</option>
                                    <option value="Competição">Competição</option>
                                    <option value="Hobby / Lazer">Hobby / Lazer</option>
                                    <option value="Disciplina / Foco">Disciplina / Foco</option>
                                    <option value="Socializar">Socializar</option>
                                    <option value="Faixa preta">Chegar à faixa preta</option>
                                </select>
                            </div>
                            <div class="perfil-field">
                                <label>Horário preferido de treino</label>
                                <select id="perfilHorario">
                                    <option value="Manhã">Manhã (6h-11:59h)</option>
                                    <option value="Noite">Noite (18h-23:59h)</option>
                                </select>
                            </div>
                            <div class="perfil-field">
                                <label>Experiência anterior</label>
                                <select id="perfilExperiencia">
                                    <option value="">Selecione</option>
                                    <option value="Nunca treinei">Nunca treinei</option>
                                    <option value="Menos de 1 ano">Menos de 1 ano</option>
                                    <option value="1-2 anos">1-2 anos</option>
                                    <option value="3-5 anos">3-5 anos</option>
                                    <option value="5-10 anos">5-10 anos</option>
                                    <option value="10+ anos">10+ anos</option>
                                </select>
                            </div>
                        </div>

                        <div class="perfil-section">
                            <div class="perfil-section-title"><span>🏥</span> Saúde e Segurança</div>
                            <div class="perfil-field">
                                <label>Lesão ou condição médica</label>
                                <textarea id="perfilSaude" placeholder="Ex: Lesão no joelho, hérnia de disco, asma..."></textarea>
                            </div>
                        </div>

                        <div id="perfilMessage"></div>
                        <button class="perfil-save-btn" id="perfilSaveBtn" onclick="saveProfile()">💾 Salvar Perfil</button>

                        <div class="perfil-section" style="margin-top:16px;">
                            <div class="perfil-section-title"><span>🔒</span> Alterar Senha</div>
                            <div class="perfil-field">
                                <label>Senha Atual</label>
                                <input type="password" id="perfilSenhaAtual" placeholder="••••••">
                            </div>
                            <div class="perfil-pwd-row">
                                <div class="perfil-field">
                                    <label>Nova Senha</label>
                                    <input type="password" id="perfilSenhaNova" placeholder="••••••">
                                </div>
                                <div class="perfil-field">
                                    <label>Confirmar</label>
                                    <input type="password" id="perfilSenhaConfirma" placeholder="••••••">
                                </div>
                            </div>
                            <div id="perfilPwdMessage"></div>
                            <button class="perfil-save-btn" style="margin-top:10px" onclick="changePassword()">🔑 Alterar Senha</button>
                        </div>

                        <button class="perfil-logout-btn" onclick="handleLogout()">🚪 Sair da Conta</button>
                    </div>
                </div>

            </div>
            <!-- end appScreen -->

            <!-- ============================================= -->
            <!-- ===== ADMIN SCREEN (TOTALMENTE SEPARADO) ==== -->
            <!-- ============================================= -->
            <div id="adminScreen" style="display:none;">

            <!-- TAB: PAINEL (Dashboard) -->
            <div id="adm-painel" class="adm-tab active">
                <div class="admin-container">
                    <div class="adm-page-title">
                        <h2>Painel do Administrador</h2>
                        <p>Gestão de alunos e presenças</p>
                    </div>

                    <div class="admin-welcome">
                        <div class="admin-welcome-icon">🥋</div>
                        <div class="admin-welcome-text">
                            <div class="admin-welcome-title" id="adminWelcomeName">Professor</div>
                            <div class="admin-welcome-sub">Bem-vindo ao painel</div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="admin-stats" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="admin-stat warn">
                            <div class="admin-stat-num" id="adminPendingAccountsCount">0</div>
                            <div class="admin-stat-label">Cadastros</div>
                        </div>
                        <div class="admin-stat warn">
                            <div class="admin-stat-num" id="adminPendingResetsCount">0</div>
                            <div class="admin-stat-label">Senhas</div>
                        </div>
                        <div class="admin-stat warn">
                            <div class="admin-stat-num" id="adminPendingCheckinsCount">0</div>
                            <div class="admin-stat-label">Check-ins</div>
                        </div>
                        <div class="admin-stat warn">
                            <div class="admin-stat-num" id="adminPendingGradCount">0</div>
                            <div class="admin-stat-label">Graduações</div>
                        </div>
                        <div class="admin-stat ok">
                            <div class="admin-stat-num" id="adminTodayCheckinsCount">0</div>
                            <div class="admin-stat-label">Hoje</div>
                        </div>
                    </div>

                    <!-- Pending Accounts -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🆕 Novos Alunos <span class="admin-badge" id="adminAccBadge" style="display:none">0</span></div>
                            <button class="admin-refresh-btn" onclick="loadPendingAccounts()">↻</button>
                        </div>
                        <div id="adminAccountsList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                    </div>

                    <!-- Pending Password Resets -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🔑 Reset de Senha <span class="admin-badge" id="adminResetBadge" style="display:none">0</span></div>
                            <button class="admin-refresh-btn" onclick="loadPendingResets()">↻</button>
                        </div>
                        <div id="adminResetsList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                    </div>

                    <!-- Pending Check-ins -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">⏳ Check-ins Pendentes <span class="admin-badge" id="adminCheckinBadge" style="display:none">0</span></div>
                            <button class="admin-refresh-btn" onclick="loadPendingCheckins()">↻</button>
                        </div>
                        <div class="admin-filter-row">
                            <button class="admin-filter-btn active" onclick="filterAdminCheckins('hoje', event)">Hoje</button>
                            <button class="admin-filter-btn" onclick="filterAdminCheckins('semana', event)">Semana</button>
                            <button class="admin-filter-btn" onclick="filterAdminCheckins('todos', event)">Todos</button>
                        </div>
                        <div id="adminCheckinsList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                        <button class="admin-bulk-btn" id="adminBulkApproveBtn" style="display:none" onclick="bulkApproveCheckins()">✓ Aprovar Todos Pendentes</button>
                    </div>

                    <!-- Pending Graduations -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🏆 Graduações Pendentes <span class="admin-badge" id="adminGradBadge" style="display:none">0</span></div>
                            <button class="admin-refresh-btn" onclick="loadPendingGraduacoes()">↻</button>
                        </div>
                        <div id="adminGradList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                    </div>

                    <!-- Recent Approved -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">✅ Aprovados Hoje <span class="admin-badge green" id="adminApprovedBadge" style="display:none">0</span></div>
                        </div>
                        <div id="adminApprovedList">
                            <div class="admin-empty">Nenhum aprovado hoje</div>
                        </div>
                    </div>

                    <!-- Ranking (same as student sees) -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🏆 Ranking</div>
                            <button class="admin-refresh-btn" onclick="loadAdminRanking()">↻</button>
                        </div>
                        <div style="margin-bottom:8px;">
                            <div class="rank-period" id="admRankPeriod" style="margin:0;">
                                <button class="rank-period-btn active" onclick="switchAdmRankPeriod('mes', event)">📅 Mês</button>
                                <button class="rank-period-btn" onclick="switchAdmRankPeriod('ano', event)">📆 Ano</button>
                            </div>
                        </div>
                        <div id="adminRankingList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: ALUNOS -->
            <div id="adm-alunos" class="adm-tab">
                <div class="admin-container">
                    <div class="adm-page-title">
                        <h2>Gestão de Alunos</h2>
                    </div>
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">👥 Alunos Cadastrados <span class="admin-badge green" id="adminStudentsBadge" style="display:none">0</span></div>
                            <button class="admin-refresh-btn" onclick="loadStudentsList()">↻</button>
                        </div>
                        <div style="margin-bottom:12px;">
                            <input type="text" id="adminStudentSearch" placeholder="Buscar por nome ou email..." oninput="filterStudentsList()" style="width:100%;box-sizing:border-box;">
                        </div>
                        <div id="adminStudentsList">
                            <div class="admin-empty">Carregando...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTs moved to Sistema tab -->

            <!-- TAB: RELATÓRIOS (REBUILT) -->
            <div id="adm-relatorios" class="adm-tab">
                <div class="admin-container">
                    <div class="adm-page-title">
                        <h2>Central de Relatórios</h2>
                        <p>Selecione o período e CT para análise</p>
                    </div>

                    <!-- Date Range + CT Filter -->
                    <div class="rpt-filters">
                        <div class="rpt-date-range">
                            <div class="rpt-date-field">
                                <label>De</label>
                                <input type="date" id="rptDateFrom">
                            </div>
                            <div class="rpt-date-field">
                                <label>Até</label>
                                <input type="date" id="rptDateTo">
                            </div>
                        </div>
                        <div class="rpt-date-field" style="min-width:120px;">
                            <label>CT</label>
                            <select id="rptCTSelect" onchange="_rptFilterCT=this.value">
                                <option value="">Todos os CTs</option>
                            </select>
                        </div>
                        <button class="rpt-generate-btn" onclick="generateReport()">📊 Gerar Relatório</button>
                    </div>

                    <!-- Quick period buttons -->
                    <div class="rpt-quick-bar">
                        <button class="rpt-quick-btn active" onclick="setRptQuickPeriod('hoje',this)">Hoje</button>
                        <button class="rpt-quick-btn" onclick="setRptQuickPeriod('semana',this)">Semana</button>
                        <button class="rpt-quick-btn" onclick="setRptQuickPeriod('mes',this)">Mês</button>
                        <button class="rpt-quick-btn" onclick="setRptQuickPeriod('ano',this)">Ano</button>
                    </div>

                    <div id="rptLoading" class="admin-empty" style="display:none;">Carregando relatório...</div>
                    <div id="rptContent" style="display:none;">

                        <!-- Summary -->
                        <div class="rpt-header">
                            <div class="rpt-header-title">📋 Relatório</div>
                            <div class="rpt-header-date" id="rptPeriodLabel"></div>
                        </div>

                        <div class="admin-stats" id="rptSummaryStats"></div>

                        <!-- 🚨 ALERTS (5+ faltas) -->
                        <div class="admin-section" id="rptAlertSection" style="display:none;">
                            <div class="admin-section-header">
                                <div class="admin-section-title">🚨 Alertas · Alunos com 5+ Faltas</div>
                            </div>
                            <div id="rptAlerts" class="rpt-mini-list"></div>
                        </div>

                        <!-- 📊 Presença por Horário -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">📊 Presença por Horário</div>
                            </div>
                            <div id="rptHourlySummary"></div>
                        </div>

                        <!-- ❌ Faltas Acumuladas -->
                        <div class="admin-section">
                            <div class="rpt-section-toggle open" onclick="toggleRptSection(this)">
                                <div class="rpt-section-toggle-left">
                                    <span>❌</span>
                                    <span class="rpt-section-toggle-title">Faltas Acumuladas <span class="admin-badge" style="background:rgba(232,93,93,0.15);color:#f87171;" id="rptFaltasBadge">0</span></span>
                                </div>
                                <span class="rpt-section-toggle-arrow">▶</span>
                            </div>
                            <div id="rptFaltasList" class="rpt-chamada"></div>
                        </div>

                        <!-- 🏢 Check-ins por CT -->
                        <div class="admin-section">
                            <div class="admin-section-title">🏢 Check-ins por CT</div>
                            <div id="rptCTChart" class="rpt-chart-area"></div>
                        </div>

                        <!-- Insights -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">⚠️ Em Risco (15-30 dias)</div>
                            </div>
                            <div id="rptRisk" class="rpt-mini-list"></div>
                        </div>
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">🔴 Inativos (+30 dias)</div>
                            </div>
                            <div id="rptInactive" class="rpt-mini-list"></div>
                        </div>
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">🥋 Elegíveis para Promoção</div>
                            </div>
                            <div id="rptPromo" class="rpt-mini-list"></div>
                        </div>

                        <!-- Export -->
                        <div style="margin-top:16px;text-align:center;padding-bottom:12px;">
                            <button class="admin-btn approve" onclick="exportReportCSV()" style="min-width:200px;">📥 Exportar CSV</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: PRÊMIOS CONFIG -->
            <div id="adm-campeonato" class="adm-tab">
                <div class="admin-container">
                    <div class="adm-page-title">
                        <h2>Campeonato de Borrachinha</h2>
                        <p>Placar, campeões e edições</p>
                    </div>

                    <!-- CAMPEONATO ADMIN -->
                    <div>

                        <!-- PLACAR BORRACHINHAS -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">🔵 Placar de Borrachinhas (por CT)</div>
                                <button class="adm-refresh-btn" onclick="loadCampPlacarAdmin()">↻</button>
                            </div>
                            <div style="padding:12px;">
                                <div class="ct-detail-row">
                                    <div class="ct-detail-field">
                                        <label>📅 Edição</label>
                                        <select id="campPlacarEdicao" onchange="loadCampPlacarAdmin()">
                                            <option value="">Selecione</option>
                                        </select>
                                    </div>
                                    <div class="ct-detail-field">
                                        <label>📍 CT</label>
                                        <select id="campPlacarCT" onchange="onCampPlacarCTChange()">
                                            <option value="">Selecione o CT</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="ct-detail-row">
                                    <div class="ct-detail-field">
                                        <label>🏷️ Categoria</label>
                                        <select id="campPlacarCategoria" onchange="loadCampPlacarAdmin()">
                                            <option value="Masculino">Masculino</option>
                                            <option value="Feminino">Feminino</option>
                                        <option value="Misto">Misto</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="margin:12px 0 8px;font-size:12px;font-weight:700;color:var(--text-2);">Selecione Edição + CT para gerenciar o placar daquele CT:</div>

                                <!-- Adicionar aluno ao placar -->
                                <div class="ct-detail-row" style="margin-bottom:10px;">
                                    <div class="ct-detail-field" style="flex:2;">
                                        <label>Adicionar Aluno</label>
                                        <select id="campPlacarAddAluno">
                                            <option value="">Selecione aluno</option>
                                        </select>
                                    </div>
                                    <div class="ct-detail-field" style="flex:0 0 auto; align-self:flex-end;">
                                        <button type="button" onclick="addAlunoPlacar()" style="padding:10px 16px;background:rgba(212,175,55,0.15);border:1px solid rgba(212,175,55,0.3);color:var(--gold);border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;">+ Adicionar</button>
                                    </div>
                                </div>

                                <!-- Lista de participantes com inputs -->
                                <div id="campPlacarRows" style="margin-bottom:12px;"></div>

                                <div id="campPlacarMessage" style="margin:8px 0;"></div>
                                <button class="ct-schedule-save" onclick="saveCampPlacar()" style="width:100%;padding:14px;font-size:14px;border-radius:12px;">🔵 Salvar Placar</button>
                            </div>
                        </div>

                        <!-- CADASTRAR CAMPEÕES -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">🏅 Cadastrar Campeões</div>
                                <button class="adm-refresh-btn" onclick="loadChampionsAdmin()">↻</button>
                            </div>

                            <div style="padding:12px;">
                                <div class="ct-detail-row">
                                    <div class="ct-detail-field" style="flex:1;">
                                        <label>📅 Edição</label>
                                        <select id="campEdicao">
                                            <option value="">Selecione</option>
                                        </select>
                                    </div>
                                    <div class="ct-detail-field" style="flex:1;">
                                        <label>🏷️ Categoria</label>
                                        <select id="campCategoria">
                                            <option value="Masculino">Masculino</option>
                                            <option value="Feminino">Feminino</option>
                                        <option value="Misto">Misto</option>
                                        </select>
                                    </div>
                                </div>

                                <div style="margin:14px 0 8px;font-size:13px;font-weight:700;color:var(--text-2);">🏆 Campeões Locais (por CT)</div>
                                <div id="campLocalFields"></div>
                                <button type="button" onclick="addCampLocalField()" style="background:none;border:1px dashed rgba(255,255,255,0.15);color:var(--text-3);font-size:12px;padding:8px;width:100%;border-radius:8px;cursor:pointer;margin-bottom:14px;">+ Adicionar Campeão Local</button>

                                <div style="margin:14px 0 8px;font-size:13px;font-weight:700;color:var(--gold);">👑 Campeão Geral</div>
                                <div class="ct-detail-row">
                                    <div class="ct-detail-field">
                                        <label>Nome</label>
                                        <input type="text" id="campGeralNome" placeholder="Nome do campeão geral">
                                    </div>
                                    <div class="ct-detail-field">
                                        <label>CT</label>
                                        <select id="campGeralCT"></select>
                                    </div>
                                </div>
                                <div class="ct-detail-row">
                                    <div class="ct-detail-field">
                                        <label>Faixa</label>
                                        <select id="campGeralFaixa">
                                            <option value="Branca">Branca</option>
                                            <option value="Azul">Azul</option>
                                            <option value="Roxa">Roxa</option>
                                            <option value="Marrom">Marrom</option>
                                            <option value="Preta">Preta</option>
                                        </select>
                                    </div>
                                </div>

                                <div id="campSaveMessage" style="margin:10px 0;"></div>
                                <button class="ct-schedule-save" onclick="saveChampions()" style="width:100%;padding:14px;font-size:14px;border-radius:12px;">🏅 Salvar Campeões</button>
                            </div>
                        </div>

                        <!-- Campeões Cadastrados -->
                        <div class="admin-section">
                            <div class="admin-section-header">
                                <div class="admin-section-title">👑 Campeões Cadastrados</div>
                            </div>
                            <div id="campAdminList" style="padding:12px;">
                                <div style="text-align:center;color:var(--text-3);font-size:12px;padding:8px;">Nenhum campeão cadastrado</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- TAB: SISTEMA (Manutenção + CTs + Check-in + Perfil) -->
            <div id="adm-sistema" class="adm-tab">
                <div class="admin-container">
                    <div class="adm-page-title">
                        <h2>Sistema & Manutenção</h2>
                        <p>Saúde do sistema, configurações e perfil</p>
                    </div>

                    <!-- System Health -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🏥 Saúde do Sistema</div>
                            <button class="admin-refresh-btn" onclick="loadSystemHealth()">↻</button>
                        </div>
                        <div id="sysHealthScore" class="sys-health-score" style="display:none;">
                            <div class="sys-health-circle" id="sysHealthCircle"><span id="sysHealthNum">--</span></div>
                            <div class="sys-health-info">
                                <div class="sys-health-label" id="sysHealthLabel">Verificando...</div>
                                <div class="sys-health-time" id="sysHealthTime"></div>
                            </div>
                        </div>
                        <div id="sysHealthStats" class="admin-stats" style="display:none;"></div>
                        <div id="sysHealthIssues"></div>
                    </div>

                    <!-- CTs Management -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🏢 Centros de Treinamento</div>
                            <button class="admin-refresh-btn" onclick="loadCTScheduleAdmin()">↻</button>
                        </div>
                        <div id="adminCTScheduleList"><div class="admin-empty">Carregando...</div></div>
                    </div>

                    <!-- Admin Check-in -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">✍️ Meu Check-in</div>
                        </div>
                        <div class="checkin-profile" style="margin-bottom:16px;">
                            <div class="checkin-avatar" id="admCheckinInitial">P</div>
                            <div class="checkin-info">
                                <div class="checkin-name" id="admDisplayName">-</div>
                                <div class="checkin-meta"><span id="admDisplayFaixa">-</span></div>
                            </div>
                            <div class="checkin-count">
                                <div class="checkin-count-num" id="admDisplayCount">0</div>
                                <div class="checkin-count-label">Treinos</div>
                            </div>
                        </div>
                        <div class="ct-section">
                            <div class="section-title">Onde você treinou?</div>
                            <div class="ct-grid" id="admCtGrid"></div>
                            <div class="selected-ct-bar" id="admSelectedInfo">
                                <span>Academia:</span><span id="admSelectedCT">-</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="adminConfirmAttendance()">✓ Confirmar Presença</button>
                        <div id="admAttendanceMessage"></div>
                    </div>

                    <!-- Admin Profile -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">👤 Meu Perfil</div>
                        </div>
                        <div class="perfil-card" style="margin-bottom:16px;">
                            <div class="perfil-header">
                                <div class="perfil-avatar" id="admPerfilInitial">P</div>
                                <div class="perfil-info">
                                    <div class="perfil-name" id="admPerfilName">-</div>
                                    <div class="perfil-email" id="admPerfilEmail">-</div>
                                    <div style="margin-top:6px;"><span class="admin-checkin-status aprovado">PROFESSOR</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Change Password -->
                    <div class="admin-section">
                        <div class="admin-section-header">
                            <div class="admin-section-title">🔒 Alterar Senha</div>
                        </div>
                        <div class="form-group"><label class="form-label">Senha Atual</label><input type="password" id="admCurrentPw" placeholder="••••••"></div>
                        <div class="form-group"><label class="form-label">Nova Senha</label><input type="password" id="admNewPw" placeholder="Mínimo 6 caracteres"></div>
                        <div class="form-group"><label class="form-label">Confirmar</label><input type="password" id="admConfirmPw" placeholder="Repita a nova senha"></div>
                        <div id="admPwMessage"></div>
                        <button class="btn btn-primary" onclick="adminChangePassword()">🔑 Alterar Senha</button>
                    </div>

                    <!-- Logout -->
                    <button class="perfil-logout-btn" onclick="handleLogout()" style="margin-top:16px;margin-bottom:80px;">🚪 Sair da Conta</button>
                </div>
            </div>

        </div>
        <!-- end adminScreen -->

        </div>
        <!-- end main -->

        <!-- STUDENT BOTTOM NAV -->
        <div class="bnav" id="bottomNav">
            <div class="bnav-inner">
                <button class="bnav-btn active" onclick="switchTab('treino-tab', event)">
                    <span class="bnav-icon">🥋</span>
                    <span class="bnav-label">Treino</span>
                </button>
                <button class="bnav-btn" onclick="switchTab('ranking-tab', event)">
                    <span class="bnav-icon">🏆</span>
                    <span class="bnav-label">Ranking</span>
                </button>
                <button class="bnav-btn" onclick="switchTab('perfil', event)">
                    <span class="bnav-icon">👤</span>
                    <span class="bnav-label">Perfil</span>
                </button>
            </div>
        </div>

        <!-- ADMIN BOTTOM NAV -->
        <div class="bnav" id="adminNav" style="display:none;">
            <div class="bnav-inner">
                <button class="bnav-btn active" onclick="switchAdminTab('adm-painel', event)">
                    <span class="bnav-icon">🏠</span><span class="bnav-label">Painel</span>
                </button>
                <button class="bnav-btn" onclick="switchAdminTab('adm-alunos', event)">
                    <span class="bnav-icon">👥</span><span class="bnav-label">Alunos</span>
                </button>
                <button class="bnav-btn" onclick="switchAdminTab('adm-relatorios', event)">
                    <span class="bnav-icon">📊</span><span class="bnav-label">Relatórios</span>
                </button>
                <button class="bnav-btn" onclick="switchAdminTab('adm-campeonato', event)">
                    <span class="bnav-icon">🏅</span><span class="bnav-label">Camp.</span>
                </button>
                <button class="bnav-btn" onclick="switchAdminTab('adm-sistema', event)">
                    <span class="bnav-icon">🔧</span><span class="bnav-label">Sistema</span>
                </button>
            </div>
        </div>

    </div>
    <!-- end app -->

    <!-- STUDENT EDITOR MODAL (ADMIN) -->
    <div id="stuModal" class="stu-modal-overlay">
        <div class="stu-modal">
            <div class="stu-modal-header">
                <div class="stu-modal-toprow">
                    <button class="stu-modal-back" onclick="closeStuModal()">‹ Voltar</button>
                    <div class="stu-modal-title">Editar Aluno</div>
                    <button class="stu-modal-save" id="stuSaveBtn" onclick="saveStuModal()">Salvar</button>
                </div>
            </div>
            <div class="stu-modal-body">
                <div id="stuModalMsg" class="stu-modal-msg"></div>

                <!-- Hero -->
                <div class="stu-hero">
                    <div class="stu-hero-avatar" id="stuAvatar">?</div>
                    <div class="stu-hero-name" id="stuHeroName">—</div>
                    <div class="stu-hero-email" id="stuHeroEmail">—</div>
                    <div class="stu-hero-stats">
                        <div class="stu-hero-stat">
                            <div class="stu-hero-stat-num" id="stuHeroTreinos">0</div>
                            <div class="stu-hero-stat-lbl">Treinos</div>
                        </div>
                        <div class="stu-hero-stat">
                            <div class="stu-hero-stat-num" id="stuHeroFaixa">—</div>
                            <div class="stu-hero-stat-lbl">Faixa</div>
                        </div>
                        <div class="stu-hero-stat">
                            <div class="stu-hero-stat-num" id="stuHeroCT">—</div>
                            <div class="stu-hero-stat-lbl">CT</div>
                        </div>
                    </div>
                </div>

                <!-- Core -->
                <div class="stu-section">
                    <div class="stu-section-title">🥋 Dados do Aluno</div>
                    <div class="stu-field">
                        <label>Nome Completo</label>
                        <input type="text" id="stuName">
                    </div>
                    <div class="stu-field-row">
                        <div class="stu-field">
                            <label>Faixa</label>
                            <select id="stuFaixa" onchange="updateGrauOptions('stuFaixa','stuGrau')">
                                <option value="Branca">Branca</option>
                                <option value="Cinza">Cinza</option>
                                <option value="Amarela">Amarela</option>
                                <option value="Laranja">Laranja</option>
                                <option value="Verde">Verde</option>
                                <option value="Azul">Azul</option>
                                <option value="Roxa">Roxa</option>
                                <option value="Marrom">Marrom</option>
                                <option value="Preta">Preta</option>
                                <option value="Coral">Coral</option>
                                <option value="Vermelha">Vermelha</option>
                            </select>
                        </div>
                        <div class="stu-field">
                            <label>Grau</label>
                            <select id="stuGrau">
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="stu-field">
                        <label>CT Principal</label>
                        <select id="stuCT" onchange="onStuCTChange()"></select>
                    </div>
                    <div class="stu-field">
                        <label>📅 Dias de Treino</label>
                        <div class="stu-days-row" id="stuDiasGrid">
                            <button type="button" class="stu-day-btn" data-day="seg" onclick="this.classList.toggle('on')">S</button>
                            <button type="button" class="stu-day-btn" data-day="ter" onclick="this.classList.toggle('on')">T</button>
                            <button type="button" class="stu-day-btn" data-day="qua" onclick="this.classList.toggle('on')">Q</button>
                            <button type="button" class="stu-day-btn" data-day="qui" onclick="this.classList.toggle('on')">Q</button>
                            <button type="button" class="stu-day-btn" data-day="sex" onclick="this.classList.toggle('on')">S</button>
                            <button type="button" class="stu-day-btn" data-day="sab" onclick="this.classList.toggle('on')">S</button>
                            <button type="button" class="stu-day-btn" data-day="dom" onclick="this.classList.toggle('on')">D</button>
                        </div>
                        <div class="stu-days-hint" id="stuDiasHint"></div>
                    </div>
                    <div class="stu-toggle-row">
                        <div class="stu-toggle-label">🛡️ Administrador</div>
                        <div class="stu-toggle" id="stuAdminToggle" onclick="this.classList.toggle('on')"></div>
                    </div>
                </div>

                <!-- Personal -->
                <div class="stu-section">
                    <div class="stu-section-title">👤 Informações Pessoais</div>
                    <div class="stu-field-row">
                        <div class="stu-field">
                            <label>Data de Nascimento</label>
                            <input type="date" id="stuNascimento">
                        </div>
                        <div class="stu-field">
                            <label>Gênero</label>
                            <select id="stuGenero">
                                <option value="">—</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                                <option value="Outro">Outro</option>
                                <option value="Prefiro não informar">Prefiro não informar</option>
                            </select>
                        </div>
                    </div>
                    <div class="stu-field">
                        <label>Profissão</label>
                        <input type="text" id="stuProfissao" placeholder="Ex: Engenheiro, Professor...">
                    </div>
                    <div class="stu-field">
                        <label>Bairro / Cidade</label>
                        <input type="text" id="stuBairro" placeholder="Ex: Tijuca - Rio de Janeiro">
                    </div>
                </div>

                <!-- Contact -->
                <div class="stu-section">
                    <div class="stu-section-title">📱 Contato</div>
                    <div class="stu-field-row">
                        <div class="stu-field">
                            <label>Telefone</label>
                            <input type="tel" id="stuTelefone" placeholder="(21) 99999-9999">
                        </div>
                        <div class="stu-field">
                            <label>Instagram</label>
                            <input type="text" id="stuInstagram" placeholder="@usuario">
                        </div>
                    </div>
                    <div class="stu-field">
                        <label>Contato de Emergência</label>
                        <input type="text" id="stuEmergencia" placeholder="Nome — (21) 99999-9999">
                    </div>
                </div>

                <!-- Training -->
                <div class="stu-section">
                    <div class="stu-section-title">🥋 Treino</div>
                    <div class="stu-field-row">
                        <div class="stu-field">
                            <label>Como conheceu</label>
                            <select id="stuOrigem">
                                <option value="">—</option>
                                <option value="Instagram / Redes Sociais">Instagram / Redes Sociais</option>
                                <option value="Indicação de amigo">Indicação de amigo</option>
                                <option value="Google / Pesquisa">Google / Pesquisa</option>
                                <option value="Passando pelo local">Passando pelo local</option>
                                <option value="Evento / Competição">Evento / Competição</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div class="stu-field">
                            <label>Objetivo</label>
                            <select id="stuObjetivo">
                                <option value="">—</option>
                                <option value="Saúde e condicionamento">Saúde</option>
                                <option value="Defesa pessoal">Defesa pessoal</option>
                                <option value="Competição">Competição</option>
                                <option value="Hobby / Lazer">Hobby / Lazer</option>
                                <option value="Disciplina / Foco">Disciplina / Foco</option>
                                <option value="Socializar">Socializar</option>
                                <option value="Faixa preta">Faixa preta</option>
                            </select>
                        </div>
                    </div>
                    <div class="stu-field-row">
                        <div class="stu-field">
                            <label>Horário preferido</label>
                            <select id="stuHorario">
                                <option value="Manhã">Manhã (6h-11:59h)</option>
                                <option value="Noite">Noite (18h-23:59h)</option>
                            </select>
                        </div>
                        <div class="stu-field">
                            <label>Experiência</label>
                            <select id="stuExperiencia">
                                <option value="">—</option>
                                <option value="Nunca treinei">Nunca treinei</option>
                                <option value="Menos de 1 ano">Menos de 1 ano</option>
                                <option value="1-2 anos">1-2 anos</option>
                                <option value="3-5 anos">3-5 anos</option>
                                <option value="5-10 anos">5-10 anos</option>
                                <option value="10+ anos">10+ anos</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Health -->
                <div class="stu-section">
                    <div class="stu-section-title">🏥 Saúde</div>
                    <div class="stu-field">
                        <label>Lesão ou Condição Médica</label>
                        <textarea id="stuSaude" placeholder="Ex: Lesão no joelho, hérnia de disco..."></textarea>
                    </div>
                </div>

                <!-- Graduation Timeline -->
                <div class="stu-section">
                    <div class="stu-section-title">🏆 Linha do Tempo · Graduação</div>
                    <div class="grad-add-form" id="gradAddForm">
                        <select id="gradTipo" onchange="onGradTipoChange()">
                            <option value="grau">🟡 Grau na faixa</option>
                            <option value="faixa">🟣 Graduação de faixa</option>
                        </select>
                        <select id="gradFaixa" onchange="updateGrauOptions('gradFaixa','gradGrau')">
                            <option value="Branca">Branca</option>
                            <option value="Cinza">Cinza</option>
                            <option value="Amarela">Amarela</option>
                            <option value="Laranja">Laranja</option>
                            <option value="Verde">Verde</option>
                            <option value="Azul">Azul</option>
                            <option value="Roxa">Roxa</option>
                            <option value="Marrom">Marrom</option>
                            <option value="Preta">Preta</option>
                        </select>
                        <select id="gradGrau">
                            <option value="0">0º Grau</option>
                            <option value="1">1º Grau</option>
                            <option value="2">2º Grau</option>
                            <option value="3">3º Grau</option>
                            <option value="4">4º Grau</option>
                        </select>
                        <input type="text" id="gradObs" placeholder="Obs (opcional)" style="min-width:100px;">
                        <button class="grad-add-btn" onclick="addGraduacao()">✅ Aprovar</button>
                    </div>
                    <div id="gradTimeline" class="grad-timeline">
                        <div class="grad-empty">Nenhum evento registrado</div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="stu-danger-zone">
                    <button class="stu-delete-btn" id="stuDeleteBtn" onclick="deleteStuFromModal()">🗑️ Excluir Aluno</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BIRTHDAY CELEBRATION MODAL -->
    <div id="bdayOverlay" class="bday-overlay" style="display:none;">
        <div class="bday-glow"></div>
        <div class="bday-card">
            <div class="bday-emoji">🎂</div>
            <div class="bday-title">Feliz Aniversário!</div>
            <div class="bday-name" id="bdayName">Aluno</div>
            <div class="bday-stats" id="bdayStats"></div>
            <div class="bday-msg" id="bdayMsg"></div>
            <div class="bday-quote" id="bdayQuote"></div>
            <div class="bday-family">🥋 Obrigado por fazer parte da nossa família!</div>
            <button class="bday-close" onclick="closeBirthday()">Ossú! 🤙</button>
        </div>
    </div>

    <!-- EDIT CHAMPION MODAL -->
    <div id="champEditOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;padding:20px;">
        <div style="background:#1a1a1a;border:1px solid rgba(212,175,55,0.2);border-radius:20px;padding:24px 20px;max-width:360px;width:100%;">
            <div style="font-family:'Sora',sans-serif;font-size:16px;font-weight:800;color:#fff;margin-bottom:16px;">✏️ Editar Campeão</div>
            <input type="hidden" id="champEditRow">
            <div style="margin-bottom:10px;">
                <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">Nome</label>
                <input type="text" id="champEditNome" style="width:100%;padding:10px 12px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <div style="flex:1;">
                    <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">Edição</label>
                    <select id="champEditEdicao" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;"></select>
                </div>
                <div style="flex:1;">
                    <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">Tipo</label>
                    <select id="champEditTipo" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;">
                        <option value="LOCAL">Local</option>
                        <option value="GERAL">Geral</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:8px;margin-bottom:14px;">
                <div style="flex:1;">
                    <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">CT</label>
                    <select id="champEditCT" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;"></select>
                </div>
                <div style="flex:1;">
                    <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">Faixa</label>
                    <select id="champEditFaixa" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;">
                        <option value="Branca">Branca</option>
                        <option value="Azul">Azul</option>
                        <option value="Roxa">Roxa</option>
                        <option value="Marrom">Marrom</option>
                        <option value="Preta">Preta</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom:14px;">
                <label style="font-size:11px;color:var(--text-3);font-weight:600;display:block;margin-bottom:4px;">Categoria</label>
                <select id="champEditCategoria" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;">
                    <option value="Masculino">Masculino</option>
                    <option value="Feminino">Feminino</option>
                                        <option value="Misto">Misto</option>
                </select>
            </div>
            <div id="champEditMessage" style="min-height:18px;margin-bottom:8px;font-size:12px;text-align:center;"></div>
            <div style="display:flex;gap:8px;">
                <button onclick="closeEditChampion()" style="flex:1;padding:12px;border-radius:12px;border:1px solid var(--border);background:none;color:var(--text-2);font-family:'Sora',sans-serif;font-size:13px;font-weight:600;cursor:pointer;">Cancelar</button>
                <button onclick="saveEditChampion()" style="flex:1;padding:12px;border-radius:12px;border:none;background:linear-gradient(135deg,#d4af37,#b8972e);color:#000;font-family:'Sora',sans-serif;font-size:13px;font-weight:700;cursor:pointer;">💾 Salvar</button>
            </div>
        </div>
    </div>

    <!-- MOTIVATION MODAL (Retorno) -->
    <div id="motivOverlay" class="motiv-overlay" style="display:none;">
        <div class="motiv-card">
            <div class="motiv-emoji" id="motivEmoji">🥋</div>
            <div class="motiv-title" id="motivTitle">Sentimos sua falta!</div>
            <div class="motiv-days" id="motivDays"></div>
            <div class="motiv-msg" id="motivMsg"></div>
            <div class="motiv-quote" id="motivQuote"></div>
            <div class="motiv-stat" id="motivStat">
                <div class="motiv-stat-num" id="motivStatNum">0</div>
                <div class="motiv-stat-lbl" id="motivStatLbl">treinos<br>registrados</div>
            </div>
            <br>
            <button class="motiv-cta" id="motivCTA" onclick="closeMotivation(true)">Bora Treinar! 🤙</button>
            <button class="motiv-skip" onclick="closeMotivation(false)">Agora não</button>
        </div>
    </div>

    <!-- AVATAR BUILDER MODAL -->
    <div id="avatarBuilderOverlay" class="avb-overlay" style="display:none;">
        <div class="avb-modal">
            <div class="avb-header">
                <div class="avb-title">😎 Crie seu Avatar</div>
                <button class="avb-close" onclick="closeAvatarBuilder()">✕</button>
            </div>
            <div class="avb-preview-wrap">
                <div class="avb-preview" id="avbPreview"></div>
            </div>
            <div class="avb-tabs" id="avbTabs">
                <button class="avb-tab active" onclick="switchAvbTab('skin',this)">🎨</button>
                <button class="avb-tab" onclick="switchAvbTab('hair',this)">💇</button>
                <button class="avb-tab" onclick="switchAvbTab('eyes',this)">👀</button>
                <button class="avb-tab" onclick="switchAvbTab('mouth',this)">👄</button>
                <button class="avb-tab" onclick="switchAvbTab('acc',this)">🥋</button>
            </div>
            <div class="avb-tab-label" id="avbTabLabel">Cor da Pele</div>
            <div class="avb-options" id="avbOptions"></div>
            <div class="avb-actions">
                <button class="avb-btn-random" onclick="randomAvatar()">🎲 Aleatório</button>
                <button class="avb-btn-save" onclick="saveAvatarBuilder()">✅ Salvar Avatar</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3QEuqI7qkXeHywJR4GVfzQf_g9tblz9bf7kEF8_Nz0dLFedepdjZR0AUCi5nvBhVe/exec';
        let currentUser = null;
        let selectedCT = null;
        let allCTs = [];
        let ctSchedules = {}; // { 'CT Goodfellas': { seg: true, ter: false, ... } }
        let currentRankingPeriod = 'mes';
        let currentRankingFilter = 'geral';
        let allRankingData = null;

        // =================================================================
        // 🔒 SECURITY MODULE
        // =================================================================
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#x27;');
        }

        async function secureFetch(action, payload) {
            var token = getSessionToken();
            if (!token && ['login','requestAccount','getCTsList','requestPasswordReset'].indexOf(action) === -1) {
                handleSessionExpired();
                throw new Error('Sessão expirada');
            }
            var body = Object.assign({}, payload || {}, { action: action });
            if (token) body.token = token;
            var response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(body) });
            var data = await response.json();
            if (data.unauthorized === true) { handleSessionExpired(); throw new Error('Sessão expirada'); }
            if (data.forbidden === true) { alert('⛔ Sem permissão'); throw new Error('Permissão negada'); }
            return data;
        }

        function getSessionToken() {
            try {
                var session = JSON.parse(localStorage.getItem('bjjSession') || 'null');
                if (!session || !session.token) return null;
                if (session.expiresAt && Date.now() > session.expiresAt) { clearSession(); return null; }
                return session.token;
            } catch(e) { return null; }
        }

        function setSessionToken(token) {
            localStorage.setItem('bjjSession', JSON.stringify({ token: token, expiresAt: Date.now() + 86400000 }));
        }

        function clearSession() {
            localStorage.removeItem('bjjUser');
            localStorage.removeItem('bjjProfile');
            localStorage.removeItem('bjjSession');
            currentUser = null;
        }

        function handleSessionExpired() {
            clearSession();
            alert('Sua sessão expirou. Faça login novamente.');
            location.reload();
        }


        // ===== UTILS =====
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = '<div class="msg ' + escapeHtml(type) + '">' + message + '</div>';
        }

        // ===== INIT =====
        window.addEventListener('load', function() {
            const s = localStorage.getItem('bjjUser');
            if (s) {
                try {
                    if (!getSessionToken()) { clearSession(); return; }
                    currentUser = JSON.parse(s);
                    showAppScreen();
                    loadAttendanceInfo();
                    loadCTs();
                    checkMotivation(currentUser);
                    // Restore avatar immediately from localStorage
                    loadAvatarFromData(null);
                    // Carregar perfil do cache e atualizar do backend
                    var cached = localStorage.getItem('bjjProfile');
                    if (cached) {
                        try {
                            var cachedProfile = JSON.parse(cached);
                            fillProfileFields(cachedProfile);
                            checkBirthday(cachedProfile);
                        } catch(e2) {}
                    }
                    fetchProfileFromBackend();
                } catch(e) {
                    clearSession();
                }
            }
        });

        // ===== AUTH =====
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            showMessage('loginMessage', 'Conectando...', 'warning');

            try {
                const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email: email, password: password }) });
                const data = await r.json();
                if (data.authenticated === true) {
                    if (data.token) { setSessionToken(data.token); }
                    var userData = Object.assign({}, data);
                    delete userData.token;
                    currentUser = userData;
                    localStorage.setItem('bjjUser', JSON.stringify(currentUser));
                    showAppScreen();
                    loadAttendanceInfo();
                    loadCTs();
                    checkMotivation(currentUser);
                    fetchProfileFromBackend();
                } else {
                    showMessage('loginMessage', data.message || 'Erro ao fazer login', 'danger');
                }
            } catch (err) {
                showMessage('loginMessage', 'Erro de conexão: ' + err.message, 'danger');
            }
        }

        // ===== PASSWORD UTILITIES =====
        function togglePasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '🙈';
                btn.title = 'Ocultar senha';
            } else {
                input.type = 'password';
                btn.textContent = '👁';
                btn.title = 'Mostrar senha';
            }
        }

        function checkPasswordMatch() {
            const pw = document.getElementById('regPassword').value;
            const confirm = document.getElementById('regPasswordConfirm').value;
            const hint = document.getElementById('passwordMatchHint');
            if (!confirm) { hint.textContent = ''; hint.className = 'password-match-hint'; return; }
            if (pw === confirm) {
                hint.textContent = '✔ Senhas coincidem';
                hint.className = 'password-match-hint match';
            } else {
                hint.textContent = '✘ Senhas não coincidem';
                hint.className = 'password-match-hint no-match';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const regPw = document.getElementById('regPassword');
            const regPwC = document.getElementById('regPasswordConfirm');
            if (regPw) regPw.addEventListener('input', checkPasswordMatch);
            if (regPwC) regPwC.addEventListener('input', checkPasswordMatch);
        });

        async function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const faixa = document.getElementById('regFaixa').value;
            const grau = document.getElementById('regGrau').value;
            const ct = document.getElementById('regCT').value;

            if (password.length < 6) { showMessage('registerMessage', '⚠️ Senha deve ter no mínimo 6 caracteres', 'warning'); return; }
            if (password !== passwordConfirm) { showMessage('registerMessage', '⚠️ As senhas não coincidem', 'warning'); return; }
            if (!ct) { showMessage('registerMessage', '⚠️ Escolha seu CT Principal', 'warning'); return; }
            showMessage('registerMessage', 'Cadastrando...', 'warning');

            try {
                const r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'requestAccount', name, email, password, faixa, grau, ct }) });
                const data = await r.json();
                if (data.success) {
                    showMessage('registerMessage', '✅ Cadastro realizado! Faça login após aprovação.', 'success');
                    setTimeout(() => showLogin(), 2000);
                } else {
                    showMessage('registerMessage', data.message || 'Erro ao cadastrar', 'danger');
                }
            } catch (err) {
                showMessage('registerMessage', 'Erro de conexão', 'danger');
            }
        }

        // ===== NAVIGATION =====
        function isAdmin() {
            return currentUser && (currentUser.admin === true || currentUser.admin === 'TRUE');
        }

        var _currentViewMode = 'admin'; // 'admin' or 'aluno'

        function showAppScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('headerUser').style.display = 'flex';
            document.getElementById('headerUserName').textContent = currentUser.name.split(' ')[0];
            document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();

            if (isAdmin()) {
                // Show mode switcher for admins
                document.getElementById('modeSwitcher').classList.add('visible');
                _currentViewMode = 'admin';
                applyViewMode('admin');
            } else {
                // Student only
                document.getElementById('modeSwitcher').classList.remove('visible');
                _currentViewMode = 'aluno';
                applyViewMode('aluno');
            }
        }

        function switchViewMode(mode) {
            if (mode === _currentViewMode) return;
            _currentViewMode = mode;
            applyViewMode(mode);
        }

        function applyViewMode(mode) {
            var hdr = document.querySelector('.hdr');
            var hdrTitle = document.querySelector('.hdr-title');
            var hdrAvatar = document.querySelector('.hdr-avatar');
            var modeAluno = document.getElementById('modeOptAluno');
            var modeAdmin = document.getElementById('modeOptAdmin');

            if (mode === 'admin') {
                // ADMIN VIEW
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'none';
                document.getElementById('adminScreen').style.display = 'block';
                document.getElementById('adminNav').style.display = 'block';
                document.getElementById('headerSubtitle').innerHTML = 'Administrador <span class="admin-header-badge">ADMIN</span>';
                // Admin header colors
                if (hdr) { hdr.style.background = 'var(--adm-bg-card)'; hdr.style.borderBottomColor = 'var(--adm-border)'; }
                if (hdrTitle) { hdrTitle.style.background = 'linear-gradient(135deg, var(--adm-primary-bright), var(--adm-primary))'; hdrTitle.style.webkitBackgroundClip = 'text'; hdrTitle.style.webkitTextFillColor = 'transparent'; }
                if (hdrAvatar) { hdrAvatar.style.background = 'var(--adm-primary-dim)'; hdrAvatar.style.color = 'var(--adm-primary-bright)'; hdrAvatar.style.borderColor = 'var(--adm-border-accent)'; }
                // Toggle buttons
                if (modeAdmin) { modeAdmin.classList.add('active', 'admin-active'); }
                if (modeAluno) { modeAluno.classList.remove('active'); }
                // Fill admin profile info
                document.getElementById('adminWelcomeName').textContent = currentUser.name.split(' ')[0];
                document.getElementById('admPerfilName').textContent = currentUser.name;
                document.getElementById('admPerfilEmail').textContent = currentUser.email;
                document.getElementById('admPerfilInitial').textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('admCheckinInitial').textContent = currentUser.name.charAt(0).toUpperCase();
                document.getElementById('admDisplayName').textContent = currentUser.name;
                document.getElementById('admDisplayFaixa').textContent = currentUser.faixa;
                document.getElementById('admDisplayCount').textContent = currentUser.treinos || '0';
                // Reset admin tab to painel
                document.querySelectorAll('.adm-tab').forEach(function(t) { t.classList.remove('active'); });
                var painelTab = document.getElementById('adm-painel');
                if (painelTab) painelTab.classList.add('active');
                document.querySelectorAll('#adminNav .bnav-btn').forEach(function(b) { b.classList.remove('active'); });
                var firstAdmBtn = document.querySelector('#adminNav .bnav-btn');
                if (firstAdmBtn) firstAdmBtn.classList.add('active');
                loadAdminPanel();
            } else {
                // STUDENT VIEW
                document.getElementById('adminScreen').style.display = 'none';
                document.getElementById('adminNav').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                document.getElementById('bottomNav').style.display = 'block';
                document.getElementById('headerSubtitle').textContent = 'Checkin';
                // Student header colors (reset)
                if (hdr) { hdr.style.background = ''; hdr.style.borderBottomColor = ''; }
                if (hdrTitle) { hdrTitle.style.background = ''; hdrTitle.style.webkitBackgroundClip = ''; hdrTitle.style.webkitTextFillColor = ''; }
                if (hdrAvatar) { hdrAvatar.style.background = ''; hdrAvatar.style.color = ''; hdrAvatar.style.borderColor = ''; }
                // Toggle buttons
                if (modeAluno) { modeAluno.classList.add('active'); modeAluno.classList.remove('admin-active'); }
                if (modeAdmin) { modeAdmin.classList.remove('active', 'admin-active'); }
                // Load student data
                document.getElementById('checkinInitial').textContent = currentUser.name.charAt(0).toUpperCase();
                // Reset student tab to treino and activate first nav btn
                document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
                document.querySelectorAll('#bottomNav .bnav-btn').forEach(function(b) { b.classList.remove('active'); });
                var treinoTab = document.getElementById('treino-tab');
                if (treinoTab) treinoTab.classList.add('active');
                var firstBtn = document.querySelector('#bottomNav .bnav-btn');
                if (firstBtn) firstBtn.classList.add('active');
            }
        }

        function showLogin() {
            document.getElementById('registerTab').style.display = 'none';
            document.getElementById('forgotTab').style.display = 'none';
            document.getElementById('loginTab').style.display = 'block';
        }

        function showRegister() {
            document.getElementById('loginTab').style.display = 'none';
            document.getElementById('forgotTab').style.display = 'none';
            document.getElementById('registerTab').style.display = 'block';
            loadCTs();
        }

        function showForgotPassword() {
            document.getElementById('loginTab').style.display = 'none';
            document.getElementById('registerTab').style.display = 'none';
            document.getElementById('forgotTab').style.display = 'block';
        }

        async function handleForgotPassword(e) {
            e.preventDefault();
            var email = document.getElementById('forgotEmail').value.trim();
            var senha = document.getElementById('forgotPassword').value;
            var senhaConfirm = document.getElementById('forgotPasswordConfirm').value;

            if (senha !== senhaConfirm) {
                showMessage('forgotMessage', 'As senhas não coincidem', 'error');
                return;
            }
            if (senha.length < 6) {
                showMessage('forgotMessage', 'Senha deve ter no mínimo 6 caracteres', 'error');
                return;
            }

            showMessage('forgotMessage', 'Enviando solicitação...', 'info');
            try {
                var r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'requestPasswordReset', email: email, novaSenha: senha }) });
                var data = await r.json();
                if (data.success) {
                    showMessage('forgotMessage', data.message || 'Solicitação enviada! Aguarde aprovação do Professor.', 'success');
                    document.getElementById('forgotPassword').value = '';
                    document.getElementById('forgotPasswordConfirm').value = '';
                    setTimeout(function() { showLogin(); }, 3000);
                } else {
                    showMessage('forgotMessage', data.message || 'Erro ao solicitar', 'error');
                }
            } catch (err) {
                showMessage('forgotMessage', 'Erro de conexão', 'error');
            }
        }

        function handleLogout() {
            if (confirm('Sair da conta?')) {
                clearSession();
                // Limpar campos do perfil
                for (var i = 0; i < PERFIL_FIELDS.length; i++) {
                    var el = document.getElementById(PERFIL_FIELDS[i].id);
                    if (el) el.value = '';
                }
                document.getElementById('appScreen').style.display = 'none';
                document.getElementById('adminScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('headerUser').style.display = 'none';
                document.getElementById('bottomNav').style.display = 'none';
                document.getElementById('adminNav').style.display = 'none';
                document.getElementById('headerSubtitle').textContent = 'Checkin';
                // Reset header to default gold theme
                document.querySelector('.hdr').style.background = '';
                document.querySelector('.hdr').style.borderBottomColor = '';
                document.querySelector('.hdr-title').style.background = '';
                document.querySelector('.hdr-title').style.webkitBackgroundClip = '';
                document.querySelector('.hdr-title').style.webkitTextFillColor = '';
                if (document.querySelector('.hdr-avatar')) {
                    document.querySelector('.hdr-avatar').style.background = '';
                    document.querySelector('.hdr-avatar').style.color = '';
                    document.querySelector('.hdr-avatar').style.borderColor = '';
                }
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                showLogin();
            }
        }

        function switchTab(tabName, evt) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#bottomNav .bnav-btn').forEach(b => b.classList.remove('active'));
            var tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            var e = evt || window.event;
            if (e && e.target) {
                var btn = e.target.closest('.bnav-btn');
                if (btn) btn.classList.add('active');
            }

            // Load content for active sub-tabs
            if (tabName === 'treino-tab') {
                var activeSub = tab.querySelector('.subtab-content.active');
                if (activeSub) triggerSubTabLoad(activeSub.id);
            }
            if (tabName === 'ranking-tab') {
                var activeSub = tab.querySelector('.subtab-content.active');
                if (activeSub) triggerSubTabLoad(activeSub.id);
            }
            if (tabName === 'perfil') loadProfile();
        }

        function switchSubTab(parentId, subId, evt) {
            var parent = document.getElementById(parentId);
            if (!parent) return;
            parent.querySelectorAll('.subtab-content').forEach(s => s.classList.remove('active'));
            parent.querySelectorAll('.subtab-btn').forEach(b => b.classList.remove('active'));
            var sub = document.getElementById(subId);
            if (sub) sub.classList.add('active');
            if (evt && evt.target) {
                var btn = evt.target.closest('.subtab-btn');
                if (btn) btn.classList.add('active');
            }
            triggerSubTabLoad(subId);
        }

        function triggerSubTabLoad(subId) {
            if (subId === 'sub-ranking') loadRanking();
            if (subId === 'sub-evolucao') { loadEvolucao(); loadMyGraduacoes(); }
            if (subId === 'sub-presencas') loadPresencas();
            if (subId === 'sub-campeonato') loadChampions();
        }

        

        // ===== CHECK-IN =====
        async function loadCTs() {
            try {
                const data = await secureFetch('getCTsList', {});
                if (data.success && data.cts) {
                    allCTs = data.cts;
                    // Armazenar schedules
                    ctSchedules = {};
                    data.cts.forEach(ct => {
                        if (typeof ct === 'object' && ct.schedule) {
                            ctSchedules[ct.name] = ct.schedule;
                        }
                    });
                    const regCT = document.getElementById('regCT');
                    if (regCT) {
                        data.cts.forEach(ct => {
                            const name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                            if (!Array.from(regCT.options).find(o => o.value === name)) {
                                const opt = document.createElement('option');
                                opt.value = name;
                                opt.textContent = name;
                                regCT.appendChild(opt);
                            }
                        });
                    }
                    const grid = document.getElementById('ctGrid');
                    if (grid) {
                        grid.innerHTML = '';
                        var dayKeys = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
                        var hoje = dayKeys[new Date().getDay()];
                        data.cts.forEach(ct => {
                            const name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                            var schedule = ctSchedules[name];
                            // Se tem schedule configurado, só mostra se hoje tem aula
                            if (schedule) {
                                var temConfig = Object.values(schedule).some(function(v) { return v === true; });
                                if (temConfig && !schedule[hoje]) return; // Pula CT sem aula hoje
                            }
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'ct-btn';
                            btn.textContent = name;
                            btn.addEventListener('click', () => selectCT(name));
                            grid.appendChild(btn);
                        });
                        // Se nenhum CT tem aula hoje
                        if (grid.children.length === 0) {
                            var dayLabels = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                            grid.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:13px;padding:20px;grid-column:1/-1;">😴 Nenhum CT com treino hoje (' + dayLabels[new Date().getDay()] + ')</div>';
                        }
                    }
                    // Check training alarm
                    checkTreinoAlarm(data.cts);
                    // Auto-refresh alarm a cada 60s (countdown, estado)
                    if (!window._alarmInterval) {
                        window._alarmInterval = setInterval(function() {
                            if (allCTs && allCTs.length > 0) checkTreinoAlarm(allCTs);
                        }, 60000);
                    }
                }
            } catch (err) { console.error('Erro CTs:', err); }
        }

        function selectCT(ctName) {
            selectedCT = ctName;
            document.querySelectorAll('.ct-btn').forEach(b => b.classList.remove('selected'));
            event.target?.classList.add('selected');
            document.getElementById('selectedCT').textContent = ctName;
            document.getElementById('selectedInfo').classList.add('active');

            // Avisar se hoje não é dia de treino neste CT
            var schedule = ctSchedules[ctName];
            if (schedule) {
                var dayKeys = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
                var hoje = dayKeys[new Date().getDay()];
                var temConfig = Object.values(schedule).some(function(v) { return v === true; });
                if (temConfig && !schedule[hoje]) {
                    var dayLabels = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
                    var hojeDia = dayLabels[new Date().getDay()];
                    showMessage('attendanceMessage', '⚠️ Hoje (' + hojeDia + ') não é dia de treino no ' + ctName + '. Seu check-in ficará pendente para avaliação do Professor.', 'warning');
                } else {
                    // Limpar mensagem se dia é permitido
                    var msgEl = document.getElementById('attendanceMessage');
                    if (msgEl) msgEl.innerHTML = '';
                }
            }
        }

        // ═══ TREINO ALARM ═══
        // ===== MOTIVATIONAL MESSAGES =====
        var MOTIVATIONAL_CHECKIN = [
            'Treino feito! Cada repetição te torna mais forte. 💪',
            'Ossú! Mais um treino no banco. Consistência vence talento! 🔥',
            'Você apareceu e deu o melhor. Isso já te coloca à frente de muitos! 🥋',
            'Treino registrado! O tatame nunca mente — você evoluiu hoje. 🏆',
            'Mais um dia de evolução. Quem treina junto, cresce junto! 🤝',
            'Mandou bem! A faixa não enrola em quem não aparece. Você apareceu! ⭐',
            'Treino concluído! Cada gota de suor é um investimento em você. 💎',
            'Parabéns pelo treino! Disciplina é fazer mesmo quando não quer. 🎯',
            'Hoje você foi melhor que ontem. E amanhã será melhor que hoje! 📈',
            'Check-in feito! O caminho da faixa preta é um passo de cada vez. 🥇'
        ];

        var MOTIVATIONAL_MISSED = [
            'O tatame sentiu sua falta hoje... Amanhã é dia de voltar! 💪',
            'Perdeu o treino de hoje, mas não perca o de amanhã! 🥋',
            'Sem treino hoje? Tudo bem, descanse e volte com tudo! 🔄',
            'O jiu-jitsu te espera. Não deixe o tatame esfriar! 🔥',
            'Hoje não deu, mas seu compromisso continua. Bora amanhã? 🤙',
            'Quem falta ao treino, o tatame cobra depois. Volte logo! 😤',
            'Não treinou hoje? Lembre: a consistência constrói campeões. ⏰',
            'O treino de hoje era importante... mas o de amanhã também é! 💎'
        ];

        function getRandomMessage(arr) {
            // Usa o dia como seed para mesma mensagem no mesmo dia
            var dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            return arr[dayOfYear % arr.length];
        }

        function fezCheckinHoje() {
            if (!currentUser) return false;
            var uc = currentUser.ultimoCheckin;
            if (!uc) return false;
            var last = new Date(uc);
            if (isNaN(last.getTime())) return false;
            var now = new Date();
            return last.getFullYear() === now.getFullYear() && last.getMonth() === now.getMonth() && last.getDate() === now.getDate();
        }

        function checkTreinoAlarm(cts) {
            var alarm = document.getElementById('treino-alarm');
            if (!alarm) return;
            if (!currentUser) { alarm.style.display = 'none'; return; }

            var dayKeys = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 'sab'];
            var dayLabels = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            var now = new Date();
            var hoje = dayKeys[now.getDay()];
            var hojeName = dayLabels[now.getDay()];
            var nowMin = now.getHours() * 60 + now.getMinutes();

            var icon = document.getElementById('treinoAlarmIcon');
            var title = document.getElementById('treinoAlarmTitle');
            var sub = document.getElementById('treinoAlarmSub');
            var timesDiv = document.getElementById('treinoAlarmTimes');

            // ===== SCAN ALL CTs =====
            var ctsComAulaHoje = []; // { name, horarios, slots[], schedule }
            var allSlots = [];       // merged from all CTs

            for (var i = 0; i < cts.length; i++) {
                var ct = cts[i];
                if (typeof ct === 'string') continue;
                var ctName = ct.name || '';
                var schedule = ct.schedule || {};
                var hasConfig = Object.values(schedule).some(function(v) { return v === true; });
                var temAulaHoje = !hasConfig || schedule[hoje] === true;
                if (!temAulaHoje) continue;

                // Per-day horarios: use today's specific times
                var horarios = '';
                var hpd = ct.horariosPorDia || {};
                if (hpd[hoje]) {
                    horarios = hpd[hoje];
                } else if (hpd._global) {
                    horarios = hpd._global;
                } else {
                    horarios = ct.horarios || '';
                }
                if (horarios.indexOf('1899') > -1 || horarios.indexOf('GMT') > -1) {
                    var mx = horarios.match(/(\d{1,2}):(\d{2}):\d{2}/);
                    if (mx) horarios = (mx[1].length < 2 ? '0' + mx[1] : mx[1]) + ':' + mx[2];
                }

                var ctSlots = [];
                if (horarios) {
                    var parts = horarios.split(',');
                    for (var s = 0; s < parts.length; s++) {
                        var t = parts[s].trim();
                        var pm = t.match(/^(\d{1,2}):(\d{2})$/);
                        if (!pm) continue;
                        var h = parseInt(pm[1]), m = parseInt(pm[2]);
                        var slot = { label: t, startMin: h * 60 + m, endMin: Math.min(h * 60 + m + 300, 1439), ct: ctName };
                        ctSlots.push(slot);
                        allSlots.push(slot);
                    }
                }
                ctsComAulaHoje.push({ name: ctName, horarios: horarios, slots: ctSlots, schedule: schedule });
            }

            allSlots.sort(function(a, b) { return a.startMin - b.startMin; });
            var ctNames = ctsComAulaHoje.map(function(c) { return c.name; });

            // ===== NENHUM CT TEM AULA HOJE → DESCANSO =====
            if (ctsComAulaHoje.length === 0) {
                alarm.style.display = 'flex';
                alarm.className = 'treino-alarm no-train';
                icon.textContent = '😴';
                title.textContent = 'Hoje é dia de descanso';
                sub.textContent = hojeName + ' · Sem treino hoje';

                // Próximo dia com aula em qualquer CT
                var nextDay = '';
                for (var nd = 1; nd <= 7; nd++) {
                    var checkDay = dayKeys[(now.getDay() + nd) % 7];
                    for (var ci = 0; ci < cts.length; ci++) {
                        var c2 = cts[ci];
                        if (typeof c2 === 'string') continue;
                        var sch2 = c2.schedule || {};
                        if (sch2[checkDay]) {
                            nextDay = dayLabels[(now.getDay() + nd) % 7];
                            break;
                        }
                    }
                    if (nextDay) break;
                }
                timesDiv.innerHTML = nextDay ? '<div style="font-size:11px;color:var(--text-3);">Próximo treino: <strong>' + nextDay + '</strong></div>' : '';
                return;
            }

            // ===== TEM AULA HOJE =====
            var ctLabel = ctNames.length === 1 ? ctNames[0] : ctNames.join(' · ');

            // Se nenhum CT tem horários cadastrados, fallback
            if (allSlots.length === 0) {
                alarm.style.display = 'flex';
                alarm.className = 'treino-alarm';
                icon.textContent = '🔔';
                title.textContent = 'Hoje tem treino!';
                sub.textContent = hojeName + ' · ' + ctLabel + ' · Bora pro tatame! 🤙';
                timesDiv.innerHTML = '<div style="font-size:11px;color:rgba(74,222,128,0.4);">Horários não cadastrados</div>';
                return;
            }

            var primeiraAulaMin = allSlots[0].startMin;
            var ultimaJanelaFim = allSlots[allSlots.length - 1].endMin;
            var alertaInicio = primeiraAulaMin - 120;
            var checkinFeito = fezCheckinHoje();

            // ===== ANTES DE 2H DA PRIMEIRA AULA → ESCONDER =====
            if (nowMin < alertaInicio) {
                alarm.style.display = 'none';
                return;
            }

            // ===== APÓS TODAS AS JANELAS → PÓS-TREINO =====
            if (nowMin > ultimaJanelaFim) {
                alarm.style.display = 'flex';
                if (checkinFeito) {
                    alarm.className = 'treino-alarm checked-in';
                    icon.textContent = '🏆';
                    title.textContent = 'Treino concluído!';
                    sub.textContent = getRandomMessage(MOTIVATIONAL_CHECKIN);
                    timesDiv.innerHTML = '<div style="font-size:11px;color:rgba(96,165,250,0.5);">' + hojeName + ' · Total: ' + (currentUser.treinos || 0) + ' treinos</div>';
                } else {
                    alarm.className = 'treino-alarm missed';
                    icon.textContent = '😔';
                    title.textContent = 'Você não treinou hoje';
                    sub.textContent = getRandomMessage(MOTIVATIONAL_MISSED);
                    var nextDay2 = '';
                    for (var nd2 = 1; nd2 <= 7; nd2++) {
                        var cd2 = dayKeys[(now.getDay() + nd2) % 7];
                        for (var ci2 = 0; ci2 < ctsComAulaHoje.length; ci2++) {
                            if (ctsComAulaHoje[ci2].schedule[cd2]) { nextDay2 = dayLabels[(now.getDay() + nd2) % 7]; break; }
                        }
                        if (nextDay2) break;
                    }
                    timesDiv.innerHTML = nextDay2 ? '<div style="font-size:11px;color:rgba(251,191,36,0.5);">Próximo treino: <strong>' + nextDay2 + '</strong></div>' : '';
                }
                return;
            }

            // ===== DENTRO DA JANELA =====
            if (checkinFeito) {
                alarm.style.display = 'flex';
                alarm.className = 'treino-alarm checked-in';
                icon.textContent = '✅';
                title.textContent = 'Presença registrada!';
                sub.textContent = getRandomMessage(MOTIVATIONAL_CHECKIN);
                timesDiv.innerHTML = '<div style="font-size:11px;color:rgba(96,165,250,0.5);">' + hojeName + ' · Total: ' + (currentUser.treinos || 0) + ' treinos</div>';
                return;
            }

            // Alarme ativo - mostrar SÓ a próxima aula
            alarm.style.display = 'flex';
            alarm.className = 'treino-alarm';
            icon.textContent = '🔔';

            // Encontrar próxima aula (visível 2h antes)
            var multiCT = ctsComAulaHoje.length > 1;
            var nextSlot = null;
            for (var ns = 0; ns < allSlots.length; ns++) {
                if (nowMin < allSlots[ns].endMin && nowMin >= allSlots[ns].startMin - 120) {
                    nextSlot = allSlots[ns];
                    break;
                }
            }
            // Se nenhum slot visível (todos >2h), esconder alarme
            if (!nextSlot) {
                alarm.style.display = 'none';
                return;
            }

            var diffMin = nextSlot.startMin - nowMin;
            var nextLabel = nextSlot.label + (multiCT ? ' · ' + nextSlot.ct : '');
            
            if (diffMin > 0) {
                // Contagem regressiva
                var hh = Math.floor(diffMin / 60);
                var mm = diffMin % 60;
                var countdown = hh > 0 ? hh + 'h' + (mm > 0 ? mm + 'min' : '') : mm + 'min';
                title.textContent = 'Hoje tem treino!';
                sub.textContent = '⏱️ Próxima aula em ' + countdown + (multiCT ? ' · ' + nextSlot.ct : '');
            } else {
                // Aula em andamento
                title.textContent = 'Aula em andamento!';
                sub.textContent = '🥋 ' + nextLabel + ' · Bora pro tatame!';
            }

            var timesHtml = '<div class="treino-alarm-time next"><span class="clock-icon">⏰</span> ' + nextLabel + '</div>';
            timesDiv.innerHTML = timesHtml;
        }

        /**
         * Verifica se o check-in está dentro da janela permitida para o CT.
         * Regra: cada horário de aula abre uma janela de 5h para check-in.
         *   - Manhã (ex: 07:30) → check-in 07:30 até 12:30
         *   - Noite  (ex: 19:00) → check-in 19:00 até 00:00
         * Janela máxima: não ultrapassa 23:59 (meia-noite).
         * Se o CT não tem horários configurados, fallback: 06:00–23:59.
         * Retorna { allowed, message, windows }
         */
        function checkCheckinWindow(ctName) {
            var ct = allCTs.find(function(c) { return c.name === ctName; });
            // Use per-day horarios for today
            var hpdStu = (ct && ct.horariosPorDia) ? ct.horariosPorDia : {};
            var dayKeysStu = ['dom','seg','ter','qua','qui','sex','sab'];
            var hojeStu = dayKeysStu[new Date().getDay()];
            var horarios = hpdStu[hojeStu] || hpdStu._global || ((ct && ct.horarios) ? ct.horarios.toString().trim() : '');

            var now = new Date();
            var nowMinutes = now.getHours() * 60 + now.getMinutes();

            // Sem horários configurados → fallback 06:00-23:59
            if (!horarios) {
                if (nowMinutes < 360 || nowMinutes > 1439) {
                    return { allowed: false, message: '⚠️ Check-in disponível apenas das 06:00 às 23:59' };
                }
                return { allowed: true };
            }

            var slots = horarios.split(',');
            var windows = [];

            for (var i = 0; i < slots.length; i++) {
                var t = slots[i].trim();
                var parts = t.match(/^(\d{1,2}):(\d{2})$/);
                if (!parts) continue;
                var h = parseInt(parts[1]);
                var m = parseInt(parts[2]);
                var startMin = h * 60 + m;
                var endMin = Math.min(startMin + 300, 1439); // +5h, cap 23:59
                windows.push({ start: startMin, end: endMin, label: t });
            }

            if (windows.length === 0) {
                if (nowMinutes < 360 || nowMinutes > 1439) {
                    return { allowed: false, message: '⚠️ Check-in disponível apenas das 06:00 às 23:59' };
                }
                return { allowed: true };
            }

            // Verificar se está em alguma janela
            for (var j = 0; j < windows.length; j++) {
                if (nowMinutes >= windows[j].start && nowMinutes <= windows[j].end) {
                    return { allowed: true, matchedSlot: windows[j].label };
                }
            }

            // Fora de todas as janelas - mostrar próxima
            var proximaHoje = null;
            for (var k = 0; k < windows.length; k++) {
                if (windows[k].start > nowMinutes) {
                    if (!proximaHoje || windows[k].start < proximaHoje.start) {
                        proximaHoje = windows[k];
                    }
                }
            }

            var msg = '⚠️ Fora do horário de check-in.';
            if (proximaHoje) {
                msg += '<br>Próxima janela: ' + proximaHoje.label + ' até ' + formatMinutes(proximaHoje.end);
            } else {
                msg += '<br>Janelas de hoje já encerraram.';
            }
            // Listar todas as janelas
            var lista = windows.map(function(w) { return w.label + ' → ' + formatMinutes(w.end); }).join(', ');
            msg += '<br>📋 Horários do CT: ' + lista;

            return { allowed: false, message: msg };
        }

        function formatMinutes(totalMin) {
            var h = Math.floor(totalMin / 60);
            var m = totalMin % 60;
            return (h < 10 ? '0' + h : h) + ':' + (m < 10 ? '0' + m : m);
        }

        function confirmAttendance() {
            if (!selectedCT) { showMessage('attendanceMessage', 'Selecione o CT', 'warning'); return; }

            // ===== VALIDAÇÃO DE JANELA DE CHECK-IN =====
            var windowCheck = checkCheckinWindow(selectedCT);
            if (!windowCheck.allowed) {
                showMessage('attendanceMessage', windowCheck.message, 'warning');
                return;
            }

            showMessage('attendanceMessage', 'Registrando presença...', 'info');

            secureFetch('attendance', {
                email: currentUser.email, name: currentUser.name,
                faixa: currentUser.faixa, grau: currentUser.grau, ct: selectedCT
            }).then(data => {
                if (data.success) {
                    if (data.status === 'APROVADO') {
                        currentUser.treinos = (currentUser.treinos || 0) + 1;
                        currentUser.ultimoCheckin = new Date().toISOString();
                        localStorage.setItem('bjjUser', JSON.stringify(currentUser));
                        document.getElementById('displayCount').textContent = currentUser.treinos;
                        showMessage('attendanceMessage', '✅ Presença registrada com sucesso!', 'success');
                        // Atualizar alarme para estado motivacional
                        if (allCTs && allCTs.length > 0) checkTreinoAlarm(allCTs);
                    } else {
                        showMessage('attendanceMessage', data.message || '⏳ Check-in pendente de aprovação.', 'warning');
                    }
                    selectedCT = null;
                    document.querySelectorAll('.ct-btn').forEach(b => b.classList.remove('selected'));
                    document.getElementById('selectedCT').textContent = '-';
                    document.getElementById('selectedInfo').classList.remove('active');
                    setTimeout(() => document.getElementById('attendanceMessage').innerHTML = '', 5000);
                } else {
                    showMessage('attendanceMessage', data.message || 'Erro', 'danger');
                }
            }).catch(() => showMessage('attendanceMessage', 'Erro de conexão', 'danger'));
        }

        function loadAttendanceInfo() {
            if (currentUser) {
                document.getElementById('displayName').textContent = currentUser.name;
                document.getElementById('displayFaixa').textContent = currentUser.faixa;
                document.getElementById('displayCount').textContent = currentUser.treinos || '0';
            }
        }

        // ===== RANKING =====
        async function loadRanking() {
            // Reset UI
            document.getElementById('rankingMessage').style.display = 'block';
            document.getElementById('rankingMessage').textContent = 'Carregando ranking...';
            document.getElementById('userTrainingSection').style.display = 'none';
            document.getElementById('top3Container').style.display = 'none';
            document.getElementById('top3Container').innerHTML = '';
            document.getElementById('userPositionSection').style.display = 'none';
            document.getElementById('rankingListSection').style.display = 'none';
            document.getElementById('ctRankingContainer').style.display = 'none';
            document.getElementById('ctFilterGrid').innerHTML = '';

            try {
                const data = await secureFetch('getRankingMonth', { email: currentUser.email, period: currentRankingPeriod });
                if (data.success && data.ranking && data.ranking.length > 0) {
                    displayRanking(data.ranking);
                } else {
                    document.getElementById('rankingMessage').textContent = 'Sem dados de ranking';
                }
            } catch (err) {
                document.getElementById('rankingMessage').textContent = 'Erro ao carregar ranking';
            }
        }

        function switchRankingPeriod(period, evt) {
            document.querySelectorAll('.rank-period-btn').forEach(b => b.classList.remove('active'));
            var e = evt || window.event;
            if (e && e.target) { var b = e.target.closest('.rank-period-btn'); if (b) b.classList.add('active'); }
            currentRankingPeriod = period;
            currentRankingFilter = 'geral';
            const label = document.getElementById('userTotalLabel');
            label.textContent = period === 'mes' ? 'treinos este mês' : 'treinos este ano';
            loadRanking();
        }

        function switchRankingFilter(ctName, evt) {
            document.querySelectorAll('.rank-ct-chip').forEach(c => c.classList.remove('active'));
            var e = evt || window.event;
            if (e && e.target) { var c = e.target.closest('.rank-ct-chip'); if (c) c.classList.add('active'); }
            currentRankingFilter = ctName;

            if (ctName === 'geral') {
                document.getElementById('userTrainingSection').style.display = 'block';
                document.getElementById('top3Container').style.display = 'grid';
                document.getElementById('userPositionSection').style.display = null;
                document.getElementById('rankingListSection').style.display = null;
                document.getElementById('ctRankingContainer').style.display = 'none';
                displayGeneralRanking(allRankingData);
            } else {
                document.getElementById('userTrainingSection').style.display = 'none';
                document.getElementById('top3Container').style.display = 'none';
                document.getElementById('userPositionSection').style.display = 'none';
                document.getElementById('rankingListSection').style.display = 'none';
                document.getElementById('ctRankingContainer').style.display = 'block';
                displayCTRanking(allRankingData, ctName);
            }
        }

        function displayRanking(ranking) {
            allRankingData = ranking;
            const ctsSet = new Set();
            ranking.forEach(s => { if (s.treinosPorCT) Object.keys(s.treinosPorCT).forEach(ct => ctsSet.add(ct)); });

            const filterGrid = document.getElementById('ctFilterGrid');
            filterGrid.innerHTML = '';

            const geralChip = document.createElement('button');
            geralChip.className = 'rank-ct-chip geral active';
            geralChip.textContent = '📊 Geral';
            geralChip.onclick = function(e) { switchRankingFilter('geral', e); };
            filterGrid.appendChild(geralChip);

            Array.from(ctsSet).sort().forEach(ct => {
                const chip = document.createElement('button');
                chip.className = 'rank-ct-chip';
                chip.textContent = ct;
                chip.onclick = function(e) { switchRankingFilter(ct, e); };
                filterGrid.appendChild(chip);
            });

            displayGeneralRanking(ranking);
        }

        function displayGeneralRanking(ranking) {
            document.getElementById('rankingMessage').style.display = 'none';

            const userRank = ranking.find(r => r.email.toLowerCase() === currentUser.email.toLowerCase());
            const userPosition = ranking.findIndex(r => r.email.toLowerCase() === currentUser.email.toLowerCase()) + 1;

            // User training cards
            if (userRank && userRank.treinosPorCT && Object.keys(userRank.treinosPorCT).length > 0) {
                const section = document.getElementById('userTrainingSection');
                section.style.display = 'block';
                const grid = document.getElementById('userTrainingGrid');
                grid.innerHTML = '';
                Object.keys(userRank.treinosPorCT).sort().forEach(ct => {
                    const tag = document.createElement('div');
                    tag.className = 'user-ct-tag';
                    tag.innerHTML = '<div class="user-ct-tag-name">' + escapeHtml(ct) + '</div><div class="user-ct-tag-count">' + userRank.treinosPorCT[ct] + '</div>';
                    grid.appendChild(tag);
                });
                document.getElementById('userTotalCount').textContent = userRank.totalTreinos;
            } else {
                document.getElementById('userTrainingSection').style.display = 'none';
            }

            // Top 3
            const top3 = document.getElementById('top3Container');
            top3.innerHTML = '';
            const medals = ['🥇','🥈','🥉'];
            const classes = ['gold','silver','bronze'];
            for (let i = 0; i < Math.min(3, ranking.length); i++) {
                const s = ranking[i];
                let cts = '';
                if (s.treinosPorCT) cts = Object.keys(s.treinosPorCT).map(c => c + ': ' + s.treinosPorCT[c]).join(' | ');
                const card = document.createElement('div');
                card.className = 'podium-card ' + classes[i];
                card.innerHTML = '<div class="podium-medal">' + medals[i] + '</div><div class="podium-name">' + escapeHtml(s.name) + '</div><div class="podium-faixa">' + escapeHtml(s.faixa) + '</div><div class="podium-count">' + escapeHtml(s.totalTreinos) + '</div><div class="podium-ct">' + escapeHtml(s.ctPrincipal) + '</div>' + (cts ? '<div style="font-size:9px;color:var(--text-3);margin-top:4px;">' + escapeHtml(cts) + '</div>' : '');
                top3.appendChild(card);
            }
            top3.style.display = ranking.length > 0 ? 'grid' : 'none';

            // User position (if >3)
            if (userRank && userPosition > 3) {
                const posSection = document.getElementById('userPositionSection');
                posSection.style.display = 'block';
                const nextUser = ranking[userPosition] || null;
                const nextDiff = nextUser ? userRank.totalTreinos - nextUser.totalTreinos : 0;
                let uCts = '';
                if (userRank.treinosPorCT) uCts = Object.keys(userRank.treinosPorCT).map(c => c + ': ' + userRank.treinosPorCT[c]).join(' • ');
                document.getElementById('userPositionCard').innerHTML =
                    '<div><div class="user-pos-rank">#' + userPosition + 'º lugar</div><div class="user-pos-name">' + currentUser.name + '</div><div class="user-pos-meta">' + userRank.faixa + ' • ' + userRank.totalTreinos + ' treinos</div>' + (uCts ? '<div style="font-size:11px;color:var(--text-3);margin-top:4px;">' + uCts + '</div>' : '') + '</div><div><div class="user-pos-next-label">Próximo</div><div class="user-pos-diff">' + (nextDiff > 0 ? '+' : '') + nextDiff + ' treinos</div></div>';
            }

            // 4th+ list
            const listSection = document.getElementById('rankingListSection');
            const list = document.getElementById('rankingList');
            if (ranking.length > 3) {
                listSection.style.display = 'block';
                list.innerHTML = '';
                for (let i = 3; i < ranking.length; i++) {
                    const s = ranking[i];
                    const isMe = s.email.toLowerCase() === currentUser.email.toLowerCase();
                    let cts = '';
                    if (s.treinosPorCT) cts = Object.keys(s.treinosPorCT).map(c => c + ': ' + s.treinosPorCT[c]).join(' • ');
                    const item = document.createElement('div');
                    item.className = 'rank-item' + (isMe ? ' me' : '');
                    item.innerHTML = '<div class="rank-item-left"><div class="rank-pos">#' + (i+1) + '</div><div><div class="rank-name">' + escapeHtml(s.name) + (isMe ? ' ✨' : '') + '</div><div class="rank-detail">' + escapeHtml(s.faixa) + ' • ' + escapeHtml(s.ctPrincipal) + '</div>' + (cts ? '<div style="font-size:10px;color:var(--text-3);margin-top:2px;">' + escapeHtml(cts) + '</div>' : '') + '</div></div><div class="rank-num">' + escapeHtml(s.totalTreinos) + '</div>';
                    list.appendChild(item);
                }
            }
        }

        function displayCTRanking(ranking, ctName) {
            const ctRanking = ranking
                .filter(s => s.treinosPorCT && s.treinosPorCT[ctName] && s.treinosPorCT[ctName] > 0)
                .map(s => ({ ...s, ctTreinos: s.treinosPorCT[ctName] }))
                .sort((a, b) => b.ctTreinos - a.ctTreinos);

            const list = document.getElementById('ctRankingList');
            document.getElementById('ctRankingTitle').textContent = 'Ranking em ' + ctName;
            list.innerHTML = '';

            if (ctRanking.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:20px;">Nenhum aluno treinou neste CT</div>';
                return;
            }

            for (let i = 0; i < ctRanking.length; i++) {
                const s = ctRanking[i];
                const isMe = s.email.toLowerCase() === currentUser.email.toLowerCase();
                const item = document.createElement('div');
                item.className = 'rank-item' + (isMe ? ' me' : '');
                item.innerHTML = '<div class="rank-item-left"><div class="rank-pos">#' + (i+1) + '</div><div><div class="rank-name">' + escapeHtml(s.name) + (isMe ? ' ✨' : '') + '</div><div class="rank-detail">' + escapeHtml(s.faixa) + ' • ' + escapeHtml(s.ctPrincipal) + '</div></div></div><div class="rank-num">' + escapeHtml(s.ctTreinos) + '</div>';
                list.appendChild(item);
            }
        }

        // ===== EVOLUÇÃO =====
        const BELT_CONFIG = {
            'Branca': { order: 0, emoji: '⚪', class: 'branca', next: 'Azul', minMonths: 12, minTreinos: 90 },
            'Azul':   { order: 1, emoji: '🔵', class: 'azul',   next: 'Roxa', minMonths: 24, minTreinos: 200 },
            'Roxa':   { order: 2, emoji: '🟣', class: 'roxa',   next: 'Marrom', minMonths: 24, minTreinos: 300 },
            'Marrom': { order: 3, emoji: '🟤', class: 'marrom', next: 'Preta', minMonths: 18, minTreinos: 200 },
            'Preta':  { order: 4, emoji: '⚫', class: 'preta',  next: null, minMonths: 0, minTreinos: 0 }
        };
        const BELT_ORDER = ['Branca', 'Azul', 'Roxa', 'Marrom', 'Preta'];
        const BELT_ACCUMULATED = { 'Branca': 0, 'Azul': 90, 'Roxa': 290, 'Marrom': 590, 'Preta': 790 };

        /**
         * Updates grau select options based on selected faixa.
         * Preta (IBJJF): 0º-6º Grau
         * Others: 0º-4º Grau
         */
        function updateGrauOptions(faixaSelectId, grauSelectId) {
            var faixaSel = document.getElementById(faixaSelectId);
            var grauSel = document.getElementById(grauSelectId);
            if (!faixaSel || !grauSel) return;
            var faixa = faixaSel.value;
            var currentVal = grauSel.value;
            var maxGrau = faixa === 'Preta' ? 6 : 4;
            var html = '';
            for (var g = 0; g <= maxGrau; g++) {
                html += '<option value="' + g + '">' + g + 'º Grau</option>';
            }
            grauSel.innerHTML = html;
            // Restore value if within range
            if (parseInt(currentVal) <= maxGrau) grauSel.value = currentVal;
        }
        const SEMESTER_MAX_CLASSES = 48;
        const GRAU_MIN_TREINOS = 22;
        const FREQ_MIN_APTO = 75;
        const FREQ_MIN_EVOLUCAO = 60;

        function loadEvolucao() {
            if (!currentUser) return;
            const faixa = currentUser.faixa || 'Branca';
            const grau = parseInt(currentUser.grau) || 0;
            const totalTreinos = parseInt(currentUser.treinos) || 0;
            const treinosSemestre = Math.min(totalTreinos, SEMESTER_MAX_CLASSES);
            const freq = Math.min(SEMESTER_MAX_CLASSES > 0 ? Math.round((treinosSemestre / SEMESTER_MAX_CLASSES) * 100) : 0, 100);
            const avaliacao = currentUser.avaliacaoTecnica || false;
            const compromisso = currentUser.compromisso || false;
            const tempoNaFaixa = currentUser.tempoNaFaixa || 0;

            renderHero(faixa, grau, totalTreinos, treinosSemestre, freq);
            renderSeals(grau, treinosSemestre);
            renderFrequencyNew(freq, treinosSemestre);
            renderFaixaCriteria(faixa, grau, totalTreinos, freq, tempoNaFaixa, avaliacao, compromisso);
            renderIBJJFRoadmap(faixa, grau, totalTreinos);
            renderMotivation(freq);
        }

        function renderHero(faixa, grau, totalTreinos, treinosSemestre, freq) {
            const cfg = BELT_CONFIG[faixa] || BELT_CONFIG['Branca'];
            var maxGrau = faixa === 'Preta' ? 6 : 4;
            document.getElementById('evoHeroBelt').className = 'evo-hero-belt ' + cfg.class;
            document.getElementById('evoHeroTitle').textContent = 'Faixa ' + faixa + ' ' + cfg.emoji;
            document.getElementById('evoHeroSub').textContent = grau + 'º/' + maxGrau + 'º grau' + (faixa === 'Preta' ? ' · IBJJF' : (cfg.next ? ' • Próxima: ' + cfg.next : ' • 🏆 Máxima'));

            const statusEl = document.getElementById('evoHeroStatus');
            if (freq < FREQ_MIN_EVOLUCAO) statusEl.innerHTML = '<div class="evo-hero-status red">🔴 Não apto</div>';
            else if (freq < FREQ_MIN_APTO) statusEl.innerHTML = '<div class="evo-hero-status yellow">🟡 Em evolução</div>';
            else statusEl.innerHTML = '<div class="evo-hero-status green">🟢 Apto</div>';

            document.getElementById('evoStatTreinos').textContent = totalTreinos;
            document.getElementById('evoStatSemestre').textContent = treinosSemestre;
        }

        // IBJJF Preta grau requirements (years at each degree)
        const PRETA_GRAU_ANOS = [0, 3, 3, 3, 5, 5, 5]; // 0º=0, 1º=3a, 2º=3a, 3º=3a, 4º=5a, 5º=5a, 6º=5a
        const PRETA_GRAU_LABELS = ['Faixa Preta', '1º Grau', '2º Grau', '3º Grau', '4º Grau', '5º Grau', '6º Grau'];
        const PRETA_GRAU_TITLES = ['', '', '', 'Mestre', 'Mestre', 'Mestre', 'Coral'];

        function renderSeals(grauAtual, treinosSemestre) {
            const faixa = (currentUser && currentUser.faixa) || 'Branca';
            const row = document.getElementById('evoSealsRow');
            row.innerHTML = '';

            if (faixa === 'Preta') {
                // IBJJF: 7 seals (0º-6º grau), year-based
                row.style.gridTemplateColumns = 'repeat(7, 1fr)';
                for (let i = 0; i <= 6; i++) {
                    let cls = 'locked', icon = '🔒', prog = '';
                    if (i <= grauAtual) {
                        cls = 'unlocked'; icon = '⭐'; prog = '✅ Conquistado';
                    } else if (i === grauAtual + 1) {
                        cls = 'current-target'; icon = '🎯'; prog = PRETA_GRAU_ANOS[i] + ' anos mín.';
                    } else {
                        cls = 'locked'; icon = '🔒'; prog = PRETA_GRAU_ANOS[i] + ' anos mín.';
                    }

                    var title = PRETA_GRAU_TITLES[i];
                    var labelHtml = PRETA_GRAU_LABELS[i] + (title ? '<br><span style="font-size:9px;color:var(--accent);">' + title + '</span>' : '');

                    const seal = document.createElement('div');
                    seal.className = 'evo-seal';
                    seal.innerHTML = '<div class="evo-seal-circle ' + cls + '">' + icon + '</div><div class="evo-seal-label ' + (i <= grauAtual ? 'unlocked' : '') + '">' + labelHtml + '</div><div class="evo-seal-progress">' + prog + '</div>';
                    row.appendChild(seal);
                }
            } else {
                // Standard: 5 seals (0º-4º grau), treino-based
                row.style.gridTemplateColumns = 'repeat(5, 1fr)';
                const reqs = [0, GRAU_MIN_TREINOS, GRAU_MIN_TREINOS*2, GRAU_MIN_TREINOS*3, GRAU_MIN_TREINOS*4];

                for (let i = 0; i <= 4; i++) {
                    const min = reqs[i];
                    const hasEnoughTreinos = treinosSemestre >= min;
                    const isReady = hasEnoughTreinos && i > grauAtual;
                    const progress = Math.min(treinosSemestre, min);

                    let cls = 'locked', icon = '🔒', lbl = '', prog = '';
                    if (hasEnoughTreinos && !isReady) {
                        cls = 'unlocked'; icon = '⭐'; lbl = 'unlocked'; prog = '✅ Conquistado';
                    } else if (isReady) {
                        cls = 'current-target'; icon = '✅'; lbl = 'current-target'; prog = '🎉 Apto!';
                    } else {
                        cls = 'locked'; icon = '🔒'; lbl = ''; prog = progress + '/' + min;
                    }

                    const seal = document.createElement('div');
                    seal.className = 'evo-seal';
                    seal.innerHTML = '<div class="evo-seal-circle ' + cls + '">' + icon + '</div><div class="evo-seal-label ' + lbl + '">' + i + 'º Grau</div><div class="evo-seal-progress">' + prog + '</div>';
                    row.appendChild(seal);
                }
            }
        }

        function renderFrequencyNew(freq, treinosSemestre) {
            const cls = freq < FREQ_MIN_EVOLUCAO ? 'red' : freq < FREQ_MIN_APTO ? 'yellow' : 'green';
            const pctEl = document.getElementById('evoFreqPct');
            pctEl.textContent = freq + '%';
            pctEl.className = 'evo-freq-pct ' + cls;
            const barEl = document.getElementById('evoFreqBarFill');
            barEl.className = 'evo-freq-bar-fill ' + cls;
            setTimeout(() => { barEl.style.width = Math.min(freq, 100) + '%'; }, 100);
            document.getElementById('evoFreqDetail').textContent = treinosSemestre + ' de ' + SEMESTER_MAX_CLASSES + ' aulas possíveis';
        }

        function renderFaixaCriteria(faixa, grau, totalTreinos, freq, tempoNaFaixa, avaliacao, compromisso) {
            const cfg = BELT_CONFIG[faixa] || BELT_CONFIG['Branca'];
            if (!cfg.next) {
                document.getElementById('evoFaixaCriteria').style.display = 'none';
                document.getElementById('evoExamBtn').style.display = 'none';
                return;
            }
            document.getElementById('evoFaixaCriteriaTitle').textContent = faixa + ' → ' + cfg.next;

            const criteria = [
                { label: '4º grau completo', detail: grau + 'º/4º grau', pass: grau >= 4 },
                { label: 'Tempo mínimo ' + cfg.minMonths + ' meses', detail: tempoNaFaixa + '/' + cfg.minMonths + ' meses', pass: tempoNaFaixa >= cfg.minMonths },
                { label: 'Mínimo ' + cfg.minTreinos + ' treinos', detail: totalTreinos + '/' + cfg.minTreinos, pass: totalTreinos >= cfg.minTreinos },
                { label: 'Frequência ≥ 75%', detail: freq + '%', pass: freq >= 75 },
                { label: 'Avaliação técnica', detail: avaliacao ? 'Aprovada' : 'Pendente', pass: avaliacao, pending: !avaliacao },
                { label: 'Compromisso validado', detail: compromisso ? 'Validado' : 'Pendente', pass: compromisso, pending: !compromisso }
            ];

            const passCount = criteria.filter(c => c.pass).length;
            document.getElementById('evoFaixaProgress').textContent = passCount + '/' + criteria.length;

            const listEl = document.getElementById('evoFaixaCriteriaList');
            listEl.innerHTML = '';
            criteria.forEach(c => {
                const st = c.pass ? 'pass' : (c.pending ? 'pending' : 'fail');
                const icon = c.pass ? '✓' : (c.pending ? '⏳' : '✗');
                listEl.innerHTML += '<div class="evo-criteria-item"><div class="evo-criteria-check ' + st + '">' + icon + '</div><div class="evo-criteria-text"><div class="evo-criteria-label">' + c.label + '</div><div class="evo-criteria-detail">' + c.detail + '</div></div></div>';
            });

            const allPass = grau >= 4 && tempoNaFaixa >= cfg.minMonths && totalTreinos >= cfg.minTreinos && freq >= 75 && avaliacao && compromisso;
            const btn = document.getElementById('evoExamBtn');
            if (allPass) {
                btn.className = 'evo-exam-btn active';
                btn.disabled = false;
                btn.innerHTML = '✅ Apto para Exame de Faixa → ' + cfg.next;
                btn.onclick = () => alert('Parabéns! Você cumpriu todos os critérios. A aprovação e agendamento do exame será feita pelo professor.');
            } else {
                btn.className = 'evo-exam-btn disabled';
                btn.disabled = true;
                btn.innerHTML = '🔒 ' + (criteria.length - passCount) + ' critério(s) pendente(s)';
            }
        }

        /* ===== IBJJF FULL BELT SYSTEM ===== */
        var IBJJF_BELTS = [
            { id: 'branca',  name: 'Branca',  cls: 'branca',  age: '16+', graus: 4, minMonths: 0,  minTreinos: 0 },
            { id: 'azul',    name: 'Azul',    cls: 'azul',    age: '16+', graus: 4, minMonths: 24, minTreinos: 90 },
            { id: 'roxa',    name: 'Roxa',    cls: 'roxa',    age: '16+', graus: 4, minMonths: 24, minTreinos: 200 },
            { id: 'marrom',  name: 'Marrom',  cls: 'marrom',  age: '18+', graus: 4, minMonths: 18, minTreinos: 300 },
            { id: 'preta',   name: 'Preta',   cls: 'preta',   age: '19+', graus: 6, minMonths: 36, minTreinos: 200 }
        ];

        var FAIXA_TO_IBJJF = { 'Branca': 'branca', 'Azul': 'azul', 'Roxa': 'roxa', 'Marrom': 'marrom', 'Preta': 'preta' };

        function renderIBJJFRoadmap(faixaAtual, grauAtual, totalTreinos) {
            var track = document.getElementById('ibjjfTrack');
            var fillEl = document.getElementById('ibjjfTrackFill');
            track.innerHTML = '';
            track.appendChild(fillEl);

            var currentId = FAIXA_TO_IBJJF[faixaAtual] || 'branca';
            var currentIdx = -1;
            for (var ai = 0; ai < IBJJF_BELTS.length; ai++) { if (IBJJF_BELTS[ai].id === currentId) { currentIdx = ai; break; } }
            var nextIdx = currentIdx + 1;

            var completedNodes = 0;

            for (var i = 0; i < IBJJF_BELTS.length; i++) {
                var belt = IBJJF_BELTS[i];

                var state = 'future';
                if (i < currentIdx) state = 'completed';
                else if (i === currentIdx) state = 'current';
                else if (i === nextIdx) state = 'next';

                if (state === 'completed' || state === 'current') completedNodes++;

                var node = document.createElement('div');
                node.className = 'ibjjf-node ' + state;

                var h = '<div class="ibjjf-node-inner">';
                h += '<div class="ibjjf-belt-band ' + belt.cls + '"></div>';
                h += '<div class="ibjjf-belt-info">';
                h += '<div class="ibjjf-belt-name">' + belt.name + '</div>';

                var meta = [];
                if (belt.age) meta.push('Idade: ' + belt.age);
                if (belt.minMonths > 0) meta.push('min ' + belt.minMonths + ' meses');
                if (belt.minTreinos > 0) meta.push(belt.minTreinos + ' treinos');
                h += '<div class="ibjjf-belt-meta">' + meta.join(' · ') + '</div>';
                h += '</div>';

                h += '<div class="ibjjf-belt-badges">';
                if (state === 'current') {
                    var maxG = belt.graus || 4;
                    h += '<div class="ibjjf-grau-dots">';
                    for (var g = 0; g < maxG; g++) {
                        h += '<div class="ibjjf-grau-dot' + (g < grauAtual ? ' filled' : '') + '"></div>';
                    }
                    h += '</div>';
                    h += '<div class="ibjjf-status-tag here" style="margin-left:8px">VOCÊ</div>';
                } else if (state === 'next') {
                    h += '<div class="ibjjf-status-tag goal">META</div>';
                } else if (state === 'completed') {
                    h += '<div class="ibjjf-status-tag done">✓</div>';
                }
                h += '</div></div>';

                node.innerHTML = h;
                track.appendChild(node);
            }

            var fillPct = IBJJF_BELTS.length > 0 ? Math.round((completedNodes / IBJJF_BELTS.length) * 100) : 0;
            setTimeout(function() { fillEl.style.height = Math.min(fillPct, 100) + '%'; }, 200);

            var overallPct = 0;
            if (currentIdx >= 0) {
                overallPct = Math.round((currentIdx / (IBJJF_BELTS.length - 1)) * 100);
                if (currentIdx < IBJJF_BELTS.length - 1) {
                    var cfg = BELT_CONFIG[faixaAtual];
                    if (cfg && cfg.minTreinos > 0) {
                        var segPct = Math.round((1 / (IBJJF_BELTS.length - 1)) * 100);
                        overallPct += Math.round(Math.min(totalTreinos / cfg.minTreinos, 0.99) * segPct);
                    }
                }
            }
            overallPct = Math.min(overallPct, 100);
            document.getElementById('ibjjfOverallPct').textContent = overallPct + '%';
            setTimeout(function() { document.getElementById('ibjjfOverallFill').style.width = overallPct + '%'; }, 300);
        }

        function renderMotivation(freq) {
            const iconEl = document.getElementById('evoMotivation').querySelector('.evo-motivation-icon');
            const textEl = document.getElementById('evoMotivationText');
            const subEl = document.getElementById('evoMotivationSub');
            if (freq >= 75) { iconEl.textContent = '🔥'; textEl.textContent = '"Consistência constrói campeões."'; subEl.textContent = 'Sua dedicação está no caminho certo!'; }
            else if (freq >= 60) { iconEl.textContent = '💪'; textEl.textContent = '"Você está perto. Continue firme."'; subEl.textContent = 'Mais alguns treinos e você atinge o objetivo'; }
            else if (freq >= 30) { iconEl.textContent = '🥋'; textEl.textContent = '"A faixa preta é construída nos dias que você quase faltou."'; subEl.textContent = 'Cada treino conta — volte ao tatame'; }
            else { iconEl.textContent = '🌅'; textEl.textContent = '"A jornada de mil milhas começa com um único passo."'; subEl.textContent = 'Nunca é tarde para recomeçar'; }
        }

        // ===== PRESENÇAS (Calendário Mensal) =====
        var _prsData = null;
        var _prsMonth = new Date().getMonth();
        var _prsYear = new Date().getFullYear();
        var _prsSelectedDay = null;

        async function loadPresencas() {
            if (_prsData) { renderPresencas(); return; }
            var grid = document.getElementById('prsCalGrid');
            if (grid) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-3);">Carregando...</div>';
            try {
                var data = await secureFetch('getMyPresencas', {});
                if (data.success) {
                    _prsData = data.records || [];
                    renderPresencas();
                }
            } catch(e) {
                if (grid) grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--coral);">Erro ao carregar</div>';
            }
        }

        function prsChangeMonth(delta) {
            _prsMonth += delta;
            if (_prsMonth > 11) { _prsMonth = 0; _prsYear++; }
            if (_prsMonth < 0) { _prsMonth = 11; _prsYear--; }
            _prsSelectedDay = null;
            document.getElementById('prsDetail').style.display = 'none';
            renderPresencas();
        }

        function renderPresencas() {
            var MESES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            var DIAS_SEMANA = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
            var DAY_KEYS = ['dom','seg','ter','qua','qui','sex','sab'];

            // Title
            document.getElementById('prsMonthTitle').textContent = MESES[_prsMonth] + ' ' + _prsYear;

            // Build attendance map for this month
            var monthKey = _prsYear + '-' + String(_prsMonth + 1).padStart(2, '0');
            var dayMap = {}; // { "15": [{hora, ct}, ...] }
            var ctSet = {};
            var totalMes = 0;

            if (_prsData) {
                for (var i = 0; i < _prsData.length; i++) {
                    var r = _prsData[i];
                    if (r.date && r.date.substring(0, 7) === monthKey) {
                        var dayNum = parseInt(r.date.substring(8, 10));
                        if (!dayMap[dayNum]) dayMap[dayNum] = [];
                        dayMap[dayNum].push({ hora: r.hora, ct: r.ct });
                        if (r.ct) ctSet[r.ct] = true;
                        totalMes++;
                    }
                }
            }

            // Student's training days
            var stuDiasTreino = [];
            if (currentUser && currentUser.diasTreino) {
                stuDiasTreino = currentUser.diasTreino.split(',');
            } else {
                // Fallback: read from profile cache
                try {
                    var cached = JSON.parse(localStorage.getItem('bjjProfile') || '{}');
                    if (cached.diasTreino) stuDiasTreino = cached.diasTreino.split(',');
                } catch(e) {}
            }

            // Calculate expected training days this month
            var daysInMonth = new Date(_prsYear, _prsMonth + 1, 0).getDate();
            var expectedDays = 0;
            var now = new Date();
            for (var ed = 1; ed <= daysInMonth; ed++) {
                var edDate = new Date(_prsYear, _prsMonth, ed);
                if (edDate > now) break;
                var edKey = DAY_KEYS[edDate.getDay()];
                if (stuDiasTreino.indexOf(edKey) !== -1) expectedDays++;
            }

            // Summary
            document.getElementById('prsTotalMes').textContent = totalMes;
            document.getElementById('prsCTsMes').textContent = Object.keys(ctSet).length || (totalMes > 0 ? 1 : 0);
            var freq = expectedDays > 0 ? Math.round(totalMes / expectedDays * 100) : (totalMes > 0 ? 100 : 0);
            document.getElementById('prsFreqMes').textContent = Math.min(freq, 100) + '%';

            // Render calendar grid
            var firstDay = new Date(_prsYear, _prsMonth, 1).getDay();
            // Adjust to start on Monday: 0=Mon...6=Sun
            var startOffset = (firstDay + 6) % 7;
            var html = '';

            // Empty cells before first day
            for (var e = 0; e < startOffset; e++) {
                html += '<div class="prs-day empty"></div>';
            }

            var today = new Date();
            for (var d = 1; d <= daysInMonth; d++) {
                var dt = new Date(_prsYear, _prsMonth, d);
                var dayOfWeek = DAY_KEYS[dt.getDay()];
                var isToday = d === today.getDate() && _prsMonth === today.getMonth() && _prsYear === today.getFullYear();
                var isExpected = stuDiasTreino.indexOf(dayOfWeek) !== -1;
                var hasCheckin = dayMap[d] && dayMap[d].length > 0;
                var isPast = dt < now && !isToday;
                var isFuture = dt > now;

                var cls = 'prs-day';
                if (isToday) cls += ' today';
                if (hasCheckin) {
                    cls += ' present';
                    if (dayMap[d].length > 1) cls += ' multi';
                } else if (isExpected && isPast) {
                    cls += ' missed';
                } else if (isExpected && !isFuture) {
                    cls += ' expected';
                }
                if (_prsSelectedDay === d) cls += ' selected';

                html += '<div class="' + cls + '" onclick="prsSelectDay(' + d + ')">' + d + '</div>';
            }

            document.getElementById('prsCalGrid').innerHTML = html;

            // Monthly list (recent first)
            var listHtml = '<div class="prs-list-title">📋 Registro do mês (' + totalMes + ')</div>';
            var sortedDays = Object.keys(dayMap).map(Number).sort(function(a,b) { return b - a; });
            for (var li = 0; li < sortedDays.length; li++) {
                var ld = sortedDays[li];
                var ldt = new Date(_prsYear, _prsMonth, ld);
                var ldow = DIAS_SEMANA[ldt.getDay()];
                var entries = dayMap[ld];
                for (var le = 0; le < entries.length; le++) {
                    listHtml += '<div class="prs-list-item">' +
                        '<div class="prs-list-date">' + ld + '</div>' +
                        '<div class="prs-list-day">' + ldow + '</div>' +
                        '<div class="prs-list-ct">📍 ' + (entries[le].ct || '—') + '</div>' +
                        '<div class="prs-list-time">🕐 ' + (entries[le].hora || '—') + '</div>' +
                        '</div>';
                }
            }
            if (totalMes === 0) {
                listHtml += '<div style="text-align:center;padding:20px;color:var(--text-3);font-size:12px;">Nenhum treino registrado neste mês</div>';
            }
            document.getElementById('prsList').innerHTML = listHtml;

            // Show detail if day selected
            if (_prsSelectedDay && dayMap[_prsSelectedDay]) {
                prsShowDayDetail(_prsSelectedDay, dayMap[_prsSelectedDay]);
            }
        }

        function prsSelectDay(day) {
            _prsSelectedDay = (_prsSelectedDay === day) ? null : day;
            renderPresencas();
        }

        function prsShowDayDetail(day, entries) {
            var DIAS_SEMANA = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];
            var dt = new Date(_prsYear, _prsMonth, day);
            var detail = document.getElementById('prsDetail');
            var header = document.getElementById('prsDetailHeader');
            var list = document.getElementById('prsDetailList');

            header.textContent = '📅 ' + DIAS_SEMANA[dt.getDay()] + ', ' + day + '/' + (_prsMonth + 1);
            var html = '';
            for (var i = 0; i < entries.length; i++) {
                html += '<div class="prs-detail-item">' +
                    '<div class="prs-detail-time">' + (entries[i].hora || '—') + '</div>' +
                    '<div class="prs-detail-ct">📍 ' + (entries[i].ct || '—') + '</div>' +
                    '<div class="prs-detail-badge">✅ Confirmado</div>' +
                    '</div>';
            }
            if (entries.length === 0) {
                html = '<div style="text-align:center;padding:12px;color:var(--text-3);font-size:12px;">Sem registro neste dia</div>';
            }
            list.innerHTML = html;
            detail.style.display = 'block';
        }

        // ===== GRADUATION TIMELINE =====

        // Admin: tipo change shows/hides grau field
        function onGradTipoChange() {
            var tipo = document.getElementById('gradTipo').value;
            document.getElementById('gradGrau').style.display = (tipo === 'grau') ? '' : 'none';
        }

        // Admin: approve graduation event (direct or pending)
        async function addGraduacao() {
            if (!stuModalEmail) return;
            var tipo = document.getElementById('gradTipo').value;

            var payload = {
                alunoEmail: stuModalEmail,
                tipo: tipo,
                faixa: document.getElementById('gradFaixa').value,
                grau: document.getElementById('gradGrau').value,
                obs: document.getElementById('gradObs').value.trim()
            };

            try {
                var result = await secureFetch('addGraduacao', payload);
                if (result.success) {
                    document.getElementById('gradObs').value = '';
                    loadGraduacoes(stuModalEmail);
                } else {
                    alert(result.message || 'Erro');
                }
            } catch(e) { alert('Erro de conexão'); }
        }

        // Admin: approve a pending event by rowIndex
        async function approveGraduacaoRow(rowIndex) {
            try {
                var result = await secureFetch('addGraduacao', { rowIndex: rowIndex });
                if (result.success) {
                    loadGraduacoes(stuModalEmail);
                } else {
                    alert(result.message || 'Erro');
                }
            } catch(e) { alert('Erro de conexão'); }
        }

        // Admin: reject a pending event
        async function rejectGraduacaoRow(rowIndex) {
            if (!confirm('Rejeitar esta solicitação?')) return;
            try {
                var result = await secureFetch('rejectGraduacao', { rowIndex: rowIndex });
                if (result.success) {
                    loadGraduacoes(stuModalEmail);
                } else {
                    alert(result.message || 'Erro');
                }
            } catch(e) { alert('Erro de conexão'); }
        }

        // Admin: load graduation events for a student
        async function loadGraduacoes(email) {
            var container = document.getElementById('gradTimeline');
            if (!container) return;
            container.innerHTML = '<div class="grad-empty">Carregando...</div>';

            try {
                var data = await secureFetch('getGraduacoes', { alunoEmail: email });
                if (data.success) {
                    renderGradTimeline(container, data.events || []);
                }
            } catch(e) {
                container.innerHTML = '<div class="grad-empty">Erro ao carregar</div>';
            }
        }

        // Render graduation timeline (admin view with approve/reject)
        function renderGradTimeline(container, events) {
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="grad-empty">Nenhum evento registrado</div>';
                return;
            }

            var FAIXA_EMOJI = {
                'Branca':'⬜','Cinza':'🩶','Amarela':'🟨','Laranja':'🟧',
                'Verde':'🟩','Azul':'🟦','Roxa':'🟪','Marrom':'🟫','Preta':'⬛'
            };

            var html = '';
            for (var i = 0; i < events.length; i++) {
                var ev = events[i];
                var isPending = (ev.status === 'PENDENTE');
                var cls = 'grad-event ' + ev.tipo + (isPending ? ' pendente' : '');
                var title = '', icon = '';

                if (ev.tipo === 'inicio') {
                    title = 'Início no Jiu-Jitsu'; icon = '🥋';
                } else if (ev.tipo === 'grau') {
                    title = ev.grau + 'º Grau · Faixa ' + ev.faixa; icon = '🏅';
                } else if (ev.tipo === 'faixa') {
                    title = 'Graduação: Faixa ' + ev.faixa; icon = (FAIXA_EMOJI[ev.faixa] || '🥋');
                }

                var statusBadge = isPending 
                    ? '<span class="grad-status pendente">⏳ PENDENTE</span>'
                    : '<span class="grad-status aprovado">✅ APROVADO</span>';

                html += '<div class="' + cls + '">';
                html += '<div class="grad-date">' + formatGradDate(ev.data) + ' ' + statusBadge + '</div>';
                html += '<div class="grad-title">' + icon + ' ' + title + '</div>';
                if (ev.obs) html += '<div class="grad-obs">"' + escapeHtml(ev.obs) + '"</div>';
                
                if (isPending && ev.rowIndex) {
                    html += '<div class="grad-actions">';
                    html += '<button class="grad-action-btn approve" onclick="approveGraduacaoRow(' + ev.rowIndex + ')">✅ Aprovar</button>';
                    html += '<button class="grad-action-btn reject" onclick="rejectGraduacaoRow(' + ev.rowIndex + ')">✕ Rejeitar</button>';
                    html += '</div>';
                }
                html += '</div>';
            }
            container.innerHTML = html;
        }

        function formatGradDate(dateStr) {
            if (!dateStr) return '—';
            var MESES = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            var parts = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (parts) {
                return parseInt(parts[1]) + ' ' + MESES[parseInt(parts[2])-1] + ' ' + parts[3];
            }
            var parts2 = dateStr.split('-');
            if (parts2.length >= 3) {
                return parseInt(parts2[2]) + ' ' + MESES[parseInt(parts2[1])-1] + ' ' + parts2[0];
            }
            return dateStr;
        }

        // ===== STUDENT GRADUATION TIMELINE =====

        function toggleDeclareForm() {
            var form = document.getElementById('evoDeclareForm');
            var toggle = document.getElementById('evoDeclareToggle');
            if (!form) return;
            var open = form.style.display !== 'none';
            form.style.display = open ? 'none' : 'block';
            if (toggle) toggle.classList.toggle('open', !open);
        }

        function onEvoDeclTipoChange() {
            var tipo = document.getElementById('evoDeclTipo').value;
            document.getElementById('evoDeclGrau').style.display = (tipo === 'grau') ? '' : 'none';
        }

        async function requestGraduacao() {
            var tipo = document.getElementById('evoDeclTipo').value;
            var data = document.getElementById('evoDeclData').value;
            if (!data) { alert('Informe a data'); return; }

            var payload = {
                tipo: tipo,
                faixa: document.getElementById('evoDeclFaixa').value,
                grau: document.getElementById('evoDeclGrau').value,
                data: data,
                obs: ''
            };

            var msg = document.getElementById('evoDeclMsg');
            if (msg) msg.textContent = 'Enviando...';

            try {
                var result = await secureFetch('requestGraduacao', payload);
                if (result.success) {
                    if (msg) { msg.style.color = '#2ecc71'; msg.textContent = '✅ Solicitação enviada! Aguarde aprovação.'; }
                    document.getElementById('evoDeclData').value = '';
                    loadMyGraduacoes();
                } else {
                    if (msg) { msg.style.color = 'var(--coral)'; msg.textContent = result.message || 'Erro'; }
                }
            } catch(e) {
                if (msg) { msg.style.color = 'var(--coral)'; msg.textContent = 'Erro de conexão'; }
            }
        }

        // Student: load own graduation timeline
        async function loadMyGraduacoes() {
            var container = document.getElementById('evoTimelineContent');
            if (!container) return;

            try {
                var data = await secureFetch('getMyGraduacoes', {});
                if (data.success) {
                    var events = data.events || [];
                    
                    // Handle inicio box
                    var inicioEvent = null;
                    for (var i = 0; i < events.length; i++) {
                        if (events[i].tipo === 'inicio') { inicioEvent = events[i]; break; }
                    }
                    
                    var inicioBox = document.getElementById('evoInicioBox');
                    var inicioRow = inicioBox ? inicioBox.querySelector('.evo-inicio-row') : null;
                    var inicioSaved = document.getElementById('evoInicioSaved');
                    
                    if (inicioEvent && inicioEvent.data) {
                        if (inicioRow) inicioRow.style.display = 'none';
                        if (inicioSaved) {
                            inicioSaved.style.display = 'block';
                            var label = inicioBox ? inicioBox.querySelector('.evo-inicio-label') : null;
                            if (label) label.style.display = 'none';
                            document.getElementById('evoInicioSavedText').textContent = 
                                'Início: ' + formatGradDateLong(inicioEvent.data);
                        }
                    }
                    
                    // Filter out inicio for timeline
                    var tlEvents = events.filter(function(e) { return e.tipo !== 'inicio'; });
                    
                    if (tlEvents.length > 0) {
                        renderEvoTimeline(container, tlEvents);
                    } else {
                        container.innerHTML = '<div class="evo-tl-start">Sua jornada será registrada aqui pelo professor 🥋</div>';
                    }
                    
                    checkAptStatus();
                }
            } catch(e) {
                container.innerHTML = '<div class="evo-tl-start">Erro ao carregar timeline</div>';
            }
        }

        function formatGradDateLong(dateStr) {
            if (!dateStr) return '—';
            var MESES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
            var parts = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (parts) {
                return parseInt(parts[1]) + ' de ' + MESES[parseInt(parts[2])-1] + ' de ' + parts[3];
            }
            var parts2 = dateStr.split('-');
            if (parts2.length >= 3) {
                return parseInt(parts2[2]) + ' de ' + MESES[parseInt(parts2[1])-1] + ' de ' + parts2[0];
            }
            return dateStr;
        }

        async function saveMyInicioBJJ() {
            var input = document.getElementById('evoInicioDate');
            if (!input || !input.value) { alert('Selecione a data'); return; }
            
            var btn = document.getElementById('evoInicioBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Salvando...'; }
            
            try {
                var result = await secureFetch('setMyInicioBJJ', { data: input.value });
                if (result.success) {
                    loadMyGraduacoes();
                } else {
                    alert(result.message || 'Erro');
                }
            } catch(e) { alert('Erro de conexão'); }
            
            if (btn) { btn.disabled = false; btn.textContent = 'Salvar'; }
        }

        function editInicioBJJ() {
            var inicioBox = document.getElementById('evoInicioBox');
            if (!inicioBox) return;
            var row = inicioBox.querySelector('.evo-inicio-row');
            var saved = document.getElementById('evoInicioSaved');
            var label = inicioBox.querySelector('.evo-inicio-label');
            if (row) row.style.display = 'flex';
            if (saved) saved.style.display = 'none';
            if (label) label.style.display = 'block';
        }

        function checkAptStatus() {
            var aptMsg = document.getElementById('evoAptMsg');
            var aptText = document.getElementById('evoAptText');
            if (!aptMsg || !aptText) return;
            
            var examBtn = document.getElementById('evoExamBtn');
            if (examBtn && !examBtn.disabled) {
                aptMsg.style.display = 'block';
                aptText.textContent = 'Você atingiu os critérios para o próximo grau!';
            } else {
                aptMsg.style.display = 'none';
            }
        }

        function renderEvoTimeline(container, events) {
            var FAIXA_EMOJI = {
                'Branca':'⬜','Cinza':'🩶','Amarela':'🟨','Laranja':'🟧',
                'Verde':'🟩','Azul':'🟦','Roxa':'🟪','Marrom':'🟫','Preta':'⬛'
            };
            var MESES = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];

            var html = '';
            for (var i = 0; i < events.length; i++) {
                var ev = events[i];
                var isPending = (ev.status === 'PENDENTE');
                var title = '', sub = '', icon = '';

                if (ev.tipo === 'inicio') {
                    title = 'Início da Jornada'; sub = 'Primeiro dia no tatame'; icon = '🥋';
                } else if (ev.tipo === 'grau') {
                    title = ev.grau + 'º Grau · ' + ev.faixa;
                    sub = isPending ? 'Aguardando aprovação do professor' : 'Grau recebido na faixa ' + ev.faixa;
                    icon = '🏅';
                } else if (ev.tipo === 'faixa') {
                    title = 'Faixa ' + ev.faixa;
                    sub = isPending ? 'Aguardando aprovação do professor' : 'Promovido à faixa ' + ev.faixa;
                    icon = (FAIXA_EMOJI[ev.faixa] || '🥋');
                }

                var dateStr = '';
                var dp = (ev.data || '').match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                var d, m, y;
                if (dp) {
                    d = parseInt(dp[1]); m = parseInt(dp[2]) - 1; y = parseInt(dp[3]);
                } else {
                    var dp2 = (ev.data || '').split('-');
                    if (dp2.length >= 3) { y = parseInt(dp2[0]); m = parseInt(dp2[1]) - 1; d = parseInt(dp2[2]); }
                }
                if (d && m !== undefined && y) {
                    dateStr = d + ' de ' + MESES[m] + ' de ' + y;
                    var evDate = new Date(y, m, d);
                    var now = new Date();
                    var diffDays = Math.floor((now - evDate) / (1000*60*60*24));
                    if (diffDays >= 0) {
                        if (diffDays < 30) dateStr += ' · há ' + diffDays + ' dias';
                        else if (diffDays < 365) dateStr += ' · há ' + Math.floor(diffDays/30) + ' meses';
                        else dateStr += ' · há ' + Math.floor(diffDays/365) + ' ano(s)';
                    }
                }

                var statusHtml = isPending 
                    ? '<div class="evo-tl-status pendente">⏳ Aguardando aprovação</div>'
                    : '<div class="evo-tl-status aprovado">✅ Aprovado</div>';

                html += '<div class="evo-tl-event ' + ev.tipo + (isPending ? ' pendente' : '') + '">';
                html += '<div class="evo-tl-icon">' + icon + '</div>';
                html += '<div class="evo-tl-title">' + title + '</div>';
                html += '<div class="evo-tl-sub">' + sub + '</div>';
                html += '<div class="evo-tl-date">📅 ' + dateStr + '</div>';
                if (ev.obs) html += '<div class="evo-tl-obs">"' + escapeHtml(ev.obs) + '"</div>';
                html += statusHtml;
                html += '</div>';
            }
            container.innerHTML = html;
        }

        // ===== PROFILE (Aba Alunos, colunas I-T) =====
        // I:Nascimento|J:Genero|K:Profissao|L:Bairro|M:Telefone|N:Instagram|O:Emergencia|P:Origem|Q:Objetivo|R:Horario|S:Experiencia|T:Saude
        var PERFIL_FIELDS = [
            { id: 'perfilNascimento', key: 'nascimento' },
            { id: 'perfilGenero',     key: 'genero' },
            { id: 'perfilProfissao',  key: 'profissao' },
            { id: 'perfilBairro',     key: 'bairro' },
            { id: 'perfilTelefone',   key: 'telefone' },
            { id: 'perfilInstagram',  key: 'instagram' },
            { id: 'perfilEmergencia', key: 'emergencia' },
            { id: 'perfilOrigem',     key: 'origem' },
            { id: 'perfilObjetivo',   key: 'objetivo' },
            { id: 'perfilHorario',    key: 'horario' },
            { id: 'perfilExperiencia',key: 'experiencia' },
            { id: 'perfilSaude',      key: 'saude' },
            { id: 'perfilAvatarData', key: 'avatar' }
        ];

        function loadProfile() {
            if (!currentUser) return;
            document.getElementById('perfilAvatarInitial').textContent = (currentUser.name || '?')[0].toUpperCase();
            document.getElementById('perfilNome').textContent = currentUser.name || '—';
            document.getElementById('perfilFaixaTag').textContent = (currentUser.faixa || 'Branca') + ' • ' + (currentUser.grau || 0) + 'º/4º grau • ' + (currentUser.treinos || 0) + ' treinos';
            
            // 1) Load avatar from localStorage first
            loadAvatarFromData(null);

            // 2) Load from localStorage cache first (instant)
            var cached = localStorage.getItem('bjjProfile');
            if (cached) {
                try {
                    var cachedProfile = JSON.parse(cached);
                    fillProfileFields(cachedProfile);
                } catch(e) { localStorage.removeItem('bjjProfile'); }
            }
            
            // 3) Then fetch from backend to get latest data
            fetchProfileFromBackend();
            
            document.getElementById('perfilSenhaAtual').value = '';
            document.getElementById('perfilSenhaNova').value = '';
            document.getElementById('perfilSenhaConfirma').value = '';
        }

        function fillProfileFields(p) {
            if (!p) return;
            for (var i = 0; i < PERFIL_FIELDS.length; i++) {
                var f = PERFIL_FIELDS[i];
                var el = document.getElementById(f.id);
                if (!el) continue;
                var val = p[f.key];
                if (val === undefined || val === null) val = '';
                val = val.toString();
                // Convert ISO date to YYYY-MM-DD
                if (f.key === 'nascimento' && val.indexOf('T') > -1) {
                    val = val.substring(0, 10);
                }
                el.value = val;
            }
            // Load avatar if present
            if (p.avatar) {
                loadAvatarFromData(p.avatar);
                localStorage.setItem('bjjAvatar', p.avatar);
            }
            updateProfileCompleteness();
        }

        async function fetchProfileFromBackend() {
            if (!currentUser || !currentUser.email) return;
            try {
                var data = await secureFetch('getProfile', { email: currentUser.email });
                if (data.success && data.profile) {
                    // Cache in localStorage
                    localStorage.setItem('bjjProfile', JSON.stringify(data.profile));
                    fillProfileFields(data.profile);
                    // Store diasTreino in currentUser for calendar
                    if (data.profile.diasTreino) {
                        currentUser.diasTreino = data.profile.diasTreino;
                        localStorage.setItem('bjjUser', JSON.stringify(currentUser));
                    }
                    // Check birthday after profile loads
                    checkBirthday(data.profile);
                }
            } catch (err) { console.error('Erro perfil:', err); }
        }

        // ===== BIRTHDAY CELEBRATION =====
        function checkBirthday(profile) {
            if (!profile || !profile.nascimento) return;
            if (!currentUser) return;

            // Parse birth date
            var nascStr = profile.nascimento.toString();
            if (nascStr.indexOf('T') > -1) nascStr = nascStr.substring(0, 10);
            var parts = nascStr.split('-');
            if (parts.length < 3) return;

            var birthMonth = parseInt(parts[1]);
            var birthDay = parseInt(parts[2]);
            var birthYear = parseInt(parts[0]);

            var now = new Date();
            var todayMonth = now.getMonth() + 1;
            var todayDay = now.getDate();
            var currentYear = now.getFullYear();

            // Is today the birthday?
            if (birthMonth !== todayMonth || birthDay !== todayDay) return;

            // Calculate age
            var idade = currentYear - birthYear;
            var faixa = currentUser.faixa || 'Branca';

            // 10+ mensagens que rotacionam aleatoriamente a cada acesso
            var allMessages = [
                'Mais um ano de vida e mais um capítulo na sua história no tatame. Que venham muitas finalizações nesse novo ciclo!',
                'Hoje é seu dia! A mesma garra que você mostra no treino, a vida celebra com mais um ano de conquistas.',
                'Parabéns, guerreiro(a)! O tatame te moldou e a vida te presenteia com mais um ano de evolução. Ossú!',
                'Cada treino seu é uma vitória. Hoje a maior vitória é celebrar mais um ano de vida. Felicidades!',
                'Neste dia especial, lembre-se: sua presença no tatame inspira mais do que você imagina. Parabéns!',
                'Aniversário de quem vive o Jiu Jitsu é comemorado em dobro: na vida e no tatame. Que dia incrível!',
                'Você prova todo dia que disciplina e paixão andam juntas. Hoje o tatame celebra você. Parabéns!',
                'Mais um ano de quedas, levantadas e superações. Isso é Jiu Jitsu. Isso é a vida. Feliz aniversário!',
                'O Jiu Jitsu ensina que cada dia é uma chance de ser melhor. Hoje você é melhor por mais um ano. Parabéns!',
                'Sua jornada no tatame é feita de suor, respeito e evolução. Que este novo ano multiplique tudo isso!',
                'Treinar com você é um privilégio. Que este aniversário marque o início de grandes conquistas!',
                'A academia inteira celebra com você hoje. Mais um ano de luta, amizade e crescimento. Ossú!'
            ];

            // 10+ citações motivacionais
            var allQuotes = [
                '"A faixa não segura as calças, ela segura sua história de superação."',
                '"Cada ano é uma nova fase. No tatame e na vida, a evolução nunca para."',
                '"Mais um ano de vida, mais um ano de luta. O Jiu Jitsu ensina que cada dia é uma vitória."',
                '"O tatame é onde celebramos cada conquista. Hoje celebramos você!"',
                '"A melhor luta da sua vida é a que você trava consigo mesmo. Parabéns por mais um ano vencendo!"',
                '"No Jiu Jitsu e na vida: consistência, resiliência e humildade."',
                '"Que neste novo ano você conquiste muitos treinos e fortaleça cada vez mais sua base."',
                '"O campeão não é aquele que sempre vence, mas aquele que nunca desiste de lutar."',
                '"Quem treina junto, cresce junto. Obrigado por fazer parte dessa família."',
                '"O tatame é o espelho da vida: te derruba, te ensina e te levanta mais forte."',
                '"Sua maior faixa é a persistência. Continue no caminho, guerreiro!"',
                '"Aniversário é dia de celebrar cada gota de suor que virou conquista."'
            ];

            var msg = allMessages[Math.floor(Math.random() * allMessages.length)];
            var quote = allQuotes[Math.floor(Math.random() * allQuotes.length)];

            // Belt emojis
            var beltEmoji = { 'Branca': '⚪', 'Azul': '🔵', 'Roxa': '🟣', 'Marrom': '🟤', 'Preta': '⚫' };

            showBirthdayCelebration(currentUser.name, idade, 0, faixa, beltEmoji[faixa] || '🥋', msg, quote);
        }

        function showBirthdayCelebration(name, idade, treinos, faixa, beltEmoji, msg, quote) {
            var firstName = name.split(' ')[0];

            // Fill content
            document.getElementById('bdayName').textContent = firstName + '!';
            document.getElementById('bdayMsg').textContent = msg;
            document.getElementById('bdayQuote').textContent = quote;

            // Age card
            if (idade > 0) {
                document.getElementById('bdayStats').innerHTML = '<div class="bday-stat"><div class="bday-stat-num">🎉 ' + idade + ' anos</div></div>';
            } else {
                document.getElementById('bdayStats').innerHTML = '';
            }

            // Show overlay
            var overlay = document.getElementById('bdayOverlay');
            overlay.style.display = 'flex';

            // Generate confetti
            spawnConfetti(overlay);
        }

        function spawnConfetti(container) {
            var colors = ['#d4af37', '#f5d76e', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dfe6e9', '#fd79a8', '#a29bfe', '#00b894', '#e17055'];
            var shapes = ['square', 'circle'];

            for (var i = 0; i < 60; i++) {
                var confetti = document.createElement('div');
                confetti.className = 'bday-confetti';
                var color = colors[Math.floor(Math.random() * colors.length)];
                var size = 6 + Math.random() * 8;
                var left = Math.random() * 100;
                var delay = Math.random() * 3;
                var duration = 3 + Math.random() * 4;
                var shape = shapes[Math.floor(Math.random() * shapes.length)];

                confetti.style.cssText = 'background:' + color + ';width:' + size + 'px;height:' + size + 'px;left:' + left + '%;animation-delay:' + delay + 's;animation-duration:' + duration + 's;' + (shape === 'circle' ? 'border-radius:50%;' : 'border-radius:2px;');
                container.appendChild(confetti);
            }

            // Continuous confetti waves
            var waveCount = 0;
            var waveInterval = setInterval(function() {
                waveCount++;
                if (waveCount > 4) { clearInterval(waveInterval); return; }
                for (var j = 0; j < 20; j++) {
                    var c = document.createElement('div');
                    c.className = 'bday-confetti';
                    var clr = colors[Math.floor(Math.random() * colors.length)];
                    var sz = 6 + Math.random() * 8;
                    c.style.cssText = 'background:' + clr + ';width:' + sz + 'px;height:' + sz + 'px;left:' + (Math.random() * 100) + '%;animation-duration:' + (3 + Math.random() * 4) + 's;' + (Math.random() > 0.5 ? 'border-radius:50%;' : '');
                    container.appendChild(c);
                }
            }, 2000);
        }

        function closeBirthday() {
            var overlay = document.getElementById('bdayOverlay');
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.5s ease';
            setTimeout(function() {
                overlay.style.display = 'none';
                overlay.style.opacity = '';
                overlay.style.transition = '';
                // Remove confetti
                var confettis = overlay.querySelectorAll('.bday-confetti');
                confettis.forEach(function(c) { c.remove(); });
            }, 500);
        }

        // ===== MOTIVATION SYSTEM (Retorno) =====
        // Psicologia: nunca culpar, sempre acolher. Escala gradual de empatia.

        var MOTIV_TIERS = {
            // 7-14 dias: Tom leve, amigável — "ei, bora voltar?"
            tier1: {
                emoji: ['🥋', '💪', '🤙'],
                titles: ['O tatame tá te esperando!', 'Bora voltar?', 'Saudade do treino?'],
                titleClass: 'tier1',
                messages: [
                    'Faz alguns dias que você não aparece. Um treino leve já faz toda a diferença — no corpo e na mente.',
                    'Seu corpo já sabe o caminho. Às vezes a parte mais difícil é só calçar o chinelo e ir. O resto flui.',
                    'Não precisa ser o treino perfeito. Precisa ser o treino. Aparece, respira, move. O tatame faz o resto.',
                    'Sabe aquela sensação depois do treino? De que valeu a pena? Ela tá te esperando.',
                    'Um dia de cada vez. Um treino de cada vez. Seu próximo treino pode ser hoje.'
                ],
                quotes: [
                    '"A disciplina é a ponte entre metas e conquistas." — Jim Rohn',
                    '"Você não precisa de motivação. Precisa de rotina." — Princípio do tatame',
                    '"O campeão treina quando não quer. O iniciante treina quando quer."',
                    '"Consistência vence talento quando talento não é consistente."'
                ],
                cta: 'Bora Treinar! 🤙'
            },

            // 15-30 dias: Tom empático, acolhedor — "a vida acontece"
            tier2: {
                emoji: ['🌱', '🤝', '☀️'],
                titles: ['A vida acontece. O tatame entende.', 'Seu espaço continua aqui.', 'Volta quando puder. Estamos aqui.'],
                titleClass: 'tier2',
                messages: [
                    'Faz um tempinho que você não treina, e tá tudo bem. A vida pede pausas. Mas o tatame sempre vai estar aqui, pronto pra te receber de volta.',
                    'Pausa não é desistência. Todo praticante passa por fases. O importante é que a chama ainda existe — e ela existe, senão você não estaria aqui.',
                    'Não existe "voltar atrasado". Existe voltar. E quem volta depois de uma pausa volta com mais consciência, mais maturidade.',
                    'Talvez a rotina mudou, talvez o corpo pediu descanso, talvez a cabeça precisava de espaço. Tudo válido. E o tatame continua te esperando, sem julgamento.',
                    'O Jiu Jitsu não cobra presença perfeita. Cobra presença honesta. Volta quando sentir. Um treino já recomeça tudo.'
                ],
                quotes: [
                    '"Não é sobre nunca cair. É sobre sempre levantar." — Filosofia do tatame',
                    '"A jornada de mil milhas começa com um único passo." — Lao Tzu',
                    '"Quem volta é mais forte do que quem nunca parou."',
                    '"O tatame é o único lugar onde recomeçar é sempre bem-vindo."'
                ],
                cta: 'Quero Voltar 💪'
            },

            // 31-60 dias: Motivação profunda — identidade + superação
            tier3: {
                emoji: ['🔥', '🏔️', '🌅'],
                titles: ['O mais difícil é voltar. Depois, flui.', 'Sua jornada não parou.', 'Recomeçar é um ato de coragem.'],
                titleClass: 'tier3',
                messages: [
                    'Faz mais de um mês, e sabemos que quanto mais tempo passa, mais pesado fica voltar. Mas essa resistência é só a mente testando você — exatamente como no tatame.',
                    'Você já provou que consegue. Cada treino que fez antes está gravado no seu corpo, na sua memória muscular, na sua história. Nada disso se perdeu.',
                    'A pessoa que volta depois de um mês é mais corajosa do que a que nunca parou. Porque voltar exige humildade, e humildade é o coração do Jiu Jitsu.',
                    'Ninguém vai te julgar. Ninguém vai perguntar onde você estava. O tatame só vai te abraçar de volta. É assim que funciona.',
                    'Você pode estar pensando que perdeu condicionamento, que vai ser difícil. Vai ser diferente. Mas depois do primeiro treino de volta, você vai se perguntar por que esperou tanto.'
                ],
                quotes: [
                    '"A coragem não é ausência de medo. É decidir que algo é mais importante que o medo."',
                    '"Todo mestre já foi um desastre. Todo faixa preta já pensou em desistir."',
                    '"O tatame não mede tempo de ausência. Mede presença de espírito."',
                    '"Recomeçar não é fracasso. É a prova de que você ainda se importa."'
                ],
                cta: 'Vou Recomeçar 🔥'
            },

            // 60+ dias: Identidade + pertencimento — "você ainda é um de nós"
            tier4: {
                emoji: ['❤️', '🥋', '🌟'],
                titles: ['Sua história no tatame não acabou.', 'Você ainda é um de nós.', 'O tatame lembra de você.'],
                titleClass: 'tier4',
                messages: [
                    'Faz um bom tempo. E talvez uma parte de você ache que já era, que o momento passou. Mas não passou. Enquanto você quiser, o tatame é seu.',
                    'A vida levou você pra longe do treino por um tempo. Isso não apaga quem você se tornou no tatame. Cada aula, cada rolo, cada gota de suor — tudo isso ainda é parte de você.',
                    'Não importa se faz dois meses ou dois anos. O dia que você pisar no tatame de novo vai ser o dia mais importante da sua jornada. Porque será a prova de que você não desistiu de si mesmo.',
                    'Sabe o que diferencia quem treina de quem desistiu? Quem desistiu não pensa mais no tatame. Você está aqui. Isso já diz tudo.',
                    'A sua equipe continua aqui. Seu espaço no tatame continua aqui. Não precisa explicar nada. Só precisa aparecer. O resto a gente resolve junto.'
                ],
                quotes: [
                    '"Não é o fim quando você cai. É o fim quando você decide não levantar."',
                    '"O verdadeiro faixa preta não é quem nunca perdeu. É quem nunca desistiu."',
                    '"A maior luta é contra a voz que diz pra não ir. Vença essa, e o treino é bônus."',
                    '"Enquanto houver vontade, haverá caminho. E o caminho passa pelo tatame."'
                ],
                cta: 'Meu Tatame Me Espera ❤️'
            }
        };

        function checkMotivation(userData) {
            if (!userData || !userData.ultimoCheckin) return;

            // Só mostrar uma vez por dia
            var motivKey = 'bjjMotiv_' + new Date().toISOString().slice(0, 10);
            if (localStorage.getItem(motivKey)) return;

            var lastDate = new Date(userData.ultimoCheckin);
            if (isNaN(lastDate.getTime())) return;

            var now = new Date();
            var diffMs = now - lastDate;
            var diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            // Menos de 7 dias = tudo bem, não mostra nada
            if (diffDays < 7) return;

            // Selecionar tier
            var tier;
            if (diffDays <= 14) tier = MOTIV_TIERS.tier1;
            else if (diffDays <= 30) tier = MOTIV_TIERS.tier2;
            else if (diffDays <= 60) tier = MOTIV_TIERS.tier3;
            else tier = MOTIV_TIERS.tier4;

            // Sortear mensagem e quote
            var emoji = tier.emoji[Math.floor(Math.random() * tier.emoji.length)];
            var title = tier.titles[Math.floor(Math.random() * tier.titles.length)];
            var msg = tier.messages[Math.floor(Math.random() * tier.messages.length)];
            var quote = tier.quotes[Math.floor(Math.random() * tier.quotes.length)];

            // Marcar como mostrado hoje
            localStorage.setItem(motivKey, 'true');

            // Delay para não conflitar com birthday
            setTimeout(function() {
                showMotivation(emoji, title, tier.titleClass, diffDays, msg, quote, userData.treinos || 0, tier.cta);
            }, 1500);
        }

        function showMotivation(emoji, title, titleClass, days, msg, quote, treinos, ctaText) {
            document.getElementById('motivEmoji').textContent = emoji;
            var titleEl = document.getElementById('motivTitle');
            titleEl.textContent = title;
            titleEl.className = 'motiv-title ' + titleClass;

            // Texto de dias
            var daysText;
            if (days <= 14) daysText = 'Último treino há ' + days + ' dias';
            else if (days <= 60) daysText = 'Último treino há ' + Math.floor(days / 7) + ' semanas';
            else daysText = 'Último treino há ' + Math.floor(days / 30) + ' meses';
            document.getElementById('motivDays').textContent = daysText;

            document.getElementById('motivMsg').textContent = msg;
            document.getElementById('motivQuote').textContent = quote;

            document.getElementById('motivStatNum').textContent = treinos;
            document.getElementById('motivStatLbl').innerHTML = 'treinos<br>na sua jornada';

            document.getElementById('motivCTA').textContent = ctaText;

            document.getElementById('motivOverlay').style.display = 'flex';
        }

        function closeMotivation(goToCheckin) {
            var overlay = document.getElementById('motivOverlay');
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.4s ease';
            setTimeout(function() {
                overlay.style.display = 'none';
                overlay.style.opacity = '';
                overlay.style.transition = '';
            }, 400);
        }

        function updateProfileCompleteness() {
            var filled = 0;
            for (var i = 0; i < PERFIL_FIELDS.length; i++) {
                var el = document.getElementById(PERFIL_FIELDS[i].id);
                if (el && el.value && el.value.trim() !== '') filled++;
            }
            var pct = Math.round((filled / PERFIL_FIELDS.length) * 100);
            document.getElementById('perfilCompletePct').textContent = pct + '%';
            setTimeout(function() { document.getElementById('perfilCompleteFill').style.width = pct + '%'; }, 100);
        }

        async function saveProfile() {
            if (!currentUser) return;
            var btn = document.getElementById('perfilSaveBtn');
            btn.disabled = true;
            btn.textContent = '⏳ Salvando...';

            var profileData = {};
            for (var i = 0; i < PERFIL_FIELDS.length; i++) {
                var f = PERFIL_FIELDS[i];
                var el = document.getElementById(f.id);
                profileData[f.key] = el ? el.value || '' : '';
            }

            try {
                var data = await secureFetch('saveProfile', { email: currentUser.email, profile: profileData });
                if (data.success) {
                    // Cache locally for persistence
                    localStorage.setItem('bjjProfile', JSON.stringify(profileData));
                    showMessage('perfilMessage', '✅ Perfil salvo com sucesso!', 'success');
                    updateProfileCompleteness();
                } else {
                    showMessage('perfilMessage', '❌ ' + (data.message || data.error || 'Erro ao salvar'), 'danger');
                }
            } catch (err) {
                showMessage('perfilMessage', '❌ Erro de conexão', 'danger');
            }

            btn.disabled = false;
            btn.textContent = '💾 Salvar Perfil';
            setTimeout(function() { document.getElementById('perfilMessage').innerHTML = ''; }, 4000);
        }


        // ═══════ AVATAR BUILDER ═══════
        var AVB_PARTS = {
            skin: {
                label: 'Cor da Pele',
                options: [
                    { id: 's1', color: '#FDDBB4' },
                    { id: 's2', color: '#F1C27D' },
                    { id: 's3', color: '#E0A370' },
                    { id: 's4', color: '#C68642' },
                    { id: 's5', color: '#8D5524' },
                    { id: 's6', color: '#634220' },
                    { id: 's7', color: '#D4A07A' },
                    { id: 's8', color: '#F0C8A0' }
                ]
            },
            hair: {
                label: 'Cabelo',
                options: [
                    { id: 'h0', emoji: '🚫', label: 'Careca' },
                    { id: 'h1', emoji: '👦', label: 'Curto' },
                    { id: 'h2', emoji: '🧑', label: 'Médio' },
                    { id: 'h3', emoji: '🦱', label: 'Cacheado' },
                    { id: 'h4', emoji: '👩‍🦰', label: 'Longo' },
                    { id: 'h5', emoji: '🧔', label: 'Moicano' },
                    { id: 'h6', emoji: '👴', label: 'Ralo' },
                    { id: 'h7', emoji: '🦲', label: 'Raspado' }
                ]
            },
            eyes: {
                label: 'Olhos',
                options: [
                    { id: 'e1', emoji: '😐', label: 'Normal' },
                    { id: 'e2', emoji: '😊', label: 'Feliz' },
                    { id: 'e3', emoji: '😠', label: 'Bravo' },
                    { id: 'e4', emoji: '😴', label: 'Sonolento' },
                    { id: 'e5', emoji: '😎', label: 'Cool' },
                    { id: 'e6', emoji: '😜', label: 'Piscando' },
                    { id: 'e7', emoji: '🤨', label: 'Suspeito' },
                    { id: 'e8', emoji: '🥺', label: 'Pidão' }
                ]
            },
            mouth: {
                label: 'Boca',
                options: [
                    { id: 'm1', emoji: '🙂', label: 'Sorriso' },
                    { id: 'm2', emoji: '😄', label: 'Rindo' },
                    { id: 'm3', emoji: '😐', label: 'Sério' },
                    { id: 'm4', emoji: '😛', label: 'Língua' },
                    { id: 'm5', emoji: '😏', label: 'Safado' },
                    { id: 'm6', emoji: '😮', label: 'Surpreso' },
                    { id: 'm7', emoji: '🤐', label: 'Fechado' },
                    { id: 'm8', emoji: '😬', label: 'Nervoso' }
                ]
            },
            acc: {
                label: 'Acessório',
                options: [
                    { id: 'a0', emoji: '🚫', label: 'Nenhum' },
                    { id: 'a1', emoji: '🥋', label: 'Kimono' },
                    { id: 'a2', emoji: '🩹', label: 'Curativo' },
                    { id: 'a3', emoji: '😤', label: 'Couve-flor' },
                    { id: 'a4', emoji: '🎀', label: 'Faixa cabeça' },
                    { id: 'a5', emoji: '🧢', label: 'Boné' },
                    { id: 'a6', emoji: '🕶️', label: 'Óculos' },
                    { id: 'a7', emoji: '🎧', label: 'Fone' }
                ]
            }
        };

        var avbState = { skin: 's1', hair: 'h1', eyes: 'e1', mouth: 'm1', acc: 'a0' };
        var avbCurrentTab = 'skin';

        function openAvatarBuilder() {
            // Load current avatar data if exists
            var stored = document.getElementById('perfilAvatarData').value;
            if (stored) {
                try { avbState = JSON.parse(stored); } catch(e) {}
            }
            document.getElementById('avatarBuilderOverlay').style.display = 'flex';
            switchAvbTab('skin', document.querySelector('.avb-tab'));
            renderAvbPreview();
        }

        function closeAvatarBuilder() {
            document.getElementById('avatarBuilderOverlay').style.display = 'none';
        }

        function switchAvbTab(tab, btn) {
            avbCurrentTab = tab;
            document.querySelectorAll('.avb-tab').forEach(function(t) { t.classList.remove('active'); });
            if (btn) btn.classList.add('active');
            document.getElementById('avbTabLabel').textContent = AVB_PARTS[tab].label;
            renderAvbOptions();
        }

        function renderAvbOptions() {
            var opts = AVB_PARTS[avbCurrentTab].options;
            var container = document.getElementById('avbOptions');
            var html = '';
            for (var i = 0; i < opts.length; i++) {
                var o = opts[i];
                var sel = avbState[avbCurrentTab] === o.id ? ' selected' : '';
                if (avbCurrentTab === 'skin') {
                    html += '<div class="avb-opt' + sel + '" onclick="selectAvbOpt(\'' + avbCurrentTab + '\',\'' + o.id + '\')">' +
                        '<div class="avb-opt-color" style="background:' + o.color + ';"></div>' +
                    '</div>';
                } else {
                    html += '<div class="avb-opt' + sel + '" onclick="selectAvbOpt(\'' + avbCurrentTab + '\',\'' + o.id + '\')">' +
                        '<div style="display:flex;flex-direction:column;align-items:center;gap:2px;">' +
                            '<span style="font-size:26px;line-height:1;">' + o.emoji + '</span>' +
                            '<span style="font-size:8px;color:var(--text-3);font-weight:600;">' + o.label + '</span>' +
                        '</div>' +
                    '</div>';
                }
            }
            container.innerHTML = html;
        }

        function selectAvbOpt(cat, id) {
            avbState[cat] = id;
            renderAvbOptions();
            renderAvbPreview();
        }

        function randomAvatar() {
            var cats = Object.keys(AVB_PARTS);
            for (var i = 0; i < cats.length; i++) {
                var c = cats[i];
                var opts = AVB_PARTS[c].options;
                avbState[c] = opts[Math.floor(Math.random() * opts.length)].id;
            }
            renderAvbOptions();
            renderAvbPreview();
        }

        function getSkinColor(id) {
            var opts = AVB_PARTS.skin.options;
            for (var i = 0; i < opts.length; i++) { if (opts[i].id === id) return opts[i].color; }
            return '#FDDBB4';
        }

        function darken(hex, pct) {
            var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            r = Math.round(r * (1-pct)); g = Math.round(g * (1-pct)); b = Math.round(b * (1-pct));
            return '#' + [r,g,b].map(function(c){return c.toString(16).padStart(2,'0');}).join('');
        }

        function buildAvatarSVG(state, size) {
            size = size || 120;
            var skin = getSkinColor(state.skin);
            var skinDark = darken(skin, 0.15);
            var cx = 60, cy = 60;

            var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120">';

            // ── Background circle ──
            svg += '<circle cx="60" cy="60" r="58" fill="' + darken(skin, 0.4) + '" opacity="0.3"/>';

            // ── Neck ──
            svg += '<rect x="45" y="85" width="30" height="20" rx="8" fill="' + skin + '"/>';

            // ── Face ──
            svg += '<ellipse cx="60" cy="58" rx="38" ry="40" fill="' + skin + '"/>';
            // Cheeks
            svg += '<ellipse cx="35" cy="65" rx="8" ry="5" fill="' + darken(skin, 0.05) + '" opacity="0.5"/>';
            svg += '<ellipse cx="85" cy="65" rx="8" ry="5" fill="' + darken(skin, 0.05) + '" opacity="0.5"/>';

            // ── Ears ──
            svg += '<ellipse cx="22" cy="58" rx="7" ry="10" fill="' + skin + '"/>';
            svg += '<ellipse cx="22" cy="58" rx="4" ry="6" fill="' + skinDark + '" opacity="0.3"/>';
            svg += '<ellipse cx="98" cy="58" rx="7" ry="10" fill="' + skin + '"/>';
            svg += '<ellipse cx="98" cy="58" rx="4" ry="6" fill="' + skinDark + '" opacity="0.3"/>';

            // ── Cauliflower ear (a3) ──
            if (state.acc === 'a3') {
                svg += '<ellipse cx="22" cy="56" rx="8" ry="11" fill="' + darken(skin, 0.1) + '"/>';
                svg += '<ellipse cx="21" cy="54" rx="4" ry="5" fill="' + darken(skin, 0.2) + '" opacity="0.6"/>';
            }

            // ── HAIR ──
            var hairColor = '#2C1810';
            var h = state.hair;
            if (h === 'h0' || h === 'h7') {
                // Bald / Raspado — skull shine
                svg += '<ellipse cx="50" cy="30" rx="12" ry="6" fill="white" opacity="0.08"/>';
                if (h === 'h7') svg += '<ellipse cx="60" cy="22" rx="30" ry="8" fill="' + hairColor + '" opacity="0.2"/>';
            } else if (h === 'h1') {
                // Short
                svg += '<ellipse cx="60" cy="28" rx="35" ry="22" fill="' + hairColor + '"/>';
                svg += '<ellipse cx="60" cy="32" rx="32" ry="14" fill="' + hairColor + '"/>';
            } else if (h === 'h2') {
                // Medium
                svg += '<ellipse cx="60" cy="26" rx="37" ry="24" fill="' + hairColor + '"/>';
                svg += '<rect x="23" y="30" width="10" height="30" rx="5" fill="' + hairColor + '"/>';
                svg += '<rect x="87" y="30" width="10" height="30" rx="5" fill="' + hairColor + '"/>';
            } else if (h === 'h3') {
                // Curly / Afro
                svg += '<circle cx="60" cy="32" r="38" fill="' + hairColor + '"/>';
                for (var ci = 0; ci < 8; ci++) {
                    var ang = ci * 0.785;
                    var hx = 60 + Math.cos(ang) * 36;
                    var hy = 32 + Math.sin(ang) * 36;
                    svg += '<circle cx="' + hx + '" cy="' + hy + '" r="8" fill="' + hairColor + '"/>';
                }
            } else if (h === 'h4') {
                // Long
                svg += '<ellipse cx="60" cy="26" rx="37" ry="24" fill="' + hairColor + '"/>';
                svg += '<rect x="20" y="30" width="14" height="55" rx="7" fill="' + hairColor + '"/>';
                svg += '<rect x="86" y="30" width="14" height="55" rx="7" fill="' + hairColor + '"/>';
                svg += '<rect x="30" y="30" width="10" height="50" rx="5" fill="' + hairColor + '" opacity="0.5"/>';
                svg += '<rect x="80" y="30" width="10" height="50" rx="5" fill="' + hairColor + '" opacity="0.5"/>';
            } else if (h === 'h5') {
                // Mohawk
                svg += '<rect x="48" y="5" width="24" height="30" rx="12" fill="' + hairColor + '"/>';
                svg += '<rect x="51" y="2" width="18" height="20" rx="9" fill="' + hairColor + '"/>';
                svg += '<rect x="50" y="28" width="20" height="12" rx="5" fill="' + hairColor + '"/>';
            } else if (h === 'h6') {
                // Ralo / Thin
                svg += '<ellipse cx="60" cy="28" rx="33" ry="18" fill="' + hairColor + '" opacity="0.4"/>';
                svg += '<ellipse cx="46" cy="26" rx="8" ry="6" fill="' + skin + '" opacity="0.3"/>';
            }

            // ── EYES ──
            var e = state.eyes;
            if (e === 'e1') {
                // Normal
                svg += '<ellipse cx="44" cy="54" rx="7" ry="8" fill="white"/>';
                svg += '<circle cx="45" cy="54" r="4" fill="#2C1810"/>';
                svg += '<circle cx="46" cy="52" r="1.5" fill="white"/>';
                svg += '<ellipse cx="76" cy="54" rx="7" ry="8" fill="white"/>';
                svg += '<circle cx="77" cy="54" r="4" fill="#2C1810"/>';
                svg += '<circle cx="78" cy="52" r="1.5" fill="white"/>';
            } else if (e === 'e2') {
                // Happy ^_^
                svg += '<path d="M37 54 Q44 48 51 54" stroke="#2C1810" stroke-width="3" fill="none" stroke-linecap="round"/>';
                svg += '<path d="M69 54 Q76 48 83 54" stroke="#2C1810" stroke-width="3" fill="none" stroke-linecap="round"/>';
            } else if (e === 'e3') {
                // Angry
                svg += '<line x1="37" y1="46" x2="51" y2="50" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>';
                svg += '<ellipse cx="44" cy="55" rx="7" ry="7" fill="white"/>';
                svg += '<circle cx="45" cy="55" r="4" fill="#2C1810"/>';
                svg += '<line x1="83" y1="46" x2="69" y2="50" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>';
                svg += '<ellipse cx="76" cy="55" rx="7" ry="7" fill="white"/>';
                svg += '<circle cx="77" cy="55" r="4" fill="#2C1810"/>';
            } else if (e === 'e4') {
                // Sleepy
                svg += '<path d="M37 56 Q44 52 51 56" stroke="#2C1810" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
                svg += '<path d="M69 56 Q76 52 83 56" stroke="#2C1810" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
                svg += '<text x="84" y="46" font-size="8" fill="#2C1810" font-weight="bold">z</text>';
                svg += '<text x="90" y="40" font-size="6" fill="#2C1810">z</text>';
            } else if (e === 'e5') {
                // Cool / Sunglasses
                svg += '<rect x="32" y="48" width="22" height="14" rx="4" fill="#1a1a2e"/>';
                svg += '<rect x="66" y="48" width="22" height="14" rx="4" fill="#1a1a2e"/>';
                svg += '<line x1="54" y1="54" x2="66" y2="54" stroke="#1a1a2e" stroke-width="2"/>';
                svg += '<rect x="34" y="50" width="8" height="3" rx="1" fill="rgba(255,255,255,0.15)"/>';
                svg += '<rect x="68" y="50" width="8" height="3" rx="1" fill="rgba(255,255,255,0.15)"/>';
            } else if (e === 'e6') {
                // Wink
                svg += '<ellipse cx="44" cy="54" rx="7" ry="8" fill="white"/>';
                svg += '<circle cx="45" cy="54" r="4" fill="#2C1810"/>';
                svg += '<circle cx="46" cy="52" r="1.5" fill="white"/>';
                svg += '<path d="M69 54 Q76 48 83 54" stroke="#2C1810" stroke-width="3" fill="none" stroke-linecap="round"/>';
            } else if (e === 'e7') {
                // Suspicious
                svg += '<line x1="37" y1="50" x2="51" y2="48" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>';
                svg += '<ellipse cx="44" cy="55" rx="6" ry="5" fill="white"/>';
                svg += '<circle cx="46" cy="55" r="3" fill="#2C1810"/>';
                svg += '<ellipse cx="76" cy="55" rx="7" ry="8" fill="white"/>';
                svg += '<circle cx="77" cy="55" r="4" fill="#2C1810"/>';
            } else if (e === 'e8') {
                // Pidão (puppy eyes)
                svg += '<ellipse cx="44" cy="54" rx="9" ry="10" fill="white"/>';
                svg += '<circle cx="44" cy="56" r="6" fill="#5C3D2E"/>';
                svg += '<circle cx="44" cy="56" r="3" fill="#2C1810"/>';
                svg += '<circle cx="46" cy="53" r="2.5" fill="white"/>';
                svg += '<ellipse cx="76" cy="54" rx="9" ry="10" fill="white"/>';
                svg += '<circle cx="76" cy="56" r="6" fill="#5C3D2E"/>';
                svg += '<circle cx="76" cy="56" r="3" fill="#2C1810"/>';
                svg += '<circle cx="78" cy="53" r="2.5" fill="white"/>';
            }

            // ── Nose ──
            svg += '<ellipse cx="60" cy="64" rx="4" ry="3" fill="' + skinDark + '" opacity="0.35"/>';

            // ── MOUTH ──
            var m = state.mouth;
            if (m === 'm1') {
                // Smile
                svg += '<path d="M48 74 Q60 82 72 74" stroke="#2C1810" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
            } else if (m === 'm2') {
                // Laughing (open)
                svg += '<path d="M45 73 Q60 86 75 73 Z" fill="#2C1810"/>';
                svg += '<path d="M50 80 Q60 84 70 80" fill="#e74c3c" opacity="0.6"/>';
                svg += '<path d="M50 73 Q60 76 70 73" fill="white"/>';
            } else if (m === 'm3') {
                // Serious
                svg += '<line x1="48" y1="76" x2="72" y2="76" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>';
            } else if (m === 'm4') {
                // Tongue
                svg += '<path d="M48 74 Q60 82 72 74" stroke="#2C1810" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
                svg += '<ellipse cx="60" cy="80" rx="6" ry="5" fill="#e74c3c" opacity="0.7"/>';
            } else if (m === 'm5') {
                // Smirk
                svg += '<path d="M48 76 Q56 76 72 72" stroke="#2C1810" stroke-width="2.5" fill="none" stroke-linecap="round"/>';
            } else if (m === 'm6') {
                // Surprised O
                svg += '<ellipse cx="60" cy="77" rx="7" ry="8" fill="#2C1810"/>';
                svg += '<ellipse cx="60" cy="76" rx="5" ry="5" fill="#3d1f10"/>';
            } else if (m === 'm7') {
                // Closed / muzzled
                svg += '<line x1="50" y1="76" x2="70" y2="76" stroke="#2C1810" stroke-width="2" stroke-linecap="round"/>';
                svg += '<line x1="53" y1="73" x2="53" y2="79" stroke="#2C1810" stroke-width="1.5" stroke-linecap="round"/>';
                svg += '<line x1="60" y1="73" x2="60" y2="79" stroke="#2C1810" stroke-width="1.5" stroke-linecap="round"/>';
                svg += '<line x1="67" y1="73" x2="67" y2="79" stroke="#2C1810" stroke-width="1.5" stroke-linecap="round"/>';
            } else if (m === 'm8') {
                // Nervous / teeth
                svg += '<path d="M45 73 Q60 80 75 73 Q60 84 45 73 Z" fill="white" stroke="#2C1810" stroke-width="1.5"/>';
                svg += '<line x1="53" y1="73" x2="53" y2="80" stroke="#2C1810" stroke-width="1" opacity="0.4"/>';
                svg += '<line x1="60" y1="73.5" x2="60" y2="81" stroke="#2C1810" stroke-width="1" opacity="0.4"/>';
                svg += '<line x1="67" y1="73" x2="67" y2="80" stroke="#2C1810" stroke-width="1" opacity="0.4"/>';
            }

            // ── ACCESSORIES ──
            var a = state.acc;
            if (a === 'a1') {
                // Kimono collar
                svg += '<path d="M35 92 L48 85 L60 95 L72 85 L85 92 L85 120 L35 120 Z" fill="white" stroke="#ccc" stroke-width="1"/>';
                svg += '<line x1="60" y1="95" x2="60" y2="120" stroke="#ccc" stroke-width="1"/>';
            } else if (a === 'a2') {
                // Band-aid on face
                svg += '<rect x="70" y="38" width="20" height="10" rx="3" fill="#F5C99E" stroke="#D4A574" stroke-width="0.5" transform="rotate(-20 80 43)"/>';
                svg += '<line x1="74" y1="41" x2="74" y2="45" stroke="#D4A574" stroke-width="0.5" transform="rotate(-20 80 43)"/>';
                svg += '<line x1="86" y1="41" x2="86" y2="45" stroke="#D4A574" stroke-width="0.5" transform="rotate(-20 80 43)"/>';
            } else if (a === 'a4') {
                // Headband
                svg += '<rect x="22" y="36" width="76" height="8" rx="2" fill="#e74c3c"/>';
                svg += '<circle cx="60" cy="40" r="4" fill="#e74c3c"/>';
                svg += '<text x="58" y="42" font-size="6" fill="white" font-weight="bold" text-anchor="middle">勝</text>';
            } else if (a === 'a5') {
                // Cap
                svg += '<ellipse cx="60" cy="28" rx="40" ry="12" fill="#2c3e50"/>';
                svg += '<rect x="20" y="24" width="80" height="12" rx="4" fill="#2c3e50"/>';
                svg += '<rect x="18" y="32" width="50" height="6" rx="2" fill="#34495e"/>';
            } else if (a === 'a6') {
                // Glasses (round)
                svg += '<circle cx="44" cy="54" r="12" fill="none" stroke="#333" stroke-width="2.5"/>';
                svg += '<circle cx="76" cy="54" r="12" fill="none" stroke="#333" stroke-width="2.5"/>';
                svg += '<line x1="56" y1="54" x2="64" y2="54" stroke="#333" stroke-width="2"/>';
                svg += '<line x1="32" y1="52" x2="24" y2="50" stroke="#333" stroke-width="2"/>';
                svg += '<line x1="88" y1="52" x2="96" y2="50" stroke="#333" stroke-width="2"/>';
            } else if (a === 'a7') {
                // Headphones
                svg += '<path d="M22 52 Q22 20 60 18 Q98 20 98 52" stroke="#333" stroke-width="5" fill="none"/>';
                svg += '<rect x="14" y="48" width="14" height="20" rx="6" fill="#333"/>';
                svg += '<rect x="16" y="52" width="10" height="12" rx="4" fill="#555"/>';
                svg += '<rect x="92" y="48" width="14" height="20" rx="6" fill="#333"/>';
                svg += '<rect x="94" y="52" width="10" height="12" rx="4" fill="#555"/>';
            }

            svg += '</svg>';
            return svg;
        }

        function renderAvbPreview() {
            document.getElementById('avbPreview').innerHTML = buildAvatarSVG(avbState, 120);
        }

        function saveAvatarBuilder() {
            var json = JSON.stringify(avbState);
            document.getElementById('perfilAvatarData').value = json;
            applyAvatarToProfile(avbState);
            applyAvatarToHeader(avbState);
            // Save to localStorage immediately
            localStorage.setItem('bjjAvatar', json);
            closeAvatarBuilder();
        }

        function applyAvatarToProfile(state) {
            if (!state || !state.skin) return;
            var el = document.getElementById('perfilAvatar');
            if (!el) return;
            var initial = document.getElementById('perfilAvatarInitial');
            if (initial) initial.style.display = 'none';
            var svgDiv = document.getElementById('perfilAvatarSVG');
            if (svgDiv) {
                svgDiv.style.display = 'block';
                svgDiv.innerHTML = buildAvatarSVG(state);
            }
            // Remove gradient bg when avatar is active
            el.style.background = 'transparent';
        }

        function applyAvatarToHeader(state) {
            if (!state || !state.skin) return;
            var hdrAvatar = document.getElementById('userInitial');
            if (!hdrAvatar) return;
            hdrAvatar.innerHTML = buildAvatarSVG(state);
            hdrAvatar.style.background = 'transparent';
            hdrAvatar.style.fontSize = '0';
            hdrAvatar.style.border = 'none';
        }

        function loadAvatarFromData(dataStr) {
            if (!dataStr) {
                // Try localStorage
                dataStr = localStorage.getItem('bjjAvatar');
            }
            if (!dataStr) return;
            try {
                var state = JSON.parse(dataStr);
                if (state && state.skin) {
                    avbState = state;
                    applyAvatarToProfile(state);
                    applyAvatarToHeader(state);
                    document.getElementById('perfilAvatarData').value = dataStr;
                }
            } catch(e) {}
        }

        async function changePassword() {
            if (!currentUser) return;
            var atual = document.getElementById('perfilSenhaAtual').value;
            var nova = document.getElementById('perfilSenhaNova').value;
            var confirma = document.getElementById('perfilSenhaConfirma').value;

            if (!atual || !nova || !confirma) { showMessage('perfilPwdMessage', '⚠️ Preencha todos os campos', 'warning'); return; }
            if (nova.length < 6) { showMessage('perfilPwdMessage', '⚠️ Mínimo 6 caracteres', 'warning'); return; }
            if (nova !== confirma) { showMessage('perfilPwdMessage', '⚠️ As senhas não coincidem', 'warning'); return; }

            try {
                var data = await secureFetch('changePassword', { email: currentUser.email, currentPassword: atual, newPassword: nova });
                if (data.success) {
                    showMessage('perfilPwdMessage', '✅ Senha alterada!', 'success');
                    document.getElementById('perfilSenhaAtual').value = '';
                    document.getElementById('perfilSenhaNova').value = '';
                    document.getElementById('perfilSenhaConfirma').value = '';
                } else {
                    showMessage('perfilPwdMessage', '❌ ' + (data.message || data.error || 'Erro'), 'danger');
                }
            } catch (err) {
                showMessage('perfilPwdMessage', '❌ Erro de conexão', 'danger');
            }
            setTimeout(function() { document.getElementById('perfilPwdMessage').innerHTML = ''; }, 4000);
        }

        // Phone mask
        (function() {
            var tel = document.getElementById('perfilTelefone');
            if (tel) {
                tel.addEventListener('input', function(e) {
                    var v = e.target.value.replace(/\D/g, '');
                    if (v.length > 11) v = v.substring(0, 11);
                    if (v.length > 6) v = '(' + v.substring(0, 2) + ') ' + v.substring(2, 7) + '-' + v.substring(7);
                    else if (v.length > 2) v = '(' + v.substring(0, 2) + ') ' + v.substring(2);
                    else if (v.length > 0) v = '(' + v;
                    e.target.value = v;
                    updateProfileCompleteness();
                });
            }
            var allFields = document.querySelectorAll('#perfil input, #perfil select, #perfil textarea');
            for (var i = 0; i < allFields.length; i++) {
                allFields[i].addEventListener('change', updateProfileCompleteness);
                allFields[i].addEventListener('input', function(e) {
                    if (e.target.id !== 'perfilTelefone') updateProfileCompleteness();
                });
            }
        })();

        // ===== AUTO UPDATE GRAU =====
        async function autoUpdateGrau(novoGrau) {
            if (!currentUser) return;
            if (currentUser._updatingGrau) return;
            if (novoGrau <= (currentUser.grau || 0)) return;
            currentUser._updatingGrau = true;
            try {
                const data = await secureFetch('updateGrau', { email: currentUser.email, grau: novoGrau });
                if (data.success) {
                    currentUser.grau = novoGrau;
                    localStorage.setItem('bjjUser', JSON.stringify(currentUser));
                }
            } catch (err) { console.error('Erro grau:', err); }
            finally { currentUser._updatingGrau = false; }
        }

        // ===== ONDE TREINAR / GUIDE =====
        var guideDataCache = null;

        async function loadGuide() {
            var heroEl = document.getElementById('guideTodayHero');
            var cardsEl = document.getElementById('guideCTCards');
            cardsEl.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:24px;font-size:13px;">Carregando...</div>';

            try {
                var data = await secureFetch('getCTsList', {});
                if (data.success && data.cts && data.cts.length > 0) {
                    guideDataCache = data.cts;
                    renderGuide(data.cts);
                } else {
                    cardsEl.innerHTML = '<div class="guide-noclass">Nenhum CT cadastrado no momento.</div>';
                    heroEl.innerHTML = '';
                }
            } catch (err) {
                cardsEl.innerHTML = '<div class="guide-noclass">Erro ao carregar informações.</div>';
            }
        }

        function renderGuide(cts) {
            var now = new Date();
            var jsDay = now.getDay(); // 0=dom, 1=seg...
            var DAY_MAP = ['dom','seg','ter','qua','qui','sex','sab'];
            var DAY_LABELS = { seg:'Seg', ter:'Ter', qua:'Qua', qui:'Qui', sex:'Sex', sab:'Sáb', dom:'Dom' };
            var DAY_FULL = { dom:'Domingo', seg:'Segunda-feira', ter:'Terça-feira', qua:'Quarta-feira', qui:'Quinta-feira', sex:'Sexta-feira', sab:'Sábado' };
            var todayKey = DAY_MAP[jsDay];

            // Find CTs with class today
            var todayCTs = [];
            var otherCTs = [];
            for (var i = 0; i < cts.length; i++) {
                var ct = cts[i];
                if (ct.schedule && ct.schedule[todayKey]) {
                    todayCTs.push(ct);
                } else {
                    otherCTs.push(ct);
                }
            }

            // Hero - Today status
            var heroEl = document.getElementById('guideTodayHero');
            if (todayCTs.length > 0) {
                var ctNames = todayCTs.map(function(c) { return c.name; }).join(' · ');
                heroEl.innerHTML = '<div class="guide-today-hero">' +
                    '<div class="guide-today-label"><span class="guide-today-live"></span> Hoje tem treino</div>' +
                    '<div class="guide-today-day">' + DAY_FULL[todayKey] + '</div>' +
                    '<div class="guide-today-cts">📍 ' + ctNames + '</div>' +
                '</div>';
            } else {
                heroEl.innerHTML = '<div class="guide-noclass">😴 ' + DAY_FULL[todayKey] + ' — Sem treino hoje. Descanse e volte mais forte!</div>';
            }

            // CT Cards - today first, then others
            var allOrdered = todayCTs.concat(otherCTs);
            var cardsHtml = '';

            for (var c = 0; c < allOrdered.length; c++) {
                var ct = allOrdered[c];
                var isToday = todayCTs.indexOf(ct) >= 0;

                cardsHtml += '<div class="guide-card' + (isToday ? ' today' : '') + '" id="guideCard' + c + '">';

                // Header
                cardsHtml += '<div class="guide-card-header" onclick="toggleGuideCard(' + c + ')">';
                cardsHtml += '<div class="guide-card-icon">' + (isToday ? '🥋' : '📍') + '</div>';
                cardsHtml += '<div class="guide-card-info">';
                cardsHtml += '<div class="guide-card-name">' + ct.name;
                if (isToday) cardsHtml += ' <span class="guide-live-badge"><span class="guide-today-live"></span>HOJE</span>';
                cardsHtml += '</div>';
                if (ct.endereco) cardsHtml += '<div class="guide-card-addr">📌 ' + ct.endereco + '</div>';
                cardsHtml += '</div>';
                cardsHtml += '<div class="guide-card-toggle">▼</div>';
                cardsHtml += '</div>';

                // Body
                cardsHtml += '<div class="guide-card-body">';

                // Schedule dots
                var dayOrder = ['seg','ter','qua','qui','sex','sab','dom'];
                cardsHtml += '<div class="guide-sched">';
                for (var d = 0; d < dayOrder.length; d++) {
                    var dk = dayOrder[d];
                    var isOn = ct.schedule && ct.schedule[dk];
                    var isCurrent = dk === todayKey;
                    var cls = isOn ? (isCurrent ? 'current' : 'on') : 'off';
                    cardsHtml += '<div class="guide-sched-day ' + cls + '">' + DAY_LABELS[dk] + '</div>';
                }
                cardsHtml += '</div>';

                // Horários
                var _guideHrs = '';
                if (ct.horariosPorDia) {
                    var _dk2 = ['dom','seg','ter','qua','qui','sex','sab'];
                    var _hj2 = _dk2[new Date().getDay()];
                    _guideHrs = (ct.horariosPorDia[_hj2] || ct.horariosPorDia._global || ct.horarios || '');
                } else { _guideHrs = ct.horarios || ''; }
                if (_guideHrs) {
                    cardsHtml += '<div class="guide-info-row"><div class="guide-info-icon">🕐</div><div class="guide-info-content">' +
                        '<div class="guide-info-label">Horários</div>' +
                        '<div class="guide-info-value">' + ct.horarios.replace(/,/g, ' · ') + '</div></div></div>';
                }

                // Valor
                if (ct.valorAvulso) {
                    cardsHtml += '<div class="guide-info-row"><div class="guide-info-icon">💰</div><div class="guide-info-content">' +
                        '<div class="guide-info-label">Valor Avulso</div>' +
                        '<div class="guide-info-value">R$ ' + ct.valorAvulso + '</div></div></div>';
                }

                // Planos
                if (ct.planos) {
                    cardsHtml += '<div class="guide-info-row"><div class="guide-info-icon">📋</div><div class="guide-info-content">' +
                        '<div class="guide-info-label">Planos</div>' +
                        '<div class="guide-info-value">' + ct.planos.replace(/\|/g, '<br>') + '</div></div></div>';
                }

                // Benefícios
                if (ct.beneficios) {
                    var bens = ct.beneficios.split(',');
                    var BENEFIT_MAP = {
                        'totalpass': { label: 'TotalPass', cls: 'totalpass', icon: '🟠' },
                        'gympass': { label: 'Gympass', cls: 'gympass', icon: '🔴' },
                        'wellhub': { label: 'WellHub', cls: 'wellhub', icon: '🟣' },
                        'gogood': { label: 'GoGood', cls: 'gogood', icon: '🟢' },
                        'classpass': { label: 'ClassPass', cls: 'classpass', icon: '🔵' },
                        'totalfit': { label: 'TotalFit', cls: 'totalfit', icon: '🟡' }
                    };
                    cardsHtml += '<div class="guide-info-row"><div class="guide-info-icon">✅</div><div class="guide-info-content">' +
                        '<div class="guide-info-label">Aceita</div>' +
                        '<div class="guide-benefits">';
                    for (var b = 0; b < bens.length; b++) {
                        var bKey = bens[b].trim().toLowerCase().replace(/\s/g, '');
                        var bCfg = BENEFIT_MAP[bKey] || { label: bens[b].trim(), cls: 'default', icon: '✓' };
                        cardsHtml += '<span class="guide-benefit-tag ' + bCfg.cls + '">' + bCfg.icon + ' ' + bCfg.label + '</span>';
                    }
                    cardsHtml += '</div></div></div>';
                }

                // Actions
                var hasActions = ct.mapLink || ct.instagram || ct.telefone;
                if (hasActions) {
                    cardsHtml += '<div class="guide-actions">';
                    if (ct.mapLink) cardsHtml += '<a class="guide-action-btn" href="' + ct.mapLink + '" target="_blank">📍 Mapa</a>';
                    if (ct.telefone) cardsHtml += '<a class="guide-action-btn" href="https://wa.me/55' + ct.telefone.replace(/\D/g,'') + '" target="_blank">💬 WhatsApp</a>';
                    if (ct.instagram) cardsHtml += '<a class="guide-action-btn" href="https://instagram.com/' + ct.instagram.replace('@','') + '" target="_blank">📸 Insta</a>';
                    cardsHtml += '</div>';
                }

                cardsHtml += '</div>'; // body
                cardsHtml += '</div>'; // card
            }

            document.getElementById('guideCTCards').innerHTML = cardsHtml;

            // Auto-expand today's CTs
            for (var t = 0; t < todayCTs.length; t++) {
                var card = document.getElementById('guideCard' + t);
                if (card) card.classList.add('open');
            }
        }

        function toggleGuideCard(idx) {
            var card = document.getElementById('guideCard' + idx);
            if (card) card.classList.toggle('open');
        }

        function animateCounter(elementId, target) {
            var el = document.getElementById(elementId);
            if (!el) return;
            var current = 0;
            var duration = 600;
            var steps = 20;
            var increment = target / steps;
            var stepTime = duration / steps;
            function tick() {
                current += increment;
                if (current >= target) { el.textContent = target; return; }
                el.textContent = Math.round(current);
                setTimeout(tick, stepTime);
            }
            if (target === 0) { el.textContent = '0'; return; }
            tick();
        }

        // ===== CAMPEONATO INTERNO =====
        var championsCache = null;

        async function loadChampions() {
            var hall = document.getElementById('campHall');
            var cards = document.getElementById('campHallCards');

            // Load Champions
            try {
                var data = await secureFetch('getChampions', {});
                if (data.success && data.champions && data.champions.length > 0 && hall && cards) {
                    championsCache = data.champions;
                    hall.style.display = 'block';
                    renderChampionsHall(data.champions, cards);
                } else if (hall) {
                    hall.style.display = 'none';
                }
            } catch (err) {
                if (hall) hall.style.display = 'none';
            }

            // Load Scoreboard
            loadCampScoreboard();
        }

        var campScoreEdFilter = '';
        var campScoreCTFilter = '';
        var CAMP_CATS = ['Masculino', 'Feminino', 'Misto'];
        var CAMP_CAT_ICONS = { 'Masculino': '♂️', 'Feminino': '♀️', 'Misto': '🤝' };
        var CAMP_CAT_COLORS = { 'Masculino': 'var(--gold)', 'Feminino': '#e879a0', 'Misto': '#7ec8e3' };

        async function loadCampScoreboard() {
            var section = document.getElementById('campScoreSection');
            if (!section) return;
            try {
                var data = await secureFetch('getCampPlacar', { edicao: '', ct: '' });
                var edSel = document.getElementById('campScoreEdSelect');
                var edicoes = (data.success && data.edicoes) ? data.edicoes : [];
                if (edicoes.length === 0) {
                    var now = new Date(); var y = now.getFullYear();
                    edicoes = ['2º Semestre ' + y, '1º Semestre ' + y, '2º Semestre ' + (y-1), '1º Semestre ' + (y-1)];
                }
                if (edSel) {
                    var prevEd = campScoreEdFilter;
                    edSel.innerHTML = '';
                    edicoes.forEach(function(ed) { edSel.innerHTML += '<option value="' + ed + '">' + ed + '</option>'; });
                    if (prevEd && edicoes.indexOf(prevEd) !== -1) { edSel.value = prevEd; }
                    else {
                        var now2 = new Date();
                        var curEd = (now2.getMonth() < 6 ? '1º' : '2º') + ' Semestre ' + now2.getFullYear();
                        edSel.value = (edicoes.indexOf(curEd) !== -1) ? curEd : edicoes[0];
                    }
                    campScoreEdFilter = edSel.value;
                }
                loadCampScoreCTs();
            } catch (err) {
                var list = document.getElementById('campScoreList');
                if (list) list.innerHTML = '<div class="camp-score-empty">⚠️ Erro ao carregar</div>';
            }
        }

        function onCampScoreEdChange() {
            campScoreEdFilter = document.getElementById('campScoreEdSelect').value;
            campScoreCTFilter = '';
            loadCampScoreCTs();
        }
        function onCampScoreCTChange() {
            campScoreCTFilter = document.getElementById('campScoreCTSelect').value;
            loadCampScoreData();
        }

        async function loadCampScoreCTs() {
            try {
                var data = await secureFetch('getCampPlacar', { edicao: campScoreEdFilter, ct: '' });
                var cts = (data.success && data.cts) ? data.cts : [];
                if (cts.length === 0 && allCTs && allCTs.length > 0) {
                    allCTs.forEach(function(ct) {
                        var name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                        if (cts.indexOf(name) === -1) cts.push(name);
                    });
                }
                var ctSel = document.getElementById('campScoreCTSelect');
                if (ctSel) {
                    ctSel.innerHTML = '<option value="TODOS">🏆 Todos os CTs</option>';
                    cts.forEach(function(ct) { ctSel.innerHTML += '<option value="' + ct + '">' + ct + '</option>'; });
                    var userCT = currentUser ? currentUser.ct : '';
                    if (campScoreCTFilter && (campScoreCTFilter === 'TODOS' || cts.indexOf(campScoreCTFilter) !== -1)) {
                        ctSel.value = campScoreCTFilter;
                    } else if (userCT && cts.indexOf(userCT) !== -1) {
                        ctSel.value = userCT;
                    } else {
                        ctSel.value = ctSel.options[0].value;
                    }
                    campScoreCTFilter = ctSel.value;
                }
                loadCampScoreData();
            } catch (err) {
                renderCampAllCats([]);
            }
        }

        async function loadCampScoreData() {
            var isTodos = campScoreCTFilter === 'TODOS';
            try {
                // Busca SEM filtro de categoria — traz tudo
                var payload = { action: 'getCampPlacar', edicao: campScoreEdFilter, ct: isTodos ? '' : campScoreCTFilter };
                if (getSessionToken()) payload.token = getSessionToken();
                var r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                var data = await r.json();
                if (data.unauthorized) { handleSessionExpired(); return; }
                if (data.forbidden) { alert('⛔ Sem permissão'); return; }
                var placar = data.success ? (data.placar || []) : [];
                if (isTodos) { renderCampTodosAllCats(placar); }
                else { renderCampAllCats(placar); }
            } catch (err) {
                renderCampAllCats([]);
            }
        }

        // ═══ RENDER POR CT — mostra pódio para cada categoria ═══
        function renderCampAllCats(placar) {
            var container = document.getElementById('campScoreList');
            if (!container) return;
            if (placar.length === 0) {
                container.innerHTML = '<div class="camp-score-empty">🔵 Nenhum placar registrado para <strong>' + (campScoreCTFilter || 'este CT') + '</strong>.<br><span style="font-size:11px;color:var(--text-3);">O professor registra as borrachinhas durante o campeonato.</span></div>';
                return;
            }
            var FAIXA_EMOJI = { 'Branca': '⬜', 'Azul': '🟦', 'Roxa': '🟪', 'Marrom': '🟫', 'Preta': '⬛' };
            var isMe = currentUser ? currentUser.email : '';

            // Separar por categoria
            var byCat = {};
            for (var i = 0; i < placar.length; i++) {
                var cat = placar[i].categoria || 'Masculino';
                if (!byCat[cat]) byCat[cat] = [];
                byCat[cat].push(placar[i]);
            }

            var html = '';
            for (var ci = 0; ci < CAMP_CATS.length; ci++) {
                var catName = CAMP_CATS[ci];
                var catData = byCat[catName];
                if (!catData || catData.length === 0) continue;

                var catIcon = CAMP_CAT_ICONS[catName];
                var catColor = CAMP_CAT_COLORS[catName];
                var sorted = catData.slice().sort(function(a,b) { return b.borrachinhas - a.borrachinhas; });

                // Categoria header
                html += '<div class="camp-cat-section">';
                html += '<div class="camp-cat-header" style="color:' + catColor + ';">' + catIcon + ' ' + catName + '</div>';

                // PODIUM top 3
                if (sorted.length >= 2) {
                    var top = sorted.slice(0, Math.min(3, sorted.length));
                    var podiumOrder, posLabels, medals;
                    if (top.length >= 3) {
                        podiumOrder = [top[1], top[0], top[2]]; posLabels = ['pos2','pos1','pos3']; medals = ['🥈','🥇','🥉'];
                    } else {
                        podiumOrder = [top[1], top[0]]; posLabels = ['pos2','pos1']; medals = ['🥈','🥇'];
                    }
                    html += '<div class="camp-podium-rank">';
                    for (var pi = 0; pi < podiumOrder.length; pi++) {
                        var pp = podiumOrder[pi];
                        var ini = pp.nome ? pp.nome.charAt(0).toUpperCase() : '?';
                        var firstName = pp.nome ? pp.nome.split(' ')[0] : '?';
                        html += '<div class="camp-podium-col ' + posLabels[pi] + '">' +
                            '<div class="camp-podium-medal">' + medals[pi] + '</div>' +
                            '<div class="camp-podium-avatar">' + ini + '</div>' +
                            '<div class="camp-podium-pname">' + firstName + '</div>' +
                            '<div class="camp-podium-borr">🔵 ' + pp.borrachinhas + '</div>' +
                            '<div class="camp-podium-bar"></div>' +
                        '</div>';
                    }
                    html += '</div>';
                }

                // Full list
                for (var j = 0; j < sorted.length; j++) {
                    var p = sorted[j];
                    var pos = j + 1;
                    var posClass = pos === 1 ? ' top1' : pos === 2 ? ' top2' : pos === 3 ? ' top3' : '';
                    var eliminated = p.borrachinhas === 0 ? ' eliminated' : '';
                    var meClass = (p.email && p.email === isMe) ? ' style="box-shadow:0 0 0 1px var(--gold);"' : '';
                    var initial = p.nome ? p.nome.charAt(0).toUpperCase() : '?';
                    var posLabel = pos <= 3 ? ['🥇','🥈','🥉'][pos-1] : pos + 'º';
                    html += '<div class="camp-score-row' + posClass + eliminated + '"' + meClass + '>' +
                        '<div class="camp-score-pos">' + posLabel + '</div>' +
                        '<div class="camp-score-avatar">' + initial + '</div>' +
                        '<div class="camp-score-info">' +
                            '<div class="camp-score-name">' + p.nome + (p.email === isMe ? ' ⭐' : '') + '</div>' +
                            '<div class="camp-score-meta">' + (FAIXA_EMOJI[p.faixa] || '🥋') + ' ' + (p.faixa || '—') + '</div>' +
                        '</div>' +
                        '<div class="camp-score-borr"><div>' +
                            '<div class="camp-score-borr-num">' + p.borrachinhas + '</div>' +
                            '<div class="camp-score-borr-lbl">🔵 vidas</div>' +
                        '</div></div>' +
                    '</div>';
                }

                html += '</div>'; // /camp-cat-section
            }
            container.innerHTML = html;
        }

        // ═══ RENDER TODOS OS CTs — pódio de CTs por categoria ═══
        function renderCampTodosAllCats(placar) {
            var container = document.getElementById('campScoreList');
            if (!container) return;
            if (placar.length === 0) {
                container.innerHTML = '<div class="camp-score-empty">🔵 Nenhum placar registrado neste semestre.</div>';
                return;
            }
            var FAIXA_EMOJI = { 'Branca': '⬜', 'Azul': '🟦', 'Roxa': '🟪', 'Marrom': '🟫', 'Preta': '⬛' };

            // Separar por categoria
            var byCat = {};
            for (var i = 0; i < placar.length; i++) {
                var cat = placar[i].categoria || 'Masculino';
                if (!byCat[cat]) byCat[cat] = [];
                byCat[cat].push(placar[i]);
            }

            var html = '';
            for (var ci = 0; ci < CAMP_CATS.length; ci++) {
                var catName = CAMP_CATS[ci];
                var catData = byCat[catName];
                if (!catData || catData.length === 0) continue;

                var catIcon = CAMP_CAT_ICONS[catName];
                var catColor = CAMP_CAT_COLORS[catName];

                // Group by CT → find 1st of each
                var ctMap = {};
                for (var k = 0; k < catData.length; k++) {
                    var p = catData[k];
                    if (!p.ct) continue;
                    if (!ctMap[p.ct]) ctMap[p.ct] = [];
                    ctMap[p.ct].push(p);
                }
                var ctChamps = [];
                var ctKeys = Object.keys(ctMap);
                for (var c = 0; c < ctKeys.length; c++) {
                    var ct = ctKeys[c];
                    var s = ctMap[ct].sort(function(a,b) { return b.borrachinhas - a.borrachinhas; });
                    if (s.length > 0) ctChamps.push({ ct: ct, champ: s[0], total: s.length });
                }
                ctChamps.sort(function(a,b) { return b.champ.borrachinhas - a.champ.borrachinhas; });
                if (ctChamps.length === 0) continue;

                html += '<div class="camp-cat-section">';
                html += '<div class="camp-cat-header" style="color:' + catColor + ';">' + catIcon + ' ' + catName + '</div>';

                // CT Campeão — golden hero
                var w = ctChamps[0];
                var heroBorder = catName === 'Feminino' ? 'rgba(232,121,160,0.35)' : catName === 'Misto' ? 'rgba(126,200,227,0.35)' : 'rgba(212,175,55,0.35)';
                var heroBg = catName === 'Feminino' ? 'linear-gradient(135deg, #1a0a12 0%, #2a1520 50%, #1a0a12 100%)' : catName === 'Misto' ? 'linear-gradient(135deg, #0a1520 0%, #102535 50%, #0a1520 100%)' : 'linear-gradient(135deg, #1a1708 0%, #2a2510 50%, #1a1708 100%)';
                html += '<div class="camp-podium-geral" style="border-color:' + heroBorder + ';background:' + heroBg + ';">' +
                    '<div class="camp-podium-geral-shimmer"></div>' +
                    '<div class="camp-podium-geral-crown">🏆</div>' +
                    '<div class="camp-podium-geral-label" style="color:' + catColor + ';">CT Campeão ' + catIcon + '</div>' +
                    '<div class="camp-podium-geral-name">' + w.ct + '</div>' +
                    '<div class="camp-podium-geral-meta">🥇 <strong>' + w.champ.nome + '</strong> · 🔵 ' + w.champ.borrachinhas + ' vidas · ' + (FAIXA_EMOJI[w.champ.faixa]||'🥋') + ' ' + (w.champ.faixa||'') + '</div>' +
                '</div>';

                // Pódio dos CTs
                if (ctChamps.length >= 2) {
                    var top = ctChamps.slice(0, Math.min(3, ctChamps.length));
                    var podiumOrder, posLabels, medals;
                    if (top.length >= 3) {
                        podiumOrder = [top[1], top[0], top[2]]; posLabels = ['pos2','pos1','pos3']; medals = ['🥈','🥇','🥉'];
                    } else {
                        podiumOrder = [top[1], top[0]]; posLabels = ['pos2','pos1']; medals = ['🥈','🥇'];
                    }
                    html += '<div style="font-size:10px;color:var(--text-3);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:10px 0 2px;padding-left:4px;">Pódio dos CTs</div>';
                    html += '<div class="camp-podium-rank">';
                    for (var pi = 0; pi < podiumOrder.length; pi++) {
                        var pp = podiumOrder[pi];
                        var ctI = pp.ct ? pp.ct.charAt(0).toUpperCase() : '?';
                        html += '<div class="camp-podium-col ' + posLabels[pi] + '">' +
                            '<div class="camp-podium-medal">' + medals[pi] + '</div>' +
                            '<div class="camp-podium-avatar">' + ctI + '</div>' +
                            '<div class="camp-podium-pname">' + pp.ct + '</div>' +
                            '<div class="camp-podium-borr">' + pp.champ.nome.split(' ')[0] + ' · 🔵' + pp.champ.borrachinhas + '</div>' +
                            '<div class="camp-podium-bar"></div>' +
                        '</div>';
                    }
                    html += '</div>';
                }

                // Full CT list
                html += '<div style="font-size:10px;color:var(--text-3);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:6px 0 6px;padding-left:4px;">Ranking completo</div>';
                for (var j = 0; j < ctChamps.length; j++) {
                    var cc = ctChamps[j];
                    var isWinner = j === 0;
                    var medal = j === 0 ? '🥇' : j === 1 ? '🥈' : j === 2 ? '🥉' : (j+1) + 'º';
                    html += '<div class="camp-ct-champ-card' + (isWinner ? ' winner' : '') + '">' +
                        '<div class="camp-ct-champ-pos">' + medal + '</div>' +
                        '<div class="camp-ct-champ-info">' +
                            '<div class="camp-ct-champ-ct">' + cc.ct + '</div>' +
                            '<div class="camp-ct-champ-name">' + (FAIXA_EMOJI[cc.champ.faixa]||'🥋') + ' ' + cc.champ.nome + ' · 🔵 ' + cc.champ.borrachinhas + ' vidas</div>' +
                        '</div>' +
                        '<div class="camp-ct-champ-borr">' + cc.total + '<span style="font-size:10px;color:var(--text-3);font-weight:400;"> atletas</span></div>' +
                    '</div>';
                }

                html += '</div>'; // /camp-cat-section
            }
            container.innerHTML = html;
        }


        function toggleCampRules() {
            var body = document.getElementById('campAccordionBody');
            var arrow = document.getElementById('campAccordionArrow');
            var sub = document.querySelector('.camp-accordion-sub');
            if (!body) return;
            if (body.style.display === 'none') {
                body.style.display = 'block';
                if (arrow) arrow.classList.add('open');
                if (sub) sub.textContent = 'Toque para esconder';
            } else {
                body.style.display = 'none';
                if (arrow) arrow.classList.remove('open');
                if (sub) sub.textContent = 'Toque para ver as regras';
            }
        }

        function renderChampionsHall(champions, container) {
            var FAIXA_EMOJI = { 'Branca': '⬜', 'Azul': '🟦', 'Roxa': '🟪', 'Marrom': '🟫', 'Preta': '⬛' };
            var html = '';

            // Agrupar por edição → categoria
            var edicoes = {};
            for (var i = 0; i < champions.length; i++) {
                var c = champions[i];
                if (!edicoes[c.edicao]) edicoes[c.edicao] = {};
                var cat = c.categoria || 'Masculino';
                if (!edicoes[c.edicao][cat]) edicoes[c.edicao][cat] = [];
                edicoes[c.edicao][cat].push(c);
            }

            var edicaoKeys = Object.keys(edicoes).sort().reverse();
            for (var e = 0; e < edicaoKeys.length; e++) {
                var ed = edicaoKeys[e];
                html += '<div class="camp-podium-section">';
                html += '<div class="camp-podium-ed-label">📅 ' + ed + '</div>';

                var cats = Object.keys(edicoes[ed]).sort(); // Feminino, Masculino
                for (var ci = 0; ci < cats.length; ci++) {
                    var catName = cats[ci];
                    var catIcon = catName === 'Feminino' ? '♀️' : catName === 'Misto' ? '🤝' : '♂️';
                    var grupo = edicoes[ed][catName];
                    var geral = null;
                    var locais = [];

                    for (var g = 0; g < grupo.length; g++) {
                        if (grupo[g].tipo === 'GERAL') geral = grupo[g];
                        else locais.push(grupo[g]);
                    }

                    // Categoria label
                    if (cats.length > 1 || catName !== 'Masculino') {
                        var catLblColor = catName === 'Feminino' ? '#e879a0' : catName === 'Misto' ? '#7ec8e3' : 'var(--text-3)';
                        html += '<div style="font-size:10px;color:' + catLblColor + ';font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin:' + (ci > 0 ? '14px' : '0') + ' 0 8px;padding-left:4px;">' + catIcon + ' ' + catName + '</div>';
                    }

                    // Campeão Geral
                    if (geral) {
                        var geralBorder = catName === 'Feminino' ? 'rgba(232,121,160,0.35)' : catName === 'Misto' ? 'rgba(126,200,227,0.35)' : 'rgba(212,175,55,0.35)';
                        var geralBg = catName === 'Feminino' ? 'linear-gradient(135deg, #1a0a12 0%, #2a1520 50%, #1a0a12 100%)' : catName === 'Misto' ? 'linear-gradient(135deg, #0a1520 0%, #102535 50%, #0a1520 100%)' : 'linear-gradient(135deg, #1a1708 0%, #2a2510 50%, #1a1708 100%)';
                        var geralLblColor = catName === 'Feminino' ? '#e879a0' : catName === 'Misto' ? '#7ec8e3' : 'var(--gold)';
                        var geralTitle = catName === 'Feminino' ? 'Campeã Geral' : 'Campeão Geral';
                        html += '<div class="camp-podium-geral" style="border-color:' + geralBorder + ';background:' + geralBg + ';">' +
                            '<div class="camp-podium-geral-shimmer"></div>' +
                            '<div class="camp-podium-geral-crown">👑</div>' +
                            '<div class="camp-podium-geral-label" style="color:' + geralLblColor + ';">' + geralTitle + ' ' + catIcon + '</div>' +
                            '<div class="camp-podium-geral-name">' + geral.nome + '</div>' +
                            '<div class="camp-podium-geral-meta">' + (FAIXA_EMOJI[geral.faixa] || '🥋') + ' Faixa ' + (geral.faixa || '—') + ' · <strong>' + (geral.ct || '—') + '</strong></div>' +
                        '</div>';
                    }

                    // Campeões Locais
                    if (locais.length > 0) {
                        html += '<div class="camp-podium-locals-title">🏆 Campeões por CT ' + catIcon + '</div>';
                        for (var l = 0; l < locais.length; l++) {
                            var lc = locais[l];
                            html += '<div class="camp-podium-local">' +
                                '<div class="camp-podium-local-icon">🏆</div>' +
                                '<div class="camp-podium-local-info">' +
                                    '<div class="camp-podium-local-name">' + lc.nome + '</div>' +
                                    '<div class="camp-podium-local-meta">' + (FAIXA_EMOJI[lc.faixa] || '🥋') + ' Faixa ' + (lc.faixa || '—') + '</div>' +
                                '</div>' +
                                '<div class="camp-podium-local-ct">' + (lc.ct || '—') + '</div>' +
                            '</div>';
                        }
                    }
                }

                html += '</div>'; // /camp-podium-section
            }
            container.innerHTML = html;
        }

        // ===== CAMPEONATO ADMIN =====
        var campLocalCount = 0;
        var campPlacarData = []; // { email, nome, ct, faixa, borrachinhas }
        var adminStudentsCacheCamp = [];

        function getCampEdicoes() {
            var now = new Date();
            var year = now.getFullYear();
            var edicoes = [];
            for (var y = year + 1; y >= 2025; y--) {
                edicoes.push('2º Semestre ' + y);
                edicoes.push('1º Semestre ' + y);
            }
            return edicoes;
        }

        async function initCampAdmin() {
            // SEMPRE buscar CTs do backend para garantir que estejam carregados
            try {
                var data = await secureFetch('getCTsList', {});
                if (data.success && data.cts) {
                    allCTs = data.cts;
                    ctSchedules = {};
                    data.cts.forEach(function(ct) {
                        if (typeof ct === 'object' && ct.schedule) ctSchedules[ct.name] = ct.schedule;
                    });
                }
            } catch (e) { console.error('Erro ao carregar CTs:', e); }

            var edicoes = getCampEdicoes();

            // Popular edições - Campeões
            var sel = document.getElementById('campEdicao');
            if (sel) {
                sel.innerHTML = '<option value="">Selecione a edição</option>';
                edicoes.forEach(function(ed) { sel.innerHTML += '<option value="' + ed + '">' + ed + '</option>'; });
            }

            // Popular edições - Placar
            var selP = document.getElementById('campPlacarEdicao');
            if (selP) {
                selP.innerHTML = '<option value="">Selecione a edição</option>';
                edicoes.forEach(function(ed) { selP.innerHTML += '<option value="' + ed + '">' + ed + '</option>'; });
                var now = new Date();
                var curEd = (now.getMonth() < 6 ? '1º' : '2º') + ' Semestre ' + now.getFullYear();
                selP.value = curEd;
            }

            // Popular CT select para placar
            var selCT = document.getElementById('campPlacarCT');
            if (selCT) {
                selCT.innerHTML = '<option value="">Selecione o CT</option>';
                if (allCTs && allCTs.length > 0) {
                    allCTs.forEach(function(ct) {
                        var name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                        selCT.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
                    });
                }
            }

            // Popular CTs - Campeões
            populateCampCTSelect('campGeralCT');

            campLocalCount = 0;
            var lf = document.getElementById('campLocalFields');
            if (lf) lf.innerHTML = '';
            addCampLocalField();

            loadStudentsForPlacar();
            loadChampionsAdmin();
        }

        function onCampPlacarCTChange() {
            // Filtrar alunos pelo CT selecionado
            var ct = document.getElementById('campPlacarCT').value;
            var sel = document.getElementById('campPlacarAddAluno');
            if (!sel) return;
            sel.innerHTML = '<option value="">Selecione aluno</option>';

            var filtered = adminStudentsCacheCamp.filter(function(s) {
                if (!ct) return true;
                return s.ct === ct;
            });
            filtered.sort(function(a, b) { return (a.name || '').localeCompare(b.name || ''); });
            filtered.forEach(function(s) {
                sel.innerHTML += '<option value="' + escapeHtml(s.email) + '">' + escapeHtml(s.name) + '</option>';
            });

            // Recarregar placar para esse CT
            loadCampPlacarAdmin();
        }

        function populateCampCTSelect(selectId) {
            var sel = document.getElementById(selectId);
            if (!sel) return;
            sel.innerHTML = '<option value="">CT</option>';
            if (allCTs && allCTs.length > 0) {
                allCTs.forEach(function(ct) {
                    var name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                    sel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
                });
            }
        }

        async function loadStudentsForPlacar() {
            try {
                var data = await secureFetch('getStudentsList', {});
                if (data.success && data.students) {
                    adminStudentsCacheCamp = data.students;
                }
            } catch (err) { console.error('Erro carregar alunos camp:', err); }
        }

        function addAlunoPlacar() {
            var sel = document.getElementById('campPlacarAddAluno');
            var ctSel = document.getElementById('campPlacarCT');
            if (!sel || !sel.value) return;
            if (!ctSel || !ctSel.value) {
                showMessage('campPlacarMessage', '⚠️ Selecione o CT primeiro', 'warning');
                return;
            }

            var email = sel.value;
            if (campPlacarData.find(function(p) { return p.email === email; })) {
                showMessage('campPlacarMessage', '⚠️ Aluno já está no placar', 'warning');
                return;
            }

            var student = adminStudentsCacheCamp.find(function(s) { return s.email === email; });
            if (!student) return;

            campPlacarData.push({
                email: student.email,
                nome: student.name || '',
                ct: ctSel.value,
                faixa: student.faixa || '',
                borrachinhas: 5,
                categoria: document.getElementById('campPlacarCategoria').value || 'Masculino'
            });

            sel.value = '';
            renderPlacarAdmin();
        }

        function removePlacarRow(email) {
            campPlacarData = campPlacarData.filter(function(p) { return p.email !== email; });
            renderPlacarAdmin();
        }

        function updatePlacarBorr(email, value) {
            var entry = campPlacarData.find(function(p) { return p.email === email; });
            if (entry) entry.borrachinhas = parseInt(value) || 0;
        }

        function renderPlacarAdmin() {
            var container = document.getElementById('campPlacarRows');
            if (!container) return;
            var ct = document.getElementById('campPlacarCT') ? document.getElementById('campPlacarCT').value : '';
            var cat = document.getElementById('campPlacarCategoria') ? document.getElementById('campPlacarCategoria').value : 'Masculino';
            var CAT_IC = { 'Masculino': '♂️', 'Feminino': '♀️', 'Misto': '🤝' };

            if (campPlacarData.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:12px;padding:12px;">' + 
                    (!ct ? '📍 Selecione Edição, CT e Categoria para gerenciar o placar' : 'Nenhum atleta em <strong>' + (CAT_IC[cat]||'') + ' ' + cat + '</strong> para ' + ct + '. Adicione acima ☝️') + '</div>';
                return;
            }

            campPlacarData.sort(function(a, b) { return b.borrachinhas - a.borrachinhas; });

            var html = '<div style="font-size:11px;color:var(--gold);font-weight:700;margin-bottom:8px;letter-spacing:0.5px;">📍 ' + (ct || '—') + ' — ' + (CAT_IC[cat]||'') + ' ' + cat + ' — ' + campPlacarData.length + ' atletas</div>';
            for (var i = 0; i < campPlacarData.length; i++) {
                var p = campPlacarData[i];
                html += '<div class="camp-adm-row">' +
                    '<div style="font-size:11px;color:var(--text-3);min-width:22px;text-align:center;font-weight:700;">' + (i + 1) + 'º</div>' +
                    '<div class="camp-adm-name">' + p.nome + '</div>' +
                    '<div style="display:flex;align-items:center;gap:4px;">' +
                        '<span style="font-size:14px;">🔵</span>' +
                        '<input type="number" class="camp-adm-input" value="' + p.borrachinhas + '" min="0" onchange="updatePlacarBorr(\'' + p.email + '\', this.value)">' +
                    '</div>' +
                    '<button onclick="removePlacarRow(\'' + p.email + '\')" style="background:none;border:none;color:#e74c3c;font-size:14px;cursor:pointer;padding:4px;">✕</button>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        async function saveCampPlacar() {
            var edicao = document.getElementById('campPlacarEdicao').value;
            var ct = document.getElementById('campPlacarCT').value;
            if (!edicao) {
                showMessage('campPlacarMessage', '⚠️ Selecione a edição', 'warning');
                return;
            }
            if (!ct) {
                showMessage('campPlacarMessage', '⚠️ Selecione o CT', 'warning');
                return;
            }
            if (campPlacarData.length === 0) {
                showMessage('campPlacarMessage', '⚠️ Adicione alunos ao placar', 'warning');
                return;
            }

            showMessage('campPlacarMessage', 'Salvando placar...', 'warning');
            try {
                var data = await secureFetch('saveCampPlacar', { edicao: edicao, placar: campPlacarData });
                if (data.success) {
                    showMessage('campPlacarMessage', '✅ ' + data.message, 'success');
                } else {
                    showMessage('campPlacarMessage', '❌ ' + data.message, 'danger');
                }
            } catch (err) {
                showMessage('campPlacarMessage', '❌ Erro: ' + err.message, 'danger');
            }
        }

        async function loadCampPlacarAdmin() {
            var edicao = document.getElementById('campPlacarEdicao') ? document.getElementById('campPlacarEdicao').value : '';
            var ct = document.getElementById('campPlacarCT') ? document.getElementById('campPlacarCT').value : '';
            var categoria = document.getElementById('campPlacarCategoria') ? document.getElementById('campPlacarCategoria').value : 'Masculino';
            if (!edicao || !ct) {
                campPlacarData = [];
                renderPlacarAdmin();
                return;
            }

            try {
                var data = await secureFetch('getCampPlacar', { edicao: edicao, ct: ct, categoria: categoria });
                campPlacarData = (data.success && data.placar) ? data.placar : [];
                renderPlacarAdmin();
            } catch (err) {
                campPlacarData = [];
                renderPlacarAdmin();
            }
        }

        // --- Campeões ---
        function addCampLocalField() {
            campLocalCount++;
            var idx = campLocalCount;
            var container = document.getElementById('campLocalFields');
            if (!container) return;
            var div = document.createElement('div');
            div.className = 'ct-detail-row';
            div.id = 'campLocal' + idx;
            div.innerHTML =
                '<div class="ct-detail-field"><label>Nome</label><input type="text" id="campLocalNome' + idx + '" placeholder="Campeão do CT"></div>' +
                '<div class="ct-detail-field"><label>CT</label><select id="campLocalCT' + idx + '"></select></div>' +
                '<div class="ct-detail-field"><label>Faixa</label><select id="campLocalFaixa' + idx + '">' +
                    '<option value="Branca">Branca</option><option value="Azul">Azul</option><option value="Roxa">Roxa</option><option value="Marrom">Marrom</option><option value="Preta">Preta</option>' +
                '</select></div>';
            container.appendChild(div);
            populateCampCTSelect('campLocalCT' + idx);
        }

        async function saveChampions() {
            var edicao = document.getElementById('campEdicao').value;
            var categoria = document.getElementById('campCategoria') ? document.getElementById('campCategoria').value : 'Masculino';
            if (!edicao) {
                showMessage('campSaveMessage', '⚠️ Selecione a edição', 'warning');
                return;
            }

            var champions = [];
            for (var i = 1; i <= campLocalCount; i++) {
                var nome = document.getElementById('campLocalNome' + i);
                var ct = document.getElementById('campLocalCT' + i);
                var faixa = document.getElementById('campLocalFaixa' + i);
                if (nome && nome.value.trim()) {
                    champions.push({ edicao: edicao, tipo: 'LOCAL', nome: nome.value.trim(), ct: ct ? ct.value : '', faixa: faixa ? faixa.value : '', categoria: categoria });
                }
            }

            var geralNome = document.getElementById('campGeralNome').value.trim();
            if (geralNome) {
                champions.push({ edicao: edicao, tipo: 'GERAL', nome: geralNome, ct: document.getElementById('campGeralCT').value, faixa: document.getElementById('campGeralFaixa').value, categoria: categoria });
            }

            if (champions.length === 0) {
                showMessage('campSaveMessage', '⚠️ Preencha ao menos um campeão', 'warning');
                return;
            }

            showMessage('campSaveMessage', 'Salvando...', 'warning');
            try {
                var data = await secureFetch('saveChampions', { champions: champions });
                if (data.success) {
                    showMessage('campSaveMessage', '✅ ' + data.message, 'success');
                    document.getElementById('campGeralNome').value = '';
                    campLocalCount = 0;
                    document.getElementById('campLocalFields').innerHTML = '';
                    addCampLocalField();
                    loadChampionsAdmin();
                } else {
                    showMessage('campSaveMessage', '❌ ' + data.message, 'danger');
                }
            } catch (err) {
                showMessage('campSaveMessage', '❌ Erro: ' + err.message, 'danger');
            }
        }

        async function loadChampionsAdmin() {
            var container = document.getElementById('campAdminList');
            if (!container) return;
            container.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:12px;padding:8px;">Carregando...</div>';

            try {
                var data = await secureFetch('getChampions', {});
                if (data.success && data.champions && data.champions.length > 0) {
                    renderChampionsAdmin(data.champions, container);
                } else {
                    container.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:12px;padding:8px;">Nenhum campeão cadastrado</div>';
                }
            } catch (err) {
                container.innerHTML = '<div style="text-align:center;color:var(--text-3);font-size:12px;padding:8px;">Erro ao carregar</div>';
            }
        }

        function renderChampionsAdmin(champions, container) {
            var FAIXA_EMOJI = { 'Branca': '⬜', 'Azul': '🟦', 'Roxa': '🟪', 'Marrom': '🟫', 'Preta': '⬛' };
            var html = '';

            var edicoes = {};
            for (var i = 0; i < champions.length; i++) {
                var c = champions[i];
                if (!edicoes[c.edicao]) edicoes[c.edicao] = [];
                edicoes[c.edicao].push(c);
            }

            var edicaoKeys = Object.keys(edicoes).sort().reverse();
            for (var e = 0; e < edicaoKeys.length; e++) {
                var ed = edicaoKeys[e];
                var grupo = edicoes[ed];
                html += '<div style="font-size:11px;color:var(--text-3);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin:' + (e > 0 ? '16px' : '0') + ' 0 8px;padding-left:4px;">📅 ' + ed + '</div>';
                grupo.sort(function(a, b) { return a.tipo === 'GERAL' ? -1 : 1; });
                for (var g = 0; g < grupo.length; g++) {
                    var ch = grupo[g];
                    var isGeral = ch.tipo === 'GERAL';
                    var rowIdx = ch.rowIndex || 0;
                    html += '<div class="camp-champ-card camp-champ-admin">' +
                        '<div class="camp-champ-medal">' + (isGeral ? '👑' : '🏆') + '</div>' +
                        '<div class="camp-champ-info">' +
                            '<div class="camp-champ-name">' + ch.nome + '</div>' +
                            '<div class="camp-champ-detail">' + (FAIXA_EMOJI[ch.faixa] || '🥋') + ' ' + (ch.faixa || '—') + ' · <strong>' + (ch.ct || '—') + '</strong> · ' + (ch.categoria === 'Feminino' ? '♀️' : '♂️') + ' ' + (ch.categoria || 'Masc') + '</div>' +
                        '</div>' +
                        '<div class="camp-champ-actions">' +
                            '<button class="camp-champ-act-btn edit" onclick="event.stopPropagation();openEditChampion(' + rowIdx + ',\'' + escHtml(ch.edicao) + '\',\'' + escHtml(ch.tipo) + '\',\'' + escHtml(ch.nome) + '\',\'' + escHtml(ch.ct) + '\',\'' + escHtml(ch.faixa) + '\',\'' + escHtml(ch.categoria || 'Masculino') + '\')">✏️</button>' +
                            '<button class="camp-champ-act-btn del" onclick="event.stopPropagation();deleteChampion(' + rowIdx + ',\'' + escHtml(ch.nome) + '\')">🗑️</button>' +
                        '</div>' +
                    '</div>';
                }
            }
            container.innerHTML = html;
        }

        function escHtml(s) {
            return (s || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        }

        function openEditChampion(rowIndex, edicao, tipo, nome, ct, faixa, categoria) {
            document.getElementById('champEditRow').value = rowIndex;
            document.getElementById('champEditNome').value = nome;
            document.getElementById('champEditFaixa').value = faixa || 'Branca';
            document.getElementById('champEditTipo').value = tipo || 'LOCAL';
            document.getElementById('champEditCategoria').value = categoria || 'Masculino';

            // Populate edicao select
            var edSel = document.getElementById('champEditEdicao');
            var edicoes = getCampEdicoes();
            edSel.innerHTML = '';
            edicoes.forEach(function(ed) { edSel.innerHTML += '<option value="' + ed + '">' + ed + '</option>'; });
            edSel.value = edicao;

            // Populate CT select
            var ctSel = document.getElementById('champEditCT');
            ctSel.innerHTML = '<option value="">—</option>';
            if (allCTs && allCTs.length > 0) {
                allCTs.forEach(function(c) {
                    var name = typeof c === 'string' ? c : c.name || c.toString();
                    ctSel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
                });
            }
            ctSel.value = ct;

            document.getElementById('champEditMessage').innerHTML = '';
            document.getElementById('champEditOverlay').style.display = 'flex';
        }

        function closeEditChampion() {
            document.getElementById('champEditOverlay').style.display = 'none';
        }

        async function saveEditChampion() {
            var rowIndex = document.getElementById('champEditRow').value;
            var payload = {
                action: 'updateChampion',
                rowIndex: parseInt(rowIndex),
                edicao: document.getElementById('champEditEdicao').value,
                tipo: document.getElementById('champEditTipo').value,
                nome: document.getElementById('champEditNome').value.trim(),
                ct: document.getElementById('champEditCT').value,
                faixa: document.getElementById('champEditFaixa').value,
                categoria: document.getElementById('champEditCategoria').value
            };

            if (!payload.nome) {
                document.getElementById('champEditMessage').innerHTML = '<span style="color:#e74c3c;">Preencha o nome</span>';
                return;
            }

            document.getElementById('champEditMessage').innerHTML = '<span style="color:var(--text-3);">Salvando...</span>';
            try {
                if (getSessionToken()) payload.token = getSessionToken();
                var r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                var data = await r.json();
                if (data.unauthorized) { handleSessionExpired(); return; }
                if (data.forbidden) { alert('⛔ Sem permissão'); return; }
                if (data.success) {
                    closeEditChampion();
                    loadChampionsAdmin();
                } else {
                    document.getElementById('champEditMessage').innerHTML = '<span style="color:#e74c3c;">❌ ' + escapeHtml(data.message) + '</span>';
                }
            } catch (err) {
                document.getElementById('champEditMessage').innerHTML = '<span style="color:#e74c3c;">❌ ' + err.message + '</span>';
            }
        }

        async function deleteChampion(rowIndex, nome) {
            if (!confirm('Remover campeão "' + nome + '"?')) return;

            try {
                var data = await secureFetch('deleteChampion', { rowIndex: rowIndex });
                if (data.success) {
                    loadChampionsAdmin();
                } else {
                    alert('Erro: ' + data.message);
                }
            } catch (err) {
                alert('Erro: ' + err.message);
            }
        }

        // ===== ADMIN PANEL =====
        let adminCheckinFilter = 'hoje';
        let adminPendingCheckins = [];
        let adminApprovedCheckins = [];
        let adminSelectedCT = null;
        let adminStudentsCache = [];

        function switchAdminTab(tabName, evt) {
            document.querySelectorAll('.adm-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('#adminNav .bnav-btn').forEach(function(b) { b.classList.remove('active'); });
            var tab = document.getElementById(tabName);
            if (tab) tab.classList.add('active');
            if (evt && evt.target) {
                var btn = evt.target.closest('.bnav-btn');
                if (btn) btn.classList.add('active');
            }
            if (tabName === 'adm-painel') loadAdminPanel();
            if (tabName === 'adm-alunos') loadStudentsList();
            if (tabName === 'adm-relatorios') loadNewReportData();
            if (tabName === 'adm-campeonato') initCampAdmin();
            if (tabName === 'adm-sistema') { loadSystemHealth(); loadAdminCTs(); loadAdminProfile(); }
        }

        function loadAdminProfile() {
            if (!currentUser) return;
            document.getElementById('admPerfilName').textContent = currentUser.name;
            document.getElementById('admPerfilEmail').textContent = currentUser.email;
            document.getElementById('admPerfilInitial').textContent = currentUser.name.charAt(0).toUpperCase();
        }

        async function loadAdminPanel() {
            if (!currentUser || !isAdmin()) return;
            loadPendingAccounts();
            loadPendingResets();
            loadPendingCheckins();
            loadPendingGraduacoes();
            loadAdminRanking();
        }

        // --- ADMIN OWN CHECK-IN ---
        async function loadAdminCTs() {
            try {
                var data = await secureFetch('getCTsList', {});
                if (data.success && data.cts) {
                    var grid = document.getElementById('admCtGrid');
                    if (grid) {
                        grid.innerHTML = '';
                        data.cts.forEach(function(ct) {
                            var name = typeof ct === 'string' ? ct : ct.name || ct.toString();
                            var btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'ct-btn';
                            if (adminSelectedCT === name) btn.classList.add('selected');
                            btn.textContent = name;
                            btn.addEventListener('click', function() {
                                adminSelectedCT = name;
                                document.querySelectorAll('#admCtGrid .ct-btn').forEach(function(b) { b.classList.remove('selected'); });
                                btn.classList.add('selected');
                                document.getElementById('admSelectedCT').textContent = name;
                                document.getElementById('admSelectedInfo').classList.add('active');
                            });
                            grid.appendChild(btn);
                        });
                    }
                }
            } catch (err) { console.error('Erro CTs admin:', err); }
        }

        function adminConfirmAttendance() {
            if (!adminSelectedCT) { showMessage('admAttendanceMessage', 'Selecione o CT', 'warning'); return; }
            var windowCheck = checkCheckinWindow(adminSelectedCT);
            if (!windowCheck.allowed) {
                showMessage('admAttendanceMessage', windowCheck.message, 'warning');
                return;
            }
            showMessage('admAttendanceMessage', 'Registrando...', 'info');
            secureFetch('attendance', {
                email: currentUser.email, name: currentUser.name,
                faixa: currentUser.faixa, grau: currentUser.grau, ct: adminSelectedCT
            }).then(function(data) {
                if (data.success) {
                    if (data.status === 'APROVADO') {
                        currentUser.treinos = (currentUser.treinos || 0) + 1;
                        currentUser.ultimoCheckin = new Date().toISOString();
                        localStorage.setItem('bjjUser', JSON.stringify(currentUser));
                        document.getElementById('admDisplayCount').textContent = currentUser.treinos;
                        showMessage('admAttendanceMessage', '✅ Presença registrada!', 'success');
                    } else {
                        showMessage('admAttendanceMessage', data.message || '⏳ Pendente de aprovação', 'warning');
                    }
                    adminSelectedCT = null;
                    document.querySelectorAll('#admCtGrid .ct-btn').forEach(function(b) { b.classList.remove('selected'); });
                    document.getElementById('admSelectedCT').textContent = '-';
                    document.getElementById('admSelectedInfo').classList.remove('active');
                    setTimeout(function() { document.getElementById('admAttendanceMessage').innerHTML = ''; }, 4000);
                } else {
                    showMessage('admAttendanceMessage', data.message || 'Erro', 'danger');
                }
            }).catch(function() { showMessage('admAttendanceMessage', 'Erro de conexão', 'danger'); });
        }

        // --- ADMIN CHANGE PASSWORD ---
        async function adminChangePassword() {
            var cur = document.getElementById('admCurrentPw').value;
            var nw = document.getElementById('admNewPw').value;
            var confirm = document.getElementById('admConfirmPw').value;
            if (!cur || !nw) { showMessage('admPwMessage', 'Preencha todos os campos', 'warning'); return; }
            if (nw.length < 6) { showMessage('admPwMessage', 'Mínimo 6 caracteres', 'warning'); return; }
            if (nw !== confirm) { showMessage('admPwMessage', 'Senhas não conferem', 'warning'); return; }
            showMessage('admPwMessage', 'Alterando...', 'info');
            try {
                var data = await secureFetch('changePassword', { email: currentUser.email, currentPassword: cur, newPassword: nw });
                if (data.success) {
                    showMessage('admPwMessage', '✅ Senha alterada!', 'success');
                    document.getElementById('admCurrentPw').value = '';
                    document.getElementById('admNewPw').value = '';
                    document.getElementById('admConfirmPw').value = '';
                } else {
                    showMessage('admPwMessage', data.message || 'Erro', 'danger');
                }
            } catch (err) { showMessage('admPwMessage', 'Erro de conexão', 'danger'); }
        }



        // --- PENDING GRADUATIONS ---
        async function loadPendingGraduacoes() {
            var container = document.getElementById('adminGradList');
            if (!container) return;
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getPendingGraduacoes', {});
                if (data.success && data.pending && data.pending.length > 0) {
                    var html = '';
                    data.pending.forEach(function(g, idx) {
                        var icon = g.tipo === 'grau' ? '🔵' : (g.tipo === 'faixa' ? '🥋' : '📅');
                        var detail = '';
                        if (g.tipo === 'grau') detail = g.faixa + ' · ' + g.grau + 'º Grau';
                        else if (g.tipo === 'faixa') detail = 'Faixa ' + g.faixa;
                        else if (g.tipo === 'inicio') detail = 'Início no BJJ';
                        if (g.data) detail += ' · ' + g.data;
                        if (g.obs) detail += ' · "' + g.obs + '"';

                        html += '<div class="admin-card" id="gradCard' + idx + '">' +
                            '<div class="admin-card-top">' +
                                '<div class="admin-card-avatar" style="font-size:18px;">' + icon + '</div>' +
                                '<div class="admin-card-info">' +
                                    '<div class="admin-card-name">' + escapeHtml(g.name) + '</div>' +
                                    '<div class="admin-card-meta">' + escapeHtml(g.email) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="admin-card-detail">' + escapeHtml(g.tipoLabel) + ' · ' + escapeHtml(detail) + '</div>' +
                            '<div class="admin-card-actions">' +
                                '<button class="admin-btn approve" onclick="approveGraduacao(' + g.rowIndex + ',' + idx + ')">✓ Aprovar</button>' +
                                '<button class="admin-btn reject" onclick="rejectGraduacao(' + g.rowIndex + ',' + idx + ',\'' + escapeHtml(g.name).replace(/'/g, "\\'") + '\')">✕ Rejeitar</button>' +
                            '</div>' +
                        '</div>';
                    });
                    container.innerHTML = html;
                    var badge = document.getElementById('adminGradBadge');
                    if (badge) { badge.textContent = data.pending.length; badge.style.display = 'inline-block'; }
                    var countEl = document.getElementById('adminPendingGradCount');
                    if (countEl) countEl.textContent = data.pending.length;
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhuma graduação pendente 🎉</div>';
                    var badge2 = document.getElementById('adminGradBadge');
                    if (badge2) badge2.style.display = 'none';
                    var countEl2 = document.getElementById('adminPendingGradCount');
                    if (countEl2) countEl2.textContent = '0';
                }
            } catch (err) {
                console.error('loadPendingGraduacoes:', err);
                container.innerHTML = '<div class="admin-empty" style="color:#E85D5D;">Erro ao carregar</div>';
            }
        }

        async function approveGraduacao(rowIndex, idx) {
            var card = document.getElementById('gradCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('addGraduacao', { rowIndex: rowIndex });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(45,138,78,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:#2d8a4e">✅ Graduação aprovada!</div>'; }
                    setTimeout(loadPendingGraduacoes, 1500);
                } else {
                    alert(data.message || 'Erro ao aprovar');
                    if (card) card.style.opacity = '1';
                }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        async function rejectGraduacao(rowIndex, idx, name) {
            if (!confirm('Rejeitar graduação de ' + name + '?')) return;
            var card = document.getElementById('gradCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('rejectGraduacao', { rowIndex: rowIndex });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(232,93,93,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:var(--coral)">❌ Graduação rejeitada</div>'; }
                    setTimeout(loadPendingGraduacoes, 1500);
                } else { alert(data.message || 'Erro'); if (card) card.style.opacity = '1'; }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        // --- ATTENDANCE REPORT ---
        var _rptData = null;
        var _rptFilterCT = '';

        function initReportDates() {
            var now = new Date();
            var todayStr = now.getFullYear() + '-' + ('0'+(now.getMonth()+1)).slice(-2) + '-' + ('0'+now.getDate()).slice(-2);
            document.getElementById('rptDateFrom').value = todayStr;
            document.getElementById('rptDateTo').value = todayStr;
        }

        function setRptQuickPeriod(period, btn) {
            document.querySelectorAll('.rpt-quick-btn').forEach(function(b) { b.classList.remove('active'); });
            if (btn) btn.classList.add('active');
            var now = new Date();
            var from = new Date(now), to = new Date(now);
            if (period === 'semana') { from.setDate(now.getDate() - now.getDay()); }
            else if (period === 'mes') { from = new Date(now.getFullYear(), now.getMonth(), 1); }
            else if (period === 'ano') { from = new Date(now.getFullYear(), 0, 1); }
            document.getElementById('rptDateFrom').value = fmtDateISO(from);
            document.getElementById('rptDateTo').value = fmtDateISO(to);
            generateReport();
        }

        function fmtDateISO(d) {
            return d.getFullYear() + '-' + ('0'+(d.getMonth()+1)).slice(-2) + '-' + ('0'+d.getDate()).slice(-2);
        }

        function fmtDateBR(isoStr) {
            if (!isoStr) return '';
            var p = isoStr.split('-');
            if (p.length === 3) return p[2] + '/' + p[1] + '/' + p[0];
            return isoStr;
        }

        async function loadNewReportData() {
            initReportDates();
            generateReport();
        }

        async function generateReport() {
            var loading = document.getElementById('rptLoading');
            var content = document.getElementById('rptContent');
            if (loading) loading.style.display = 'block';
            if (content) content.style.display = 'none';

            var dateFrom = document.getElementById('rptDateFrom').value;
            var dateTo = document.getElementById('rptDateTo').value;
            var filterCT = document.getElementById('rptCTSelect').value || '';

            try {
                var data = await secureFetch('getReportData', { dateFrom: dateFrom, dateTo: dateTo, filterCT: filterCT });
                if (loading) loading.style.display = 'none';
                if (data.success) {
                    _rptData = data;
                    // Populate CT select
                    var ctSel = document.getElementById('rptCTSelect');
                    if (ctSel && data.allCTs) {
                        var curVal = ctSel.value;
                        var opts = '<option value="">Todos os CTs</option>';
                        data.allCTs.forEach(function(ct) {
                            opts += '<option value="' + escapeHtml(ct) + '"' + (ct === curVal ? ' selected' : '') + '>' + escapeHtml(ct) + '</option>';
                        });
                        ctSel.innerHTML = opts;
                    }
                    if (content) content.style.display = 'block';
                    renderReport(data);
                }
            } catch(e) {
                if (loading) { loading.style.display = 'block'; loading.textContent = 'Erro ao carregar relatório'; }
                console.error('generateReport:', e);
            }
        }

        function rptStatCards(cards) {
            return cards.map(function(c) {
                return '<div class="admin-stat ' + (c.cls||'') + '"><div class="admin-stat-num">' + c.num + '</div><div class="admin-stat-label">' + c.label + '</div></div>';
            }).join('');
        }

        function rptBarChart(containerId, dataObj, prefix) {
            var el = document.getElementById(containerId);
            if (!el) return;
            var keys = Object.keys(dataObj);
            if (keys.length === 0) { el.innerHTML = '<div class="admin-empty">Sem dados</div>'; return; }
            var max = Math.max.apply(null, keys.map(function(k){return dataObj[k];})) || 1;
            var h = '';
            keys.forEach(function(k) {
                var pct = Math.max(Math.round(dataObj[k] / max * 100), 4);
                var lbl = (prefix||'') + k;
                h += '<div class="rpt-bar-row"><div class="rpt-bar-label">' + lbl + '</div><div class="rpt-bar-track"><div class="rpt-bar-fill" style="width:' + pct + '%;"><span class="rpt-bar-val">' + dataObj[k] + '</span></div></div></div>';
            });
            el.innerHTML = h;
        }

        function rptMiniList(containerId, items, emptyMsg) {
            var el = document.getElementById(containerId);
            if (!el) return;
            if (!items || items.length === 0) { el.innerHTML = '<div class="admin-empty">' + (emptyMsg||'Sem dados') + '</div>'; return; }
            var h = '';
            items.forEach(function(item) {
                h += '<div class="rpt-mini-item"><div><span class="rpt-mini-name">' + escapeHtml(item.name||'') + '</span><div class="rpt-mini-meta">' + escapeHtml(item.meta||'') + '</div></div><span class="rpt-mini-tag ' + (item.tagCls||'') + '">' + (item.tag||'') + '</span></div>';
            });
            el.innerHTML = h;
        }

        function renderReport(data) {
            var s = data.summary;
            var ctLabel = data.filterCT ? ' · ' + data.filterCT : '';

            // Period label
            var periodEl = document.getElementById('rptPeriodLabel');
            if (periodEl) periodEl.textContent = fmtDateBR(data.dateFrom) + ' até ' + fmtDateBR(data.dateTo) + ctLabel;

            // Summary stats
            var totalFaltas = 0;
            (data.faltasAlunos || []).forEach(function(f) { totalFaltas += f.faltas; });
            var statsEl = document.getElementById('rptSummaryStats');
            if (statsEl) statsEl.innerHTML = rptStatCards([
                {num: s.totalPeriodo, label:'Check-ins no período', cls:'ok'},
                {num: s.totalAlunos, label:'Alunos total'},
                {num: s.ativos, label:'Ativos', cls:'ok'},
                {num: (data.alertas5 || []).length, label:'🚨 Alertas 5+', cls: (data.alertas5||[]).length > 0 ? 'warn' : ''}
            ]);

            // ===== ALERTS (5+ faltas) =====
            var alertSection = document.getElementById('rptAlertSection');
            var alertEl = document.getElementById('rptAlerts');
            if (alertSection && alertEl) {
                if (data.alertas5 && data.alertas5.length > 0) {
                    alertSection.style.display = '';
                    var ah = '';
                    data.alertas5.forEach(function(a) {
                        ah += '<div class="rpt-alert-row">' +
                            '<div class="rpt-alert-icon">🚨</div>' +
                            '<div class="rpt-alert-info">' +
                                '<div class="rpt-alert-name">' + escapeHtml(a.name) + '</div>' +
                                '<div class="rpt-alert-meta">' + escapeHtml(a.ct||'') + ' · ' + escapeHtml(a.faixa||'') + ' · ' + escapeHtml(a.turno||'Flexível') + ' · ' + a.esperadas + ' aulas esperadas</div>' +
                            '</div>' +
                            '<div class="rpt-alert-badge">' + a.faltas + ' faltas</div>' +
                        '</div>';
                    });
                    alertEl.innerHTML = ah;
                } else {
                    alertSection.style.display = 'none';
                }
            }

            // ===== HOURLY SUMMARY (presentes + ausentes por horário) =====
            var hourlyEl = document.getElementById('rptHourlySummary');
            if (hourlyEl) {
                var hs = data.hourlySummary || {};
                var hKeys = Object.keys(hs).sort();
                if (hKeys.length === 0) {
                    hourlyEl.innerHTML = '<div class="admin-empty">Sem dados de horário</div>';
                } else {
                    var hh = '';
                    hKeys.forEach(function(slot) {
                        var info = hs[slot];
                        hh += '<div class="rpt-hourly-slot">';
                        hh += '<div class="rpt-hourly-header">';
                        hh += '<div class="rpt-hourly-time">🕐 ' + slot + '</div>';
                        hh += '<div class="rpt-hourly-badges">';
                        hh += '<div class="rpt-hourly-badge green">✅ ' + info.presentes + '</div>';
                        hh += '<div class="rpt-hourly-badge red">❌ ' + info.ausentes + '</div>';
                        hh += '</div></div>';
                        hh += '<div class="rpt-hourly-detail">';
                        hh += '<div class="rpt-hourly-columns">';
                        // Presentes column
                        hh += '<div class="rpt-hourly-col">';
                        hh += '<div class="rpt-hourly-group-title">✅ Presentes (' + info.presentes + ')</div>';
                        if (info.presentesList && info.presentesList.length > 0) {
                            info.presentesList.forEach(function(p) {
                                hh += '<div class="rpt-hourly-name">' + escapeHtml(p.name) + ' <span style="color:var(--adm-text-3);font-size:10px;">' + escapeHtml(p.faixa||'') + '</span></div>';
                            });
                        } else {
                            hh += '<div class="rpt-hourly-name" style="color:var(--adm-text-3);">Nenhum</div>';
                        }
                        hh += '</div>';
                        // Ausentes column
                        hh += '<div class="rpt-hourly-col">';
                        hh += '<div class="rpt-hourly-group-title">❌ Ausentes (' + info.ausentes + ')</div>';
                        if (info.ausentesList && info.ausentesList.length > 0) {
                            info.ausentesList.forEach(function(a) {
                                hh += '<div class="rpt-hourly-name" style="color:#f87171;">' + escapeHtml(a.name) + ' <span style="font-size:10px;">' + escapeHtml(a.faixa||'') + '</span></div>';
                            });
                        } else {
                            hh += '<div class="rpt-hourly-name" style="color:var(--adm-text-3);">Nenhum</div>';
                        }
                        hh += '</div>';
                        hh += '</div></div></div>';
                    });
                    hourlyEl.innerHTML = hh;
                }
            }

            // ===== FALTAS ACUMULADAS =====
            var faltasBadge = document.getElementById('rptFaltasBadge');
            var faltasEl = document.getElementById('rptFaltasList');
            var faltasArr = data.faltasAlunos || [];
            if (faltasBadge) faltasBadge.textContent = faltasArr.filter(function(f){return f.faltas > 0;}).length;
            if (faltasEl) {
                var faltasFiltered = faltasArr.filter(function(f){return f.faltas > 0;});
                if (faltasFiltered.length === 0) {
                    faltasEl.innerHTML = '<div class="admin-empty">Nenhuma falta no período 🎉</div>';
                } else {
                    var fh = '';
                    faltasFiltered.forEach(function(f) {
                        var badgeCls = f.faltas >= 5 ? 'danger' : (f.faltas >= 3 ? 'warn' : 'info');
                        fh += '<div class="rpt-aluno-row">' +
                            '<div class="rpt-aluno-status absent">❌</div>' +
                            '<div class="rpt-aluno-info">' +
                                '<div class="rpt-aluno-name">' + escapeHtml(f.name) + '</div>' +
                                '<div class="rpt-aluno-detail">' + escapeHtml(f.ct||'') + ' · ' + escapeHtml(f.faixa||'') + ' · ' + escapeHtml(f.turno||'Flexível') + ' · ' + f.presentes + '/' + f.esperadas + ' aulas (' + f.pctPresenca + '%)</div>' +
                            '</div>' +
                            '<div class="rpt-aluno-badge ' + badgeCls + '">' + f.faltas + ' falta' + (f.faltas !== 1 ? 's' : '') + '</div>' +
                        '</div>';
                    });
                    faltasEl.innerHTML = fh;
                }
            }

            // ===== CT Chart =====
            rptBarChart('rptCTChart', data.ctPresent || {}, '');

            // ===== Insights =====
            rptMiniList('rptRisk',
                (data.insights.emRisco || []).map(function(r) { return {name:r.name, meta:r.ct+' · '+r.faixa, tag:r.dias+' dias', tagCls:'yellow'}; }),
                'Nenhum em risco 💪');
            rptMiniList('rptInactive',
                (data.insights.inativos || []).slice(0,25).map(function(i2) { return {name:i2.name, meta:i2.ct+' · '+i2.faixa, tag:i2.dias+' dias', tagCls:'red'}; }),
                'Nenhum inativo 🎉');
            rptMiniList('rptPromo',
                (data.insights.elegiveisPromo || []).map(function(p) { return {name:p.name, meta:p.faixa+' → '+p.proxFaixa+' · '+p.treinos+' treinos', tag:'Elegível', tagCls:'blue'}; }),
                'Nenhum elegível no momento');
        }

        function toggleRptSection(el) {
            el.classList.toggle('open');
            var content = el.nextElementSibling;
            if (content) content.style.display = el.classList.contains('open') ? '' : 'none';
        }

        function exportReportCSV() {
            if (!_rptData) { alert('Gere o relatório primeiro'); return; }
            var d = _rptData;
            var s = d.summary;
            var csv = '\uFEFF';
            csv += 'RELAT\u00d3RIO ACADEMIA - Per\u00edodo: ' + fmtDateBR(d.dateFrom) + ' a ' + fmtDateBR(d.dateTo) + '\n';
            csv += 'Gerado em: ' + new Date().toLocaleString('pt-BR') + '\n\n';
            csv += 'RESUMO\n';
            csv += 'Total Alunos,' + s.totalAlunos + '\n';
            csv += 'Ativos,' + s.ativos + '\n';
            csv += 'Inativos,' + s.inativos + '\n';
            csv += 'Check-ins no per\u00edodo,' + s.totalPeriodo + '\n';
            csv += 'Alertas 5+ faltas,' + (d.alertas5||[]).length + '\n\n';

            csv += 'PRESEN\u00c7A POR HOR\u00c1RIO\nHor\u00e1rio,Presentes,Ausentes\n';
            var hs = d.hourlySummary || {};
            Object.keys(hs).sort().forEach(function(slot) {
                csv += slot + ',' + hs[slot].presentes + ',' + hs[slot].ausentes + '\n';
            });

            csv += '\nFALTAS ACUMULADAS\nNome,CT,Faixa,Esperadas,Presentes,Faltas,Frequ\u00eancia\n';
            (d.faltasAlunos||[]).forEach(function(f) {
                csv += '"' + f.name + '","' + (f.ct||'') + '","' + (f.faixa||'') + '",' + f.esperadas + ',' + f.presentes + ',' + f.faltas + ',' + f.pctPresenca + '%\n';
            });

            csv += '\nALERTAS 5+ FALTAS\nNome,CT,Faixa,Faltas,Esperadas\n';
            (d.alertas5||[]).forEach(function(a) {
                csv += '"' + a.name + '","' + (a.ct||'') + '","' + (a.faixa||'') + '",' + a.faltas + ',' + a.esperadas + '\n';
            });

            csv += '\nEM RISCO (15-30 dias)\nNome,CT,Faixa,Dias\n';
            (d.insights.emRisco||[]).forEach(function(r) {
                csv += '"' + r.name + '","' + (r.ct||'') + '","' + (r.faixa||'') + '",' + r.dias + '\n';
            });
            csv += '\nINATIVOS (+30 dias)\nNome,CT,Faixa,Dias\n';
            (d.insights.inativos||[]).forEach(function(i2) {
                csv += '"' + i2.name + '","' + (i2.ct||'') + '","' + (i2.faixa||'') + '",' + i2.dias + '\n';
            });

            var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'relatorio_' + (d.dateFrom||'') + '_' + (d.dateTo||'') + '.csv';
            link.click();
        }

        // ===== SYSTEM HEALTH =====
        async function loadSystemHealth() {
            var issuesDiv = document.getElementById('sysHealthIssues');
            if (issuesDiv) issuesDiv.innerHTML = '<div class="admin-empty">Verificando sistema...</div>';
            try {
                var data = await secureFetch('getSystemHealth', {});
                if (!data.success) return;

                var scoreEl = document.getElementById('sysHealthScore');
                var circleEl = document.getElementById('sysHealthCircle');
                var numEl = document.getElementById('sysHealthNum');
                var labelEl = document.getElementById('sysHealthLabel');
                var timeEl = document.getElementById('sysHealthTime');
                if (scoreEl) scoreEl.style.display = 'flex';
                if (numEl) numEl.textContent = data.healthScore;
                if (timeEl) timeEl.textContent = 'Verificado: ' + new Date().toLocaleTimeString('pt-BR');
                if (circleEl) {
                    circleEl.className = 'sys-health-circle';
                    if (data.healthScore >= 80) { if(labelEl) labelEl.textContent = '✅ Sistema saudável'; }
                    else if (data.healthScore >= 50) { circleEl.classList.add('warn'); if(labelEl) labelEl.textContent = '⚠️ Atenção necessária'; }
                    else { circleEl.classList.add('bad'); if(labelEl) labelEl.textContent = '🔴 Problemas detectados'; }
                }

                var statsEl = document.getElementById('sysHealthStats');
                if (statsEl && data.stats) {
                    statsEl.style.display = 'grid';
                    statsEl.innerHTML = rptStatCards([
                        {num: data.stats.totalAlunos||0, label:'Alunos'},
                        {num: data.stats.totalPresenca||0, label:'Presenças'},
                        {num: data.stats.totalCTs||0, label:'CTs'},
                        {num: (data.stats.presencaPendentes||0) + (data.stats.contasPendentes||0) + (data.stats.resetsPendentes||0), label:'Pendências', cls: (data.stats.presencaPendentes||0) > 0 ? 'warn' : ''}
                    ]);
                }

                if (issuesDiv) {
                    if (!data.issues || data.issues.length === 0) {
                        issuesDiv.innerHTML = '<div class="admin-empty">Nenhum problema encontrado! 🎉</div>';
                    } else {
                        var icons = {error:'🔴', warning:'🟡', info:'ℹ️'};
                        var ih = '';
                        data.issues.forEach(function(issue) {
                            ih += '<div class="sys-issue ' + issue.type + '"><div class="sys-issue-icon">' + (icons[issue.type]||'ℹ️') + '</div><div><span class="sys-issue-area">[' + issue.area + ']</span> ' + issue.msg + '</div></div>';
                        });
                        issuesDiv.innerHTML = ih;
                    }
                }
            } catch(e) {
                if (issuesDiv) issuesDiv.innerHTML = '<div class="admin-empty" style="color:#f87171;">Erro: ' + (e.message||'falha na verificação') + '</div>';
            }
        }

                // --- CT SCHEDULE MANAGEMENT ---
        var ctScheduleCache = {};

        async function loadCTScheduleAdmin() {
            var container = document.getElementById('adminCTScheduleList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getCTsList', {});
                if (data.success && data.cts && data.cts.length > 0) {
                    ctScheduleCache = {};
                    var html = '';
                    var DAY_LABELS = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
                    var DAY_KEYS = ['seg', 'ter', 'qua', 'qui', 'sex', 'sab', 'dom'];
                    var ALL_BENEFITS = ['TotalPass','Gympass','WellHub','GoGood','ClassPass','TotalFit'];

                    for (var i = 0; i < data.cts.length; i++) {
                        var ct = data.cts[i];
                        var ctName = typeof ct === 'string' ? ct : ct.name;
                        var schedule = (typeof ct === 'object' && ct.schedule) ? ct.schedule : {};
                        ctScheduleCache[ctName] = JSON.parse(JSON.stringify(schedule));

                        html += '<div class="ct-schedule-card" id="ctSched_' + i + '">';
                        html += '<div class="ct-schedule-header">';
                        html += '<div class="ct-schedule-name">📍 ' + ctName + '</div>';
                        html += '<span class="ct-schedule-status saved" id="ctSchedStatus_' + i + '">salvo</span>';
                        html += '</div>';
                        html += '<div class="ct-schedule-days">';

                        for (var d = 0; d < DAY_KEYS.length; d++) {
                            var active = schedule[DAY_KEYS[d]] === true;
                            html += '<div class="ct-day-toggle ' + (active ? 'active' : '') + '" ';
                            html += 'onclick="toggleCTDay(\'' + ctName.replace(/'/g, "\\'") + '\', \'' + DAY_KEYS[d] + '\', this, ' + i + ')">';
                            html += '<span class="ct-day-label">' + DAY_LABELS[d] + '</span>';
                            html += '<span class="ct-day-icon"></span>';
                            html += '</div>';
                        }

                        html += '</div>';

                        // Detail fields
                        var esc = function(v) { return (v || '').replace(/"/g, '&quot;'); };
                        var curBenefits = ct.beneficios ? ct.beneficios.split(',').map(function(b) { return b.trim().toLowerCase().replace(/\s/g,''); }) : [];

                        html += '<div class="ct-detail-section">';
                        html += '<div class="ct-detail-title">📋 Detalhes do CT</div>';

                        html += '<div class="ct-detail-field"><label>Endereço</label><input type="text" id="ctDet_end_' + i + '" value="' + esc(ct.endereco) + '" placeholder="Rua, número, bairro"></div>';

                        // Per-day time picker
                        var hpd = ct.horariosPorDia || {};
                        var DEFAULT_TIMES = ['06:00','06:30','07:00','07:30','08:00','08:30','09:00','10:00','11:00','17:00','18:00','18:30','19:00','19:30','20:00','20:30','21:00','21:30'];

                        html += '<div class="ct-detail-field">';
                        html += '<label>⏰ Horários por Dia da Semana</label>';
                        html += '<input type="hidden" id="ctDet_hrs_' + i + '" value="">';

                        // Day selector tabs
                        html += '<div class="ct-hpd-days" id="ctHpdDays_' + i + '">';
                        for (var hd = 0; hd < DAY_KEYS.length; hd++) {
                            var dayActive = schedule[DAY_KEYS[hd]] === true;
                            if (!dayActive) continue;
                            html += '<button type="button" class="ct-hpd-day-btn' + (hd === 0 || !document.querySelector ? '' : '') + '" data-day="' + DAY_KEYS[hd] + '" data-idx="' + i + '" onclick="switchCTHpdDay(this,' + i + ',\'' + DAY_KEYS[hd] + '\')">' + DAY_LABELS[hd] + '</button>';
                        }
                        html += '</div>';

                        // Time slots area (one per day, stacked)
                        for (var hd2 = 0; hd2 < DAY_KEYS.length; hd2++) {
                            var dk = DAY_KEYS[hd2];
                            if (schedule[dk] !== true) continue;
                            var dayTimes = hpd[dk] ? hpd[dk].split(',').map(function(t){return t.trim();}).filter(Boolean) : (hpd._global ? hpd._global.split(',').map(function(t){return t.trim();}).filter(Boolean) : []);
                            var allDayTimes = DEFAULT_TIMES.slice();
                            for (var dti = 0; dti < dayTimes.length; dti++) {
                                if (allDayTimes.indexOf(dayTimes[dti]) === -1) allDayTimes.push(dayTimes[dti]);
                            }
                            allDayTimes.sort();

                            html += '<div class="ct-hpd-panel" id="ctHpdPanel_' + i + '_' + dk + '" style="display:none;">';
                            html += '<div class="ct-time-slots" id="ctHpdSlots_' + i + '_' + dk + '">';
                            for (var dti2 = 0; dti2 < allDayTimes.length; dti2++) {
                                var tv = allDayTimes[dti2];
                                var isOn = dayTimes.indexOf(tv) >= 0;
                                var isCust = DEFAULT_TIMES.indexOf(tv) === -1;
                                html += '<div class="ct-time-slot' + (isOn ? ' active' : '') + (isCust ? ' custom' : '') + '" data-time="' + tv + '" data-day="' + dk + '" data-idx="' + i + '" onclick="toggleCTHpdTime(this,' + i + ',\'' + dk + '\')">' + tv;
                                if (isCust) html += '<span class="ct-time-remove" onclick="event.stopPropagation();removeCTHpdTime(this,' + i + ',\'' + dk + '\')">✕</span>';
                                html += '</div>';
                            }
                            html += '</div>';
                            html += '<div class="ct-time-add-row">';
                            html += '<input type="text" class="ct-time-add-input" id="ctHpdNew_' + i + '_' + dk + '" placeholder="HH:MM" maxlength="5">';
                            html += '<button type="button" class="ct-time-add-btn" onclick="addCTHpdTime(' + i + ',\'' + dk + '\')">+</button>';
                            html += '</div>';
                            html += '</div>';
                        }

                        html += '</div>';

                        html += '<div class="ct-detail-row">';
                        html += '<div class="ct-detail-field"><label>Valor Avulso (R$)</label><input type="text" id="ctDet_val_' + i + '" value="' + esc(ct.valorAvulso) + '" placeholder="50,00"></div>';
                        html += '</div>';

                        html += '<div class="ct-detail-field"><label>Planos (separe com |)</label><input type="text" id="ctDet_pla_' + i + '" value="' + esc(ct.planos) + '" placeholder="Mensal R$199 | Trimestral R$549"></div>';

                        // Benefit toggles
                        html += '<div class="ct-detail-field"><label>Benefícios aceitos</label><div class="ct-benefit-toggles" id="ctBen_' + i + '">';
                        for (var b = 0; b < ALL_BENEFITS.length; b++) {
                            var bKey = ALL_BENEFITS[b].toLowerCase().replace(/\s/g,'');
                            var bActive = curBenefits.indexOf(bKey) >= 0;
                            html += '<div class="ct-benefit-toggle' + (bActive ? ' active' : '') + '" data-benefit="' + ALL_BENEFITS[b] + '" onclick="this.classList.toggle(\'active\');markCTUnsaved(' + i + ')">' + ALL_BENEFITS[b] + '</div>';
                        }
                        html += '</div></div>';

                        html += '<div class="ct-detail-row">';
                        html += '<div class="ct-detail-field"><label>Link Google Maps</label><input type="text" id="ctDet_map_' + i + '" value="' + esc(ct.mapLink) + '" placeholder="https://maps.google.com/..."></div>';
                        html += '<div class="ct-detail-field"><label>Instagram</label><input type="text" id="ctDet_ig_' + i + '" value="' + esc(ct.instagram) + '" placeholder="@seuct"></div>';
                        html += '</div>';

                        html += '<div class="ct-detail-field"><label>Telefone / WhatsApp</label><input type="text" id="ctDet_tel_' + i + '" value="' + esc(ct.telefone) + '" placeholder="(21) 99999-9999"></div>';

                        html += '</div>'; // end detail section

                        html += '<div class="ct-schedule-actions">';
                        html += '<button class="ct-schedule-save" id="ctSchedSave_' + i + '" onclick="saveCTFull(\'' + ctName.replace(/'/g, "\\'") + '\', ' + i + ')">Salvar Tudo</button>';
                        html += '</div>';
                        html += '</div>';
                    }

                    container.innerHTML = html;

                    // Init per-day tabs (auto-click first day)
                    initCTHpdDays();

                    // Add change listeners to detail fields
                    for (var k = 0; k < data.cts.length; k++) {
                        (function(idx) {
                            var fields = ['ctDet_end_','ctDet_val_','ctDet_pla_','ctDet_map_','ctDet_ig_','ctDet_tel_'];
                            fields.forEach(function(prefix) {
                                var el = document.getElementById(prefix + idx);
                                if (el) el.addEventListener('input', function() { markCTUnsaved(idx); });
                            });
                            // Time input: Enter to add + auto-colon mask (per-day)
                            var dayContainer = document.getElementById('ctHpdDays_' + idx);
                            if (dayContainer) {
                                dayContainer.querySelectorAll('.ct-hpd-day-btn').forEach(function(dayBtn) {
                                    var dk = dayBtn.getAttribute('data-day');
                                    var ti2 = document.getElementById('ctHpdNew_' + idx + '_' + dk);
                                    if (ti2) {
                                        ti2.addEventListener('keydown', function(e) {
                                            if (e.key === 'Enter') { e.preventDefault(); addCTHpdTime(idx, dk); }
                                        });
                                        ti2.addEventListener('input', function(e2) {
                                            var v2 = e2.target.value.replace(/[^\d:]/g, '');
                                            if (v2.length === 2 && v2.indexOf(':') === -1) v2 = v2 + ':';
                                            e2.target.value = v2;
                                        });
                                    }
                                });
                                updateHpdDayCount(idx);
                            }
                            var timeInput = document.getElementById('ctTimeNew_DISABLED_' + idx);
                            if (timeInput) {
                                timeInput.addEventListener('keydown', function(e) {
                                    if (e.key === 'Enter') { e.preventDefault(); }
                                });
                                timeInput.addEventListener('input', function(e) {
                                    var v = e.target.value.replace(/[^\d:]/g, '');
                                    if (v.length === 2 && v.indexOf(':') === -1) v = v + ':';
                                    if (v.length > 5) v = v.substring(0, 5);
                                    e.target.value = v;
                                });
                            }
                        })(k);
                    }
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhum CT cadastrado</div>';
                }
            } catch (err) {
                container.innerHTML = '<div class="admin-empty">Erro ao carregar CTs</div>';
            }
        }

        function markCTUnsaved(cardIdx) {
            var statusEl = document.getElementById('ctSchedStatus_' + cardIdx);
            if (statusEl) { statusEl.textContent = 'alterado'; statusEl.className = 'ct-schedule-status unsaved'; }
        }

        // ===== CT TIME SLOT PICKER =====
        function updateCTTimeHidden(cardIdx) {
            var container = document.getElementById('ctTimeSlots_' + cardIdx);
            if (!container) return;
            var active = container.querySelectorAll('.ct-time-slot.active');
            var times = [];
            for (var i = 0; i < active.length; i++) {
                times.push(active[i].getAttribute('data-time'));
            }
            times.sort();
            var hidden = document.getElementById('ctDet_hrs_' + cardIdx);
            if (hidden) hidden.value = times.join(',');
            markCTUnsaved(cardIdx);
        }

        function toggleCTTime(el, cardIdx) {
            el.classList.toggle('active');
            updateCTTimeHidden(cardIdx);
        }

        function removeCTTime(removeBtn, cardIdx) {
            var slot = removeBtn.parentElement;
            slot.remove();
            updateCTTimeHidden(cardIdx);
        }

        function addCTTime(cardIdx) {
            var input = document.getElementById('ctTimeNew_' + cardIdx);
            if (!input) return;
            var val = input.value.trim();
            // Validar formato HH:MM
            if (!/^\d{1,2}:\d{2}$/.test(val)) {
                input.style.borderColor = '#E85D5D';
                setTimeout(function() { input.style.borderColor = ''; }, 1500);
                return;
            }
            var parts = val.split(':');
            var h = parseInt(parts[0]), m = parseInt(parts[1]);
            if (h < 0 || h > 23 || m < 0 || m > 59) {
                input.style.borderColor = '#E85D5D';
                setTimeout(function() { input.style.borderColor = ''; }, 1500);
                return;
            }
            var formatted = ('0' + h).slice(-2) + ':' + ('0' + m).slice(-2);

            var container = document.getElementById('ctTimeSlots_' + cardIdx);
            if (!container) return;
            // Checar duplicata
            var existing = container.querySelectorAll('.ct-time-slot');
            for (var i = 0; i < existing.length; i++) {
                if (existing[i].getAttribute('data-time') === formatted) {
                    existing[i].classList.add('active');
                    updateCTTimeHidden(cardIdx);
                    input.value = '';
                    return;
                }
            }
            // Criar novo slot (custom, já ativo)
            var slot = document.createElement('div');
            slot.className = 'ct-time-slot active custom';
            slot.setAttribute('data-time', formatted);
            slot.setAttribute('onclick', 'toggleCTTime(this,' + cardIdx + ')');
            slot.innerHTML = formatted + '<span class="ct-time-remove" onclick="event.stopPropagation();removeCTTime(this,' + cardIdx + ')">✕</span>';
            // Inserir ordenado
            var inserted = false;
            for (var j = 0; j < existing.length; j++) {
                if (existing[j].getAttribute('data-time') > formatted) {
                    container.insertBefore(slot, existing[j]);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) container.appendChild(slot);
            input.value = '';
            updateCTTimeHidden(cardIdx);
        }

        function toggleCTDay(ctName, dayKey, el, cardIdx) {
            var isActive = el.classList.contains('active');
            if (isActive) {
                el.classList.remove('active');
            } else {
                el.classList.add('active');
            }
            // Update cache
            if (!ctScheduleCache[ctName]) ctScheduleCache[ctName] = {};
            ctScheduleCache[ctName][dayKey] = !isActive;
            // Mark as unsaved
            var statusEl = document.getElementById('ctSchedStatus_' + cardIdx);
            if (statusEl) {
                statusEl.textContent = 'alterado';
                statusEl.className = 'ct-schedule-status unsaved';
            }
        }

        async function saveCTFull(ctName, cardIdx) {
            var saveBtn = document.getElementById('ctSchedSave_' + cardIdx);
            if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Salvando...'; }

            var schedule = ctScheduleCache[ctName] || {};

            // Collect benefit toggles
            var benContainer = document.getElementById('ctBen_' + cardIdx);
            var activeBens = [];
            if (benContainer) {
                var toggles = benContainer.querySelectorAll('.ct-benefit-toggle.active');
                toggles.forEach(function(t) { activeBens.push(t.getAttribute('data-benefit')); });
            }

            try {
                // Save schedule
                var r1 = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'saveCTSchedule', ctName: ctName, schedule: schedule, token: getSessionToken() }) });
                await r1.json();

                // Save details
                var details = {
                    action: 'saveCTDetails',
                    ctName: ctName,
                    endereco: (document.getElementById('ctDet_end_' + cardIdx) || {}).value || '',
                    horarios: collectCTHpdJSON(cardIdx),
                    valorAvulso: (document.getElementById('ctDet_val_' + cardIdx) || {}).value || '',
                    planos: (document.getElementById('ctDet_pla_' + cardIdx) || {}).value || '',
                    beneficios: activeBens.join(','),
                    mapLink: (document.getElementById('ctDet_map_' + cardIdx) || {}).value || '',
                    instagram: (document.getElementById('ctDet_ig_' + cardIdx) || {}).value || '',
                    telefone: (document.getElementById('ctDet_tel_' + cardIdx) || {}).value || ''
                };

                details.token = getSessionToken();
                var r2 = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(details) });
                var data = await r2.json();

                if (data.success) {
                    var statusEl = document.getElementById('ctSchedStatus_' + cardIdx);
                    if (statusEl) { statusEl.textContent = 'salvo'; statusEl.className = 'ct-schedule-status saved'; }
                } else {
                    alert(data.message || 'Erro ao salvar');
                }
            } catch (err) {
                alert('Erro de conexão');
            }

            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Salvar Tudo'; }
        }

        // === PER-DAY HORARIOS FUNCTIONS ===
        function switchCTHpdDay(btn, idx, day) {
            // Deactivate other day buttons
            var container = btn.parentElement;
            container.querySelectorAll('.ct-hpd-day-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            // Hide all panels for this CT, show selected
            var allPanels = document.querySelectorAll('[id^="ctHpdPanel_' + idx + '_"]');
            allPanels.forEach(function(p) { p.style.display = 'none'; });
            var panel = document.getElementById('ctHpdPanel_' + idx + '_' + day);
            if (panel) panel.style.display = 'block';
        }

        function initCTHpdDays() {
            // Auto-click first day button for each CT
            document.querySelectorAll('.ct-hpd-days').forEach(function(container) {
                var first = container.querySelector('.ct-hpd-day-btn');
                if (first) first.click();
            });
        }

        function toggleCTHpdTime(el, idx, day) {
            el.classList.toggle('active');
            markCTUnsaved(idx);
            updateHpdDayCount(idx);
        }

        function removeCTHpdTime(el, idx, day) {
            el.parentElement.remove();
            markCTUnsaved(idx);
            updateHpdDayCount(idx);
        }

        function addCTHpdTime(idx, day) {
            var input = document.getElementById('ctHpdNew_' + idx + '_' + day);
            if (!input) return;
            var val = input.value.trim();
            if (!/^\d{1,2}:\d{2}$/.test(val)) { input.style.borderColor = '#e74c3c'; return; }
            var h = parseInt(val.split(':')[0]), m = parseInt(val.split(':')[1]);
            if (h > 23 || m > 59) { input.style.borderColor = '#e74c3c'; return; }
            var formatted = (h < 10 ? '0' + h : h) + ':' + (m < 10 ? '0' + m : m);

            var container = document.getElementById('ctHpdSlots_' + idx + '_' + day);
            if (!container) return;
            // Check duplicate
            var existing = container.querySelectorAll('.ct-time-slot');
            for (var e = 0; e < existing.length; e++) {
                if (existing[e].getAttribute('data-time') === formatted) { input.value = ''; return; }
            }

            var slot = document.createElement('div');
            slot.className = 'ct-time-slot active custom';
            slot.setAttribute('data-time', formatted);
            slot.setAttribute('data-day', day);
            slot.setAttribute('data-idx', idx);
            slot.onclick = function() { toggleCTHpdTime(this, idx, day); };
            slot.innerHTML = formatted + '<span class="ct-time-remove" onclick="event.stopPropagation();removeCTHpdTime(this,' + idx + ',\'' + day + '\')">✕</span>';

            // Insert sorted
            var inserted = false;
            for (var s = 0; s < existing.length; s++) {
                if (existing[s].getAttribute('data-time') > formatted) {
                    container.insertBefore(slot, existing[s]);
                    inserted = true;
                    break;
                }
            }
            if (!inserted) container.appendChild(slot);

            input.value = '';
            input.style.borderColor = '';
            markCTUnsaved(idx);
            updateHpdDayCount(idx);
        }

        function collectCTHpdJSON(idx) {
            var result = {};
            var panels = document.querySelectorAll('[id^="ctHpdPanel_' + idx + '_"]');
            panels.forEach(function(panel) {
                var id = panel.id; // ctHpdPanel_0_seg
                var day = id.split('_').pop();
                var times = [];
                panel.querySelectorAll('.ct-time-slot.active').forEach(function(slot) {
                    times.push(slot.getAttribute('data-time'));
                });
                result[day] = times.join(',');
            });
            return JSON.stringify(result);
        }

        function updateHpdDayCount(idx) {
            var dayBtns = document.querySelectorAll('#ctHpdDays_' + idx + ' .ct-hpd-day-btn');
            dayBtns.forEach(function(btn) {
                var day = btn.getAttribute('data-day');
                var panel = document.getElementById('ctHpdPanel_' + idx + '_' + day);
                var count = panel ? panel.querySelectorAll('.ct-time-slot.active').length : 0;
                var span = btn.querySelector('.hpd-count');
                if (!span) { span = document.createElement('span'); span.className = 'hpd-count'; btn.appendChild(span); }
                span.textContent = count > 0 ? '(' + count + ')' : '';
            });
        }

        // --- STUDENTS LIST ---
        async function loadStudentsList() {
            var container = document.getElementById('adminStudentsList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getStudentsList', {});
                if (data.success && data.students) {
                    adminStudentsCache = data.students;
                    renderStudentsList(adminStudentsCache);
                    var badge = document.getElementById('adminStudentsBadge');
                    badge.textContent = data.students.length;
                    badge.style.display = 'inline-block';
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhum aluno cadastrado</div>';
                }
            } catch (err) {
                container.innerHTML = '<div class="admin-empty">Erro ao carregar</div>';
            }
        }

        function renderStudentsList(students) {
            var container = document.getElementById('adminStudentsList');
            if (students.length === 0) {
                container.innerHTML = '<div class="admin-empty">Nenhum aluno encontrado</div>';
                return;
            }
            var html = '';
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var initial = (s.name || '?').charAt(0).toUpperCase();
                var isAdm = (s.admin === true || s.admin === 'TRUE');
                var treinos = s.treinos || 0;
                var diasLabel = '';
                if (s.diasTreino) {
                    var dMap = {seg:'S',ter:'T',qua:'Q',qui:'Q',sex:'S',sab:'S',dom:'D'};
                    diasLabel = ' · 📅 ' + s.diasTreino.split(',').map(function(d) { return dMap[d] || d; }).join('');
                }
                html += '<div class="admin-student-card" onclick="openStuModal(\'' + (s.email || '').replace(/'/g, "\\'") + '\')">' +
                    '<div class="admin-card-avatar">' + initial + '</div>' +
                    '<div class="admin-student-info">' +
                        '<div class="admin-student-name">' + (s.name || '-') + (isAdm ? ' <span class="admin-header-badge">ADMIN</span>' : '') + '</div>' +
                        '<div class="admin-student-meta">' + (s.email || '') + '</div>' +
                        '<div class="admin-student-belt">🥋 ' + (s.faixa || '-') + ' · 📍 ' + (s.ct || '-') + ' · 💪 ' + treinos + diasLabel + '</div>' +
                    '</div>' +
                    '<span style="color:var(--text-3);font-size:16px;flex-shrink:0;">›</span>' +
                '</div>';
            }
            container.innerHTML = html;
        }

        // ===== STUDENT EDITOR MODAL =====
        var stuModalEmail = null;
        var admRankPeriod = 'mes';

        async function loadAdminRanking() {
            var container = document.getElementById('adminRankingList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getRankingMonth', { period: admRankPeriod });
                if (data.success && data.ranking && data.ranking.length > 0) {
                    var BELT_EMOJI = { 'Branca':'⬜','Cinza':'🩶','Amarela':'🟨','Laranja':'🟧','Verde':'🟩','Azul':'🟦','Roxa':'🟪','Marrom':'🟫','Preta':'⬛','Coral':'🔴','Vermelha':'🔴' };
                    var html = '';
                    for (var i = 0; i < data.ranking.length; i++) {
                        var r2 = data.ranking[i];
                        var pos = i + 1;
                        var medal = pos === 1 ? '🥇' : pos === 2 ? '🥈' : pos === 3 ? '🥉' : '<span style="font-size:11px;color:var(--text-3);font-weight:700;width:22px;display:inline-block;text-align:center;">' + pos + '</span>';
                        var belt = BELT_EMOJI[r2.faixa] || '⬜';
                        var initial = (r2.name || '?').charAt(0).toUpperCase();
                        html += '<div class="admin-student-card" style="cursor:default;padding:10px 12px;">' +
                            '<span style="margin-right:6px;font-size:16px;">' + medal + '</span>' +
                            '<div class="admin-card-avatar" style="width:32px;height:32px;font-size:13px;">' + initial + '</div>' +
                            '<div class="admin-student-info" style="padding:0;">' +
                                '<div class="admin-student-name" style="font-size:13px;">' + belt + ' ' + (r2.name || '-') + '</div>' +
                                '<div class="admin-student-meta" style="font-size:10px;">' + (r2.faixa || '-') + ' · ' + r2.ctsArr.map(function(c){return c.ct;}).join(', ') + '</div>' +
                            '</div>' +
                            '<div style="text-align:right;flex-shrink:0;">' +
                                '<div style="font-family:Sora;font-size:16px;font-weight:800;color:var(--gold);">' + r2.total + '</div>' +
                                '<div style="font-size:8px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;">treinos</div>' +
                            '</div>' +
                        '</div>';
                    }
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhum treino no período</div>';
                }
            } catch (err) {
                container.innerHTML = '<div class="admin-empty">Erro ao carregar ranking</div>';
            }
        }

        function switchAdmRankPeriod(period, evt) {
            admRankPeriod = period;
            document.querySelectorAll('#admRankPeriod .rank-period-btn').forEach(function(b) { b.classList.remove('active'); });
            if (evt && evt.target) evt.target.classList.add('active');
            loadAdminRanking();
        }

        function openStuModal(email) {
            var s = adminStudentsCache.find(function(st) { return st.email === email; });
            if (!s) return;

            stuModalEmail = email;
            var modal = document.getElementById('stuModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Hero
            document.getElementById('stuAvatar').textContent = (s.name || '?').charAt(0).toUpperCase();
            document.getElementById('stuHeroName').textContent = s.name || '—';
            document.getElementById('stuHeroEmail').textContent = s.email || '—';
            document.getElementById('stuHeroTreinos').textContent = s.treinos || 0;
            document.getElementById('stuHeroFaixa').textContent = s.faixa || '—';
            document.getElementById('stuHeroCT').textContent = s.ct ? s.ct.replace('CT ','') : '—';

            // Core fields
            document.getElementById('stuName').value = s.name || '';
            document.getElementById('stuFaixa').value = s.faixa || 'Branca';
            updateGrauOptions('stuFaixa', 'stuGrau');
            document.getElementById('stuGrau').value = s.grau || '0';

            // Populate CT dropdown
            var ctSelect = document.getElementById('stuCT');
            ctSelect.innerHTML = '';
            if (allCTs && allCTs.length > 0) {
                for (var c = 0; c < allCTs.length; c++) {
                    var ctName = typeof allCTs[c] === 'string' ? allCTs[c] : allCTs[c].name;
                    var opt = document.createElement('option');
                    opt.value = ctName;
                    opt.textContent = ctName;
                    if (ctName === s.ct) opt.selected = true;
                    ctSelect.appendChild(opt);
                }
            }

            // Admin toggle
            var toggle = document.getElementById('stuAdminToggle');
            if (s.admin === true || s.admin === 'TRUE') {
                toggle.classList.add('on');
            } else {
                toggle.classList.remove('on');
            }

            // Profile fields
            var nascimento = s.nascimento || '';
            if (nascimento && nascimento.indexOf('T') > 0) nascimento = nascimento.split('T')[0];
            document.getElementById('stuNascimento').value = nascimento;
            document.getElementById('stuGenero').value = s.genero || '';
            document.getElementById('stuProfissao').value = s.profissao || '';
            document.getElementById('stuBairro').value = s.bairro || '';
            document.getElementById('stuTelefone').value = s.telefone || '';
            document.getElementById('stuInstagram').value = s.instagram || '';
            document.getElementById('stuEmergencia').value = s.emergencia || '';
            document.getElementById('stuOrigem').value = s.origem || '';
            document.getElementById('stuObjetivo').value = s.objetivo || '';
            document.getElementById('stuHorario').value = s.horario || '';
            document.getElementById('stuExperiencia').value = s.experiencia || '';
            document.getElementById('stuSaude').value = s.saude || '';

            // Dias de treino
            var diasStr = s.diasTreino || '';
            var diasArr = diasStr ? diasStr.split(',') : [];
            document.querySelectorAll('#stuDiasGrid .stu-day-btn').forEach(function(btn) {
                var d = btn.getAttribute('data-day');
                if (diasArr.indexOf(d) !== -1) btn.classList.add('on');
                else btn.classList.remove('on');
            });
            updateStuDiasHint(s.ct);

            // Clear message
            var msg = document.getElementById('stuModalMsg');
            msg.className = 'stu-modal-msg';
            msg.textContent = '';

            // Hide delete for self
            var delBtn = document.getElementById('stuDeleteBtn');
            delBtn.style.display = (email === currentUser.email) ? 'none' : 'block';

            // Load graduation timeline
            loadGraduacoes(email);

            // Scroll to top
            modal.scrollTop = 0;
        }

        function onStuCTChange() {
            var ct = document.getElementById('stuCT').value;
            updateStuDiasHint(ct);
        }

        function updateStuDiasHint(ctName) {
            var hint = document.getElementById('stuDiasHint');
            if (!hint) return;
            if (!ctName || !allCTs) { hint.innerHTML = ''; return; }
            var ct = allCTs.find(function(c) { return (typeof c === 'string' ? c : c.name) === ctName; });
            if (!ct || typeof ct === 'string') { hint.innerHTML = ''; return; }
            var sch = ct.schedule || {};
            var dayMap = {seg:'Seg',ter:'Ter',qua:'Qua',qui:'Qui',sex:'Sex',sab:'Sáb',dom:'Dom'};
            var ctDays = [];
            var keys = Object.keys(dayMap);
            for (var i = 0; i < keys.length; i++) {
                if (sch[keys[i]]) ctDays.push(dayMap[keys[i]]);
            }
            if (ctDays.length === 0) { hint.innerHTML = ''; return; }
            // Check if any day is already selected
            var hasSelected = false;
            document.querySelectorAll('#stuDiasGrid .stu-day-btn.on').forEach(function() { hasSelected = true; });
            hint.innerHTML = '📍 ' + ctName + ' funciona: <strong>' + ctDays.join(', ') + '</strong>' +
                (!hasSelected ? ' · <span class="hint-link" onclick="applyCTDays()">Aplicar dias do CT</span>' : '');
        }

        function applyCTDays() {
            var ctName = document.getElementById('stuCT').value;
            if (!ctName || !allCTs) return;
            var ct = allCTs.find(function(c) { return (typeof c === 'string' ? c : c.name) === ctName; });
            if (!ct || typeof ct === 'string') return;
            var sch = ct.schedule || {};
            document.querySelectorAll('#stuDiasGrid .stu-day-btn').forEach(function(btn) {
                var d = btn.getAttribute('data-day');
                if (sch[d]) btn.classList.add('on');
                else btn.classList.remove('on');
            });
            updateStuDiasHint(ctName);
        }

        function closeStuModal() {
            document.getElementById('stuModal').style.display = 'none';
            document.body.style.overflow = '';
            stuModalEmail = null;
        }

        async function saveStuModal() {
            if (!stuModalEmail) return;
            var saveBtn = document.getElementById('stuSaveBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Salvando...';

            var payload = {
                action: 'adminUpdateStudent',
                email: stuModalEmail,
                name: document.getElementById('stuName').value.trim(),
                faixa: document.getElementById('stuFaixa').value,
                grau: document.getElementById('stuGrau').value,
                ct: document.getElementById('stuCT').value,
                admin: document.getElementById('stuAdminToggle').classList.contains('on'),
                nascimento: document.getElementById('stuNascimento').value,
                genero: document.getElementById('stuGenero').value,
                profissao: document.getElementById('stuProfissao').value,
                bairro: document.getElementById('stuBairro').value,
                telefone: document.getElementById('stuTelefone').value,
                instagram: document.getElementById('stuInstagram').value,
                emergencia: document.getElementById('stuEmergencia').value,
                origem: document.getElementById('stuOrigem').value,
                objetivo: document.getElementById('stuObjetivo').value,
                horario: document.getElementById('stuHorario').value,
                experiencia: document.getElementById('stuExperiencia').value,
                saude: document.getElementById('stuSaude').value,
                diasTreino: (function() {
                    var dias = [];
                    document.querySelectorAll('#stuDiasGrid .stu-day-btn.on').forEach(function(btn) {
                        dias.push(btn.getAttribute('data-day'));
                    });
                    return dias.join(',');
                })()
            };

            try {
                if (getSessionToken()) payload.token = getSessionToken();
                var r = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                var data = await r.json();
                if (data.unauthorized) { handleSessionExpired(); return; }
                if (data.forbidden) { alert('⛔ Sem permissão'); return; }
                var msg = document.getElementById('stuModalMsg');
                if (data.success) {
                    msg.className = 'stu-modal-msg success';
                    msg.textContent = '✅ Aluno atualizado com sucesso!';
                    // Update hero
                    document.getElementById('stuHeroName').textContent = payload.name;
                    document.getElementById('stuHeroFaixa').textContent = payload.faixa;
                    document.getElementById('stuHeroCT').textContent = payload.ct.replace('CT ','');
                    document.getElementById('stuAvatar').textContent = (payload.name || '?').charAt(0).toUpperCase();
                    // Refresh list
                    setTimeout(function() { loadStudentsList(); }, 1500);
                } else {
                    msg.className = 'stu-modal-msg error';
                    msg.textContent = data.message || 'Erro ao salvar';
                }
            } catch (err) {
                var msg2 = document.getElementById('stuModalMsg');
                msg2.className = 'stu-modal-msg error';
                msg2.textContent = 'Erro de conexão';
            }

            saveBtn.disabled = false;
            saveBtn.textContent = 'Salvar';
        }

        async function deleteStuFromModal() {
            if (!stuModalEmail) return;
            if (stuModalEmail === currentUser.email) { alert('Você não pode excluir a si mesmo!'); return; }
            if (!confirm('Remover ' + stuModalEmail + '? Esta ação não pode ser desfeita.')) return;

            try {
                var data = await secureFetch('deleteStudent', { email: stuModalEmail });
                if (data.success) {
                    closeStuModal();
                    loadStudentsList();
                } else { alert(data.message || 'Erro'); }
            } catch (err) { alert('Erro de conexão'); }
        }

        function filterStudentsList() {
            var q = (document.getElementById('adminStudentSearch').value || '').toLowerCase();
            if (!q) { renderStudentsList(adminStudentsCache); return; }
            var filtered = adminStudentsCache.filter(function(s) {
                return ((s.name || '').toLowerCase().indexOf(q) !== -1) || ((s.email || '').toLowerCase().indexOf(q) !== -1);
            });
            renderStudentsList(filtered);
        }

        // --- PENDING ACCOUNTS ---
        async function loadPendingAccounts() {
            var container = document.getElementById('adminAccountsList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getPendingAccounts', {});
                console.log('getPendingAccounts response:', JSON.stringify(data));
                if (data.success && data.accounts && data.accounts.length > 0) {
                    var html = '';
                    for (var i = 0; i < data.accounts.length; i++) {
                        var acc = data.accounts[i];
                        html += renderAccountCard(acc, i);
                    }
                    container.innerHTML = html;
                    var badge = document.getElementById('adminAccBadge');
                    badge.textContent = data.accounts.length;
                    badge.style.display = 'inline-block';
                    document.getElementById('adminPendingAccountsCount').textContent = data.accounts.length;
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhum cadastro pendente 🎉</div>';
                    document.getElementById('adminAccBadge').style.display = 'none';
                    document.getElementById('adminPendingAccountsCount').textContent = '0';
                }
            } catch (err) {
                console.error('loadPendingAccounts error:', err);
                container.innerHTML = '<div class="admin-empty" style="color:#E85D5D;">Erro: ' + (err.message || 'Falha ao carregar') + '</div>';
            }
        }

        function renderAccountCard(acc, idx) {
            var initial = (acc.name || '?').charAt(0).toUpperCase();
            var faixa = acc.faixa || 'Branca';
            var ct = acc.ct || '-';
            var dataStr = acc.data ? new Date(acc.data).toLocaleDateString('pt-BR') : '-';
            return '<div class="admin-card" id="accCard' + idx + '">' +
                '<div class="admin-card-top">' +
                    '<div class="admin-card-avatar">' + initial + '</div>' +
                    '<div class="admin-card-info">' +
                        '<div class="admin-card-name">' + (acc.name || 'Sem nome') + '</div>' +
                        '<div class="admin-card-meta">' + (acc.email || '') + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="admin-card-detail">🥋 ' + faixa + ' · 📍 ' + ct + ' · 📅 ' + dataStr + '</div>' +
                '<div class="admin-card-actions">' +
                    '<button class="admin-btn approve" onclick="approveAccount(\'' + (acc.email || '').replace(/'/g, "\\'") + '\',' + idx + ')">✓ Aprovar</button>' +
                    '<button class="admin-btn reject" onclick="rejectAccount(\'' + (acc.email || '').replace(/'/g, "\\'") + '\',' + idx + ')">✕ Rejeitar</button>' +
                '</div>' +
            '</div>';
        }

        async function approveAccount(email, idx) {
            var card = document.getElementById('accCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('approveAccount', { email: email });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(45,138,78,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:#2d8a4e">✅ ' + escapeHtml(email) + ' aprovado!</div>'; }
                    setTimeout(loadPendingAccounts, 1500);
                } else {
                    alert(data.message || 'Erro ao aprovar');
                    if (card) card.style.opacity = '1';
                }
            } catch (err) {
                alert('Erro de conexão');
                if (card) card.style.opacity = '1';
            }
        }

        async function rejectAccount(email, idx) {
            if (!confirm('Rejeitar cadastro de ' + email + '?')) return;
            var card = document.getElementById('accCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('rejectAccount', { email: email });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(232,93,93,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:var(--coral)">❌ ' + escapeHtml(email) + ' rejeitado</div>'; }
                    setTimeout(loadPendingAccounts, 1500);
                } else { alert(data.message || 'Erro'); if (card) card.style.opacity = '1'; }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        // --- PENDING PASSWORD RESETS ---
        async function loadPendingResets() {
            var container = document.getElementById('adminResetsList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getPendingResets', {});
                if (data.success && data.resets && data.resets.length > 0) {
                    var html = '';
                    for (var i = 0; i < data.resets.length; i++) {
                        var rst = data.resets[i];
                        var initial = (rst.name || '?').charAt(0).toUpperCase();
                        html += '<div class="admin-card" id="rstCard' + i + '">' +
                            '<div class="admin-card-top">' +
                                '<div class="admin-card-avatar">' + initial + '</div>' +
                                '<div class="admin-card-info">' +
                                    '<div class="admin-card-name">' + (rst.name || 'Aluno') + '</div>' +
                                    '<div class="admin-card-meta">' + (rst.email || '') + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="admin-card-detail">🔑 Solicitação de nova senha · 📅 ' + (rst.data || '-') + '</div>' +
                            '<div class="admin-card-actions">' +
                                '<button class="admin-btn approve" onclick="approveReset(\'' + (rst.email || '').replace(/'/g, "\\'") + '\',' + i + ')">✓ Aprovar</button>' +
                                '<button class="admin-btn reject" onclick="rejectReset(\'' + (rst.email || '').replace(/'/g, "\\'") + '\',' + i + ')">✕ Rejeitar</button>' +
                            '</div>' +
                        '</div>';
                    }
                    container.innerHTML = html;
                    var badge = document.getElementById('adminResetBadge');
                    badge.textContent = data.resets.length;
                    badge.style.display = 'inline-block';
                    document.getElementById('adminPendingResetsCount').textContent = data.resets.length;
                } else {
                    container.innerHTML = '<div class="admin-empty">Nenhum reset pendente 🎉</div>';
                    document.getElementById('adminResetBadge').style.display = 'none';
                    document.getElementById('adminPendingResetsCount').textContent = '0';
                }
            } catch (err) {
                container.innerHTML = '<div class="admin-empty">Erro ao carregar</div>';
            }
        }

        async function approveReset(email, idx) {
            var card = document.getElementById('rstCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('approvePasswordReset', { email: email });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(45,138,78,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:#2d8a4e">✅ Senha de ' + escapeHtml(email) + ' atualizada!</div>'; }
                    setTimeout(loadPendingResets, 1500);
                } else {
                    alert(data.message || 'Erro ao aprovar');
                    if (card) card.style.opacity = '1';
                }
            } catch (err) {
                alert('Erro de conexão');
                if (card) card.style.opacity = '1';
            }
        }

        async function rejectReset(email, idx) {
            if (!confirm('Rejeitar reset de senha de ' + email + '?')) return;
            var card = document.getElementById('rstCard' + idx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('rejectPasswordReset', { email: email });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(232,93,93,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:var(--coral)">❌ Reset rejeitado</div>'; }
                    setTimeout(loadPendingResets, 1500);
                } else { alert(data.message || 'Erro'); if (card) card.style.opacity = '1'; }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        // --- PENDING CHECK-INS ---
        async function loadPendingCheckins() {
            var container = document.getElementById('adminCheckinsList');
            var approvedContainer = document.getElementById('adminApprovedList');
            container.innerHTML = '<div class="admin-empty">Carregando...</div>';
            try {
                var data = await secureFetch('getPendingCheckins', { filter: adminCheckinFilter });

                // Pending
                adminPendingCheckins = (data.pending || []);
                adminApprovedCheckins = (data.approved || []);

                renderPendingCheckins();
                renderApprovedCheckins();

                // Stats
                document.getElementById('adminPendingCheckinsCount').textContent = adminPendingCheckins.length;
                document.getElementById('adminTodayCheckinsCount').textContent = (data.todayTotal || 0);

            } catch (err) {
                container.innerHTML = '<div class="admin-empty">Erro ao carregar</div>';
            }
        }

        function renderPendingCheckins() {
            var container = document.getElementById('adminCheckinsList');
            var bulkBtn = document.getElementById('adminBulkApproveBtn');
            if (adminPendingCheckins.length === 0) {
                container.innerHTML = '<div class="admin-empty">Nenhum check-in pendente 🎉</div>';
                document.getElementById('adminCheckinBadge').style.display = 'none';
                bulkBtn.style.display = 'none';
                return;
            }

            var html = '';
            for (var i = 0; i < adminPendingCheckins.length; i++) {
                var ck = adminPendingCheckins[i];
                html += renderCheckinCard(ck, i);
            }
            container.innerHTML = html;

            var badge = document.getElementById('adminCheckinBadge');
            badge.textContent = adminPendingCheckins.length;
            badge.style.display = 'inline-block';

            bulkBtn.style.display = adminPendingCheckins.length > 1 ? 'block' : 'none';
            bulkBtn.textContent = '✓ Aprovar Todos (' + adminPendingCheckins.length + ')';
        }

        function renderApprovedCheckins() {
            var container = document.getElementById('adminApprovedList');
            if (adminApprovedCheckins.length === 0) {
                container.innerHTML = '<div class="admin-empty">Nenhum check-in aprovado hoje</div>';
                document.getElementById('adminApprovedBadge').style.display = 'none';
                return;
            }
            var html = '';
            for (var i = 0; i < adminApprovedCheckins.length; i++) {
                var ck = adminApprovedCheckins[i];
                var initial = (ck.name || '?').charAt(0).toUpperCase();
                html += '<div class="admin-card">' +
                    '<div class="admin-card-top">' +
                        '<div class="admin-card-avatar">' + initial + '</div>' +
                        '<div class="admin-card-info">' +
                            '<div class="admin-card-name">' + (ck.name || '-') + '</div>' +
                            '<div class="admin-card-meta">' + (ck.ct || '') + ' · <span class="admin-checkin-time">' + (ck.hora || '') + '</span></div>' +
                        '</div>' +
                        '<span class="admin-checkin-status aprovado">aprovado</span>' +
                    '</div>' +
                '</div>';
            }
            container.innerHTML = html;
            var badge = document.getElementById('adminApprovedBadge');
            badge.textContent = adminApprovedCheckins.length;
            badge.style.display = 'inline-block';
        }

        function renderCheckinCard(ck, idx) {
            var initial = (ck.name || '?').charAt(0).toUpperCase();
            var dataStr = ck.dataFormatada || '-';
            var rowIndex = ck.rowIndex || 0;
            return '<div class="admin-card" id="ckCard' + idx + '">' +
                '<div class="admin-card-top">' +
                    '<div class="admin-card-avatar">' + initial + '</div>' +
                    '<div class="admin-card-info">' +
                        '<div class="admin-card-name">' + (ck.name || '-') + '</div>' +
                        '<div class="admin-card-meta">' + (ck.email || '') + '</div>' +
                    '</div>' +
                    '<span class="admin-checkin-status pendente">pendente</span>' +
                '</div>' +
                '<div class="admin-card-detail">📍 ' + (ck.ct || '-') + ' · ⏰ ' + (ck.hora || '-') + ' · 📅 ' + dataStr + '</div>' +
                '<div class="admin-card-actions">' +
                    '<button class="admin-btn approve" onclick="approveCheckin(' + rowIndex + ',' + idx + ')">✓ Aprovar</button>' +
                    '<button class="admin-btn reject" onclick="rejectCheckin(' + rowIndex + ',' + idx + ')">✕ Rejeitar</button>' +
                '</div>' +
            '</div>';
        }

        function filterAdminCheckins(filter, evt) {
            document.querySelectorAll('.admin-filter-btn').forEach(function(b) { b.classList.remove('active'); });
            if (evt && evt.target) evt.target.classList.add('active');
            adminCheckinFilter = filter;
            loadPendingCheckins();
        }

        async function approveCheckin(rowIndex, cardIdx) {
            var card = document.getElementById('ckCard' + cardIdx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('approveCheckin', { rowIndex: rowIndex, approvedBy: currentUser.email });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(45,138,78,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:#2d8a4e">✅ Aprovado!</div>'; }
                    setTimeout(loadPendingCheckins, 1000);
                } else {
                    alert(data.message || 'Erro');
                    if (card) card.style.opacity = '1';
                }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        async function rejectCheckin(rowIndex, cardIdx) {
            if (!confirm('Rejeitar este check-in?')) return;
            var card = document.getElementById('ckCard' + cardIdx);
            if (card) card.style.opacity = '0.5';
            try {
                var data = await secureFetch('rejectCheckin', { rowIndex: rowIndex });
                if (data.success) {
                    if (card) { card.style.background = 'rgba(232,93,93,0.1)'; card.innerHTML = '<div class="admin-empty" style="color:var(--coral)">❌ Rejeitado</div>'; }
                    setTimeout(loadPendingCheckins, 1000);
                } else { alert(data.message || 'Erro'); if (card) card.style.opacity = '1'; }
            } catch (err) { alert('Erro de conexão'); if (card) card.style.opacity = '1'; }
        }

        async function bulkApproveCheckins() {
            if (!confirm('Aprovar todos os ' + adminPendingCheckins.length + ' check-ins pendentes?')) return;
            var btn = document.getElementById('adminBulkApproveBtn');
            btn.disabled = true;
            btn.textContent = 'Aprovando...';
            try {
                var data = await secureFetch('bulkApproveCheckins', { approvedBy: currentUser.email, filter: adminCheckinFilter });
                if (data.success) {
                    btn.textContent = '✅ ' + (data.count || 0) + ' aprovados!';
                    setTimeout(loadPendingCheckins, 1500);
                } else { alert(data.message || 'Erro'); }
            } catch (err) { alert('Erro de conexão'); }
            btn.disabled = false;
        }
    </script>
</body>
</html>
